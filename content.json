{"meta":{"title":"Just Hack Fun","subtitle":"","description":"Focusing on Linux kernel and OS","author":"Lv Ying","url":"https://system-thoughts.github.io","root":"/"},"pages":[{"title":"","date":"2023-01-18T05:32:06.172Z","updated":"2023-01-18T05:32:06.172Z","comments":true,"path":"about/index.html","permalink":"https://system-thoughts.github.io/about/index.html","excerpt":"","text":""},{"title":"","date":"2022-08-26T01:25:11.000Z","updated":"2023-01-18T05:32:06.172Z","comments":true,"path":"changelog/index.html","permalink":"https://system-thoughts.github.io/changelog/index.html","excerpt":"","text":"Changelog 2022-11-11 ğŸ”— ç”³è¯·äº†åŸŸåjusthack.funï¼Œæ›´åŠ ä¸ªæ€§äº† 2022-08-20 ğŸ’¬ çœ‹ä¸­äº†åŸºäºgiscusçš„è¯„è®ºç³»ç»Ÿï¼Œåœ¨insideä¸»é¢˜ä¸­æŠ˜è…¾äº†å¾ˆä¹…æ— æœã€‚è½¬å‘volantisä¸»é¢˜ 2020-10-15 ğŸ¥³ æ­å»ºåŸºäºinsideä¸»é¢˜çš„hexoåšå®¢ï¼Œå¹¶åˆ©ç”¨Travis-CIæ„å»ºã€å‘å¸ƒåšå®¢ï¼Œè®©æˆ‘å…»æˆæ›´æ–°åšå®¢çš„ä¹ æƒ¯Travis-CIæŒç»­é›†æˆHexoåšå®¢"},{"title":"Open Source contribution","date":"2020-12-29T20:32:19.000Z","updated":"2023-01-18T05:32:06.172Z","comments":true,"path":"contribution/index.html","permalink":"https://system-thoughts.github.io/contribution/index.html","excerpt":"","text":""},{"title":"Slides and Talks","date":"2022-08-02T02:29:41.000Z","updated":"2023-01-18T05:32:06.176Z","comments":true,"path":"slide_talk/index.html","permalink":"https://system-thoughts.github.io/slide_talk/index.html","excerpt":"","text":"Slides[1] Programmerâ€™s Self-Cultivation - compilation overview Paper Share[1] [OSDIâ€™2020] Predictive and Adaptive Failure Mitigation to Avert Production Cloud VM Interruptions"},{"title":"Translation Collection","date":"2020-12-29T20:29:41.000Z","updated":"2023-01-18T05:32:06.176Z","comments":true,"path":"traslation/index.html","permalink":"https://system-thoughts.github.io/traslation/index.html","excerpt":"","text":"What does Translation Collection include?æœ¬é¡µé¢æ”¶é›†äº†å½“å‰åšå®¢çš„æ‰€æœ‰è¯‘æ–‡ï¼Œæˆ‘ä¼šç¿»è¯‘é‚£äº›æˆ‘æ„Ÿå…´è¶£æˆ–è€…å¯¹æˆ‘å­¦ä¹ ã€å·¥ä½œæœ‰å¸®åŠ©çš„æ–‡ç« ã€‚å¹¶ä¸ä¼šå¯¹æŸä¸€ç³»åˆ—çš„æ–‡ç« è¿›è¡Œè·Ÿè¸ªç¿»è¯‘ï¼Œå¦‚LWNï¼Œå…¶æ–‡ç« è´¨é‡è¾ƒé«˜ï¼Œä½†å¹¶éæ‰€æœ‰æ–‡ç« éƒ½åœ¨æˆ‘å·¥ä½œé¢†åŸŸä¹‹å†…ã€‚å¯¹ä¸ç†Ÿæ‚‰çš„æ–‡ç« è¿›è¡Œç¿»è¯‘äºæˆ‘æ— ç›Šï¼Œç”šè‡³ä¼šè¯¯è§£è¯»è€…ã€‚ åšå®¢ä¸­çš„æ‰€æœ‰è¯‘æ–‡ä¼šåŒ…å«å¼•æ–‡(Citation)ã€æ­£æ–‡(text)ã€å°¾å£°(coda)ã€‚å¼•æ–‡ä»‹ç»äº†æˆ‘ç¿»è¯‘æœ¬ç¯‡æ–‡ç« çš„åŸå› ï¼Œæ­£æ–‡æ˜¯åŸæ–‡çš„ç¿»è¯‘ï¼Œå°¾å£°éƒ¨åˆ†æ˜¯æˆ‘å¯¹è¿™ç¯‡æ–‡ç« çš„äº›è®¸æ„Ÿæƒ³ã€‚å¹¶éæ¯ç¯‡è¯‘æ–‡éƒ½ä¼šåŒ…å«å°¾å£°éƒ¨åˆ†ï¼Œæ¯•ç«Ÿæˆ‘ä¸æƒ³ç‹—å°¾ç»­è²‚ğŸ™ƒã€‚æ­£æ–‡éƒ¨åˆ†åŸºæœ¬ä¸Šæ˜¯åŸæ–‡çš„ä¸­è¯‘æ–‡ï¼Œé™¤éè‹±æ–‡åŸæ–‡è¡¨è¿°éå¸¸ç²¾å½©ï¼Œäº¦æˆ–æˆ‘æ— æ³•ç”¨å‡†ç¡®çš„ä¸­æ–‡å¯¹å…¶è¿›è¡Œç¿»è¯‘ï¼Œæˆ‘æ‰ä¼šåœ¨æ­£æ–‡éƒ¨åˆ†é€šè¿‡â€œå¼•ç”¨â€æ˜¾ç¤ºè‹±æ–‡åŸæ–‡ã€‚ä¸Šè¿°ä¸‰éƒ¨åˆ†é€šè¿‡åˆ†å‰²çº¿(dividing line)è¿›è¡ŒåŒºåˆ†ã€‚ ContentLinux tools ã€è¯‘æ–‡ã€‘ Becoming friends with NetworkManager"}],"posts":[{"title":"APEIæ•…éšœä¸ŠæŠ¥","slug":"APEIæ•…éšœä¸ŠæŠ¥","date":"2023-01-17T01:56:55.000Z","updated":"2023-01-18T05:32:06.128Z","comments":true,"path":"posts/f776b7e3/","link":"","permalink":"https://system-thoughts.github.io/posts/f776b7e3/","excerpt":"","text":"APEI(ACPI Platform Error Interfaces)ä¸ºç¡¬ä»¶å¹³å°æä¾›äº†ä¸€ç§å°†æ•…éšœä¿¡æ¯ä¼ é€’ç»™OSçš„æ–¹æ³•ã€‚APEIæ‰©å±•äº†ç°æœ‰çš„ç¡¬ä»¶æ•…éšœä¸ŠæŠ¥æœºåˆ¶(e.g. Intel MCA, PCIe AER etc)ï¼Œå¹¶å°†ä»–ä»¬ç»„åˆåˆ°ä¸€èµ·ä»¥æä¾›ç»Ÿä¸€çš„ç¡¬ä»¶æ•…éšœä¸ŠæŠ¥æ¡†æ¶ã€‚ç”±äºå›ºä»¶ç¦»ç¡¬ä»¶æ›´è¿‘ï¼Œè®¿é—®ç¡¬ä»¶è®¾å¤‡æ›´ä¸ºæ–¹ä¾¿ï¼ŒAPEIä¸­å›ºä»¶çš„ä½œç”¨ä¹Ÿæ›´ä¸ºæ˜æ˜¾ï¼Œæå‡ºäº†Firmware Firstæœºåˆ¶ã€‚ ç¡¬ä»¶æ•…éšœæº(Hardware error source)APEIçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ç¡¬ä»¶æ•…éšœæº(Hardware error source)ï¼Œç¡¬ä»¶æ•…éšœæºæ˜¯OSæ„ŸçŸ¥åˆ°ç¡¬ä»¶æ•…éšœçš„å…ˆå†³æ¡ä»¶ï¼Œå…¸å‹çš„ç¡¬ä»¶æ•…éšœæºåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š ä¸€ä¸ªæˆ–å¤šä¸ªç¡¬ä»¶æ•…éšœçŠ¶æ€å¯„å­˜å™¨(Hardware error status registers) ä¸€ä¸ªæˆ–å¤šä¸ªç¡¬ä»¶æ•…éšœé…ç½®/æ§åˆ¶å¯„å­˜å™¨(Hardware error configuration or control registers) é€šçŸ¥OSå½“å‰ç¡¬ä»¶å‘ç”Ÿç¡¬ä»¶æ•…éšœçš„é€šçŸ¥æœºåˆ¶ ç”±æ­¤å¯è§ï¼Œç¡¬ä»¶æ•…éšœæºæŒ‡çš„æ˜¯ç¡¬ä»¶ä¸­è®°å½•ç¡¬ä»¶æ•…éšœä¿¡æ¯ã€é…ç½®ç¡¬ä»¶æ•…éšœéƒ¨åˆ†ä»¥åŠé€šçŸ¥OSå½“å‰ç¡¬ä»¶å‘ç”Ÿç¡¬ä»¶æ•…éšœçš„é€šçŸ¥æœºåˆ¶ã€‚äº†è§£Intel MCA(Machine Check Architecture)æœºåˆ¶çš„æœ‹å‹å¯ä»¥å°†ä¸Šé¢ä¸‰ç‚¹å¯¹åº”ä¸Šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯å…¨å±€çš„ç¡¬ä»¶æ•…éšœé…ç½®/æ§åˆ¶å¯„å­˜å™¨ï¼Œå³ä¾§æ˜¯è®°å½•ç¡¬ä»¶æ•…éšœä¿¡æ¯çš„å¯„å­˜å™¨ï¼Œç¡¬ä»¶æ•…éšœé€šè¿‡MCEå¼‚å¸¸é€šçŸ¥OSï¼š å¦‚æœæ˜¯CEæ•…éšœï¼Œç¡¬ä»¶æ•…éšœæºå¯ä»¥ä¸åŒ…æ‹¬ç¡¬ä»¶æ•…éšœé€šçŸ¥æœºåˆ¶ï¼Œå¯ä»¥ç”±OSè‡ªä¸»è½®è¯¢(poll)æ•…éšœçŠ¶æ€å¯„å­˜å™¨ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¡¬ä»¶æ•…éšœã€‚è½®è¯¢æœºåˆ¶ä¸é€‚ç”¨äºUCEæ•…éšœï¼ŒUCEæ•…éšœéœ€è¦ç«‹å³å¤„ç†ï¼Œç¡¬ä»¶éœ€è¦ç«‹åˆ»é€šçŸ¥OSã€‚Intel MCAæœºåˆ¶ä¸­ï¼ŒCEæ•…éšœæ˜¯é€šè¿‡CMCIä¸­æ–­é€šçŸ¥OSï¼Œå½“å‘ç”ŸCEé£æš´æ—¶ï¼Œä¸ºäº†é™ä½å¤§é‡CMCIä¸­æ–­å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“ï¼ŒOSå°†ä¸­æ–­é€šçŸ¥æœºåˆ¶è½¬æ¢ä¸ºè½®è¯¢æœºåˆ¶è¿›è¡ŒCEé£æš´æŠ‘åˆ¶ã€‚ APEIé‡‡ç”¨å›ºä»¶ä¼˜å…ˆ(Firmware First mode, FFM)çš„æ•…éšœä¸ŠæŠ¥æœºåˆ¶ï¼Œå³ç¡¬ä»¶å•å…ƒå‡ºç°æ•…éšœï¼Œå…ˆé€šçŸ¥BIOS(Firmware)ï¼ŒBIOSè¿›è¡Œé¢„å¤„ç†ä¹‹åï¼Œç„¶åå°†æ•…éšœé€šçŸ¥ç»™OSã€‚APEIä¸­BIOSå’ŒOSåˆä½œè¿›è¡Œæ•…éšœå¤„ç†ï¼Œè¿™ç§æ¨¡å¼ä¹Ÿç»™ç¡¬ä»¶å¹³å°ä¾›åº”å•†(Hardware platform vendor)å¾ˆå¤§çš„çµæ´»æ€§è¿›è¡Œè®¾è®¡æ¥ç¡®å®šæ˜¯BIOSè¿˜æ˜¯OSæ‹¥æœ‰å…³é”®çš„ç¡¬ä»¶é”™è¯¯èµ„æºã€‚APEIå…è®¸BIOSå°†ç¡¬ä»¶é”™è¯¯æºçš„æ§åˆ¶æƒè®©æ¸¡ç»™OSã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼ŒIntel EMCA2å³ä¾¿é‡‡ç”¨FFMæ•…éšœä¸ŠæŠ¥ï¼ŒOSè¿›å…¥MCEæ•…éšœå¤„ç†æµç¨‹ä¹Ÿæ˜¯èƒ½å¤Ÿè®¿é—®ç¡¬ä»¶æ•…éšœçŠ¶æ€å¯„å­˜å™¨ã€ç¡¬ä»¶æ•…éšœæ§åˆ¶å¯„å­˜å™¨ï¼›ç„¶è€Œï¼ŒARMå®ç°çš„FFMï¼ŒOSæ— æ³•æ‹¥æœ‰å…³é”®çš„ç¡¬ä»¶é”™è¯¯èµ„æºï¼Œæ‰€æœ‰çš„æ•…éšœä¿¡æ¯å‡æ¥æºäºBIOSé¢„å¤„ç†ä¹‹åçš„æ•…éšœä¿¡æ¯ä¸ŠæŠ¥ã€‚ ACPIé”™è¯¯æº(ACPI error source)ACPIé”™è¯¯æºæŒ‡çš„æ˜¯BIOSé€šè¿‡ä¸€ç§æ ‡å‡†åŒ–çš„æœºåˆ¶å‘OSæè¿°ç¡¬ä»¶æ•…éšœæºã€‚APEIé€šè¿‡ä¸€å¥—æ ‡å‡†åŒ–çš„è¡¨æ ¼æè¿°ç¡¬ä»¶æ•…éšœæºï¼Œè¿™æ˜¯ä¸€ç§å¹³å°å’Œå¤„ç†å™¨æ¶æ„æ— å…³çš„æ¥å£ã€‚è¡¨æ ¼ä¸­ä¸ä»…åŒ…å«ç¡®å®šçš„ç¡¬ä»¶æ•…éšœä¿¡æ¯ï¼Œè¿˜åŒ…æ‹¬å…³äºé”™è¯¯æºçš„å¯æ“ä½œå‚æ•°(operational parameters)ï¼Œä¾‹å¦‚æ•…éšœçº§åˆ«ã€masking bitsã€é˜ˆå€¼ï¼Œè¿™äº›å¯æ“ä½œå‚æ•°å¯ä»¥è§†ä¸ºBIOSå’ŒOSä¹‹é—´æ²Ÿé€šè¿‡ç¨‹ä¸­çš„å¯è°ƒèŠ‚å‚æ•°ã€‚ACPIè§„èŒƒå®šä¹‰äº†HESTè¡¨(Hardware Error Source Table)ç”¨äºBIOSå‘OSæè¿°ç¡¬ä»¶æ•…éšœæºã€‚HESTè¡¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘äººä¸ºåœ°å°†HESTè¡¨ç»“æ„åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š HEST headerï¼ŒåŒ…å«ACPIè¡¨æ ¼å¤´çš„å¸¸ç”¨ä¿¡æ¯ï¼Œå¦‚è¡¨æ ¼å¤´ç­¾åã€è¡¨æ ¼é•¿åº¦ï¼Œè¿˜åŒ…å«OEMçš„äº›è®¸ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯â€œError Source Countâ€ï¼Œè¯´æ˜BIOSæŠ¥å‘Šç»™OSçš„é”™è¯¯æºä¸ªæ•° é”™è¯¯æºç»“æ„ï¼Œå®é™…æè¿°ç¡¬ä»¶æ•…éšœé”™è¯¯æºï¼Œä¸Šå›¾ä¸­ç»™å‡ºçš„æ˜¯GHESé”™è¯¯æºçš„ç»“æ„ å‰é¢æåˆ°è¿‡ACPIé”™è¯¯æºï¼Œç›¸åº”çš„å­˜åœ¨éACPIé”™è¯¯æº(Non-ACPI error source)ã€‚éACPIé”™è¯¯æºè¡¨ç¤ºå¯ä»¥é€šè¿‡éACPIæ ‡å‡†åŒ–çš„è¡¨æ ¼æè¿°ç¡¬ä»¶æ•…éšœæºï¼Œä¾‹å¦‚Intel MCAæŠ¥å‘ŠUCEæ•…éšœçš„MCEå¼‚å¸¸ä½¿ç”¨ä¸Šæ–‡æåŠçš„MSRsæè¿°ç¡¬ä»¶æ•…éšœä»¥åŠé…ç½®/æ§åˆ¶æ•…éšœæºï¼Œå¯ä»¥é€šè¿‡MCEå¼‚å¸¸ç›´æ¥é€šçŸ¥OSã€‚APEIå®šä¹‰äº†å¤šç§ç±»å‹çš„é”™è¯¯æºç»“æ„ï¼Œå¯ä»¥å°†è¿™äº›é”™è¯¯æºç»“æ„å¯ä»¥æ€»ç»“ä¸ºä¸¤ç±»ï¼š å…¼å®¹éACPIé”™è¯¯æºï¼Œå³ä¾¿è¿™äº›é”™è¯¯æºèƒ½å¤Ÿç›´æ¥é€šçŸ¥OSï¼ŒACPIä¹Ÿæ”¯æŒæ ‡å‡†åŒ–çš„è¡¨æ ¼æè¿°è¯¥æ•…éšœæºï¼Œå¦‚x86æ¶æ„é€šè¿‡MCEä¸ŠæŠ¥çš„UCEã€x86æ¶æ„é€šè¿‡MCEä¸ŠæŠ¥çš„Deferred errorã€x86æ¶æ„é€šè¿‡correceted machine checkä¸ŠæŠ¥çš„CEã€x86æ¶æ„é€šè¿‡NMIä¸ŠæŠ¥çš„UCEã€PCIe root protçš„AERæ•…éšœã€PCIeè®¾å¤‡çš„AERæ•…éšœã€PCI Express/PCI-X Bridgeçš„AERæ•…éšœ GHES(Generic Hardware Error Source)ï¼Œé€šç”¨æ•…éšœé”™è¯¯æºï¼Œä¸å—é™äºä»»ä½•æ•…éšœæºç±»å‹ï¼Œæä¾›ä¸€ç§ç»Ÿä¸€æè¿°æ•…éšœæºçš„æ–¹æ³•ï¼Œè‹¥è¦å®ç°æ¶æ„æ— å…³çš„æ•…éšœæºæè¿°ï¼ŒGHESæ˜¯ç»ä½³é€‰æ‹©ã€‚å¹³å°æ”¯æŒå¤šä¸ªé€šçŸ¥ç±»å‹çš„GHESæ•…éšœæºï¼Œä¾‹å¦‚ä½¿ç”¨SCIé€šçŸ¥ç±»å‹çš„GHESæ•…éšœæºå¤„ç†å¼‚æ­¥é”™è¯¯ï¼›ä½¿ç”¨SEA/MCEé€šçŸ¥ç±»å‹å¤„ç†åŒæ­¥é”™è¯¯ã€‚ å…¼å®¹éACPIé”™è¯¯æºå¤§æ¦‚ç‰¹å¾æ€»ç»“å¦‚ä¸‹ï¼š Error source structure Flags Max entry in HEST IA-32 Architecture Machine Check Exception FIRMWARE_FIRST|GHES_ASSIST 1 IA-32 Architecture Deferred Machine Check FIRMWARE_FIRST|GHES_ASSIST 1 IA-32 Architecture Corrected Machine Check FIRMWARE_FIRST|GHES_ASSIST 1 IA-32 Architecture Non-Maskable Interrupt N/A 1 PCI Express Root Port AER Structure FIRMWARE_FIRST|GLOBAL &gt;= 1 (none GLOBAL flag set); 1 (GLOBAL flag set) PCI Express Device AER Structure FIRMWARE_FIRST|GLOBAL &gt;= 1 (none GLOBAL flag set); 1 (GLOBAL flag set) PCI Express/PCI-X Bridge AER Structure FIRMWARE_FIRST|GLOBAL &gt;= 1 (none GLOBAL flag set); 1 (GLOBAL flag set) â€œMax entry in HESTâ€è¡¨ç¤ºHESTè¡¨æ ¼ä¸­å…è®¸è¯¥ç±»å‹çš„é”™è¯¯æºçš„æœ€å¤§æ•°ç›®ã€‚â€Flagsâ€æ˜¯é”™è¯¯æºç»“æ„ä½“ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œåªæœ‰IA-32 Architecture Non-Maskable Interruptä¸å­˜åœ¨è¯¥å­—æ®µã€‚ç›´æ¥å¼•ç”¨APEIè§„èŒƒå¯¹Flagså­—æ®µçš„bitè¿›è¡Œè§£é‡Šï¼š Bit [0] - FIRMWARE_FIRST: If set, this bit indicates to the OSPM that system firmware will handle errors from this source first.Bit [1] - GLOBAL: If set, indicates that the settings contained in this structure apply globally to all PCI Express DevicesBit [2] - GHES_ASSIST: If set, this bit indicates that although OSPM is responsible for directly handling the error (as expected when FIRMWARE_FIRST is not set), system firmware reports additional information in the context of an interrupt generated by the error. The additional information is reported in a Generic Hardware Error Source structure with a matching Related Source Id. ä¸Šè¿°åŒ…å«Flagså­—æ®µçš„é”™è¯¯æºç»“æ„ä½“ï¼Œéƒ½åŒ…å«FIRMWARE_FIRST bitï¼Œè¯¥ä½å¦‚æœè®¾ç½®ï¼Œè¡¨ç¤ºè¯¥ç±»æ•…éšœæºé‡‡ç”¨Firmware Firstçš„æ•…éšœå¤„ç†æ¨¡å¼ã€‚IA-32 MCAçš„CE/UCE/Deferredé”™è¯¯æºè¿˜ä½¿ç”¨äº†GHES_ASSIST bitï¼Œå¦‚æœè¯¥ä½è®¾ç½®äº†ï¼Œå³ä¾¿æ˜¯OSç›´æ¥å¤„ç†æ•…éšœ(FIRMWARE_FIRSTä¸è®¾ç½®ï¼ŒéFFM)ï¼Œä¹Ÿå¯ä»¥è®©BIOSç”Ÿæˆä¸­æ–­ï¼Œé€šè¿‡GHESæŠ¥å‘Šæ•…éšœä¿¡æ¯ï¼ŒGHESç»“æ„ä½“ä¸­çš„Related Source Idå¯ä»¥å°†äºŒè€…å…³è”èµ·æ¥ã€‚PCIe AERæ•…éšœè¿˜ä¼šä½¿ç”¨GLOBAL bitï¼Œè¯¥ä½ä¸FIRMWARE_FIRST bitäº’æ–¥ã€‚å¦‚æœGLOBAL bitè®¾ç½®ï¼Œè¡¨ç¤ºæ­¤æ•…éšœæºçš„æ‰€æœ‰è®¾ç½®é€‚ç”¨äºç³»ç»Ÿä¸­çš„æ‰€æœ‰PCIeè®¾å¤‡ï¼Œè‹¥è®¾ç½®FIRMWARE_FIRST bitï¼Œåˆ™å¯ä»¥ä¸ºæ¯ä¸ªPCIeè®¾å¤‡è¿›è¡Œæ•…éšœæºé…ç½®ã€‚ GHES(Generic Hardware Error Source)GHESä½œä¸ºé€šç”¨æ•…éšœæºï¼Œå¯ä»¥åšåˆ°å¹³å°æ— å…³åœ°æè¿°æ•…éšœæºï¼Œå› æ­¤è¢«ä¼šè¢«å¤šä¸ªæ¶æ„ç”¨æ¥æè¿°æ•…éšœã€‚æˆ‘æ¥è§¦åˆ°çš„ARMæœåŠ¡å™¨åŸºæœ¬ä¸Šéƒ½ä½¿ç”¨GHES(v2 or higher)æ•…éšœæºæè¿°ç¡¬ä»¶æ•…éšœã€‚GHESç»“æ„ä½“ä¸­æœ€é‡è¦çš„å­—æ®µæ˜¯Error Status Addressï¼Œå…¶æŒ‡å®šäº†ä¸€ä¸ªå¯„å­˜å™¨çš„ä½ç½®ï¼Œè¯¥å¯„å­˜å™¨ä¿å­˜äº†è¯¥é”™è¯¯æºçš„(Generic) Error Status Blockçš„èµ·å§‹ç‰©ç†åœ°å€ã€‚Error Status Block LengthæŒ‡å®šäº†(Generic) Error Status Blockçš„é•¿åº¦ï¼Œä¸¤è€…æ„æˆäº†(Generic) Error Status Blockçš„å®é™…ç‰©ç†åœ°å€ç©ºé—´ï¼Œè¯¥ç‰©ç†åœ°å€ç©ºé—´ä½äºBIOSé¢„ç•™çš„åœ°å€åŒºé—´ï¼ˆç”±äºBIOSéœ€è¦å¯¹è¯¥åŒºé—´è¿›è¡Œè¯»/å†™æ“ä½œï¼‰ï¼ŒOSä¸ºäº†è¯»å–è¯¥é”™è¯¯æºçš„æ•…éšœä¿¡æ¯ï¼Œéœ€è¦å…ˆå°†è¯¥é¢„ç•™åœ°å€ç©ºé—´æ˜ å°„åˆ°OSçš„ç³»ç»Ÿåœ°å€ç©ºé—´ã€‚ (Generic) Error Status BlockåŒ…å«é”™è¯¯æºçš„å®é™…é”™è¯¯çŠ¶æ€ä¿¡æ¯(error status information)ï¼ŒHESTã€GHESæ•…éšœæºã€error status blockçš„å…³è”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨å›¾ä¸­æ ‡æ˜äº†ç›¸åº”çš„Linux kernelæ•°æ®ç»“æ„ã€‚ Generic Error Status Block(Generic) Error Status BlockåŒ…å«ä¸¤çº§ä¿¡æ¯ï¼Œé¡¶çº§æ˜¯Generic Error Status Blockç»“æ„ï¼Œéšåçš„æ˜¯Generic Error Data Entryç»“æ„ï¼Œå¯ä»¥å°†é¡¶çº§ä¿¡æ¯ç†è§£ä¸º(Generic) Error Status Blockå¤´éƒ¨ä¿¡æ¯ã€‚Generic Error Data Entryå®é™…ä¿å­˜ç¡¬ä»¶æ•…éšœä¿¡æ¯ï¼Œ(Generic) Error Status Blockå¯èƒ½åŒ…å«å¤šä¸ªGeneric Error Data Entryä»¥ä¿å­˜ä¸åŒä¸€ç¡¬ä»¶æ•…éšœç›¸å…³çš„å¤šä¸ªç¡¬ä»¶ç»„ä»¶ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨GHESæ•…éšœæºæè¿°å‘ç”Ÿåœ¨PCI Express/PCI-X bridgeçš„æ¬¡çº§è®¾å¤‡ä¸Šçš„ç¡¬ä»¶æ•…éšœï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªGeneric Error Data Entryåˆ†åˆ«æè¿°PCI Express Bridgeçš„ç¡¬ä»¶æ•…éšœä¿¡æ¯å’ŒPCI-Xè®¾å¤‡ä¸Šçš„ç¡¬ä»¶æ•…éšœä¿¡æ¯ã€‚Generic Error Data Entryåœ¨æ•´ä¸ªHESTã€GHESå±‚çº§ç»“æ„çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Generic Error Status Blockç»“æ„ä¸­æœ€é‡è¦çš„åŸŸæ˜¯Error Severityï¼Œè¡¨ç¤ºçš„æ˜¯ç¡¬ä»¶æ•…éšœäº‹ä»¶æ•´ä½“çš„æ•…éšœçº§åˆ«ã€‚Generic Error Status Blockä¹‹åæ˜¯è¿ç»­çš„ä¸€ä¸ªæˆ–å¤šä¸ªGeneric Error Data Entryã€‚å…¶ä¸­çš„Section Typeå­—æ®µå¯ä»¥åŒºåˆ†å‡ºç¡¬ä»¶æ•…éšœçš„ç¡¬ä»¶ç±»å‹[1]ï¼ŒError Severityè¡¨ç¤ºç¡¬ä»¶æ•…éšœäº‹ä»¶ä¸­çš„è¯¥ç¡¬ä»¶ç»„ä»¶çš„æ•…éšœçº§åˆ«ï¼Œè¯¥æ•…éšœçº§åˆ«ä¸èƒ½è¶…è¿‡æ•´ä½“çš„æ•…éšœçº§åˆ«ï¼ŒGeneric error dataæ˜¯å®é™…ä¿å­˜ç¡¬ä»¶æ•…éšœçš„å­—æ®µï¼Œæ ¹æ®ä¸åŒçš„ç¡¬ä»¶ç±»å‹(Section Type)ï¼Œå…¶é‡‡ç”¨UEFIè§„èŒƒä¸­â€œCommon Platform Error Record(CPER)â€çš„ç›¸åº”ç¡¬ä»¶ç±»å‹è¡¨æ ¼è®°å½•ç¡¬ä»¶æ•…éšœä¿¡æ¯ã€‚ GHESv2(Generic Hardware Error Source version 2)ä¸ŠæŠ¥GHESæ•…éšœæºçš„å›ºä»¶å¯èƒ½ä¼šä¸OSå¹¶è¡Œè¿è¡Œï¼ˆä¾‹å¦‚å›ºä»¶è¿è¡Œåœ¨å•ç‹¬/ä¸“æœ‰å¤„ç†å™¨ä¸Šï¼Œæˆ–è€…å›ºä»¶è¿è¡Œåœ¨ä»å¤„ç†å™¨ä¸Š(application processor)ï¼‰ã€‚ä¸ºäº†é˜²æ­¢å›ºä»¶å’ŒOSå¹¶å‘è®¿é—®error status blockï¼Œæˆ–è€…OSå°šæœªè¯»å–error status blockä¾¿è¢«å›ºä»¶è¦†å†™äº†æ•…éšœä¿¡æ¯ã€‚GHESv2ä½œä¸ºGHESçš„æ‰©å±•è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼ŒGHESv2æ–°å¢äº†â€Read Ack Registerâ€ï¼Œä»…åœ¨OSè¯»å–å®Œerror status blockä¸­çš„ä¿¡æ¯ä¹‹åï¼Œå›å†™Read Ack Registerä¹‹åï¼Œå›ºä»¶æ‰èƒ½å†™error status blockï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š GHESv2åœ¨GHESè¡¨æ ¼å°¾éƒ¨æ–°å¢äº†ä¸‰ä¸ªå­—æ®µï¼š Read Ack Registerï¼šä¿å­˜Read Ack Registerçš„GASåœ°å€ Read Ack Preserveï¼šå†™Read Ack Registeræ—¶ï¼Œå…¶ä¸­åŸæœ‰çš„å†…å®¹çš„bitå¿…é¡»ä¿ç•™çš„mask bits Read Ack Writeï¼šå†™Read Ack Registeræ—¶ï¼Œå¿…é¡»è®¾ç½®çš„bitçš„mask bits å› æ­¤OSå›å†™Read Ack Registeråˆ†ä¸ºä¸¤æ­¥ï¼š è¯»å–Read Ack Registerçš„å€¼ä¸ºX OSå†™å…¥(( X &amp; ReadAckPreserve) | ReadAckWrite)åˆ°Read Ack Registerçš„å€¼","categories":[{"name":"RAS","slug":"ras","permalink":"https://system-thoughts.github.io/categories/ras/"}],"tags":[{"name":"APEI","slug":"apei","permalink":"https://system-thoughts.github.io/tags/apei/"}]},{"title":"github pageå®šåˆ¶åŸŸå","slug":"github pageå®šåˆ¶åŸŸå","date":"2022-11-12T09:31:31.000Z","updated":"2023-01-18T05:32:06.156Z","comments":true,"path":"posts/9803af4d/","link":"","permalink":"https://system-thoughts.github.io/posts/9803af4d/","excerpt":"","text":"æœ¬æ–‡ä¸»è¦è®²è§£ä¸ºgithub pageæ­å»ºçš„åšå®¢ç”³è¯·åŸŸåçš„è¿‡ç¨‹ï¼Œä»¥åŠåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­çš„ä¸€äº›ç»éªŒä¹‹è°ˆã€‚æœ¬æ–‡ä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š åŸŸåæ³¨å†Œå•†çš„é€‰æ‹©æ–¹æ³• åŸŸåç”³è¯·è¿‡ç¨‹ä¸­æ˜¯å¦éœ€è¦å®åè®¤è¯ã€æ˜¯å¦éœ€è¦è¿›è¡ŒICPå¤‡æ¡ˆ å¦‚ä½•ä¸ºgithub pageåšå®¢é…ç½®DNSè®°å½•ï¼Œä»¥ä¾¿é€šè¿‡æ–°åŸŸåå¯ä»¥è®¿é—®github page åŸŸåç”³è¯·æ‰€è°“çš„åŸŸåç”³è¯·ï¼ˆè´­ä¹°ï¼‰ï¼Œå¹¶ä¸æ„å‘³ç€ä½ èƒ½å¤Ÿæ°¸ä¹…åœ°æ‹¥æœ‰åŸŸåï¼Œå®é™…ä¸Šåªèƒ½å¤Ÿç§Ÿç”¨ä¸€å®šæœŸé™çš„åŸŸåã€‚ç”¨æˆ·ä¸€èˆ¬é€šè¿‡åŸŸåæ³¨å†Œå•†(registrar)/åŸŸååˆ†é”€å•†(reseller)ç”³è¯·åŸŸåã€‚åŸŸåä¸€èˆ¬æ˜¯ä»˜è´¹ç”³è¯·ï¼Œä¸åŒçš„åŸŸåæ³¨å†Œå•†/åˆ†é”€å•†å¯¹åŒä¸€åŸŸåçš„å®šä»·ã€ç»­è´¹ä¸åŒã€‚ä¹Ÿå­˜åœ¨å…è´¹çš„åŸŸåæ³¨å†Œå•†Freenomæä¾›.TKã€.MLã€.GAã€.CFã€.GQé¡¶çº§åŸŸåçš„æ³¨å†Œã€‚å¦‚æœè¦é€‰æ‹©å¿ƒä»ªçš„TLDï¼Œè¿˜æ˜¯é€‰æ‹©ä»˜è´¹åŸŸåè¿›è¡Œæ³¨å†Œã€‚ é€‰æ‹©åŸŸåæ³¨å†Œå•†ä¸»è¦è€ƒè™‘ä¸‰ä¸ªç»´åº¦ï¼š ä»·æ ¼ éšç§ä¿æŠ¤ æ³¨å†Œå•†æœåŠ¡ ç”¨æˆ·é€‰è´­åŸŸåæ—¶ï¼Œéœ€è¦ä¸ä»…è€ƒè™‘å½“å‰çš„æ³¨å†Œä»·æ ¼è¿˜éœ€è¦è€ƒè™‘åæœŸç»­è´¹ä»·æ ¼ã€‚å¾ˆå¤šåŸŸåæ³¨å†Œå•†ä¼šæä¾›åŸŸåæ³¨å†Œä¼˜æƒ ï¼Œä½†å¾€å¾€åªèƒ½æ³¨å†Œ1å¹´ï¼Œæ³¨å†Œä»·æ ¼æä½ï¼Œä½†åæœŸç»­è´¹ä»·æ ¼è¾ƒé«˜ã€‚æˆ‘å¯¹æ¯”äº†å›½å†…è…¾è®¯äº‘ã€é˜¿é‡Œä¸‡ç½‘ä»¥åŠå›½å¤–çš„å‡ å®¶åŸŸåæ³¨å†Œå•†ï¼Œæœ€ç»ˆäº†é€‰æ‹©äº†å›½å†…çš„åŸŸåæ³¨å†Œå•†ï¼Œå›½å¤–çš„åŸŸåæ³¨å†Œå•†å¦‚Namesiloçš„ç»­è´¹ä»·æ ¼è¾ƒé«˜ã€‚ éšç§ä¿æŠ¤å¯èƒ½ä½ ç»å¸¸å¬åˆ°æ³¨å†ŒåŸŸåè¦æäº¤èº«ä»½ä¿¡æ¯ã€å¯¹ç½‘ç«™è¦è¿›è¡Œå¤‡æ¡ˆï¼Œå®é™…ä¸ŠçœŸçš„å¦‚æ­¤å—ï¼Ÿ æˆ‘å›½å¢ƒå†…çš„åŸŸåæ³¨å†ŒæœåŠ¡å•†ã€åŸŸåæ³¨å†Œç®¡ç†æœºæ„éµå®ˆå·¥ä¿¡éƒ¨2017å¹´ã€Šä¸­å›½äº’è”ç½‘ç»œåŸŸåç®¡ç†åŠæ³•ã€‹çš„åŸŸåå®åè®¤è¯çš„è¦æ±‚ï¼š åŸŸåæ³¨å†Œç”³è¯·è€…åº”æäº¤åŸŸåæŒæœ‰è€…çœŸå®ã€å‡†ç¡®ã€å®Œæ•´çš„åŸŸåæ³¨å†Œä¿¡æ¯è¿›è¡Œå®åè®¤è¯ï¼Œè‹¥åŸŸååœ¨è§„å®šæ—¶é—´å†…æœªé€šè¿‡å®åå®¡æ ¸ï¼Œä¼šè¢«æ³¨å†Œå±€æš‚åœè§£æ(Serverhold)ã€‚å¯¹äºä¸ç¬¦åˆè§„å®šçš„åŸŸåï¼Œå°†ä¾æ³•äºˆä»¥æ³¨é”€ã€‚ å› æ­¤ï¼Œé€‰æ‹©å›½å†…åŸŸåæ³¨å†ŒæœåŠ¡å•†éœ€è¦æäº¤èº«ä»½è¯ä¿¡æ¯è¿›è¡Œå®åè®¤è¯ã€‚ æ ¹æ®å›½åŠ¡é™¢ä»¤ç¬¬292å·ã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡ç®¡ç†åŠæ³•ã€‹å’Œã€Šéç»è¥æ€§äº’è”ç½‘ä¿¡æ¯æœåŠ¡å¤‡æ¡ˆç®¡ç†åŠæ³•ã€‹è§„å®šï¼Œå›½å®¶å¯¹ç»è¥æ€§äº’è”ç½‘ä¿¡æ¯æœåŠ¡å®è¡Œè®¸å¯åˆ¶åº¦ï¼Œå¯¹éç»è¥æ€§äº’è”ç½‘ä¿¡æ¯æœåŠ¡å®è¡Œå¤‡æ¡ˆåˆ¶åº¦ã€‚æœªè·å–è®¸å¯æˆ–è€…æœªå±¥è¡Œå¤‡æ¡ˆæ‰‹ç»­çš„ï¼Œä¸å¾—ä»äº‹äº’è”ç½‘ä¿¡æ¯æœåŠ¡ï¼Œå¦åˆ™å±äºè¿æ³•è¡Œä¸º[1]: ç¬¬äºŒæ¡ åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå†…ä»äº‹äº’è”ç½‘ä¿¡æ¯æœåŠ¡æ´»åŠ¨ï¼Œå¿…é¡»éµå®ˆæœ¬åŠæ³•ã€‚ æœ¬åŠæ³•æ‰€ç§°äº’è”ç½‘ä¿¡æ¯æœåŠ¡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘å‘ä¸Šç½‘ç”¨æˆ·æä¾›ä¿¡æ¯çš„æœåŠ¡æ´»åŠ¨ã€‚ å› æ­¤ï¼Œä½¿ç”¨ä¸­å›½å¤§é™†å¢ƒå†…çš„æœåŠ¡å™¨æä¾›webæœåŠ¡å¿…é¡»è¿›è¡ŒICPå¤‡æ¡ˆï¼Œåƒgithub pageæœåŠ¡å™¨åœ¨å›½å¤–ï¼Œåˆ™ä¸éœ€è¦è¿›è¡ŒICPå¤‡æ¡ˆã€‚å¦‚æœç”¨æˆ·çš„ç½‘ç«™æœåŠ¡å™¨åœ¨ä¸­å›½å¤§é™†ï¼Œå»ºè®®ï¼ˆéå¿…é¡»ï¼‰é€‰æ‹©å›½å†…çš„åŸŸåæ³¨å†Œå•†ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼Œä»–ä»¬æœ‰è¾…åŠ©ICPå¤‡æ¡ˆçš„æµç¨‹ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå¤‡æ¡ˆã€‚å½“ç„¶ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€‰æ‹©å›½å¤–åŸŸåæ³¨å†Œå•†ï¼Œåªæ˜¯ICPå¤‡æ¡ˆä¼šéº»çƒ¦ä¸€ç‚¹ã€‚ é€šå¸¸ï¼Œæ— éœ€æ‹…å¿ƒå®åè®¤è¯çš„èº«ä»½ä¿¡æ¯è¢«æ³„éœ²ã€‚æ ¹æ® ICANN ã€Šé€šç”¨é¡¶çº§åŸŸåæ³¨å†Œæ•°æ®ä¸´æ—¶æ”¿ç­–ç»†åˆ™ï¼ˆTemporary Specification for gTLD Registration Dataï¼‰ã€‹å’Œæ¬§ç›Ÿã€Šé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹ã€‹åˆè§„è¦æ±‚ï¼ŒåŸŸåæ³¨å†Œå•†ä¿è¯whoisæŸ¥è¯¢ç»“æœä¸­åŸŸåç®¡ç†äººå‘˜çš„ç›¸å…³ä¸ªäººæ•°æ®ï¼ŒåŒ…æ‹¬å§“åã€é‚®ç®±ã€ç”µè¯ã€è¡—é“åœ°å€ç­‰ã€‚ ä½†å›½å†…æŸäº›æ³¨å†Œå•†å¹¶ä¸èƒ½å®Œå…¨åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘åœ¨è…¾è®¯äº‘æ³¨å†Œçš„.funåŸŸåé€šè¿‡whoisæŸ¥è¯¢åˆ°çš„Registrant Organizationå­—æ®µåŒ…å«æ³¨å†Œäººçš„è‹±æ–‡åï¼ˆé»˜è®¤ä¸ºå§“åæ‹¼éŸ³ï¼‰ã€‚v2exçš„ç½‘å‹å¯¹è¿™ä¸ªæƒ…å†µä¹Ÿæœ‰è®¨è®ºï¼Œè…¾è®¯äº‘å¯¹æ­¤ç­”å¤ï¼š é€šè¿‡è…¾è®¯äº‘æ³¨å†Œçš„åŸŸåï¼Œé™¤ .com / .net ç­‰ Verisign åŸŸåçš„ WHOIS ä¿¡æ¯ç”±è…¾è®¯äº‘ç›´æ¥æŒ‰è°ƒæ•´åçš„è§„åˆ™æä¾›å¤–ï¼Œå…¶ä»–è…¾è®¯äº‘åŸŸåçš„ WHOIS ä¿¡æ¯å‡ç”±ç›¸åº”çš„æ³¨å†Œå±€æä¾›ï¼Œå¹¶ç”±å„æ³¨å†Œå•†è‡ªè¡Œå†³å®šåœ¨å…¶ WHOIS å¹³å°çš„æ˜¾ç¤ºä¿¡æ¯å†…å®¹ã€‚ç”±äºå„æ³¨å†Œå±€ã€æ³¨å†Œå•†å¯¹äº GDPR å’Œ WHOIS æ˜¾ç¤ºä¿¡æ¯è°ƒæ•´çš„è½å®æ–¹æ¡ˆä¸è¿›åº¦æš‚ä¸ç»Ÿä¸€ï¼Œå› æ­¤ç›¸å…³åŸŸååœ¨ç¬¬ä¸‰æ–¹ WHOIS å¹³å°å¦‚ä½•æ˜¾ç¤ºï¼Œå–å†³äºå¯¹åº”çš„æ³¨å†Œå±€å’Œæ³¨å†Œå•†æ”¿ç­–ã€‚é€šè¿‡è…¾è®¯äº‘æ³¨å†Œçš„ .com / .net ç­‰ Verisign åŸŸåï¼Œç›®å‰é€šè¿‡ç¬¬ä¸‰æ–¹ WHOIS å¹³å°æ‰€èƒ½æŸ¥è¯¢åˆ°çš„è…¾è®¯äº‘åŸŸåæ³¨å†Œè”ç³»äººä¿¡æ¯å‡ä¸ºç¼“å­˜ä¿¡æ¯ï¼Œæœ€æ–°æŸ¥è¯¢ç»“æœä¸­ï¼Œå·²ä¸å†åŒ…æ‹¬è…¾è®¯äº‘åŸŸåçš„æ³¨å†Œè”ç³»äººä¿¡æ¯ã€‚[2] å»ºè®®åœ¨å›½å†…æ³¨å†ŒåŸŸåçš„æœ‹å‹ï¼Œå¡«å†™è‹±æ–‡åæ—¶ç‰¹æ„åšå¥½è§„é¿ã€‚å¦‚æœè¦æ£€æŸ¥ä½ çš„æ³¨å†Œä¿¡æ¯æ˜¯å¦èƒ½è¢«whoisæŸ¥è¯¢åˆ°ï¼Œå»ºè®®é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªç½‘ç«™è¿›è¡ŒæŸ¥è¯¢ï¼š https://whois.chinaz.com/ https://whois.gandi.net/ å›½å†…åŸŸåæ³¨å†Œå•†çš„whoisæŸ¥è¯¢æœåŠ¡ç¡®å®éšè—äº†ä¸ªäººä¿¡æ¯ã€‚å³ä¾¿éšè—äº†è‹±æ–‡åï¼Œä»ç„¶ä¼šæ³„éœ²æ³¨å†Œäººæ‰€åœ¨çš„çœä»½ã€‚ æ³¨å†Œå•†æœåŠ¡é€‰æ‹©åŸŸåæ³¨å†Œå•†ä¹Ÿéœ€è¦è€ƒè™‘æ³¨å†Œå•†æœåŠ¡ï¼Œè¿™é‡Œç®€å•ç½—åˆ—ä¸‹ï¼š åŸŸåè½¬å…¥/è½¬å‡ºé™åˆ¶ï¼šæœ‰çš„åŸŸåæ³¨å†ŒæœåŠ¡å•†å¯¹äºåŸŸåè½¬å…¥/è½¬å‡ºæœ‰è¾ƒä¸ºä¸¥æ ¼çš„é™åˆ¶ï¼Œå½±å“ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥äº‹å…ˆè¿›è¡Œè°ƒç ” æ”¯ä»˜æ–¹å¼ï¼šè‹¥é€‰æ‹©å›½å¤–åŸŸåæœåŠ¡å•†ï¼Œåˆ™éœ€è¦è€ƒè™‘æ”¯ä»˜çš„ä¾¿æ·æ€§ï¼ˆæ˜¯å¦æ”¯æŒæ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜ï¼‰ï¼Œå›½å¤–å‡ å®¶æ¯”è¾ƒå¤§çš„åŸŸåæ³¨å†Œå•†å¦‚namesiloã€name.comã€GoDaddyéƒ½æ”¯æŒæ”¯ä»˜å® SSLè¯ä¹¦ç”³è¯·ï¼šå¦‚æœç½‘ç«™éœ€è¦æ”¯æŒhttpsï¼ŒåŸŸåæœåŠ¡å•†èƒ½å…è´¹æ”¯æŒSSLè¯ä¹¦ç”³è¯·åˆ™ä¼šç›¸å¯¹ä¾¿æ·ï¼Œgithub pageæœ¬èº«ä¼šæä¾›httpsæœåŠ¡ï¼Œå¯å¿½ç•¥è¿™ç‚¹ å½“ç„¶ï¼Œæ ¹æ®è‡ªèº«çš„å®é™…éœ€æ±‚ï¼Œå¯¹æ³¨å†Œå•†çš„æœåŠ¡è¦æ±‚ä¹Ÿå¤§ä¸ç›¸åŒï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµã€‚ github pageå…³è”åŸŸågithub pageæ”¯æŒè®¾ç½®çš„è‡ªå®šä¹‰åŸŸç±»å‹ï¼š è‡ªå®šä¹‰åŸŸç±»å‹ èŒƒä¾‹ wwwå­åŸŸ(subdomain) www.justhack.fun è‡ªå®šä¹‰å­åŸŸ blog.justhack.fun é¡¶ç‚¹åŸŸ(apex domain) justhack.com Githubå»ºè®®åŒæ—¶é…ç½®é¡¶ç‚¹åŸŸå’Œwwwå­åŸŸï¼š When using an apex domain, we recommend configuring your GitHub Pages site to host content at both the apex domain and that domainâ€™s www subdomain variant. apex domain vs www subdomainwwwå­åŸŸèƒ½è®©äººä¸€çœ¼çœ‹å‡ºåŸŸåæ˜¯ä¸€ä¸ªæµè§ˆå™¨å¯ä»¥æ‰“å¼€çš„URLã€‚ç›´æ¥é‡‡ç”¨é¡¶ç‚¹åŸŸçš„æ–¹å¼å¯ä»¥è®©åŸŸåæ›´åŠ ç®€æ´ï¼Œå¦‚githubã€twitteréƒ½é‡‡ç”¨é¡¶ç‚¹åŸŸã€‚Githubä¹Ÿæ”¯æŒgithub pageä»…è®¾ç½®é¡¶ç‚¹åŸŸ/wwwå­åŸŸ/è‡ªå®šä¹‰å­åŸŸã€‚ ä½¿ç”¨é¡¶ç‚¹åŸŸå­˜åœ¨â€cookieæ±¡æŸ“â€çš„é—®é¢˜ï¼šå³é¡¶ç‚¹åŸŸçš„cookieä½œç”¨èŒƒå›´åŒ…æ‹¬å…¶æ‰€æœ‰å­åŸŸã€‚å³è®¿é—®justhack.funäº§ç”Ÿçš„cookieï¼Œåœ¨è®¿é—®foo.justhack.funæˆ–è€…bar.justhack.funéƒ½ä¼šå¸¦ä¸Šã€‚å¯¹è®¿é—®çš„å®‰å…¨ã€æ€§èƒ½éƒ½æœ‰å½±å“ã€‚ HTTP Cookieï¼ˆä¹Ÿå« Web Cookie æˆ–æµè§ˆå™¨ Cookieï¼‰æ˜¯æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨æœ¬åœ°çš„ä¸€å°å—æ•°æ®ã€‚æµè§ˆå™¨ä¼šå­˜å‚¨ cookie å¹¶åœ¨ä¸‹æ¬¡å‘åŒä¸€æœåŠ¡å™¨å†å‘èµ·è¯·æ±‚æ—¶æºå¸¦å¹¶å‘é€åˆ°æœåŠ¡å™¨ä¸Šã€‚é€šå¸¸ï¼Œå®ƒç”¨äºå‘ŠçŸ¥æœåŠ¡ç«¯ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€æµè§ˆå™¨â€”â€”å¦‚ä¿æŒç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€‚Cookie ä½¿åŸºäºæ— çŠ¶æ€çš„ HTTP åè®®è®°å½•ç¨³å®šçš„çŠ¶æ€ä¿¡æ¯æˆä¸ºäº†å¯èƒ½ã€‚[3] cookieä¸»è¦ç”¨åœ¨ä¸‰ä¸ªæ–¹é¢[3]ï¼š ä¼šè¯çŠ¶æ€ç®¡ç†: å¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€æ¸¸æˆåˆ†æ•°æˆ–å…¶å®ƒéœ€è¦è®°å½•çš„ä¿¡æ¯ ä¸ªæ€§åŒ–è®¾ç½®: å¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜å’Œå…¶ä»–è®¾ç½® æµè§ˆå™¨è¡Œä¸ºè·Ÿè¸ª: å¦‚è·Ÿè¸ªåˆ†æç”¨æˆ·è¡Œä¸ºç­‰ æœåŠ¡å™¨æ”¶åˆ° HTTP è¯·æ±‚åï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨å“åº”æ ‡å¤´é‡Œé¢æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ª Set-Cookieé€‰é¡¹ã€‚æµè§ˆå™¨æ”¶åˆ°å“åº”åé€šå¸¸ä¼šä¿å­˜ä¸‹Cookieï¼Œå¹¶å°†å…¶æ”¾åœ¨ HTTP Cookie æ ‡å¤´å†…ï¼Œå‘åŒä¸€æœåŠ¡å™¨å‘å‡ºè¯·æ±‚æ—¶ä¸€èµ·å‘é€ã€‚httpå“åº”å¤´ä¸­çš„Set-Cookieæ ¼å¼å¦‚ä¸‹ï¼š 1Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt; ä¸‹å›¾æ˜¯ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è¯·æ±‚www.example.comä¼ è¾“cookieç¤ºä¾‹ï¼š æµè§ˆå™¨ä½œä¸ºç”¨æˆ·ä»£ç†å‘é€httpsè¯·æ±‚è®¿é—®www.example.com æœåŠ¡å™¨å‘ŠçŸ¥å®¢æˆ·ç«¯å­˜å‚¨ä¸€å¯¹cookieï¼šfoo_cookieã€bar_cookieã€‚ æ¥ç€è®¿é—®www.example.comåŸŸåä¸‹çš„sample_page.htmlé¡µé¢ä¼šå¸¦ä¸Šä¸¤ä¸ªcookieã€‚ å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ç¡®å®šè®¿é—®åŸŸåæ˜¯å¦å¸¦æœ‰cookieï¼š åœ¨æµè§ˆå™¨(ä»¥chrome)ä¸ºä¾‹ï¼ŒæŒ‰F12è¿›å…¥å¼€å‘è€…å·¥å…· -&gt; ç‚¹å‡»Application/Cookieså³å¯æŸ¥çœ‹ç›¸åº”åŸŸåçš„Cookieï¼Œå¯è§justhack.funå¹¶ä¸åŒ…å«ä»»ä½•cookie æ‰§è¡Œcurl -I https://justhack.funå‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä»…è¿”å›http(s)å¤´éƒ¨ä¿¡æ¯ï¼Œä½†ä¸è¿”å›é¡µé¢å†…å®¹ï¼Œæ£€æŸ¥å¤´éƒ¨ä¿¡æ¯ä¸­çš„set-cookieå­—æ®µï¼ŒåŒæ ·å‘ç°è®¿é—®justhack.funå¹¶ä¸åŒ…å«ä»»ä½•cookieï¼š123456789101112131415161718192021222324â¯ curl -I https://justhack.funHTTP/1.1 200 Connection establishedHTTP/2 200 server: GitHub.comcontent-type: text/html; charset=utf-8last-modified: Sat, 12 Nov 2022 16:57:25 GMTaccess-control-allow-origin: *etag: &quot;636fd075-207c0&quot;expires: Mon, 14 Nov 2022 05:24:54 GMTcache-control: max-age=600x-proxy-cache: MISSx-github-request-id: BA4C:4119:22EE90:2983D9:6371CECEaccept-ranges: bytesdate: Mon, 14 Nov 2022 05:14:55 GMTvia: 1.1 varnishage: 0x-served-by: cache-hkg17935-HKGx-cache: MISSx-cache-hits: 0x-timer: S1668402895.753872,VS0,VE260vary: Accept-Encodingx-fastly-request-id: a144f45239faaabca10c759cae386e23e310938bcontent-length: 133056 å› ä¸ºgithub pageæ˜¯é™æ€é¡µé¢ï¼Œä¸å¸¦ä»»ä½•cookieï¼Œæ‰€ä»¥github pageå»ºè®®åŒæ—¶è®¾ç½®apex domainå’Œwww subdomainçš„æ–¹å¼æ—¢èƒ½ä¾¿äºè®¿é—®ï¼ŒåŒæ—¶ä¹Ÿä¸å­˜åœ¨cookieæ³„éœ²çš„é£é™©ã€‚ é…ç½®apex domainå’Œwww subdomainå¦‚æœgithub pageé…ç½®äº†www.justhack.funä½œä¸ºåŸŸåï¼Œä¸”é…ç½®äº†æ­£ç¡®çš„wwwå­åŸŸå’ŒapexåŸŸçš„DNSè®°å½•ï¼Œåˆ™è®¿é—®justhack.funæ—¶ä¼šé‡å®šå‘åˆ°www.justhack.funã€‚è‡ªåŠ¨é‡å®šå‘ä»…é€‚ç”¨äºwwwå­åŸŸï¼Œå…¶ä»–å­åŸŸä¸é€‚ç”¨ã€‚ä¸‹é¢ä»‹ç»å¦‚ä½•ä¸ºgithub pageåŒæ—¶é…ç½®www subdomainå’Œapex domainï¼š åœ¨github pageä»£ç ä»“ä¸­é…ç½®åŸŸåï¼Œä»¥æˆ‘æœ¬äººçš„github pageä¸ºä¾‹ï¼šæ‰“å¼€github pageä»£ç ä»“ -&gt; ç‚¹å‡»settings -&gt; ç‚¹å‡»â€œCode and automation/Pagesâ€ï¼Œåœ¨â€Custom domainâ€å¤„è¾“å…¥åŸŸåï¼Œæ­¤å¤„è¾“å…¥www subdomainï¼šwww.justhack.fun,ä¹Ÿå¯ä»¥è¾“å…¥apex domain:justhack.funã€‚è¿™ä¸ªåŠ¨ä½œä¼šåœ¨github pageçš„å‘å¸ƒåˆ†æ”¯ç”Ÿæˆä¸€ä¸ªâ€Update CNAMEâ€çš„æäº¤ï¼Œç”±äºæˆ‘çš„github pageå‘å¸ƒåˆ†æ”¯æ˜¯gh-pagesåˆ†æ”¯ï¼Œåˆ™ä¼šåœ¨è¯¥åˆ†æ”¯ç”Ÿæäº¤ã€‚æˆ‘æ˜¯é€šè¿‡travis-ciè‡ªåŠ¨éƒ¨ç½²åšå®¢å†…å®¹ï¼Œæ¯å½“æ›´æ–°masteråˆ†æ”¯ï¼Œtravis-ciä¼šè¦†ç›–æ›´æ–°gh-pagesåˆ†æ”¯ï¼Œè¯¥åˆ†æ”¯åªæœ‰ä¸€æ¬¡æäº¤ã€‚éœ€è¦åœ¨masteråˆ†æ”¯çš„sourceç›®å½•ä¸‹æ‰‹åŠ¨æ·»åŠ CNAMEæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­ä»…åŒ…å«www.justhack.funã€‚å¦‚æœæ²¡æœ‰æ­¤æ­¥æ“ä½œï¼Œåç»­æ›´æ–°masteråˆ†æ”¯ï¼Œè®¿é—®åŸŸåä¼š404ã€‚ å¯¹apex domainå’Œwww subdomainæ·»åŠ domain record: apex domainï¼šæ·»åŠ Aè®°å½•æˆ–è€…AAAAè®°å½•ï¼Œapex domainä¸å»ºè®®æ·»åŠ CNAMEè®°å½•ï¼Œè™½ç„¶éƒ¨åˆ†DNS providerå¹¶æœªå¯¹æ­¤åšäº†ä¸¥æ ¼é™åˆ¶ï¼Œä½†è¯¥è¡Œä¸ºæåº¦ä¸æ¨èã€‚1234567891011A record:185.199.108.153185.199.109.153185.199.110.153185.199.111.153AAAA record:2606:50c0:8000::1532606:50c0:8001::1532606:50c0:8002::1532606:50c0:8003::153 www subdomain: æ·»åŠ CNAMEè®°å½•ï¼ŒæŒ‡å‘github pageçš„github.ioåŸŸåã€‚ å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œéœ€è¦å…ˆæ‰§è¡Œå®Œæ­¥éª¤1å†æ‰§è¡Œæ­¥éª¤2ã€‚å…ˆé…ç½®DNSè®°å½•ï¼Œå†é…ç½®github pageçš„åŸŸåä¼šå¯¼è‡´å…¶ä»–githubç”¨æˆ·çš„github pageä½¿ç”¨ä½ çš„ä¸€ä¸ªå­åŸŸå[4] Make sure you add your custom domain to your GitHub Pages site before configuring your custom domain with your DNS provider. Configuring your custom domain with your DNS provider without adding your custom domain to GitHub could result in someone else being able to host a site on one of your subdomains. æ·»åŠ DNSè®°å½•æˆåŠŸä¹‹åï¼Œæ­¥éª¤1ä¸­â€Custom domainâ€ä¸‹æ–¹çš„â€œDNS checkâ€ä¼šæˆåŠŸï¼Œç‚¹å‡»ä¸‹é¢çš„â€Enforce HTTPSâ€è®©github pageæ”¯æŒhttpsã€‚ åŸŸéªŒè¯(verify a custom domain)ï¼Œè¿›è¡ŒåŸŸéªŒè¯èƒ½å¤Ÿé˜»æ­¢å…¶ä»–githubç”¨æˆ·æ¥ç®¡æ‚¨çš„è‡ªå®šä¹‰åŸŸï¼Œç”¨å…¶å‘å¸ƒè‡ªå·±çš„github pageã€‚åˆ é™¤ä½ çš„github pageä»£ç ä»“ã€githubä»˜è´¹æœåŠ¡è¢«å–æ¶ˆç­‰åœºæ™¯ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚éªŒè¯åŸŸä¼šåŒ…å«å…¶ä»»ä½•ç›´æ¥å­åŸŸã€‚ ä¾‹å¦‚ï¼Œå¦‚æœå·²éªŒè¯ github.com è‡ªå®šä¹‰åŸŸï¼Œdocs.github.comã€support.github.com å’Œä»»ä½•å…¶ä»–ç›´æ¥å­åŸŸä¹Ÿå°†å—åˆ°ä¿æŠ¤ï¼Œä»¥é˜²æ­¢è¢«æ¥ç®¡[5]ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š ç‚¹å‡»githubä¸ªäººèµ„æ–™ç…§ç‰‡ -&gt; é€‰æ‹©settings ç‚¹å‡»â€Code, planning, and automation/Pagesâ€ -&gt; æ·»åŠ â€Add domainâ€å¡«å†™apex domain ä¼šç”Ÿæˆä¸€æ¡DNS TXTè®°å½•ï¼ŒæŒ‰ç…§æç¤ºï¼Œåœ¨DNS providerä¸­æ·»åŠ è¯¥DNS TXTè®°å½• å¯ä»¥é€€å‡ºä¹‹åï¼Œå†è¿›å…¥è¯¥é¡µé¢ï¼ŒæŸ¥çœ‹åŸŸåæ˜¯å¦å·²ç»éªŒè¯ ç»è¿‡ä¸Šè¿°æ­¥éª¤åï¼Œå·²ç»å®Œæˆäº†github pageè‡ªå®šä¹‰åŸŸåã€‚å½“å‰å¯ä»¥é€šè¿‡www subdomainå’Œapex domainè®¿é—®github pageã€‚æ­¥éª¤1é…ç½®github pageåŸŸåæ˜¯www subdomainï¼Œè¿™é‡Œè¡¨ç¤ºé€šè¿‡www subdomainè®¿é—®github pageèƒ½å¤Ÿç›´æ¥è·å–åˆ°é¡µé¢å†…å®¹ï¼›é€šè¿‡apex domainè®¿é—®github pageä¼šè¿›è¡Œ301é‡å®šå‘ã€‚ 12345678â¯ curl https://justhack.fun&lt;html&gt;&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;&lt;/body&gt;&lt;/html&gt; ä½¿ç”¨301è·³è½¬èƒ½å¤Ÿå¸®åŠ©SEOä¼˜åŒ–ï¼Œå› ä¸ºwww subdomainå’Œapex domainå®é™…ä¸Šè®¿é—®çš„æ˜¯åŒä¸€ç½‘ç«™èµ„æºï¼Œå¦‚æœä¸è¿›è¡Œapex domainåˆ°www subdomainçš„301è·³è½¬ï¼Œæœç´¢å¼•æ“ä¼šè®¤ä¸ºè¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„åŸŸåï¼Œå¯¼è‡´åŸŸåçš„æƒé‡åˆ†æ•£ï¼Œä¸åˆ©äºSEOæ’åã€‚å¯ä»¥å°†github pageçš„åŸŸåé…ç½®ä¸ºapex domainï¼Œåˆ™æ˜¯www subdomain 301è·³è½¬è‡³apex domainã€‚æˆ‘ä¸ªäººæ›´åŠ å€¾å‘å°†github pageåŸŸåé…ç½®ä¸ºwww subdomainï¼Œå› ä¸ºå…¶ä¼šäº§ç”Ÿä¸€æ¡CNAMEè®°å½•ï¼Œè¿™å’Œé…ç½®www subdomainçš„DNSè®°å½•ä¸€è‡´ã€‚","categories":[{"name":"blog","slug":"blog","permalink":"https://system-thoughts.github.io/categories/blog/"}],"tags":[{"name":"domain","slug":"domain","permalink":"https://system-thoughts.github.io/tags/domain/"},{"name":"github page","slug":"github-page","permalink":"https://system-thoughts.github.io/tags/github-page/"}]},{"title":"ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» -- ELFå‰–æ","slug":"ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» -- ELFå‰–æ","date":"2022-07-14T11:24:32.000Z","updated":"2023-01-18T05:32:06.168Z","comments":true,"path":"posts/7de7c201/","link":"","permalink":"https://system-thoughts.github.io/posts/7de7c201/","excerpt":"ç¼–è¯‘ç”Ÿæˆçš„ä¸­é—´ç›®æ ‡æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶éƒ½æ˜¯æŒ‰ç…§ç‰¹å®šçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼è¿›è¡Œç»„ç»‡ã€‚å„ä¸ªç³»ç»Ÿçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ä¸å¤ªä¸€æ ·ï¼Œå¦‚Unix a.outæ ¼å¼ã€Windowså¯ç§»æ¤å¯æ‰§è¡Œç¨‹åº(Portable Executable, PE)ã€MacOS-Xä½¿ç”¨Mach-Oæ ¼å¼ã€‚ç°ä»£Linux/Unixéƒ½æ˜¯ç”¨å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼(Eexcutable Linkable Format, ELF)ã€‚PEå’ŒELFæ ¼å¼éƒ½æ˜¯COFF(Common File Format)æ ¼å¼çš„å˜ç§ã€‚","text":"ç¼–è¯‘ç”Ÿæˆçš„ä¸­é—´ç›®æ ‡æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶éƒ½æ˜¯æŒ‰ç…§ç‰¹å®šçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼è¿›è¡Œç»„ç»‡ã€‚å„ä¸ªç³»ç»Ÿçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ä¸å¤ªä¸€æ ·ï¼Œå¦‚Unix a.outæ ¼å¼ã€Windowså¯ç§»æ¤å¯æ‰§è¡Œç¨‹åº(Portable Executable, PE)ã€MacOS-Xä½¿ç”¨Mach-Oæ ¼å¼ã€‚ç°ä»£Linux/Unixéƒ½æ˜¯ç”¨å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼(Eexcutable Linkable Format, ELF)ã€‚PEå’ŒELFæ ¼å¼éƒ½æ˜¯COFF(Common File Format)æ ¼å¼çš„å˜ç§ã€‚ Linuxä¸Šä¸ä»…ä¸­é—´ç›®æ ‡æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶é‡‡ç”¨ELFæ ¼å¼ã€‚é‡‡ç”¨ELFæ ¼å¼çš„æ–‡ä»¶ç±»å‹å¯åˆ†ä¸ºä¸‹è¡¨ä¸­çš„å››ç±»ï¼š ELFæ–‡ä»¶ç±»å‹ è¯´æ˜ ä¸¾ä¾‹ å¯é‡å®šä½æ–‡ä»¶(Relocatable File) ç¼–è¯‘äº§ç”Ÿçš„ä¸­é—´ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥è¢«ç”¨æ¥é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…å…±äº«ç›®æ ‡æ–‡ä»¶ï¼Œé™æ€é“¾æ¥åº“ä¹Ÿå±äºè¿™ä¸€ç±» Linuxçš„.oæ–‡ä»¶Windowsä¸­çš„.objæ–‡ä»¶ å¯æ‰§è¡Œæ–‡ä»¶(Executable File) é™æ€/åŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œç¨‹åº Linuxä¸­çš„å¯æ‰§è¡Œç¨‹åºæ— åç¼€Windowsä¸­çš„.exe å…±äº«ç›®æ ‡æ–‡ä»¶(Shared Object File) é“¾æ¥å™¨å¯ä»¥ä½¿ç”¨è¿™ç±»æ–‡ä»¶å’Œå…¶ä»–å¯é‡å®šä½æ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶é“¾æ¥ç”Ÿæˆæ–°çš„å…±äº«ç›®æ ‡æ–‡ä»¶ï¼›ä¸å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡ŒåŠ¨æ€é“¾æ¥ï¼Œä½œä¸ºè¿›ç¨‹æ˜ åƒçš„ä¸€éƒ¨åˆ† Linuxçš„.soWindowsçš„DLL æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(Core Dump File) ç¨‹åºæ„å¤–ç»ˆæ­¢æ—¶ï¼Œç³»ç»Ÿä¿ç•™è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å®¹ä»¥åŠç»ˆæ­¢æ—¶çš„ä¸€äº›å…¶ä»–ä¿¡æ¯åˆ°æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ Linuxä¸‹çš„core dump é€šè¿‡fileå‘½ä»¤æŸ¥çœ‹ç›¸åº”çš„æ–‡ä»¶æ ¼å¼ï¼Œä¸Šé¢çš„å‡ ç§æ–‡ä»¶åœ¨fileå‘½ä»¤ä¸­ä¼šæ˜¾ç¤ºå‡ºç›¸åº”ç±»å‹ï¼š 12345678# file hello.ohello.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped# file hellohello: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=5c4bc53a7f316d2e95cbb40b395ff72b2f1e87fb, not stripped# file /lib64/ld-2.28.so /lib64/ld-2.28.so: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, BuildID[sha1]=523b1c63a3f4b12da75660bf483d63560694d81f, not stripped# file core-test_c-11-0-0-98197-1658125608 core-test_c-11-0-0-98197-1658125608: ELF 64-bit LSB core file, x86-64, version 1 (SYSV), SVR4-style, from &#x27;./test_c&#x27;, real uid: 0, effective uid: 0, real gid: 0, effective gid: 0, execfn: &#x27;./test_c&#x27;, platform: &#x27;x86_64&#x27; ELFæ–‡ä»¶æ ¼å¼æœ‰ä¸¤ç§ä¸åŒçš„è§†è§’ï¼šå‚ä¸é“¾æ¥çš„Linking viewï¼›åŠ è½½ã€è¿è¡ŒELFæ–‡ä»¶çš„Execution viewã€‚ ELFæ–‡ä»¶å¤´éƒ¨æ˜¯ELF headerï¼Œä½œä¸ºroad mapæè¿°ELFæ–‡ä»¶ç»„ç»‡ã€‚é“¾æ¥è§†è§’ä¸‹ï¼ŒELFæ–‡ä»¶ä¸­çš„ä¿¡æ¯æŒ‰ç…§sectionæ¥ç»„ç»‡ï¼›æ‰§è¡Œè§†è§’ä¸‹ï¼ŒELFæ–‡ä»¶ä¸­çš„ä¿¡æ¯æŒ‰ç…§segmentæ¥ç»„ç»‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå°†sectionç¿»è¯‘æˆâ€œèŠ‚â€ï¼Œå°†segmentç¿»è¯‘æˆâ€œæ®µâ€ï¼Œä½†æ˜¯åœ¨å¤„ç†ELFæ–‡ä»¶è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å°†äºŒè€…éƒ½ç¿»è¯‘æˆâ€œæ®µâ€ï¼Œå¯ä»¥æ ¹æ®å®é™…çš„è§†è§’ä¸Šä¸‹æ–‡ï¼Œä¾¿èƒ½åŒºåˆ†å‡ºâ€œæ®µâ€æŒ‡çš„æ˜¯sectionè¿˜æ˜¯segmentã€‚ä¸è®ºsectionè¿˜æ˜¯segmentï¼Œéƒ½æ˜¯ELFå°†ç›¸åŒå±æ€§çš„æ•°æ®ç»„ç»‡åˆ°ä¸€èµ·çš„æ–¹å¼ã€‚ æˆ‘ä»¬ä»¥simpleElf.cç¼–è¯‘å‡ºçš„å¯é‡å®šä½æ–‡ä»¶simpleElf.oå¼€å¯ELFç»“æ„å‰–æä¹‹æ—…ã€‚ 1234567891011121314151617181920212223# cat simpleElf.c int printf(const char *format, ...);int global_init_var = 8;int global_uninit_var;void func(int i)&#123; printf(&quot;hello %d\\n&quot;, i);&#125;int main(void)&#123; static int static_init_var = 4; static int static_uninit_var; int a = 1; int b; func(static_init_var + static_uninit_var + a + b); return 0;&#125;# gcc -c simpleElf.c -o simpleElf.o ELF headerELF headerç»“æ„ä½“åŠç›¸å…³å‚æ•°å®šä¹‰åœ¨/usr/include/elf.hï¼Œç”±äºELFæ–‡ä»¶åœ¨32bitå’Œ64bitä¸‹éƒ½é€šç”¨ï¼Œå› æ­¤å­˜åœ¨32bitç‰ˆæœ¬å’Œ64bitç‰ˆæœ¬ï¼Œä¸¤ä¸ªç‰ˆæœ¬çš„å†…å®¹ä¸€è‡´ï¼Œåªæ˜¯æŸäº›æˆå‘˜å¤§å°ä¸ä¸€æ ·ã€‚elf.hä½¿ç”¨typedefå®šä¹‰äº†ä¸€å¥—è‡ªå·±çš„å˜é‡ä½“ç³»ï¼Œå¦‚è¡¨æ‰€ç¤ºï¼š è‡ªå®šä¹‰ç±»å‹ æè¿° åŸå§‹ç±»å‹ é•¿åº¦(å­—èŠ‚) Elf32_Half 32bitç‰ˆæœ¬çš„æ— ç¬¦å·çŸ­æ•´å½¢ uint16_t 2 Elf32_Word 32bitç‰ˆæœ¬æ— ç¬¦å·æ•´å½¢ uint32_t 4 Elf32_Sword 32bitç‰ˆæœ¬æœ‰ç¬¦å·æ•´å½¢ int32_t 4 Elf32_Xword 32bitç‰ˆæœ¬64bitæ— ç¬¦å·æ•´å½¢ uint64_t 8 Elf32_Sxword 32bitç‰ˆæœ¬64bitæœ‰ç¬¦å·æ•´å½¢ int64_t 8 Elf32_Addr 32bitç‰ˆæœ¬åœ°å€ uint32_t 4 Elf32_Off 32bitç‰ˆæœ¬åç§» uint32_t 4 Elf64_Half 64bitç‰ˆæœ¬çš„æ— ç¬¦å·çŸ­æ•´å½¢ uint16_t 2 Elf64_Word 64bitç‰ˆæœ¬æ— ç¬¦å·æ•´å½¢ uint32_t 4 Elf64_Sword 64bitç‰ˆæœ¬æœ‰ç¬¦å·æ•´å½¢ int32_t 4 Elf64_Xword 64bitç‰ˆæœ¬64bitæ— ç¬¦å·æ•´å½¢ uint64_t 8 Elf64_Sxword 64bitç‰ˆæœ¬64bitæœ‰ç¬¦å·æ•´å½¢ int64_t 8 Elf64_Addr 64bitç‰ˆæœ¬åœ°å€ uint64_t 8 Elf64_Off 64bitç‰ˆæœ¬åç§» uint64_t 8 æœ¬æ–‡ä»¥64bitç‰ˆæœ¬çš„ç›¸å…³æ•°æ®ç»“æ„è¿›è¡Œä»‹ç»ï¼Œç›¸åº”ELF headerçš„æ•°æ®ç»“æ„æ˜¯Elf64_Ehdrï¼š 12345678910111213141516171819#define EI_NIDENT (16)typedef struct&#123; unsigned char e_ident[EI_NIDENT]; /* Magic number and other info */ Elf64_Half e_type; /* Object file type */ Elf64_Half e_machine; /* Architecture */ Elf64_Word e_version; /* Object file version */ Elf64_Addr e_entry; /* Entry point virtual address */ Elf64_Off e_phoff; /* Program header table file offset */ Elf64_Off e_shoff; /* Section header table file offset */ Elf64_Word e_flags; /* Processor-specific flags */ Elf64_Half e_ehsize; /* ELF header size in bytes */ Elf64_Half e_phentsize; /* Program header table entry size */ Elf64_Half e_phnum; /* Program header table entry count */ Elf64_Half e_shentsize; /* Section header table entry size */ Elf64_Half e_shnum; /* Section header table entry count */ Elf64_Half e_shstrndx; /* Section header string table index */&#125; Elf64_Ehdr; ä½¿ç”¨readelf -hè¯»å–ELFæ–‡ä»¶çš„ELF headerä¿¡æ¯ï¼š 123456789101112131415161718192021# readelf -h simpleElf.oELF Header: Magic: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 Class: ELF64 Data: 2&#x27;s complement, little endian Version: 1 (current) OS/ABI: UNIX - System V ABI Version: 0 Type: REL (Relocatable file) Machine: Advanced Micro Devices X86-64 Version: 0x1 Entry point address: 0x0 Start of program headers: 0 (bytes into file) Start of section headers: 1072 (bytes into file) Flags: 0x0 Size of this header: 64 (bytes) Size of program headers: 0 (bytes) Number of program headers: 0 Size of section headers: 64 (bytes) Number of section headers: 13 Section header string table index: 12 ELFæ ¼å¼å¯ä»¥æ”¯æŒ32bit/64bitå¤„ç†å™¨ï¼Œä¹Ÿæ”¯æŒä¸åŒå­—èŠ‚åº(å¤§ç«¯/å°ç«¯)å¤„ç†å™¨ã€‚ELF headerå¼€å¤´çš„ELF Identification(e_ident)å­—æ®µæŒ‡å®šäº†åº•å±‚ç¡¬ä»¶ä¿¡æ¯ï¼šæœ€å¼€å§‹çš„4å­—èŠ‚æ˜¯ELFæ–‡ä»¶çš„æ ‡è¯†ç ï¼Œä¹Ÿå«åšmagic numberï¼Œåˆ†åˆ«æ˜¯0x7fã€0x45ã€0x4cã€0x46ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚å¯¹åº”çš„æ˜¯ASCIIå­—ç¬¦é›†ä¸­çš„DELæ§åˆ¶ç¬¦ï¼Œå…¶ä½™ä¸‰ä¸ªå­—èŠ‚åˆšå¥½æ˜¯ELFè¿™ä¸‰ä¸ªå­—æ¯çš„ASCIIç¼–ç ã€‚ å­—èŠ‚e_ident[EI_CLASS]è¡¨ç¤ºfile classï¼ŒåŒºåˆ†ELFæ–‡ä»¶æ˜¯64bitè¿˜æ˜¯32bitã€‚1è¡¨ç¤º32bitï¼Œ2è¡¨ç¤º64bitã€‚å­—èŠ‚e_ident[EI_DATA]è¡¨ç¤ºæ•°æ®ç¼–ç æ–¹å¼ï¼Œ1è¡¨ç¤ºè¡¥ç çš„å°ç«¯è¡¨ç¤ºï¼Œ2è¡¨ç¤ºè¡¥ç çš„å¤§ç«¯è¡¨ç¤ºã€‚å­—èŠ‚e_ident[EI_VERSION]è¡¨ç¤ºELFæ–‡ä»¶ä¸»ç‰ˆæœ¬ï¼Œå½“å‰ä¸º1ï¼Œå³EV_CURRENTï¼Œè‹¥ELFè§„èŒƒç»§ç»­æ¼”è¿›ï¼Œä¸æ’é™¤EV_CURRENTä¼šå–æ›´å¤§çš„å€¼ï¼Œè¯¥å­—èŠ‚å’Œåé¢çš„e_versionå­—æ®µä¸€è‡´ã€‚å­—èŠ‚e_ident[EI_VERSION]ã€e_ident[EI_VERSION]è¡¨ç¤ºOS/ABI ELFæ‰©å±•ï¼Œ0è¡¨ç¤ºæœªå®šä¹‰ï¼Œçœ‹æ¥é»˜è®¤éµå¾ªUnix System V ABIæ ‡å‡†ã€‚ æ¥ä¸‹æ¥çš„e_typeå­—æ®µåŒºåˆ†ELFæ–‡ä»¶ç±»å‹ï¼š e_machineå­—æ®µæŒ‡å®šäº†ELFæ–‡ä»¶çš„å¹³å°æ¶æ„å±æ€§ï¼Œè¯¥å­—æ®µçš„è¯¦ç»†å–å€¼èŒƒå›´å‚è€ƒ[1]ï¼ŒEM_X86_64è¡¨ç¤ºx86_64å¹³å°ã€EM_AARCH64è¡¨ç¤ºARM64å¹³å°ã€‚e_entryå­—æ®µæŒ‡å®šçš„æ˜¯ç³»ç»ŸåŠ è½½ELFæ–‡ä»¶åï¼Œç³»ç»Ÿè·³è½¬æ‰§è¡Œçš„ç¬¬ä¸€æ¡å‘½ä»¤ï¼Œå¯ä»¥ç†è§£ä¸ºç¨‹åºçš„å…¥å£ã€‚å¯é‡å®šä½æ–‡ä»¶ä¸ä¼šè¢«åŠ è½½æ‰§è¡Œï¼Œæ‰€ä»¥æ­¤å¤„ä¸º0ã€‚e_flagså­—æ®µæŒ‡å®šELFæ–‡ä»¶å¤„ç†å™¨ç›¸å…³çš„flagï¼Œå½“å‰æ²¡æœ‰flagè¢«å®šä¹‰ï¼Œæ­¤å¤„ä¸º0ã€‚e_ehsizeå­—æ®µä¿å­˜ELF headerçš„å¤§å°ï¼Œå¯è§simpleElf.oçš„ELF headerå¤§å°ä¸º64 byteã€‚e_shstrndxå­—æ®µè¡¨ç¤ºsection header string tableåœ¨section header tableä¸­çš„ç´¢å¼•ï¼Œsection header string tableæ˜¯æ®µåè¡¨ï¼š 12345678910111213# readelf -p .shstrtab simpleElf.oString dump of section &#x27;.shstrtab&#x27;: [ 1] .symtab [ 9] .strtab [ 11] .shstrtab [ 1b] .rela.text [ 26] .data [ 2c] .bss [ 31] .rodata [ 39] .comment [ 42] .note.GNU-stack [ 52] .rela.eh_frame ç¬¬ä¸€åˆ—è¡¨ç¤ºæ®µååœ¨section header string tableæ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œç¬¬äºŒåˆ—è¡¨ç¤ºç›¸åº”çš„æ®µåã€‚section header string tableæ•°ç»„ä¸­çš„å­—ç¬¦ä¸²ä»¥â€™\\0â€™åˆ†éš”ï¼Œç¬¬0ä½ä¹Ÿæ˜¯â€™\\0â€™ï¼š offset 0 1 2 3 4 5 6 7 8 9 +0 \\0 . s y m t a b \\0 . +10 s t r t a b \\0 . s h readelf -p .shstrtab simpleElf.oæ˜¾ç¤ºçš„.shstrtabæ®µçš„å†…å®¹ä¸­åŒ…å«10ä¸ªæ®µçš„åå­—ï¼Œå°‘äº†ä¸¤ä¸ªæ®µ.textå’Œ.eh_frameï¼Œæ˜¯ä¸æ˜¯å·¥å…·çš„é—®é¢˜å‘¢ï¼Ÿå¹¶ä¸æ˜¯ï¼Œè¿™ä¸¤ä¸ªæ®µçš„åç§°å¤ç”¨äº†â€.rela.textâ€ã€â€.rela.eh_frameâ€å­—ç¬¦ä¸²ï¼Œ.textå’Œ.eh_frameçš„section headerçš„sh_nameå­—æ®µæŒ‡å‘çš„æ˜¯ä¸Šè¿°æ®µåä¸­é—´çš„â€.â€çš„åç§»ğŸ™ƒ section header tableELF headerä¸­æœ‰ä¸‰ä¸ªå­—æ®µä¸section header tableç›¸å…³ï¼š e_shoffï¼šsection header tableåœ¨æ–‡ä»¶ä¸­çš„åç§»(å•ä½ï¼šbyte)ï¼Œå¦‚æœä¸å­˜åœ¨section header tableï¼Œåˆ™ä¸º0 e_shentsizeï¼šsection header tableè¡¨é¡¹å¤§å°(å•ä½ï¼šbyte) e_shnumï¼šsection header tableè¡¨é¡¹æ•°ç›®ï¼Œå¦‚æœä¸å­˜åœ¨section header tableï¼Œæ­¤é¡¹ä¸º0 æ˜¾è€Œæ˜“è§ï¼Œsection header tableæ˜¯æ•°ç»„ç±»å‹ï¼Œæ•°ç»„é¡¹(entry)æè¿°ç›¸åº”çš„sectionï¼Œsection header table entryç±»å‹çš„æ•°æ®ç»“æ„Elf64_Shdrï¼Œä¹Ÿç§°ä½œæ®µæè¿°ç¬¦ï¼š 12345678910111213typedef struct&#123; Elf64_Word sh_name; /* Section name (string tbl index) */ Elf64_Word sh_type; /* Section type */ Elf64_Xword sh_flags; /* Section flags */ Elf64_Addr sh_addr; /* Section virtual addr at execution */ Elf64_Off sh_offset; /* Section file offset */ Elf64_Xword sh_size; /* Section size in bytes */ Elf64_Word sh_link; /* Link to another section */ Elf64_Word sh_info; /* Additional section information */ Elf64_Xword sh_addralign; /* Section alignment */ Elf64_Xword sh_entsize; /* Entry size if section holds table */&#125; Elf64_Shdr; ä½¿ç”¨readelfæŸ¥çœ‹section header table: 12345678910111213141516171819202122232425262728293031323334353637# readelf -S simpleElf.oThere are 13 section headers, starting at offset 0x430:Section Headers: [Nr] Name Type Address Offset Size EntSize Flags Link Info Align [ 0] NULL 0000000000000000 00000000 0000000000000000 0000000000000000 0 0 0 [ 1] .text PROGBITS 0000000000000000 00000040 0000000000000057 0000000000000000 AX 0 0 1 [ 2] .rela.text RELA 0000000000000000 00000320 0000000000000078 0000000000000018 I 10 1 8 [ 3] .data PROGBITS 0000000000000000 00000098 0000000000000008 0000000000000000 WA 0 0 4 [ 4] .bss NOBITS 0000000000000000 000000a0 0000000000000004 0000000000000000 WA 0 0 4 [ 5] .rodata PROGBITS 0000000000000000 000000a0 000000000000000a 0000000000000000 A 0 0 1 [ 6] .comment PROGBITS 0000000000000000 000000aa 000000000000002d 0000000000000001 MS 0 0 1 [ 7] .note.GNU-stack PROGBITS 0000000000000000 000000d7 0000000000000000 0000000000000000 0 0 1 [ 8] .eh_frame PROGBITS 0000000000000000 000000d8 0000000000000058 0000000000000000 A 0 0 8 [ 9] .rela.eh_frame RELA 0000000000000000 00000398 0000000000000030 0000000000000018 I 10 8 8 [10] .symtab SYMTAB 0000000000000000 00000130 0000000000000180 0000000000000018 11 11 8 [11] .strtab STRTAB 0000000000000000 000002b0 000000000000006c 0000000000000000 0 0 1 [12] .shstrtab STRTAB 0000000000000000 000003c8 0000000000000061 0000000000000000 0 0 1Key to Flags: W (write), A (alloc), X (execute), M (merge), S (strings), I (info), L (link order), O (extra OS processing required), G (group), T (TLS), C (compressed), x (unknown), o (OS specific), E (exclude), l (large), p (processor specific) section header tableçš„ç¬¬ä¸€é¡¹æ˜¯æ— æ•ˆçš„æ®µæè¿°ç¬¦ï¼Œé»˜è®¤å€¼ä¸º0ã€‚ç¬¬ä¸€é¡¹çš„sh_sizeå­—æ®µåœ¨ä¸€ç§æƒ…å†µä¸‹ä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„ï¼šELFæ–‡ä»¶æ®µæ•°ç›®å¤§äºç­‰äºSHN_LORESERVE(0xff00)æ—¶ï¼ŒELF headerä¸­çš„e_shnumå­—æ®µå­˜å‚¨SHN_UNDEF(0)ï¼Œå®é™…çš„æ®µæ•°ç›®ä¿å­˜åœ¨æ— æ•ˆæ®µçš„sh_sizeå­—æ®µä¸­ã€‚ç”±äºe_shnumå­—æ®µæ˜¯Elf64_Halfç±»å‹ï¼Œsh_sizeå­—æ®µçš„ç±»å‹ä¸ºElf64_Xwordç±»å‹ï¼Œèƒ½å¤Ÿä¿å­˜çš„æ•°æ®èŒƒå›´å¤§çš„å¤šã€‚è¿™ç§å®é™…ç´¢å¼•è¶…è¿‡å½“å‰å­—æ®µç±»å‹çš„è¡¨ç¤ºèŒƒå›´æ—¶ï¼ŒELFè§„èŒƒä¼šåœ¨å½“å‰å­—æ®µå­˜æ”¾ä¿ç•™å€¼(reserved value)ï¼Œå¹¶ä¸è¡¨ç¤ºå®é™…å¤§å°ã€‚å¦‚ç¬¦å·è¡¨é¡¹çš„st_shndxæˆå‘˜ï¼ŒELF headerä¸­çš„e_shstrndxï¼šå½“.shstrtabå­—ç¬¦ä¸²è¡¨ä¸­çš„ç´¢å¼•å¤§äºç­‰äºSHN_LORESERVE(0xff00)ï¼Œe_shstrndxä¿å­˜SHN_XINDEX(0xffff)ï¼Œå®é™…çš„ç´¢å¼•ä¿å­˜åœ¨æ— æ•ˆæ®µçš„sh_linkå­—æ®µä¸­ã€‚ section header table entryå„ä¸ªå­—æ®µå«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤º: Name Description sh_name æ®µåï¼Œå­˜å‚¨åœ¨.shstrtabå­—ç¬¦ä¸²è¡¨ä¸­çš„åç§» sh_type æ®µç±»å‹ï¼Œè§Section typeç« èŠ‚ sh_flags æ®µçš„æ ‡å¿—ä½ï¼Œè§Section flagç« èŠ‚ sh_addr è‹¥è¯¥æ®µè¢«åŠ è½½ï¼Œå­—æ®µè¡¨ç¤ºæ®µåœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œå¦åˆ™ä¸º0ã€‚ç”±äºå¯å……å®šä½ç›®æ ‡æ–‡ä»¶ä¸ä¼šè¢«åŠ è½½ï¼Œæ‰€æœ‰æ®µçš„è¯¥å­—æ®µéƒ½ä¸º0 sh_offset è¯¥æ®µåœ¨ELFæ–‡ä»¶ä¸­çš„åç§»ï¼ŒSHT_NOBITSæ®µä¸å æ–‡ä»¶ç©ºé—´ï¼Œè¯¥å­—æ®µæ˜¯ä¸ªæ¦‚å¿µå€¼ï¼Œæ— æ„ä¹‰ sh_size æ®µçš„æ–‡ä»¶é•¿åº¦ï¼Œå³ä¾¿SHT_NOBITSæ®µä¸å æ–‡ä»¶ç©ºé—´ï¼Œä¹Ÿä¼šæœ‰ä¸ªé0å€¼ sh_link ä¿å­˜section header table entryç´¢å¼•ï¼Œå–å†³äºæ®µç±»å‹ï¼Œè§sh_link and sh_infoç« èŠ‚ sh_info å’Œsh_linkä¸€èµ·ä½¿ç”¨ï¼Œå–å†³äºæ®µç±»å‹ï¼Œè§sh_link and sh_infoç« èŠ‚ sh_addralign æ®µåœ°å€å¯¹é½(2^sh_addralign)ï¼Œå–å€¼0æˆ–1ï¼Œä¾‹å¦‚è¯¥æ®µæ— å¯¹é½è¦æ±‚ã€‚å‡è®¾è¯¥æ®µæœ€å¼€å§‹æ˜¯douleå˜é‡ï¼Œåˆ™è¯¥æ®µå¿…é¡»æŒ‰ç…§8å­—èŠ‚å¯¹é½ sh_entsize æœ‰äº›æ®µæ˜¯ç”±å›ºå®šå¤§å°çš„é¡¹ç»„æˆï¼Œæ¯”å¦‚ç¬¦å·è¡¨ã€‚sh_entsizeè¡¨ç¤ºæ¯é¡¹å¤§å°ï¼Œ0è¡¨ç¤ºè¯¥æ®µå¹¶ä¸åŒ…å«å›ºå®šå¤§å°çš„é¡¹ Section typeä¸‹è¡¨åˆ—ä¸¾äº†simpleElf.oçš„æ®µç±»å‹ï¼Œæ›´ä¸ºè¯¦ç»†çš„æè¿°å‚è€ƒ[2]ï¼š Name Value Description SHT_NULL 0 æ— æ•ˆæ®µ SHT_PROGBITS 1 æ®µä¿å­˜çš„ä¿¡æ¯ç”±ç¨‹åºå®šä¹‰ï¼Œå¦‚ä»£ç æ®µã€æ•°æ®æ®µ SHT_SYMTAB|SHT_DYNSYM 2 ç¬¦å·è¡¨ SHT_STRTAB 3 å­—ç¬¦ä¸²è¡¨ SHT_RELA 4 é‡å®šä½è¡¨ï¼Œè¯¥æ®µåŒ…å«é‡å®šä½ä¿¡æ¯ SHT_NOBITS 8 æ®µåœ¨ELFæ–‡ä»¶ä¸­ä¸å å­˜å‚¨ç©ºé—´ï¼Œå…¶ä»–æ–¹é¢ç±»ä¼¼äºSHT_PROGBITSæ®µï¼Œå¦‚.bssæ®µ SHT_SYMTABå’ŒSHT_DYNSYMåŒä½œä¸ºç¬¦å·è¡¨ç±»å‹ï¼ŒåŒºåˆ«å¦‚ä¸‹: These sections hold a symbol table. Currently, an object file may have only one section of each type, but this restriction may be relaxed in the future. Typically, SHT_SYMTAB provides symbols for link editing, though it may also be used for dynamic linking. As a complete symbol table, it may contain many symbols unnecessary for dynamic linking. Consequently, an object file may also contain a SHT_DYNSYM section, which holds a minimal set of dynamic linking symbols, to save space. ç®€è¦æ€»ç»“ä¸‹ï¼š SHT_SYMTABåŒ…å«çš„ç¬¦å·æ¯”è¾ƒå…¨ï¼ŒåŒ…å«é™æ€é“¾æ¥(link editing)å’ŒåŠ¨æ€é“¾æ¥(dynamic linking) SHT_DYNSYMåŒ…å«çš„ç¬¦å·ç”¨äºåŠ¨æ€é“¾æ¥(dynamic linking)ï¼Œç¬¦å·è¡¨è¾ƒå° Section flagä¸‹è¡¨åˆ—ä¸¾äº†simpleElf.oçš„æ®µçš„æ ‡å¿—ä½ï¼Œreadelf -Sè¾“å‡ºçš„æœ€åä¸€è¡Œæ˜¯å„flagçš„ç®€ç§°ã€‚æ›´ä¸ºè¯¦ç»†çš„æè¿°å‚è€ƒ[2]ï¼š Name Value Description SHF_WRITE 0x1 è¯¥æ®µåœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­å¯å†™ SHF_ALLOC 0x2 è¯¥æ®µä¼šåœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ†é…ç©ºé—´ï¼Œæœ‰äº›åŒ…å«æŒ‡ç¤ºæˆ–è€…æ§åˆ¶ä¿¡æ¯çš„æ®µæ— éœ€åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ†é…ç©ºé—´ã€‚ä»£ç æ®µã€æ•°æ®æ®µã€.bssæ®µä¼šåŒ…å«è¿™ä¸ªflag SHF_EXECINSTR 0x4 è¯¥æ®µåœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­å¯æ‰§è¡Œ SHF_MERGE 0x10 ä»…æœ‰å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶SHT_PROGBITSç±»å‹çš„sectionå¯ä»¥ä½¿ç”¨è¯¥flagï¼Œç”¨äºé™æ€é“¾æ¥æ—¶åˆå¹¶ç›¸åŒæ•°æ®[3] SHF_STRINGS 0x20 è¯¥æ®µåŒ…å«ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œç©ºå­—ç¬¦åªèƒ½ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸç¬¦ï¼Œè€Œä¸èƒ½å‡ºç°åœ¨ä»»ä½•å­—ç¬¦ä¸²çš„ä¸­é—´ä½ç½® SHF_INFO_LINK 0x40 è¯¥æ®µå¯¹åº”çš„section header table entryçš„sh_infoå­—æ®µä¿å­˜äº†section header table index The data in the section may be merged to eliminate duplication. Unless the SHF_STRINGS flag is also set, the data elements in the section are of a uniform size. The size of each element is specified in the section headerâ€™s sh_entsize field. If the SHF_STRINGS flag is also set, the data elements consist of null-terminated character strings. The size of each character is specified in the section headerâ€™s sh_entsize field. Each element in the section is compared against other elements in sections with the same name, type and flags. GNU ldå½“å‰ä»…æ”¯æŒSHF_MERGE|SHF_STRINGSéƒ½è®¾ç½®çš„æ®µçš„åˆå¹¶ã€‚ sh_link and sh_infosh_linkä¸sh_infoå­˜å‚¨çš„å†…å®¹å–å†³äºsectionç±»å‹ï¼š ç”±ä¸Šè¡¨å¯è§ï¼Œsh_linkå’Œsh_infoå­˜å‚¨çš„éƒ½æ˜¯section header indexï¼Œåªæ˜¯æ ¹æ®sectionç±»å‹ï¼Œå­˜å‚¨çš„æ˜¯ä¸åŒçš„sectionçš„ç´¢å¼•ã€‚å¯¹äºï¼Œä¸åœ¨ä¸Šè¡¨çš„section typeï¼Œå…¶sh_linkå’Œsh_infoå­—æ®µä¸ºSHN_UNDEF(0)ã€‚ ç¬¦å·é“¾æ¥è¿‡ç¨‹ä¸­ï¼Œç›®æ ‡æ–‡ä»¶ä¹‹é—´ç›¸äº’æ‹¼åˆå®é™…ä¸Šæ˜¯ç›®æ ‡æ–‡ä»¶ä¹‹é—´å¯¹åœ°å€çš„å¼•ç”¨ï¼Œå³å¯¹å‡½æ•°å’Œå˜é‡çš„å¼•ç”¨ã€‚æ¯ä¸ªå‡½æ•°æˆ–è€…å˜é‡éƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„åå­—ï¼Œæ‰èƒ½é¿å…é“¾æ¥è¿‡ç¨‹ä¸­ä¸åŒå˜é‡å’Œå‡½æ•°ä¹‹é—´çš„æ··æ·†ã€‚åœ¨é“¾æ¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å˜é‡å’Œå‡½æ•°ç»Ÿç§°ä¸ºç¬¦å·(Symbol)ï¼Œå‡½æ•°åæˆ–è€…å˜é‡åå°±æ˜¯ç¬¦å·å(Symbol Name)ã€‚ é“¾æ¥è¿‡ç¨‹å¾ˆå…³é”®çš„ä¸€éƒ¨åˆ†æ˜¯ç¬¦å·çš„ç®¡ç†ï¼Œæ¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ªç›¸åº”çš„ç¬¦å·è¡¨(symbol table)ï¼Œè¿™ä¸ªè¡¨ä¸­è®°å½•äº†ç›®æ ‡æ–‡ä»¶ç”¨åˆ°çš„æ‰€æœ‰ç¬¦å·ã€‚æ¯ä¸ªå®šä¹‰çš„ç¬¦å·æœ‰ä¸€ä¸ªå¯¹åº”çš„å€¼ï¼Œå«åšç¬¦å·å€¼(symbol value)ï¼Œå¯¹äºå˜é‡å’Œå‡½æ•°æ¥è¯´ï¼Œç¬¦å·å€¼å°±æ˜¯å®ƒä»¬çš„åœ°å€ã€‚ä½¿ç”¨readelf -sæŸ¥çœ‹ELFæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼š 1234567891011121314151617181920# readelf -s simpleElf.oSymbol table &#x27;.symtab&#x27; contains 16 entries: Num: Value Size Type Bind Vis Ndx Name 0: 0000000000000000 0 NOTYPE LOCAL DEFAULT UND 1: 0000000000000000 0 FILE LOCAL DEFAULT ABS simpleElf.c 2: 0000000000000000 0 SECTION LOCAL DEFAULT 1 3: 0000000000000000 0 SECTION LOCAL DEFAULT 3 4: 0000000000000000 0 SECTION LOCAL DEFAULT 4 5: 0000000000000000 0 SECTION LOCAL DEFAULT 5 6: 0000000000000004 4 OBJECT LOCAL DEFAULT 3 static_init_var.1965 7: 0000000000000000 4 OBJECT LOCAL DEFAULT 4 static_uninit_var.1966 8: 0000000000000000 0 SECTION LOCAL DEFAULT 7 9: 0000000000000000 0 SECTION LOCAL DEFAULT 8 10: 0000000000000000 0 SECTION LOCAL DEFAULT 6 11: 0000000000000000 4 OBJECT GLOBAL DEFAULT 3 global_init_var 12: 0000000000000004 4 OBJECT GLOBAL DEFAULT COM global_uninit_var 13: 0000000000000000 34 FUNC GLOBAL DEFAULT 1 func 14: 0000000000000000 0 NOTYPE GLOBAL DEFAULT UND printf 15: 0000000000000022 53 FUNC GLOBAL DEFAULT 1 main ç¬¦å·è¡¨é¡¹çš„æ•°æ®ç»“æ„Elf64_Symï¼š 123456789typedef struct&#123; Elf64_Word st_name; /* Symbol name (string tbl index) */ unsigned char st_info; /* Symbol type and binding */ unsigned char st_other; /* Symbol visibility */ Elf64_Section st_shndx; /* Section index */ Elf64_Addr st_value; /* Symbol value */ Elf64_Xword st_size; /* Symbol size */&#125; Elf64_Sym; ç¬¦å·è¡¨é¡¹çš„å„ä¸ªå­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š Name Description st_name ç¬¦å·ååœ¨å­—ç¬¦ä¸²è¡¨.strtabä¸­çš„ç´¢å¼• st_info ç¬¦å·ç±»å‹ä¸ç»‘å®šå±æ€§ st_other ç¬¦å·çš„å¯è§†æ€§(visibility)ï¼ŒCè¯­è¨€ç¼–è¯‘çš„é‡å®šä½æ–‡ä»¶/åŠ¨æ€åº“/å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯¥é¡¹éƒ½æ˜¯STV_DEFAULT st_shndx ç¬¦å·æ‰€åœ¨æ®µåœ¨section header tableçš„ç´¢å¼•ï¼Œå‚è€ƒç¬¦å·æ‰€åœ¨æ®µ st_value ç¬¦å·å¯¹åº”çš„å€¼ä¸ç¬¦å·æœ‰å…³ï¼Œå‚è€ƒç¬¦å·å€¼ st_size ç¬¦å·å¤§å°ï¼Œå¯¹äºåŒ…å«æ•°æ®çš„ç¬¦å·ï¼Œå¦‚æ•°æ®å¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡çš„å¤§å°ã€‚å¤§å°ä¸º0ï¼Œè¡¨ç¤ºç¬¦å·ä¸å­˜åœ¨å¤§å°æˆ–è€…å¤§å°æœªçŸ¥ å¯è§ï¼Œç¬¦å·è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç¬¦å·ï¼Œå³ä¸‹æ ‡ä¸º0çš„ç¬¦å·ï¼Œæ°¸è¿œæ˜¯ä¸€ä¸ªæœªå®šä¹‰çš„ç¬¦å·ã€‚ ç¬¦å·ç±»å‹ä¸ç»‘å®šå±æ€§æˆå‘˜ä½4ä½è¡¨ç¤ºç¬¦å·ç±»å‹(symbol type)ï¼Œç¬¦å·é«˜4ä½è¡¨ç¤ºç¬¦å·ç»‘å®šå±æ€§(symbol binding)ï¼Œç›¸åº”æå–/ç»„åˆçš„Cä»£ç ï¼š 123#define ELF64_ST_BIND(i) ((i)&gt;&gt;4)#define ELF64_ST_TYPE(i) ((i)&amp;0xf)#define ELF64_ST_INFO(b,t) (((b)&lt;&lt;4)+((t)&amp;0xf)) ç¬¦å·ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œå®Œæ•´çš„symbol typeè§[4] Name Value Description STT_NOTYPE 0 æœªçŸ¥ç±»å‹ç¬¦å· STT_OBJECT 1 ç¬¦å·å…³è”çš„æ˜¯æ•°æ®å¯¹è±¡ï¼Œå¦‚å˜é‡æˆ–è€…æ•°ç»„ç­‰ STT_FUNC 2 ç¬¦å·å…³è”çš„æ˜¯å‡½æ•°æˆ–è€…å…¶ä»–å¯æ‰§è¡Œä»£ç  STT_SECTION 3 ç¬¦å·å…³è”çš„æ˜¯æ®µï¼Œç»‘å®šå±æ€§å¿…é¡»æ˜¯STB_LOCALï¼Œç”¨äºé‡å®šä½åœºæ™¯ï¼Œèƒ½å¤Ÿé€šè¿‡æ­¤ç§å½¢å¼åˆ¶å®šç¬¦å·ï¼šâ€œä¿®æ”¹æ®µxxxåç§»yyyå¤„çš„å€¼â€[5] STT_FILE 4 ç¬¦å·å…³è”çš„æ˜¯å½“å‰ELFæ–‡ä»¶çš„æºæ–‡ä»¶åï¼Œè¯¥ç¬¦å·çš„ç»‘å®šå±æ€§å¿…é¡»æ˜¯STB_LOCALï¼Œå¹¶ä¸”å®ƒçš„st_shndxä¸€å®šæ˜¯SHN_ABS STT_COMMON 5 è¯¥ç¬¦å·æ ‡è®°ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å…¬å…±å— ç¬¦å·ç»‘å®šå±æ€§å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œå®Œæ•´çš„symbol bindingè§[4] Name Value Description STB_LOCAL 0 å±€éƒ¨ç¬¦å·ï¼Œä»…åœ¨å®šä¹‰ç¬¦å·çš„ç›®æ ‡æ–‡ä»¶ä¸­å¯è§ STB_GLOBAL 1 å…¨å±€ç¬¦å·ï¼Œæ‰€æœ‰ç›®æ ‡æ–‡ä»¶éƒ½å¯è§ STB_WEAK 2 å¼±ç¬¦å·ç±»ä¼¼äºå…¨å±€ç¬¦å·ï¼Œå½“æœ‰åŒåçš„å¼±ç¬¦å·å’Œå…¨å±€ç¬¦å·ï¼Œå…¨å±€ç¬¦å·çš„ä¼˜å…ˆçº§æ›´é«˜ ç¬¦å·æ‰€åœ¨æ®µå¦‚æœç¬¦å·åœ¨å½“å‰ELFæ–‡ä»¶ä¸­ï¼Œst_shndxå­˜å‚¨ç¬¦å·åœ¨section header tableä¸­çš„ç´¢å¼•ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œst_shndxçš„å–å€¼æœ‰äº›ç‰¹æ®Šï¼š SHN_ABS(0xfff1): ç®€å†™ä¸ºABSï¼Œè¡¨ç¤ºç¬¦å·åŒ…å«äº†ä¸€ä¸ªç»å¯¹å€¼ï¼Œä¸ä¼šå› ä¸ºé‡å®šä½æ”¹å˜ã€‚æºæ–‡ä»¶åç¬¦å·å°±æ˜¯è¯¥ç±»å‹ SHN_COMMON(0xfff2): ç®€å†™ä¸ºCOMï¼Œè¡¨ç¤ºç¬¦å·æ˜¯å°šæœªåˆ†é…çš„å…¬å…±å—(commom block)ï¼Œè¯¥ç¬¦å·å€¼ä¸­å­˜å‚¨çš„æ˜¯å¯¹é½çº¦æŸï¼Œé“¾æ¥å™¨å°†æŒ‰ç…§st_valueå¯¹é½åˆ†é…åœ°å€ï¼ŒSHN_COMMONç±»å‹çš„ç¬¦å·ä»…å‡ºç°åœ¨å¯é‡å®šä½æ–‡ä»¶ä¸­ SHN_UNDEF(0): ç®€å†™ä¸ºUND,è¯¥ç±»å‹çš„ç¬¦å·åœ¨æœ¬ELFæ–‡ä»¶ä¸­å¼•ç”¨ï¼Œå®šä¹‰åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­ SHN_XINDEX(0xffff)ï¼šè¡¨ç¤ºç´¢å¼•å€¼å¤ªå¤§ï¼Œå®é™…çš„section header tableç´¢å¼•å­˜å‚¨åœ¨SHT_SYMTAB_SHNDXæ®µä¸­ SHT_SYMTAB_SHNDXæ®µçš„ç»“æ„ï¼š The section is an array of Elf32_Word values. Each value corresponds one to one with a symbol table entry and appear in the same order as those entries. The values represent the section header indexes against which the symbol table entries are defined. Only if the corresponding symbol table entryâ€™s st_shndx field contains the escape value SHN_XINDEX will the matching Elf32_Word hold the actual section header index; otherwise, the entry must be SHN_UNDEF (0). ç¬¦å·å€¼ä¸åŒçš„ç¬¦å·çš„st_valueæœ‰ä¸åŒå«ä¹‰ï¼š å¯é‡å®šä½æ–‡ä»¶ä¸­ï¼Œç¬¦å·æ‰€åœ¨æ®µä¸ºSHN_ABSçš„ç¬¦å·ï¼Œst_valueä¸­ä¿å­˜çš„æ˜¯ç¬¦å·å¯¹é½è¦æ±‚ å¯é‡å®šä½æ–‡ä»¶ä¸­ï¼Œst_valueä¿å­˜å®šä¹‰ç¬¦å·çš„æ®µåç§»(section offset)ï¼Œç¬¦å·æ‰€åœ¨çš„æ®µç”±st_shndxç¡®å®š å¯æ‰§è¡Œæ–‡ä»¶ã€åŠ¨æ€åº“ä¸­ï¼Œst_valueä¿å­˜ç¬¦å·çš„è™šæ‹Ÿåœ°å€ ç¬¦å·æ€»ç»“ä¸Šè¿°å°èŠ‚ä»‹ç»äº†ELFæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œå¯¹simpleElf.oçš„ç¬¦å·æ€»ç»“å¦‚ä¸‹ï¼š æ–‡ä»¶å(FILE)ç±»å‹ç¬¦å·ï¼Œå±€éƒ¨ç»‘å®šå±æ€§ï¼ŒSHN_ABSè¡¨ç¤ºç¬¦å·åŒ…å«çš„æ˜¯ç»å¯¹å€¼ï¼Œå³è¯¥ç¬¦å·ä¸ä¼šè¢«é‡å®šä½ï¼Œå…¶ç¬¦å·å€¼ä¿å­˜å…¶å¯¹é½è¦æ±‚ï¼Œæ­¤å¤„ä¸º0ï¼Œæ— å¯¹é½è¦æ±‚ï¼›ç¬¦å·ä¸å­˜åœ¨å¤§å°ï¼Œæ•…ç¬¦å·å¤§å°ä¸º0ã€‚ æ®µç±»å‹(SECTION)ç¬¦å·ç”¨æ¥å¼•ç”¨æ®µæœ¬èº«ï¼Œå±€éƒ¨ç»‘å®šå±æ€§ï¼Œæ ¹æ®st_shndxæ’æŸ¥æ®µå¤´è¡¨ï¼Œä»….rela.textã€.rela.eh_frameã€.symtabã€.strtabã€.shstrtabæ®µæ— å“åº”çš„ç¬¦å·ï¼Œè¿™äº›æ®µæœ‰ä¸ªç‰¹ç‚¹ï¼šè¾…åŠ©é‡å®šä½ï¼Œæ®µå†…çš„ä¿¡æ¯å¹¶ä¸ä¼šè¢«é‡å®šä½ã€‚ç¬¦å·ä¸å­˜åœ¨å¤§å°ï¼Œæ•…ç¬¦å·å¤§å°ä¸º0ã€‚ æ•°æ®ç±»å‹(OBJECT)ç¬¦å·è¡¨ç¤ºç›®æ ‡æ–‡ä»¶ä¸­çš„é™æ€å˜é‡å’Œå…¨å±€å˜é‡ï¼Œç¬¦å·å¤§å°éƒ½æ˜¯intç±»å‹å¤§å°(4)ï¼Œé™æ€å˜é‡æ˜¯å±€éƒ¨ç»‘å®šå±æ€§ï¼Œå…¨å±€å˜é‡æ˜¯å…¨å±€ç»‘å®šå±æ€§ã€‚åˆå§‹åŒ–çš„é™æ€å˜é‡å’Œå…¨å±€å˜é‡ä¿å­˜åœ¨.dataæ®µï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¿å­˜åœ¨.bssæ®µï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¿å­˜åœ¨common blockã€‚å…¶ç¬¦å·å€¼è¡¨ç¤ºç¬¦å·çš„æ®µå†…åç§»ã€‚è¿™äº›ç¬¦å·åä¸å…¶å®šä¹‰åœ¨å‡½æ•°ä¸­çš„å˜é‡åå¹¶ä¸ç›¸åŒï¼Œç‰¹åˆ«æ˜¯é™æ€ç¬¦å·ï¼Œä¸ä»…æœ‰static_å‰ç¼€ï¼Œæ›´æœ‰.&lt;num&gt;åç¼€ï¼Œç”¨äºè§£å†³ç¬¦å·åå†²çªé—®é¢˜ï¼Œå³ç¨‹åºä¸­çš„ç¬¦å·åå¿…é¡»å”¯ä¸€ï¼Œè¿™ç§è¡Œä¸ºæˆä¸ºåå­—æ”¹ç¼–(name mangling)[6]ã€‚é™æ€å˜é‡çš„æ”¹ç¼–è§„åˆ™æ›´ä¸ºå¤æ‚ä¹Ÿæ˜¯å› ä¸ºé™æ€å˜é‡çš„å±€éƒ¨ç»‘å®šå±æ€§å…è®¸ä¸åŒç›®æ ‡æ¨¡å—å­˜åœ¨åŒåå˜é‡ï¼Œå› æ­¤é€šè¿‡æ›´ä¸ºå¤æ‚çš„æ”¹ç¼–è§„åˆ™ä¿è¯ç¬¦å·åçš„å”¯ä¸€ã€‚ å‡½æ•°ç±»å‹(FUNC)ç¬¦å·å¯¹åº”ç›®æ ‡æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸¤ä¸ªå‡½æ•°ï¼Œå®ƒä»¬éƒ½åœ¨.textæ®µï¼Œç›¸åº”çš„ç¬¦å·å€¼è¡¨ç¤ºæ®µå†…åç§»ï¼Œå³funcåœ¨æ®µé¦–ï¼Œmainåœ¨æ®µå†…åç§»0x22å­—èŠ‚å¤„ï¼Œå®ƒä»¬éƒ½æ˜¯å…¨å±€ç»‘å®šå±æ€§ï¼Œä¸¤ä¸ªå‡½æ•°çš„å¤§å°åˆ†åˆ«æ˜¯34(0x22)byteå’Œ53(0x35)byteï¼Œä¸‹é¢çš„objdumpå¯¹.textæ®µçš„åæ±‡ç¼–å¯ä»¥éªŒè¯ã€‚ æœªçŸ¥ç±»å‹ç¬¦å·(NOTYPE)printfï¼ŒSHN_UNDEFè¡¨ç¤ºå…¶ä¸æ˜¯åœ¨å½“å‰ç›®æ ‡æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå…¶ç»‘å®šå±æ€§ä¸ºå…¨å±€ï¼Œå¼•ç”¨ç¬¦å·çš„ç¬¦å·å€¼å’Œç¬¦å·å¤§å°å‡æœªå®šä¹‰ 1234567891011121314151617181920212223242526272829303132333435363738objdump -d -j .text simpleElf.osimpleElf.o: file format elf64-x86-64Disassembly of section .text:0000000000000000 &lt;func&gt;: 0: 55 push %rbp 1: 48 89 e5 mov %rsp,%rbp 4: 48 83 ec 10 sub $0x10,%rsp 8: 89 7d fc mov %edi,-0x4(%rbp) b: 8b 45 fc mov -0x4(%rbp),%eax e: 89 c6 mov %eax,%esi 10: bf 00 00 00 00 mov $0x0,%edi 15: b8 00 00 00 00 mov $0x0,%eax 1a: e8 00 00 00 00 callq 1f &lt;func+0x1f&gt; 1f: 90 nop 20: c9 leaveq 21: c3 retq 0000000000000022 &lt;main&gt;: 22: 55 push %rbp 23: 48 89 e5 mov %rsp,%rbp 26: 48 83 ec 10 sub $0x10,%rsp 2a: c7 45 fc 01 00 00 00 movl $0x1,-0x4(%rbp) 31: 8b 15 00 00 00 00 mov 0x0(%rip),%edx # 37 &lt;main+0x15&gt; 37: 8b 05 00 00 00 00 mov 0x0(%rip),%eax # 3d &lt;main+0x1b&gt; 3d: 01 c2 add %eax,%edx 3f: 8b 45 fc mov -0x4(%rbp),%eax 42: 01 c2 add %eax,%edx 44: 8b 45 f8 mov -0x8(%rbp),%eax 47: 01 d0 add %edx,%eax 49: 89 c7 mov %eax,%edi 4b: e8 00 00 00 00 callq 50 &lt;main+0x2e&gt; 50: b8 00 00 00 00 mov $0x0,%eax 55: c9 leaveq 56: c3 retq å¼ºç¬¦å·ä¸å¼±ç¬¦å·æˆ‘ä»¬ç»å¸¸ç¢°åˆ°ç¬¦å·é‡å¤å®šä¹‰ï¼Œå¤šä¸ªç›®æ ‡æ–‡ä»¶ä¸­åŒ…å«åŒåå…¨å±€ç¬¦å·çš„å®šä¹‰ï¼Œè¿™äº›ç›®æ ‡æ–‡ä»¶é“¾æ¥æ—¶ä¼šæŠ¥ç¬¦å·é‡å¤å®šä¹‰çš„é”™è¯¯ï¼š 12345678910111213141516171819202122# cat lib.cvoid foo(int *p)&#123; *p = 1;&#125;# cat main.cvoid foo(double *p)&#123; *p = 2.0;&#125;int main()&#123; return 0;&#125;# gcc -c lib.c # gcc -c main.c # gcc main.o lib.o -o mainlib.o: In function `foo&#x27;:lib.c:(.text+0x0): multiple definition of `foo&#x27;main.o:main.c:(.text+0x0): first defined herecollect2: error: ld returned 1 exit status å¯è§ï¼Œgccåœ¨å¤„ç†Cè¯­è¨€çš„å‡½æ•°ç¬¦å·æ—¶ï¼Œé“¾æ¥å™¨æ˜¯ä¸æ”¯æŒè¯†åˆ«ç¬¦å·ç±»å‹çš„ï¼Œå³ä¸¤ä¸ªfooå‡½æ•°çš„è¿”å›å€¼ä¸åŒã€‚ç„¶è€Œåœ¨C++ä¸­ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„å‡½æ•°ç­¾å(Function Signature)æ˜¯ä¸åŒçš„ï¼Œå‡½æ•°ç­¾ååŒ…å«äº†ä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ï¼ŒåŒ…å«å‡½æ•°åã€å®ƒçš„å‚æ•°ç±»å‹ï¼Œå…¶æ‰€åœ¨çš„ç±»å’Œå‘½åç©ºé—´ç­‰å…¶ä»–ä¿¡æ¯ã€‚C++çš„åå­—æ”¹ç¼–æœºåˆ¶ä¿è¯ä¸åŒçš„å‡½æ•°ç­¾åå¯¹åº”ä¸åŒçš„ç¬¦å·ï¼Œå› æ­¤è¿™ä¸¤ä¸ªfooå‡½æ•°åœ¨C++ä¸­æ˜¯ä¸¤ä¸ªä¸åŒçš„ç¬¦å·ï¼š 1234567# g++ -c main.c# g++ -c lib.c# g++ main.o lib.o -o main# readelf -s lib.o | grep foo 8: 0000000000000000 21 FUNC GLOBAL DEFAULT 1 _Z3fooPi# readelf -s main.o | grep foo 9: 0000000000000000 27 FUNC GLOBAL DEFAULT 1 _Z3fooPd å¯è§ï¼Œä½¿ç”¨C++ç¼–è¯‘å™¨ç¼–è¯‘ã€é“¾æ¥ä¸Šè¿°æ–‡ä»¶ï¼Œç”±äºfooå‡½æ•°çš„ç¬¦å·ä¸åŒï¼Œå¯ä»¥é“¾æ¥æˆåŠŸã€‚ è¨€å½’æ­£ä¼ ï¼Œä¸Šé¢çš„é“¾æ¥æŠ¥é”™ç”±äºå®šä¹‰äº†ä¸¤ä¸ªåŒåçš„ç¬¦å·ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªç¬¦å·éƒ½æ˜¯å¼ºç¬¦å·(strong symbol)ï¼Œä¸ä¹‹ç›¸åº”çš„ä¹Ÿæœ‰å¼±ç¬¦å·(weak symbol)ã€‚å¼±ç¬¦å·æ˜¯åœ¨é“¾æ¥ELFç›®æ ‡æ–‡ä»¶è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ç‰¹æ®Šæ³¨é‡Š(specially annotated)ç¬¦å·ï¼Œé»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯å¼ºç¬¦å·ã€‚é“¾æ¥æœŸé—´ï¼Œå¼ºç¬¦å·å¯ä»¥è¦†ç›–åŒåå¼±ç¬¦å·ï¼Œæ¯”å¦‚åº“ä¸­å®šä¹‰çš„å¼±ç¬¦å·å¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„å¼ºç¬¦å·æ‰€è¦†ç›–ï¼Œä»è€Œä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬çš„åº“å‡½æ•°[7]ã€‚å¼±ç¬¦å·å¹¶ä¸åœ¨C/C++è§„èŒƒä¸­ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºgccæ‰©å±•çš„å¼±ç¬¦å·ã€‚é“¾æ¥è¿‡ç¨‹ä¸­ä¼šæŒ‰ç…§ä¸‹é¢çš„è§„åˆ™å¤„ç†åŒåå¼º/å¼±ç¬¦å·ï¼š ä¸å…è®¸å¼ºç¬¦å·è¢«å¤šæ¬¡å®šä¹‰ï¼Œå¦åˆ™é“¾æ¥å™¨æŠ¥å‘Šé‡å¤å®šä¹‰é”™è¯¯ ä¸åŒç›®æ ‡æ–‡ä»¶ä¸­å®šä¹‰åŒåçš„å¼ºç¬¦å·ã€å¼±ç¬¦å·ï¼Œé“¾æ¥å™¨é€‰æ‹©å¼ºç¬¦å· CSAPPã€ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹å°†æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ç§°ä¸ºå¼±ç¬¦å·ï¼Œæˆ‘è®¤ä¸ºè¿™ç§è¯´æ³•æ˜¯ä¸ä¸¥è°¨çš„ã€‚å‰é¢çš„global_uninit_varå˜é‡æ˜¯å…¨å±€ç»‘å®šå±æ€§çš„ç¬¦å·ï¼Œè¯¥ç¬¦å·å±äºcommon blockã€‚æ›´ä¸ºä¸¥æ ¼çš„åŒºåˆ†ï¼Œglobal_uninit_varè¢«ç§°ä¸ºâ€common symbolâ€è€Œéweak symbol[8]ã€‚æˆ‘ä¹Ÿæ›´åŠ å€¾å‘å°†ç»‘å®šå±æ€§ä¸ºglobalçš„ç¬¦å·ç§°ä¸ºå¼ºç¬¦å·ï¼Œå°†ç»‘å®šå±æ€§ä¸ºweakçš„ç¬¦å·ç§°ä¸ºå¼±ç¬¦å·ï¼Œè‹¥å°†common symbolä¹Ÿç§°ä¸ºå¼±ç¬¦å·ï¼Œç¬¦å·çš„ç»‘å®šå±æ€§çš„æ„ä¹‰å°±ä¼šæ¯”è¾ƒæ¨¡ç³Šã€‚ gccä¸­å®šä¹‰å¼±ç¬¦å·æœ‰ä¸¤ç§æ–¹å¼ï¼š#pragmaé¢„å¤„ç†å’Œgccæ‰©å±•weakå±æ€§__attribute__((weak))ã€‚ç®€è¦ä»‹ç»çº¿ä¸‹#pragmaé¢„å¤„ç†ï¼š 1234// function declaration#pragma weak power2int power2(int x); æˆ‘ä»¬ä¸»è¦å…³æ³¨gccæ‰©å±•weakå±æ€§å®šä¹‰å¼±ç¬¦å·çš„æ–¹å¼ï¼š ä»¥å†…æ ¸çš„arch_report_meminfoå‡½æ•°ä¸ºä¾‹ï¼Œåœ¨æ¶æ„æ— å…³çš„æ–‡ä»¶fs/proc/meminfo.cä¸­å®šä¹‰äº†arch_report_meminfoçš„å¼±ç¬¦å·ï¼Œæ˜¯ç©ºå‡½æ•°ã€‚åœ¨å…·ä½“æ¶æ„å¦‚powerpcã€x86ä¸­å®é™…å®ç°äº†arch_report_meminfoå‡½æ•°ã€‚è¿™äº›æ¶æ„ç›¸å…³çš„arch_report_meminfoæ˜¯å¼ºç¬¦å·ï¼Œä»è€Œå®Œæˆäº†ç‰¹å®šæ¶æ„å‡½æ•°çš„å®ç°ï¼Œä¹Ÿèƒ½ä¿è¯æ— å…³æ¶æ„é“¾æ¥arch_report_meminfoæ—¶ä¸å‡ºé”™ï¼ˆç©ºå‡½æ•°ï¼‰ã€‚ 123456789101112131415161718192021fs/proc/meminfo.c:void __attribute__((weak)) arch_report_meminfo(struct seq_file *m) &#123;&#125;arch/x86/mm/pat/set_memory.c:void arch_report_meminfo(struct seq_file *m)&#123; seq_printf(m, &quot;DirectMap4k: %8lu kB\\n&quot;, direct_pages_count[PG_LEVEL_4K] &lt;&lt; 2);#if defined(CONFIG_X86_64) || defined(CONFIG_X86_PAE) seq_printf(m, &quot;DirectMap2M: %8lu kB\\n&quot;, direct_pages_count[PG_LEVEL_2M] &lt;&lt; 11);#else seq_printf(m, &quot;DirectMap4M: %8lu kB\\n&quot;, direct_pages_count[PG_LEVEL_2M] &lt;&lt; 12);#endif if (direct_gbpages) seq_printf(m, &quot;DirectMap1G: %8lu kB\\n&quot;, direct_pages_count[PG_LEVEL_1G] &lt;&lt; 20);&#125; ä»¥glibcä¸­çš„strdupåº“å‡½æ•°çš„å®ç°ä¸ºä¾‹ï¼Œä¹Ÿå®šä¹‰äº†strdupçš„å¼±ç¬¦å·ï¼Œå…è®¸ç”¨æˆ·å®ç°åŒåå¼ºç¬¦å·ï¼Œè¦†ç›–åº“å‡½æ•°çš„å¼±ç¬¦å·ï¼š 123456789101112131415161718192021string/strdup.c:char *__strdup (const char *s) &#123; size_t len = strlen (s) + 1; void *new = malloc (len); if (new == NULL) return NULL; return (char *) memcpy (new, s, len);&#125;libc_hidden_def (__strdup)weak_alias (__strdup, strdup)include/libc-symbols.h:/* Define ALIASNAME as a weak alias for NAME. If weak aliases are not available, this defines a strong alias. */# define weak_alias(name, aliasname) _weak_alias (name, aliasname)# define _weak_alias(name, aliasname) \\ extern __typeof (name) aliasname __attribute__ ((weak, alias (#name))); è¿™ä¸ªä¾‹å­ä¸»è¦ä»‹ç»weak attributeç»“åˆweak attributeçš„æƒ…å†µã€‚å…ˆçœ‹alias attributeæ ¼å¼: 123456789101112131415161718192021222324252627# cat alias.cint a[8] = &#123;0&#125;;extern __attribute__((alias (&quot;a&quot;))) int b[8];void bar(int *p)&#123; *p = 1;&#125;extern __attribute__((alias (&quot;bar&quot;))) void foo(int *p);# gcc -c alias.c# readelf -s alias.oSymbol table &#x27;.symtab&#x27; contains 12 entries: Num: Value Size Type Bind Vis Ndx Name 0: 0000000000000000 0 NOTYPE LOCAL DEFAULT UND 1: 0000000000000000 0 FILE LOCAL DEFAULT ABS alias.c 2: 0000000000000000 0 SECTION LOCAL DEFAULT 1 3: 0000000000000000 0 SECTION LOCAL DEFAULT 2 4: 0000000000000000 0 SECTION LOCAL DEFAULT 3 5: 0000000000000000 0 SECTION LOCAL DEFAULT 5 6: 0000000000000000 0 SECTION LOCAL DEFAULT 6 7: 0000000000000000 0 SECTION LOCAL DEFAULT 4 8: 0000000000000000 32 OBJECT GLOBAL DEFAULT 3 a 9: 0000000000000000 32 OBJECT GLOBAL DEFAULT 3 b 10: 0000000000000000 21 FUNC GLOBAL DEFAULT 1 bar 11: 0000000000000000 21 FUNC GLOBAL DEFAULT 1 foo the attribute alias tells the compiler that the declared symbol provides an alias, or alternate identity, for the symbol being named. The named symbol is known as the alias target. The target must be defined in the same translation unit as the alias; the alias itself can only be declared, it cannot be defined. The alias declaration is a definition even when also declared extern. [9] ç®€è¦æ€»ç»“ä¸‹aliaså±æ€§ï¼š aliaså±æ€§ç”¨æ¥ç»™å·²ç»å®šä¹‰çš„ç¬¦å·æä¾›ä¸€ä¸ªåˆ«åç¬¦å·(alias target)ï¼Œå°†å·²ç»å®šä¹‰çš„ç¬¦å·ç§°ä¸ºtarget targetå’Œalias targetå¿…é¡»åœ¨åŒä¸€ç¼–è¯‘å•å…ƒï¼Œä¸”targetå¿…é¡»åœ¨è¯¥ç¼–è¯‘å•å…ƒå®šä¹‰ã€‚æ³¨æ„ä¸Šé¢ä¾‹å­ä¸­çš„æ•°ç»„aæ˜¾ç¤ºåˆå§‹åŒ–ï¼Œå¦‚æœæ˜¾ç¤ºä¸åˆå§‹åŒ–ï¼Œç¼–è¯‘æŠ¥é”™ï¼šError: b&#39; can&#39;t be equated to common symbol a&#39;ï¼Œæˆ‘çŒœæƒ³æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡aå±äºcommon blockï¼Œç¼–è¯‘å™¨è®¤ä¸ºè¿™ç§æƒ…å†µå±äºâ€œæœªå®šä¹‰â€ alias targetåªèƒ½ä»¥å£°æ˜çš„æ–¹å¼å‡ºç°ï¼Œè€Œä¸èƒ½è¢«å®šä¹‰ï¼Œå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„externçš„å£°æ˜æ–¹å¼ã€‚ç”±äºalias targetæ˜¯targetçš„åˆ«åï¼Œä¸¤è€…å®é™…æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤alias targetå·²ç»å®šä¹‰ ç”±readelfè¾“å‡ºç»“æœå¯çŸ¥ï¼Œtargetå’Œalias targetéƒ½æ˜¯ç¬¦å·ï¼Œé™¤äº†ç¬¦å·åä¸åŒï¼Œå…¶ä»–ç¬¦å·å±æ€§éƒ½ç›¸åŒ weak_alias (__strdup, strdup)é¢„å¤„ç†ä¹‹åæ˜¯extern __typeof(__strdup) strdup __attribute__ ((weak, alias (__strdup)));ï¼Œè¿™æ¡è¯­å¥å®šä¹‰äº†åˆ«åç¬¦å·strdupï¼Œå…¶targetæ˜¯strdupç¬¦å·ï¼Œè€Œä¸”åˆ«åç¬¦å·strdupæ˜¯å¼±ç¬¦å·ã€‚ å½“å‰ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„é“¾æ¥è¿‡ç¨‹åœ¨æŸ¥æ‰¾ç¬¦å·å¼•ç”¨ï¼Œæœªæ‰¾åˆ°ç¬¦å·å®šä¹‰æ—¶ä¼šæŠ¥é”™ï¼Œè¿™ç§è¢«ç§°ä¸ºå¼ºå¼•ç”¨(strong reference)ã€‚ç›¸å¯¹åº”ä¹Ÿå­˜åœ¨å¼±å¼•ç”¨(weak reference)ï¼Œé“¾æ¥å¤„ç†å¼±å¼•ç”¨å’Œå¼ºå¼•ç”¨çš„è¿‡ç¨‹å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯å¯¹äºæœªå®šä¹‰çš„ç¬¦å·ï¼Œé“¾æ¥å™¨å¤„ç†å¼±å¼•ç”¨ä¸ä¼šæŠ¥é”™ï¼Œå°†æœªå®šä¹‰çš„ç¬¦å·å€¼é»˜è®¤ä¸º0ã€‚gccçš„æ‰©å±•å¼±å¼•ç”¨å±æ€§æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹å¼ï¼š static __attribute__ ((weakref (&quot;target&quot;))) alias_targetï¼Œå£°æ˜çš„å¼±å¼•ç”¨ç¬¦å·ä¸ºtargetï¼Œåœ¨å½“å‰ç¨‹åºä¸­ä½¿ç”¨alias_targetç¬¦å·å¼•ç”¨targetã€‚åˆ«åçš„weakrefå¿…é¡»é‡‡ç”¨staticä¿®é¥°ç¬¦ï¼Œå¦åˆ™ä¼šç¼–è¯‘æŠ¥é”™ï¼š1234567891011121314151617181920212223242526272829303132333435# cat lib.c #include &lt;stdio.h&gt;void bar()&#123; printf(&quot;%s\\n&quot;,__func__);&#125;# cat main.cstatic __attribute__((weakref(&quot;bar&quot;))) void foo();int main()&#123; if (foo) foo(); return 0;&#125;# gcc main.c -o main &amp;&amp; ./main # echo $?0# gcc -c main.c lib.c# gcc -o main main.o lib.o &amp;&amp; ./main bar# readelf -s main.oSymbol table &#x27;.symtab&#x27; contains 10 entries: Num: Value Size Type Bind Vis Ndx Name 0: 0000000000000000 0 NOTYPE LOCAL DEFAULT UND 1: 0000000000000000 0 FILE LOCAL DEFAULT ABS main.c 2: 0000000000000000 0 SECTION LOCAL DEFAULT 1 3: 0000000000000000 0 SECTION LOCAL DEFAULT 3 4: 0000000000000000 0 SECTION LOCAL DEFAULT 4 5: 0000000000000000 0 SECTION LOCAL DEFAULT 6 6: 0000000000000000 0 SECTION LOCAL DEFAULT 7 7: 0000000000000000 0 SECTION LOCAL DEFAULT 5 8: 0000000000000000 31 FUNC GLOBAL DEFAULT 1 main 9: 0000000000000000 0 NOTYPE WEAK DEFAULT UND bar å¯è§ï¼Œmain.cå®šä¹‰äº†å¼±å¼•ç”¨ç¬¦å·barï¼Œæ— è®ºbaræ˜¯å¦å®šä¹‰ï¼Œç¨‹åºé“¾æ¥éƒ½ä¸ä¼šå‡ºé”™ã€‚ __attribute__((weakref)) symbolï¼Œæ— targetçš„æƒ…å†µï¼Œå³éåˆ«åçš„æƒ…å†µä¸‹ï¼Œweakrefä¹Ÿå¯ç”¨weakè¡¨ç¤º[10]ï¼š1234567891011121314151617181920212223# cat pthread.c#include &lt;stdio.h&gt;#include &lt;pthread.h&gt;int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg) __attribute__((weak));int main()&#123; if (pthread_create) &#123; printf(&quot;This is a multi-thread version\\n&quot;); &#125; else &#123; printf(&quot;This is a single-thread version\\n&quot;); &#125; return 0;&#125;# gcc pthread.c -o pt# ./ptThis is a single-thread version# gcc pthread.c -lpthread -o pt# ./ptThis is a multi-thread version æœ‰æ— é“¾æ¥libpthread.soï¼Œé“¾æ¥è¿‡ç¨‹éƒ½ä¸ä¼šæŠ¥é”™ã€‚pthread_createåœ¨å½“å‰ç¨‹åºä¸­æ˜¯å¼±ç¬¦å·ï¼Œå¼±é“¾æ¥äº†libpthread.soï¼Œåˆ™æœ‰ç¬¦å·pthread_createå®é™…å®šä¹‰ã€‚ å¼±ç¬¦å·å’Œå¼±å¼•ç”¨åœ¨å·¥ç¨‹å®ç°ä¸­å…·æœ‰å¦‚ä¸‹ä½œç”¨ï¼š åº“ä¸­å®šä¹‰çš„å¼±ç¬¦å·ï¼Œå¯ä»¥è¢«å…·ä½“å®ç°(ç”¨æˆ·å®šä¹‰/æ¶æ„å®šä¹‰)çš„å¼ºç¬¦å·è¦†ç›–ï¼Œæ— å¼ºç¬¦å·çš„æƒ…å†µä¸‹ï¼Œå¼±ç¬¦å·çš„å®šä¹‰å…·æœ‰é€šç”¨æ€§ï¼Œæœ‰å¼ºç¬¦å·çš„æƒ…å†µä¸‹åˆå…·æœ‰ç‰¹å®šæ€§ ç¨‹åºå¯ä»¥å°†æ‰©å±•åŠŸèƒ½æ¨¡å—çš„å¼•ç”¨å®šä¹‰ä¸ºå¼±å¼•ç”¨ï¼Œå½“æ‰©å±•æ¨¡å—å’Œç¨‹åºé“¾æ¥åœ¨ä¸€èµ·æ—¶ï¼Œæ‰©å±•åŠŸèƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œåä¹‹åˆ™ç¼ºå°‘æ‰©å±•åŠŸèƒ½ common blockç¬¦å·çš„st_shndxå­—æ®µä¸ºSHN_COMMONæ˜¯common symbolï¼Œæœ‰æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ç¬¦å·çš„st_typeå­—æ®µä¸ºSTT_COMMONåˆ¤æ–­ç¬¦å·ä¸ºcommon symbolã€‚å¹¶ä¸è¦æ±‚common symbolåŒæ—¶æ»¡è¶³SHN_COMMONã€STT_COMMONã€‚ç°åœ¨çš„ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨éƒ½æ”¯æŒcommon blockæœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶æœ€æ—©æ¥æºäºFortranã€‚æ—©æœŸçš„Fortranæ²¡æœ‰åŠ¨æ€åˆ†é…ç©ºé—´çš„æœºåˆ¶ï¼Œç¨‹åºå‘˜å¿…é¡»å®ç°å£°æ˜å®ƒæ‰€éœ€ç©ºé—´å¤§å°ã€‚FortranæŠŠè¿™ç§ç©ºé—´å«åšcommon blockï¼Œå½“ä¸åŒçš„ç›®æ ‡æ–‡ä»¶éœ€è¦çš„common blockç©ºé—´ä¸ä¸€è‡´æ—¶ï¼Œä»¥æœ€å¤§çš„ç©ºé—´ä¸ºå‡†ã€‚æœªå®šä¹‰çš„å…¨å±€å˜é‡æ˜¯commcon symbol,å‰é¢ç« èŠ‚æåŠçš„global_uninit_varå°±æ˜¯ä¸€ä¸ªå…¸å‹ä¾‹å­ã€‚é“¾æ¥å™¨é“¾æ¥åŒåçš„å¼ºç¬¦å·ã€commonç¬¦å·ã€å¼±ç¬¦å·éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š IWhen the link editor combines several relocatable object files, it does not allow multiple definitions of STB_GLOBAL symbols with the same name. On the other hand, if a defined global symbol exists, the appearance of a weak symbol with the same name will not cause an error. The link editor honors the global definition and ignores the weak ones. Similarly, if a common symbol exists (that is, a symbol whose st_shndx field holds SHN_COMMON), the appearance of a weak symbol with the same name will not cause an error. The link editor honors the common definition and ignores the weak ones.[11] ç®€è€Œè¨€ä¹‹ï¼Œç¬¦å·ä¼˜å…ˆçº§ï¼šSTB_GLOBAL &gt; COMMON &gt; STB_WEAKï¼Œæ›´å¤šå…³äºcommon symbolçš„ä»‹ç»ä¹Ÿè¯·å‚è€ƒ[11]ã€‚ gccçš„-fno-commonç¼–è¯‘é€‰é¡¹å…è®¸å°†æ‰€æœ‰æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¸ä»¥common blockçš„å½¢å¼å¤„ç†ï¼Œæˆ–è€…ä½¿ç”¨__attritute__æ‰©å±•: 1int global __attribute__((nocommon)); æ­¤æ—¶è¿™äº›æœªå®šä¹‰çš„å…¨å±€å˜é‡ä¾¿æ˜¯å¼ºç¬¦å·ã€‚GCCå’ŒClangä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤ä½¿ç”¨-fcommonç¼–è¯‘Cæ–‡ä»¶ï¼Œè‡ªGCC 10/Clang 11é»˜è®¤é‡‡ç”¨-fno-common[11]ã€‚","categories":[{"name":"compilation","slug":"compilation","permalink":"https://system-thoughts.github.io/categories/compilation/"}],"tags":[{"name":"ELF","slug":"elf","permalink":"https://system-thoughts.github.io/tags/elf/"}]},{"title":"ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» -- ç¼–è¯‘å’Œé“¾æ¥","slug":"ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» -- ç¼–è¯‘å’Œé“¾æ¥","date":"2022-07-10T14:28:33.000Z","updated":"2023-01-18T05:32:06.168Z","comments":true,"path":"posts/78679aea/","link":"","permalink":"https://system-thoughts.github.io/posts/78679aea/","excerpt":"è¿‘æœŸé‡è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹æ€»ç»“ç¨‹åºçš„ç¼–è¯‘ã€é“¾æ¥ã€è£…è½½è¿‡ç¨‹ã€‚ä¹¦ä¸­çš„ç¬¬äºŒç« ã€Šç¼–è¯‘å’Œé“¾æ¥ã€‹ååˆ†æ¸…æ¥šåœ°æè¿°äº†ç¼–è¯‘å’Œé“¾æ¥çš„æ•´ä½“å·¥ä½œï¼Œæœ¬æ–‡åœ¨æ­¤ç®€è¦æ€»ç»“ï¼Œç®—æ˜¯ä¸€ç¯‡è¯»ä¹¦ç¬”è®°ã€‚","text":"è¿‘æœŸé‡è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹æ€»ç»“ç¨‹åºçš„ç¼–è¯‘ã€é“¾æ¥ã€è£…è½½è¿‡ç¨‹ã€‚ä¹¦ä¸­çš„ç¬¬äºŒç« ã€Šç¼–è¯‘å’Œé“¾æ¥ã€‹ååˆ†æ¸…æ¥šåœ°æè¿°äº†ç¼–è¯‘å’Œé“¾æ¥çš„æ•´ä½“å·¥ä½œï¼Œæœ¬æ–‡åœ¨æ­¤ç®€è¦æ€»ç»“ï¼Œç®—æ˜¯ä¸€ç¯‡è¯»ä¹¦ç¬”è®°ã€‚ gccç¼–è¯‘è¿‡ç¨‹å…¨è²Œä»‹ç»ç¼–è¯‘è¿‡ç¨‹ä¹Ÿä¸èƒ½å…ä¿—ï¼Œä»¥hello worldç¨‹åºå¼€å§‹ç¼–è¯‘ä¹‹æ—…ï¼š 12345678# cat hello.c#include &lt;stdio.h&gt;int main(void)&#123; printf(&quot;Hello World\\n&quot;); return 0;&#125; ä½¿ç”¨gccç¼–è¯‘å¹¶è¿è¡Œhello worldç¨‹åºï¼š 1234567891011121314151617181920# gcc --verbose hello.c -o hello// é¢„ç¼–è¯‘&amp;ç¼–è¯‘/usr/libexec/gcc/x86_64-redhat-linux/8/cc1 -quiet -v hello.c -quiet -dumpbase hello.c -mtune=generic -march=x86-64 -auxbase hello -version -o /tmp/ccXBOY9N.s// å¤´æ–‡ä»¶æœç´¢è·¯å¾„#include &quot;...&quot; search starts here:#include &lt;...&gt; search starts here: /usr/lib/gcc/x86_64-redhat-linux/8/include /usr/local/include /usr/includeEnd of search list.// æ±‡ç¼–as -v --64 -o /tmp/ccnma4VO.o /tmp/ccXBOY9N.sGNU assembler version 2.30 (x86_64-redhat-linux) using BFD version version 2.30-73.el8COMPILER_PATH=/usr/libexec/gcc/x86_64-redhat-linux/8/:/usr/libexec/gcc/x86_64-redhat-linux/8/:/usr/libexec/gcc/x86_64-redhat-linux/:/usr/lib/gcc/x86_64-redhat-linux/8/:/usr/lib/gcc/x86_64-redhat-linux/LIBRARY_PATH=/usr/lib/gcc/x86_64-redhat-linux/8/:/usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64/:/lib/../lib64/:/usr/lib/../lib64/:/usr/lib/gcc/x86_64-redhat-linux/8/../../../:/lib/:/usr/lib/// é“¾æ¥COLLECT_GCC_OPTIONS=&#x27;-v&#x27; &#x27;-o&#x27; &#x27;hello&#x27; &#x27;-mtune=generic&#x27; &#x27;-march=x86-64&#x27; /usr/libexec/gcc/x86_64-redhat-linux/8/collect2 -plugin /usr/libexec/gcc/x86_64-redhat-linux/8/liblto_plugin.so -plugin-opt=/usr/libexec/gcc/x86_64-redhat-linux/8/lto-wrapper -plugin-opt=-fresolution=/tmp/ccs52rzN.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --no-add-needed --eh-frame-hdr --hash-style=gnu -m elf_x86_64 -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o hello /usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64/crt1.o /usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64/crti.o /usr/lib/gcc/x86_64-redhat-linux/8/crtbegin.o -L/usr/lib/gcc/x86_64-redhat-linux/8 -L/usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64 -L/lib/../lib64 -L/usr/lib/../lib64 -L/usr/lib/gcc/x86_64-redhat-linux/8/../../.. /tmp/ccnma4VO.o -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-redhat-linux/8/crtend.o /usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64/crtn.o# ./hello Hello World ä¸Šè¿°ç¼–è¯‘è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼šé¢„ç¼–è¯‘(preprocessing)ã€ç¼–è¯‘(compilation)ã€æ±‡ç¼–(assembly)å’Œé“¾æ¥(linking)ã€‚å¦‚å›¾æ‰€ç¤ºï¼š é¢„ç¼–è¯‘(preprocessing)é¢„ç¼–è¯‘è¿‡ç¨‹æ˜¯å¤„ç†æºä»£ç ä¸­ä»¥â€#â€å¼€å¤´çš„é¢„ç¼–è¯‘å‘½ä»¤ï¼Œgccçš„é¢„å¤„ç†å‘½ä»¤æ˜¯gcc -Eæˆ–è€…cppï¼Œé¢„å¤„ç†åçš„æ–‡ä»¶æ‰©å±•åä»¥.iç»“å°¾ï¼š 12# cpp hello.c &gt; hello.i# gcc -E hello.c -o hello.i æ‰€æœ‰çš„é¢„ç¼–è¯‘å‘½ä»¤çš„å¤„ç†è§„åˆ™å¦‚ä¸‹ï¼š å±•å¼€æ‰€æœ‰#defineå®å®šä¹‰ å¤„ç†æ‰€æœ‰æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå¦‚#ifã€#ifdefã€#elifã€#elseã€#endif å¤„ç†#includeé¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†æ‰€æœ‰åŒ…å«çš„å¤´æ–‡ä»¶éƒ½æ’å…¥åˆ°è¯¥é¢„ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€’å½’çš„ åˆ é™¤æ‰€æœ‰çš„æ³¨é‡Š//å’Œ/* */ æ·»åŠ è¡Œå·å’Œæ–‡ä»¶åæ ‡è¯†ï¼Œå¦‚mainå‡½æ•°ä¸Šçš„# 3 &quot;hello.c&quot;ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨äº§ç”Ÿè°ƒè¯•ç”¨çš„è¡Œå·ä¿¡æ¯ä»¥åŠç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿå‘Šè­¦ã€æŠ¥é”™èƒ½å¤Ÿæç¤ºè¡Œå· ä¿ç•™æ‰€æœ‰#pragmaç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œç¼–è¯‘å™¨ä¼šç”¨åˆ°å®ƒ ç¼–è¯‘(compilation)ç¼–è¯‘è¿‡ç¨‹æ˜¯å°†é¢„å¤„ç†å®Œçš„æ–‡ä»¶ç»è¿‡ä¸€ç³»åˆ—çš„è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–ç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç ã€‚gccçš„ç¼–è¯‘è¿‡ç¨‹ç›¸å½“äºï¼š 12# gcc -S hello.c# gcc -S hello.i -o hello.s æ±‡ç¼–ä»£ç ä»¥.såç¼€ç»“å°¾ï¼Œå®é™…ç‰ˆæœ¬çš„gccå°†é¢„ç¼–è¯‘å’Œç¼–è¯‘åœ¨ä¸€ä¸ªæ­¥éª¤ä¸­å®Œæˆï¼Œä¸Šé¢çš„/usr/libexec/gcc/x86_64-redhat-linux/8/cc1ç¨‹åºå®Œæˆè¿™ä¸ªè¿‡ç¨‹ã€‚æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å¯ä»¥åˆ†ä¸º6æ­¥ï¼šæ‰«æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æºä»£ç ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆå’Œç›®æ ‡ä»£ç ä¼˜åŒ–ï¼šä»¥ç®€å•ç¨‹åºCompilerExpression.cä¸ºä¾‹ï¼Œåˆ†æå…¶ä¸­çš„èµ‹å€¼è¯­å¥çš„ç¼–è¯‘è¿‡ç¨‹ï¼ˆè¿™ä¸ªç¨‹åºæ˜¾ç„¶æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä¸”æœªå¯¹å…¥å‚è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼‰ï¼š 1234567# cat CompilerExpression.cint array[4];void func(int index)&#123; array[index] = (index + 4) * (2 + 6);&#125; è¯æ³•åˆ†æ(lexical analysis)æºç é¦–å…ˆä¼šè¢«è¯æ³•åˆ†æå™¨(lexical analyzerï¼Œç®€ç§°lexer)ï¼Œä¹Ÿç§°æ‰«æå™¨(scanner)è¿›è¡Œè¯æ³•åˆ†æï¼Œè¿ç”¨ä¸€ç§ç±»ä¼¼æœ‰é™çŠ¶æ€æœº(Finite State Machine)çš„ç®—æ³•å°†æºä»£ç çš„å­—ç¬¦åºåˆ—åˆ†å‰²æˆä¸€ç³»åˆ—è®°å·(token)ã€‚èµ‹å€¼è¯­å¥ç»è¿‡æ‰«æåï¼Œäº§ç”Ÿäº†17ä¸ªè®°å·ï¼š è®°å· ç±»å‹ array æ ‡è¯†ç¬¦ [ å·¦æ–¹æ‹¬å· index æ ‡è¯†ç¬¦ ] å³æ–¹æ‹¬å· = èµ‹å€¼ ( å·¦åœ†æ‹¬å· index æ ‡è¯†ç¬¦ + åŠ å· 4 æ•°å­— ) å³åœ†æ‹¬å· * ä¹˜å· ( å·¦åœ†æ‹¬å· 2 æ•°å­— + åŠ å· 6 æ•°å­— ) å³åœ†æ‹¬å· ; è¯­å¥ç»“æŸ è¯æ³•åˆ†æäº§ç”Ÿçš„è®°å·å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š å­—é¢é‡ï¼šæ•°å­—ã€å­—ç¬¦ã€å­—ç¬¦ä¸²ç­‰ æ“ä½œç¬¦ï¼šç®—æœ¯è¿ç®—ç¬¦ã€èµ‹å€¼è¿ç®—ç¬¦ç­‰ åˆ†éš”ç¬¦ï¼šåˆ†å·ã€æ‹¬å·ã€é€—å·ç­‰ æ ‡è¯†ç¬¦ï¼šå˜é‡åã€å‡½æ•°åç­‰ å…³é”®å­—ï¼šintã€switchã€breakç­‰ gccæ”¯æŒCã€C++ã€fortranç­‰ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ï¼Œé‚£ä¹ˆgccå†…éƒ¨æ˜¯å¦ä¸ºæ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½å®ç°äº†ä¸€ä¸ªè¯æ³•è§£æå™¨å‘¢ï¼Ÿç­”æ¡ˆå¹¶éå¦‚æ­¤ï¼Œflex(The Fast Lexical Analyzer)ç”¨äºç”Ÿæˆè¯æ³•åˆ†æå™¨ï¼Œç¼–è¯‘å™¨è®¾è®¡è€…æä¾›ç›¸åº”çš„è¯æ³•è§„åˆ™ä½œä¸ºè¾“å…¥ã€‚ä»¥ä¸‹æ˜¯ç®€å•çš„flexè¯æ³•è§„åˆ™æ–‡ä»¶(.låç¼€)ï¼š 1234567# cat simpleLex.l%%&quot;good&quot; &#123; printf(&quot;bad&quot;); &#125;%%# lex simpleLex.l flexè¯»å–è¯æ³•è§„åˆ™æ–‡ä»¶é»˜è®¤ç”Ÿæˆlex.yy.cæ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†Cä»£ç æ ¼å¼å‡½æ•°yylex()ç”¨ä½œè¯æ³•è§£æï¼Œè¯¥å‡½æ•°å¯ä»¥çœ‹åšæœ‰é™çŠ¶æ€æœºã€‚%%å¿…é¡»åœ¨æœ¬è¡Œæœ€å‰é¢ï¼Œå³ä¹‹å‰ä¸å…è®¸æœ‰ä»»ä½•ç©ºæ ¼ï¼Œflexè¯æ³•æ–‡ä»¶çš„ç»“æ„[1]: 12345definitions %% rules %% user code definitionså’Œuser codeå‚è€ƒflexå®˜æ–¹æ–‡æ¡£ï¼Œæœ€é‡è¦çš„æ˜¯rulesï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š 1pattern action patternä¸èƒ½æœ‰ç¼©è¿›ï¼Œactionå¿…é¡»å’Œpatternåœ¨åŒä¸€è¡Œã€‚patternå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œå‚è€ƒflexæ–‡æ¡£[2]ã€‚åŒ¹é…æ¨¡å¼ï¼Œåˆ™ä¼šæ‰§è¡Œç›¸åº”åŠ¨ä½œï¼Œactionä»¥Cè¯­è¨€ä»£ç æè¿°ï¼Œå¯ä»¥ä½¿ç”¨returnå‘yylexå‡½æ•°çš„è°ƒç”¨è€…è¿”å›ä¸€ä¸ªå€¼[3]ã€‚ å°†lex.yy.cæ–‡ä»¶ä¸flexè¿è¡Œæ—¶åº“é“¾æ¥ï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ—¶ä¼šåˆ†æè¾“å…¥ä¸­å‡ºç°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œè‹¥åŒ¹é…åˆ™æ‰§è¡Œç›¸åº”çš„Cä»£ç ï¼Œä¸Šé¢çš„ç¤ºä¾‹ä¼šå°†å­—ç¬¦ä¸²ä¸­çš„â€goodâ€æ›¿æ¢ä¸ºâ€badâ€: 12345# yum install flex-devel -y# cc lex.yy.c -lfl -o simpleLexer# ./simpleLexer hello good boyhello bad boy è¾“å…¥â€hello good boyâ€ä¼šæ›¿æ¢è¾“å‡ºä¸ºâ€hello bad boyâ€ï¼Œåæ±‡ç¼–simpleLexer: 12345678910111213# objdump -d simpleLexerDisassembly of section .text:00000000004009b0 &lt;main&gt;: 4009b0: f3 0f 1e fa endbr64 4009b4: 48 83 ec 08 sub $0x8,%rsp 4009b8: 0f 1f 84 00 00 00 00 nopl 0x0(%rax,%rax,1) 4009bf: 00 4009c0: e8 f1 00 00 00 callq 400ab6 &lt;yylex&gt; 4009c5: 85 c0 test %eax,%eax 4009c7: 75 f7 jne 4009c0 &lt;main+0x10&gt; 4009c9: 31 ff xor %edi,%edi 4009cb: e8 b0 ff ff ff callq 400980 &lt;exit@plt&gt; simpleLexerç¨‹åºè°ƒç”¨yylexè¿›è¡Œè¯æ³•åˆ†æï¼Œè¯¥å‡½æ•°æ‰«ææ–‡ä»¶ï¼ˆé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ï¼‰ï¼Œå½“æ‰«æåˆ°ä¸€ä¸ªå®Œæ•´ã€æœ€é•¿çš„ã€å¯ä»¥å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å­—ç¬¦ä¸²æ—¶ï¼Œåˆ™æ‰§è¡Œè§„åˆ™åçš„Cä»£ç ï¼Œå¦‚æœCä»£ç ä¸­æ²¡æœ‰returnè¯­å¥ï¼Œåˆ™æ‰§è¡Œå®Œè¿™äº›Cä»£ç ä¹‹åï¼Œyylexä¼šç»§ç»­è¿è¡Œï¼Œå¼€å§‹ä¸‹ä¸€è½®çš„æ‰«æ[4]ã€‚ gccæºç ä¸­æœ‰ç›¸åº”çš„.lè¯æ³•è§„åˆ™æ–‡ä»¶ï¼Œä¾èµ–flexç”Ÿæˆè¯æ³•åˆ†æå™¨[5]: Similarly, when building from the source repository or snapshots, or if you modify *.l files, you need the Flex lexical analyzer generator installed. If you do not modify *.l files, releases contain the Flex-generated files and you do not need Flex installed to build them. There is still one Flex-based lexical analyzer (part of the build machinery, not of GCC itself) that is used even if you only build the C front end. è¯­æ³•åˆ†æ(syntactic analysis)è¯­æ³•åˆ†æå™¨(grammar parser)å¯¹æ‰«æå™¨äº§ç”Ÿçš„è®°å·è¿›è¡Œè¯­æ³•åˆ†æä»¥äº§ç”Ÿè¯­æ³•æ ‘(syntax tree)ã€‚æ•´ä¸ªåˆ†æè¿‡ç¨‹é‡‡ç”¨ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•(context-free grammar)çš„åˆ†ææ‰‹æ®µï¼Œç”±è¯­æ³•åˆ†æå™¨äº§ç”Ÿçš„è¯­æ³•æ ‘å°±æ˜¯ä»¥è¡¨è¾¾å¼(expression)ä¸ºèŠ‚ç‚¹çš„æ ‘ã€‚Cè¯­è¨€çš„ä¸€æ¡è¯­å¥å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¤æ‚è¯­å¥æ˜¯å¤šä¸ªè¡¨è¾¾å¼çš„ç»„åˆã€‚ä¸Šé¢è¯­å¥ç”±èµ‹å€¼è¡¨è¾¾å¼ã€åŠ æ³•è¡¨è¾¾å¼ã€ä¹˜æ³•è¡¨è¾¾å¼ã€æ•°ç»„è¡¨è¾¾å¼ã€æ‹¬å·è¡¨è¾¾å¼ç»„æˆï¼Œå½¢æˆçš„è¯­æ³•æ ‘å¦‚å›¾æ‰€ç¤ºï¼šè¯­æ³•æ ‘æ„å»ºè¿‡ç¨‹ä¸­ï¼Œè¿ç®—ç¬¦çš„ä¼˜å…ˆçº§å’Œå«ä¹‰å·²ç»ç¡®å®šä¸‹æ¥ã€‚*åœ¨Cè¯­è¨€ä¸­å¯ä»¥è¡¨ç¤ºä¹˜æ³•è¿ç®—ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºå–æŒ‡é’ˆè¿ç®—ã€‚è¯­æ³•åˆ†æé˜¶æ®µå¿…é¡»å¯¹è¿™äº›å†…å®¹è¿›è¡ŒåŒºåˆ†ï¼Œå¦‚æœå‡ºç°äº†è¡¨è¾¾å¼ä¸åˆæ³•ï¼Œå¦‚æ‹¬å·ä¸åŒ¹é…ã€ç¼ºå°‘æ“ä½œç¬¦ï¼Œç¼–è¯‘å™¨åœ¨è¯­æ³•åˆ†æé˜¶æ®µå°±æŠ¥é”™ã€‚åŒflexï¼Œgccä¹Ÿæ˜¯åˆ©ç”¨ç›¸åº”å·¥å…·æ ¹æ®è¯­æ³•è§„åˆ™ç”Ÿæˆç›¸åº”çš„è¯­æ³•åˆ†æå™¨ï¼Œè€Œæ— éœ€ä¸ºæ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½å†™ä¸€ä¸ªè¯­æ³•åˆ†æå™¨ã€‚yacc(Yet Another Compiler Compiler)ç”¨æ¥ç”Ÿæˆè¯­æ³•è§£æå™¨ï¼Œè¢«ç§°ä¸ºâ€œç¼–è¯‘å™¨çš„ç¼–è¯‘å™¨â€ï¼Œæœ€åˆç”±AT&amp;Tçš„Steven C. Johnsonåœ¨Unixsä¸Šå®ç°[6]ï¼Œyaccå·²ç»æˆä¸ºPOSIXæ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚yaccåœ¨å¼€æºè½¯ä»¶é¢†åŸŸæœ‰ä¸¤ä¸ªæ›¿ä»£å®ç°ï¼šBerkeley Yacc (byacc)ã€GNU Bisonã€‚å‰è€…ä»¥public domainè®¸å¯è¯å‘è¡Œï¼Œåè€…ä»¥GPLè®¸å¯è¯å‘è¡Œ[7]ï¼Œä¸¤è€…éƒ½å…¼å®¹yaccã€‚ è¯­ä¹‰åˆ†æ(semantic analysis)è¯­æ³•åˆ†æä»…èƒ½å¤Ÿå®Œæˆå¯¹è¡¨è¾¾å¼è¯­æ³•å±‚é¢çš„åˆ†æï¼Œä½†å®ƒå¹¶ä¸äº†è§£è¿™ä¸ªè¯­å¥æ˜¯å¦çœŸçš„æœ‰æ„ä¹‰ã€‚æ¯”å¦‚Cè¯­è¨€é‡Œä¸¤ä¸ªæŒ‡é’ˆåšä¹˜æ³•è¿ç®—æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯è¿™ä¸ªè¯­å¥æ˜¯ç¬¦åˆè¯­æ³•çš„ã€‚ç¼–è¯‘å™¨æ‰€èƒ½åˆ†æçš„è¯­ä¹‰æ˜¯é™æ€è¯­ä¹‰(static semantic)ï¼Œé™æ€è¯­ä¹‰æ˜¯åœ¨ç¼–è¯‘æœŸå¯ä»¥ç¡®å®šçš„è¯­ä¹‰ï¼Œç›¸å¯¹åº”çš„æ˜¯åŠ¨æ€è¯­ä¹‰(dynamic semantic)ï¼Œå³è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šçš„è¯­ä¹‰ï¼Œå¦‚é™¤0æ“ä½œæ˜¯ä¸ªè¿è¡ŒæœŸçš„è¯­ä¹‰é”™è¯¯ã€‚é™æ€è¯­ä¹‰åˆ†æåŒ…æ‹¬å£°æ˜å’Œç±»å‹åŒ¹é…ï¼Œç±»å‹è½¬æ¢ç­‰ã€‚æ¯”å¦‚ï¼Œå°†æµ®ç‚¹ç±»å‹è¡¨è¾¾å¼èµ‹å€¼ç»™æ•´å½¢è¡¨è¾¾å¼æ—¶ï¼Œéšå«äº†ä¸€ä¸ªæµ®ç‚¹å‹åˆ°æ•´å‹çš„è½¬æ¢è¿‡ç¨‹ï¼Œè¯­ä¹‰åˆ†æéœ€è¦å®Œæˆè¿™ä¸ªæ­¥éª¤ã€‚å°†æµ®ç‚¹ç±»å‹èµ‹å€¼ç»™ä¸€ä¸ªæŒ‡é’ˆçš„æ—¶å€™ï¼Œè¯­ä¹‰åˆ†æè¿‡ç¨‹ä¼šæ£€æŸ¥å‡ºç±»å‹ä¸åŒ¹é…ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ç»è¿‡è¯­ä¹‰åˆ†æåï¼Œæ•´ä¸ªè¯­æ³•æ ‘çš„è¡¨è¾¾å¼éƒ½æ ‡è¯†äº†ç±»å‹ï¼Œå¦‚æœæœ‰äº›ç±»å‹éœ€è¦åšéšå¼è½¬æ¢ï¼Œè¯­ä¹‰åˆ†æè¿‡ç¨‹ä¼šåœ¨è¯­æ³•æ ‘ä¸­æ’å…¥ç›¸åº”çš„è½¬æ¢èŠ‚ç‚¹ã€‚ç»è¿‡è¯­ä¹‰åˆ†æé˜¶æ®µåçš„è¯­æ³•æ ‘å¦‚å›¾æ‰€ç¤ºï¼š ä¸­é—´è¯­è¨€ç”Ÿæˆç°ä»£ç¼–è¯‘å™¨æœ‰å¤šä¸ªå±‚æ¬¡çš„ä¼˜åŒ–ï¼Œæºç çº§ä¼˜åŒ–å™¨(source code optimizer)å®Œæˆæºä»£ç çº§åˆ«çš„ä¼˜åŒ–ï¼Œå¦‚2 + 6è¡¨è¾¾å¼ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œç›´æ¥è®¡ç®—å¾—åˆ°8ï¼Œæ›´å¤šæºç çº§ä¼˜åŒ–å¯ä»¥å‚è€ƒç¼–è¯‘å™¨è®¾è®¡ç›¸å…³çš„èµ„æ–™ã€‚ä¼˜åŒ–ä¹‹åçš„è¯­æ³•æ ‘å¦‚å›¾æ‰€ç¤ºï¼šç›´æ¥åœ¨è¯­æ³•æ ‘ä¸Šåšä¼˜åŒ–æ¯”è¾ƒå›°éš¾ï¼Œæºç çº§ä¼˜åŒ–å™¨å…ˆå°†è¯­æ³•æ ‘è½¬æ¢æˆä¸­é—´ä»£ç (intermediate code)ï¼Œå®ƒæ˜¯è¯­æ³•æ ‘çš„é¡ºåºè¡¨ç¤ºï¼Œå·²ç»å¾ˆæ¥è¿‘ç›®æ ‡ä»£ç ï¼Œä½†æ˜¯ä¸ç›®æ ‡æœºå™¨å’Œè¿è¡Œæ—¶ç¯å¢ƒæ— å…³ï¼Œå¦‚å®ƒä¸åŒ…å«æ•°æ®å°ºå¯¸ã€å˜é‡åœ°å€å¯„å­˜å™¨çš„åå­—ç­‰ã€‚ä¸­é—´ä»£ç æœ‰å¤šç§ç±»å‹ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰ä¸‰åœ°å€ç (Three-adress Code)å’ŒPä»£ç (P-Code)ã€‚gccä½¿ç”¨GIMPLEçš„ä¸‰åœ°å€è¡¨ç¤ºä¸­é—´ä»£ç [8]ï¼Œæœ€åŸºæœ¬çš„ä¸‰åœ°å€ç æ˜¯è¿™æ ·çš„: 1x = y op z å› ä¸ºä¸€ä¸ªä¸‰åœ°å€è¯­å¥ä¸­æœ‰ä¸‰ä¸ªå˜é‡åœ°å€ï¼Œä¸‰åœ°å€ç å¾—åäºæ­¤ã€‚è¿™ä¸ªä¸‰åœ°å€ç è¡¨ç¤ºå°†å˜é‡yå’Œzè¿›è¡Œopæ“ä½œä»¥åèµ‹å€¼ç»™xã€‚ä¸Šé¢çš„è¯­æ³•æ ‘ç¿»è¯‘æˆä¸‰åœ°å€ç æ˜¯è¿™æ ·çš„ï¼š 1234t1 = 2 + 6t2 = index + 4t3 = t2 * t1array[index] = t3 è¿™é‡Œåˆ©ç”¨äº†å‡ ä¸ªä¸´æ—¶å˜é‡t1ã€t2ã€t3ï¼Œåœ¨ä¸‰ä»£ç çš„åŸºç¡€è¿›è¡Œæ€§ä¼˜åŒ–ï¼Œå¯ä»¥å°†t1è®¡ç®—å‡ºæ¥ï¼Œå°†åé¢çš„t1éƒ½æ›¿æ¢æ‰ï¼š 123t2 = index + 4t3 = t2 * 8array[index] = t3 è¿™é‡Œt3ä¸´æ—¶å˜é‡ä¹Ÿå¯ä»¥ä¼˜åŒ–æ‰ï¼š 12t2 = index + 4array[index] = t2 * 8 ä¸­é—´ä»£ç ä½¿å¾—ç¼–è¯‘å™¨è¢«åˆ†ä¸ºå‰ç«¯å’Œåç«¯ï¼Œç¼–è¯‘å™¨çš„å‰ç«¯è´Ÿè´£äº§ç”Ÿä¸æ„å»ºæœºå™¨æ— å…³çš„ä¸­é—´ä»£ç ï¼Œç¼–è¯‘å™¨åç«¯å°†ä¸­é—´ä»£ç è½¬æ¢æˆç›®æ ‡æœºå™¨ä»£ç ã€‚å¯¹ä¸€äº›è·¨å¹³å°çš„ç¼–è¯‘å™¨è€Œè¨€ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„å¹³å°ä½¿ç”¨åŒä¸€ä¸ªå‰ç«¯ï¼Œé’ˆå¯¹ä¸åŒæœºå™¨å¹³å°è®¾è®¡ä¸åŒçš„åç«¯ã€‚ ç›®æ ‡ä»£ç ç”Ÿæˆä¸ä¼˜åŒ–(object code generate &amp; optimize)ç”Ÿæˆä¸­é—´ä»£ç ä¹‹åçš„ç¼–è¯‘å·¥ä½œéƒ½å±äºç¼–è¯‘å™¨åç«¯ï¼Œä¸»è¦åŒ…æ‹¬ä»£ç ç”Ÿæˆå™¨(code generator)å’Œç›®æ ‡ä»£ç ä¼˜åŒ–å™¨(target code optimizer)ã€‚ä»£ç ç”Ÿæˆå™¨å°†ä¸­é—´ä»£ç è½¬æ¢ä¸ºç›®æ ‡æœºå™¨æ±‡ç¼–ä»£ç ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºç›®æ ‡æœºå™¨ï¼Œä¸åŒçš„ç›®æ ‡æœºå™¨æœ‰ç€ä¸åŒçš„å­—é•¿ã€å¯„å­˜å™¨ã€æŒ‡ä»¤ç­‰ã€‚ç¤ºä¾‹ä»£ç ç”Ÿæˆçš„x86_64çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤º: 1234567movl %edi, -4(%rbp)movl -4(%rbp), %eaxaddl $4, %eaxleal 0(,%rax,8), %edxmovl -4(%rbp), %eaxcltqmovl %edx, array(,%rax,4) æœ€åï¼Œç›®æ ‡ä»£ç ä¼˜åŒ–å™¨å¯¹ä¸Šè¿°ç›®æ ‡ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œè¿™ä¸ªçº§åˆ«çš„ä¼˜åŒ–å›åˆç›®æ ‡æœºå™¨ç›¸å…³ï¼Œå¦‚é€‰æ‹©åˆé€‚çš„å¯»å€æ–¹å¼ã€ä½¿ç”¨ä½ç§»ä»£æ›¿ä¹˜æ³•è¿ç®—ã€åˆ é™¤å¤šä½™æŒ‡ä»¤ç­‰ã€‚æºç çº§ä¼˜åŒ–å’Œç›®æ ‡ä»£ç ä¼˜åŒ–ï¼Œå¯ä»¥å‚è€ƒ[9][10]ã€‚ æ±‡ç¼–(assembly)æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼Œæ¯æ¡æ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚æ‰€ä»¥æ±‡ç¼–å™¨çš„æ±‡ç¼–è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰è¯­æ³•ã€è¯­ä¹‰ï¼Œä¹Ÿä¸æ¶‰åŠæŒ‡ä»¤ä¼˜åŒ–ï¼Œä»…ä»…æ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘å³å¯ï¼Œâ€œæ±‡ç¼–â€è¿™ä¸ªåå­—å°±æºäºæ­¤ã€‚gccçš„æ±‡ç¼–è¿‡ç¨‹ç”±æ±‡ç¼–å™¨asæ¥å®Œæˆï¼š 123# as hello.s -o hello.o# gcc -c hello.c -o hello.o# gcc -c hello.s -o hello.o æ±‡ç¼–å™¨è¾“å‡ºçš„ç›®æ ‡æ–‡ä»¶(object file)ä»¥.oç»“å°¾ã€‚ é“¾æ¥(linking)åŸå§‹é“¾æ¥çš„æ¦‚å¿µåœ¨é«˜çº§ç¼–ç¨‹è¯­è¨€å‘æ˜ä¹‹å‰å·²ç»å­˜åœ¨ã€‚æœ€å¼€å§‹çš„çº¸å¸¦æ‰“å­”ç¼–ç éƒ½æ— éœ€ç»è¿‡ç¼–è¯‘ã€æ±‡ç¼–è¿‡ç¨‹ï¼Œè€Œæ˜¯ç›´æ¥ç¼–å†™çš„äºŒè¿›åˆ¶æœºå™¨ç åœ¨è®¡ç®—æœºä¸Šè¿è¡Œã€‚å°±åœ¨æ‰“å­”ç¼–ç çš„è›®è’æ—¶ä»£ä¹Ÿä¼šé‡åˆ°â€œè½¯ä»¶å·¥ç¨‹é—®é¢˜â€ï¼Œå¦‚åœ¨ç¬¬1æ¡æŒ‡ä»¤å’Œç¬¬5æ¡æŒ‡ä»¤ä¹‹é—´æ’å…¥æŒ‡ä»¤ï¼Œåˆ™ç¬¬5æ¡æŒ‡ä»¤åŠåé¢çš„æŒ‡ä»¤çš„ä½ç½®éƒ½ä¼šç›¸åº”å¾€åç§»åŠ¨ï¼ŒåŸå…ˆæŒ‡ä»¤ä¸­å­˜åœ¨æŒ‡å‘è¿™äº›è°ƒæ•´ä½ç½®æŒ‡ä»¤çš„åœ°å€å°±éœ€è¦è°ƒæ•´ã€‚è‹¥ç¼–ç å·¥ä½œç”±å¤šä¸ªå›¢é˜Ÿåä½œï¼Œç”šè‡³å­˜åœ¨è·¨çº¸å¸¦çš„åœ°å€è°ƒæ•´ã€‚é‡æ–°è®¡ç®—å„ä¸ªç›®æ ‡åœ°å€çš„å·¥ç¨‹ç§°ä½œé‡å®šä½(relocation)**ï¼Œæœ€å¼€å§‹è¿™ä¸ªå·¥ä½œè®¤ä¸ºå®Œæˆï¼Œä¸ä»…æ¯ç‡¥ã€ç¹çï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚æ˜¾ç„¶ï¼Œé‡å®šä½å·¥ä½œäº¤ç»™ç¨‹åºå®Œæˆæ‰æ˜¯æœ€åˆé€‚çš„ï¼Œæ±‡ç¼–è¯­è¨€åº”è¿è€Œç”Ÿã€‚æ±‡ç¼–è¯­è¨€å¼•å…¥äº†ä¸€å¥—åŠ©è®°ç¬¦ï¼Œå¦‚è·³è½¬æŒ‡ä»¤ä½¿ç”¨jmpè¡¨ç¤ºï¼Œä¸ä»…æ–¹ä¾¿ç¨‹åºå‘˜é˜…è¯»ä»£ç ï¼Œè¿˜å¼•å…¥äº†ç¬¦å·(symbol)** çš„æ¦‚å¿µã€‚ç¬¦å·ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåœ°å€ï¼Œå¯èƒ½æ˜¯ä¸€æ®µå­ç¨‹åºï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå˜é‡çš„èµ·å§‹åœ°å€ã€‚å¦‚ç¬¬1æ¡æŒ‡ä»¤æ˜¯jmp fooï¼Œç¬¬5æ¡æŒ‡ä»¤å¼€å§‹çš„å­ç¨‹åºå‘½åä¸ºfooã€‚ä¸ç®¡fooè¿™ä¸ªç¬¦å·æ‰€åœ¨çš„åœ°å€å¦‚ä½•å˜åŒ–ï¼Œæ±‡ç¼–å™¨æ¯æ¬¡æ±‡ç¼–ç¨‹åºæ—¶éƒ½ä¼šé‡æ–°è®¡ç®—fooç¬¦å·åœ°å€ã€‚æœ‰äº†æ±‡ç¼–è¯­è¨€ä¹‹åï¼Œå¼€å‘æ•ˆç‡æå¤§æå‡ï¼Œéšä¹‹è½¯ä»¶è§„æ¨¡æ‰©å¤§ã€‚äººä»¬å¼€å§‹è€ƒè™‘å°†ä¸åŒåŠŸèƒ½çš„ä»£ç æŒ‰ç…§ä¸€å®šçš„æ–¹å¼ç»„ç»‡èµ·æ¥ï¼Œä¾¿äºé˜…è¯»ã€å¼€å‘ã€ç»´æŠ¤ã€‚è‡ªç„¶è€Œç„¶ï¼Œäººä»¬æŒ‰ç…§ä»£ç åŠŸèƒ½æˆ–è€…æ€§è´¨åˆ’åˆ†ï¼Œå½¢æˆäº†ä¸åŒçš„åŠŸèƒ½æ¨¡å—ï¼Œæ¨¡å—ä¹‹é—´æŒ‰ç…§å±‚æ¬¡ç»“æ„æˆ–è€…å…¶ä»–ç»“æ„ç»„ç»‡èµ·æ¥ã€‚ç¨‹åºè¢«åˆ†å‰²æˆä¸åŒçš„æ¨¡å—ä¹‹åï¼Œå°†ä¸åŒçš„æ¨¡å—ç»„åˆæˆå•ä¸€ç¨‹åºçš„è¿‡ç¨‹ç§°ä¸ºé“¾æ¥ã€‚é“¾æ¥é—®é¢˜å½’æ ¹ç»“åº•æ˜¯æ¨¡å—é—´çš„é€šä¿¡é—®é¢˜ï¼ŒCç¨‹åºçš„æ¨¡å—é—´é€šä¿¡æ–¹å¼æœ‰ä¸¤ç§ï¼š æ¨¡å—é—´çš„å‡½æ•°è°ƒç”¨ æ¨¡å—é—´çš„å˜é‡è®¿é—® ä¸¤ç§æ–¹å¼éƒ½æ˜¯æ¨¡å—é—´çš„ç¬¦å·å¼•ç”¨ï¼Œå› æ­¤é“¾æ¥å°±æ˜¯è§£å†³æ¨¡å—é—´çš„ç¬¦å·å¼•ç”¨é—®é¢˜ã€‚ä»åŸç†ä¸Šè®²ï¼Œé“¾æ¥è¿‡ç¨‹æ˜¯å¤šæ¨¡å—åœºæ™¯ä¸‹ï¼Œå¯¹å…¶ä»–ç¬¦å·çš„åœ°å€çš„å¼•ç”¨åŠ ä»¥ä¿®æ­£ã€‚é“¾æ¥è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬äº†åœ°å€å’Œç©ºé—´åˆ†é…(Address and Storage Allocation)ã€ç¬¦å·å†³è®®(Symbol Resolution)å’Œé‡å®šä½(Relocation)ç­‰æ­¥éª¤ã€‚åœ°å€å’Œç©ºé—´åˆ†é…ï¼šç›®æ ‡æ–‡ä»¶ä¸­çš„ä»£ç å’Œæ•°æ®ä¿¡æ¯ä»¥sectionçš„æ–¹å¼ç»„ç»‡ï¼Œç»“æœç›®æ ‡æ–‡ä»¶ä¸­ä»£ç ã€æ•°æ®sectionç”±å‚ä¸é“¾æ¥çš„ç›®æ ‡æ–‡ä»¶ç›¸åº”çš„sectionç»„æˆã€‚åœ°å€å’Œç©ºé—´åˆ†é…æ˜¯ç»„åˆæˆç»“æœç›®æ ‡æ–‡ä»¶sectionæ—¶è€ƒè™‘å…¶è™šæ‹Ÿåœ°å€ä»¥åŠå­˜å‚¨ç©ºé—´ã€‚ç¬¦å·å†³è®®ï¼šå°†ç¬¦å·çš„å¼•ç”¨ä¸ç¬¦å·å®šä¹‰å»ºç«‹å…³è”é‡å®šä½ï¼šä¿®æ­£ç¬¦å·å¼•ç”¨å¤„ç¬¦å·åœ°å€ï¼Œæ¯ä¸ªè¦è¢«ä¿®æ­£çš„åœ°æ–¹å«åšé‡å®šä½å…¥å£(relocation entry)ã€‚ é“¾æ¥åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ï¼Œé™æ€é“¾æ¥çš„ç©ºé—´åˆ†é…ã€ç¬¦å·å†³è®®ã€é‡å®šä½åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å®Œæˆï¼Œè¾“å‡ºçš„å¯æ‰§è¡Œç¨‹åºå·²ç»ç¡®å®šäº†æ‰€æœ‰ç¬¦å·çš„åœ°å€ã€‚åŠ¨æ€é“¾æ¥çš„æœ€ç»ˆç¬¦å·é‡å®šä½æ­¥éª¤å®Œæˆå¯èƒ½å‘ç”Ÿåœ¨å¯æ‰§è¡Œç¨‹åºåŠ è½½æ—¶ï¼Œæˆ–è€…ç¨‹åºè¿è¡Œæ—¶ï¼Œæ•…å¾—ååŠ¨æ€é“¾æ¥ã€‚ gccé»˜è®¤é‡‡ç”¨åŠ¨æ€é“¾æ¥ï¼Œä¸Šè¿°gccç¼–è¯‘è¿‡ç¨‹æœ€åçš„collect2æ‰§è¡Œçš„æ˜¯é“¾æ¥è¿‡ç¨‹ï¼Œcollect2å¯ä»¥çœ‹åšæ˜¯å¯¹é“¾æ¥å™¨ldçš„å°è£…ï¼Œldæºäºbinutilsé¡¹ç›®ã€‚å¯è§åŠ¨æ€é“¾æ¥ä¹Ÿä¼šæœ‰ldé“¾æ¥å™¨å®Œæˆç›®æ ‡æ–‡ä»¶çš„ç»„è£…ã€‚ Reference[1] https://westes.github.io/flex/manual/Format.html#Format[2] https://westes.github.io/flex/manual/Patterns.html#Patterns[3] https://tldp.org/HOWTO/GCC-Frontend-HOWTO-3.html[4] https://pandolia.net/tinyc/ch8_flex.html[5] https://gcc.gnu.org/install/build.html[6] https://en.wikipedia.org/wiki/Yacc[7] https://tomassetti.me/why-you-should-not-use-flex-yacc-and-bison/[8] https://gcc.gnu.org/wiki/GIMPLE[9] https://www.geeksforgeeks.org/code-optimization-in-compiler-design/?ref=lbp[10] https://www.tutorialspoint.com/compiler_design/compiler_design_code_optimization.htm","categories":[{"name":"compilation","slug":"compilation","permalink":"https://system-thoughts.github.io/categories/compilation/"}],"tags":[{"name":"compilation","slug":"compilation","permalink":"https://system-thoughts.github.io/tags/compilation/"},{"name":"link","slug":"link","permalink":"https://system-thoughts.github.io/tags/link/"}]},{"title":"å¯åŠ¨è¿‡ç¨‹åˆ†æ--initramfsé˜¶æ®µ","slug":"å¯åŠ¨è¿‡ç¨‹åˆ†æ--initramfsé˜¶æ®µ","date":"2022-06-23T04:16:09.000Z","updated":"2023-01-18T05:32:06.164Z","comments":true,"path":"posts/e06690ff/","link":"","permalink":"https://system-thoughts.github.io/posts/e06690ff/","excerpt":"kernel version: 5.18(4b0986a3613c) æœ¬æ–‡ä¸­çš„å¤§éƒ¨åˆ†ä»£ç æ®µéƒ½æœ‰ä»£ç åˆ é™¤ ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€æ‰§è¡Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„initç¨‹åºå®Œæˆåˆ°ç”¨æˆ·ç©ºé—´çš„åˆ‡æ¢ã€‚ç„¶è€Œæ ¹æ–‡ä»¶ç³»ç»Ÿå¯èƒ½æ˜¯åœ¨ä¸åŒçš„ç¡¬ä»¶è®¾å¤‡ä¸Šï¼Œå¦‚SCSIç¡¬ç›˜ã€SATAç¡¬ç›˜ã€Flashè®¾å¤‡ç­‰ï¼Œåç»­ä¼šå‡ºç°æ›´å¤šçš„ç¡¬ä»¶è®¾å¤‡ï¼›æ ¹æ–‡ä»¶ç³»ç»Ÿå¯ä»¥æ˜¯xfsã€ext4ã€NFSç­‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼›ä¸ºäº†æˆåŠŸæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå†…æ ¸éœ€è¦å…·å¤‡ç›¸åº”çš„è®¾å¤‡é©±åŠ¨ã€æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œå¦‚æœä¸ºäº†å…¼å®¹æ‰€æœ‰çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå°†æ‰€æœ‰ç›¸å…³é©±åŠ¨ç¼–è¯‘è¿›å†…æ ¸ï¼Œä¼šå¢å¤§å†…æ ¸å¤§å°ï¼Œå¹¶åœ¨å®é™…ç¯å¢ƒä¸­å¼•å…¥ä¸€äº›æ— ç”¨çš„é©±åŠ¨ã€‚","text":"kernel version: 5.18(4b0986a3613c) æœ¬æ–‡ä¸­çš„å¤§éƒ¨åˆ†ä»£ç æ®µéƒ½æœ‰ä»£ç åˆ é™¤ ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿã€æ‰§è¡Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„initç¨‹åºå®Œæˆåˆ°ç”¨æˆ·ç©ºé—´çš„åˆ‡æ¢ã€‚ç„¶è€Œæ ¹æ–‡ä»¶ç³»ç»Ÿå¯èƒ½æ˜¯åœ¨ä¸åŒçš„ç¡¬ä»¶è®¾å¤‡ä¸Šï¼Œå¦‚SCSIç¡¬ç›˜ã€SATAç¡¬ç›˜ã€Flashè®¾å¤‡ç­‰ï¼Œåç»­ä¼šå‡ºç°æ›´å¤šçš„ç¡¬ä»¶è®¾å¤‡ï¼›æ ¹æ–‡ä»¶ç³»ç»Ÿå¯ä»¥æ˜¯xfsã€ext4ã€NFSç­‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼›ä¸ºäº†æˆåŠŸæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå†…æ ¸éœ€è¦å…·å¤‡ç›¸åº”çš„è®¾å¤‡é©±åŠ¨ã€æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œå¦‚æœä¸ºäº†å…¼å®¹æ‰€æœ‰çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå°†æ‰€æœ‰ç›¸å…³é©±åŠ¨ç¼–è¯‘è¿›å†…æ ¸ï¼Œä¼šå¢å¤§å†…æ ¸å¤§å°ï¼Œå¹¶åœ¨å®é™…ç¯å¢ƒä¸­å¼•å…¥ä¸€äº›æ— ç”¨çš„é©±åŠ¨ã€‚ initramfsä½œä¸ºä¸€ä¸ªè¿‡æ¸¡æ–‡ä»¶ç³»ç»Ÿè§£å†³äº†æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚å…¶ä¸­åŒ…å«äº†å¿…è¦çš„ç¡¬ä»¶è®¾å¤‡ã€æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ä»¥åŠé©±åŠ¨çš„åŠ è½½å·¥å…·åŠå…¶è¿è¡Œç¯å¢ƒã€‚initramfså¯ä»¥ç¼–è¯‘è¿›å†…æ ¸ä¹Ÿå¯ä»¥ä½œä¸ºå•ç‹¬æ–‡ä»¶ç”±bootloaderåŠ è½½å…¥å†…å­˜ï¼Œåœ¨å†…æ ¸åˆå§‹åŒ–çš„æœ€åé˜¶æ®µï¼Œä¼šè§£å‹initramfsï¼Œè¿è¡Œå…¶ä¸­çš„initç¨‹åºå®Œæˆæ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼Œå¹¶æ‰§è¡Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„initç¨‹åºï¼Œå®Œæˆå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„åˆ‡æ¢ã€‚ Linux kernel 2.6å¼•å…¥initramfsæœºåˆ¶ï¼Œä¹‹å‰ä½¿ç”¨initrdå®Œæˆä¸Šè¿°å·¥ä½œã€‚å½“å‰ä¸»æµLinuxå‘è¡Œç‰ˆé‡‡ç”¨initramfsæœºåˆ¶ï¼Œå†…æ ¸ä»å…¼å®¹initrdã€‚äººä»¬è¿˜æ˜¯ä¹ æƒ¯å°†initramfsç§°ä½œinitrdï¼Œæœ¬æ–‡ä¼šå¯¹äºŒè€…è¿›è¡Œä¸¥æ ¼çš„åŒºåˆ†ã€‚ initramfs vs initrdinitrdä¸initramfsä¹‹é—´çš„ä¸»è¦åŒºåˆ«æ˜¯initrdåŸºäºramdiskæœºåˆ¶ï¼Œè€ŒinitramfsåŸºäºramfsã€‚å†…æ ¸æ–‡æ¡£&lt;ramfs, rootfs and initramfs&gt;å¾ˆå¥½åœ°ä»‹ç»ã€å¯¹æ¯”äº†ä¸¤ç§æœºåˆ¶ï¼Œæœ¬æ–‡åœ¨åé¢å‡ å°èŠ‚ç®€è¦æ€»ç»“ã€‚ ramdisk ramfs tmpfs rootfsramdiskæ˜¯å°†å›ºå®šå¤§å°çš„å†…å­˜æ¨¡æ‹Ÿæˆå—è®¾å¤‡ï¼Œéœ€è¦æ–‡ä»¶ç³»ç»Ÿ(å¦‚ext2)æ ¼å¼åŒ–å—è®¾å¤‡ä»¥å­˜å–æ•°æ®ã€‚åŒå—è®¾å¤‡ä¸€æ ·ï¼Œramdiskçš„æ•°æ®è¯»å–ä¹Ÿä¼šç”¨åˆ°ç£ç›˜ç¼“å­˜æœºåˆ¶(disk caching mechanisms, â€œpage cacheâ€ for file data, â€œdentry cacheâ€ for directory entries)ã€‚æ˜¾ç„¶ï¼Œramdiskæœ‰äº›å¤šæ­¤ä¸€ä¸¾ï¼Œæ–‡ä»¶å®é™…å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†æ–‡ä»¶è¯»å–è¿˜è¦é€šè¿‡åŸºäºå†…å­˜çš„ç£ç›˜ç¼“å­˜ã€‚ramdiskæœºåˆ¶çš„ç¼ºç‚¹åŸæ–‡æ¦‚æ‹¬çš„ååˆ†ç²¾å‡†ï¼š this wastes memory (and memory bus bandwidth), creates unnecessary work for the CPU, and pollutes the CPU caches. (There are tricks to avoid this copying by playing with the page tables, but theyâ€™re unpleasantly complicated and turn out to be about as expensive as the copying anyway. æ—¢ç„¶è®¿é—®æ–‡ä»¶éƒ½è¦ç»è¿‡ç£ç›˜cacheï¼Œä¸ºä½•ä¸ç›´æ¥å°†æ–‡ä»¶ä¿å­˜åœ¨ç£ç›˜cacheï¼ŸLinuså®ç°äº†ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿ(dummy filesystem)ramfsï¼Œå®Œæˆäº†æœ€ä½é™åº¦çš„VFSæ¥å£å®ç°ï¼Œå³æ–‡ä»¶åˆ›å»ºæ—¶èƒ½å¤Ÿåœ¨inode cacheä¸­åˆ›å»ºç›¸åº”çš„inodeå’Œdentryï¼Œå¹¶å°†æ–‡ä»¶ç›´æ¥ä¿å­˜åœ¨ç£ç›˜cacheä¸­ã€‚å­˜å‚¨æ–‡ä»¶çš„é¡µé¢ä¸ä¼šè¢«æ ‡è®°ä¸ºcleanï¼Œå› æ­¤ä¿å­˜åœ¨ç£ç›˜cacheä¸­çš„æ–‡ä»¶é¡µé¢ä¸ä¼šè¢«å›æ”¶ï¼Œé™¤éæ–‡ä»¶è¢«åˆ é™¤ã€‚ ramfsæœ‰ä¸¤ä¸ªæ˜¾è‘—çš„ç¼ºç‚¹ï¼š å†…å­˜å ç”¨æ— é™åˆ¶ï¼Œåªè¦æ„¿æ„å¾€ramfså­˜å‚¨æ•°æ®ï¼Œæ–‡ä»¶ä¾¿ä¼šå ç”¨å†…å­˜ï¼Œè€Œä¸å—é™ åŸºäºä¸Šä¸€ç‚¹ï¼Œåªæœ‰rootç”¨æˆ·èƒ½å¤Ÿåœ¨ramfsä¸­è¯»/å†™æ•°æ® ç¤¾åŒºåœ¨ramfsçš„åŸºç¡€ä¸Šå¼€å‘äº†tmpfsï¼Œtmpfså¢åŠ äº†size limitsï¼Œä¸èƒ½æ— é™åˆ¶åœ°å¾€å†…å­˜ä¸­å†™æ–‡ä»¶ï¼›å¹¶æ”¯æŒå°†ç£ç›˜ç¼“å­˜ä¸­çš„æ–‡ä»¶æ•°æ®å†™å…¥swapç©ºé—´ã€‚å› æ­¤ï¼Œtmpfsæ”¯æŒæ™®é€šç”¨æˆ·è®¿é—®å…¶æŒ‚è½½ç‚¹ã€‚ initramfsçš„æ–‡ä»¶ç±»å‹æ˜¯cpioå½’æ¡£ä»¶çš„gzipå‹ç¼©ç±»å‹ï¼Œå³cpio.gzã€‚rootfsæ˜¯ramfsï¼ˆæˆ–è€…tmpfsï¼‰çš„ä¸€ä¸ªç‰¹æ®Šç¤ºä¾‹ï¼Œinitramfsä¸­çš„æ–‡ä»¶ä¼šè¢«è§£å‹åˆ°rootfsä¸­ã€‚å½“CONFIG_TMPFSé…ç½®æ—¶ï¼Œé»˜è®¤ä½¿ç”¨tmpfsä»£æ›¿ramfsä½œä¸ºrootfsã€‚è‹¥éœ€è¦å¼ºåˆ¶ä½¿ç”¨ramfsä½œä¸ºrootfsï¼Œå¯ä»¥é€šè¿‡å†…æ ¸å¯åŠ¨é¡¹å‚æ•°rootfstype=ramfsæŒ‡å®šã€‚ rootfsæŒ‚è½½1234567891011start_kernel|-&gt; vfs_caches_init | -&gt; mnt_init | -&gt; init_rootfs // åˆ¤æ–­rootfsç±»å‹æ˜¯å¦ä¸ºtmpfs -&gt; init_mount_tree // æŒ‚è½½rootfs-&gt; arch_call_rest_init | -&gt; rest_init // åˆ›å»º1å·è¿›ç¨‹ã€2å·è¿›ç¨‹ init_rootfsåŒæ—¶æ»¡è¶³å¦‚ä¸‹æ¡ä»¶æ—¶ä¾¿ä»¥tmpfsä½œä¸ºrootfs: CONFIG_TMPFSé…ç½® æœªé€šè¿‡rootå†…æ ¸å¯åŠ¨é¡¹å‚æ•°æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡ æœªé€šè¿‡rootfstypeå†…æ ¸å¯åŠ¨é¡¹å‚æ•°æŒ‡å®šrootfsç±»å‹æˆ–è€…æŒ‡å®šç±»å‹å°±æ˜¯tmpfs 12345678910111213141516171819202122232425static int rootfs_init_fs_context(struct fs_context *fc)&#123; if (IS_ENABLED(CONFIG_TMPFS) &amp;&amp; is_tmpfs) return shmem_init_fs_context(fc); return ramfs_init_fs_context(fc);&#125;struct file_system_type rootfs_fs_type = &#123; .name = &quot;rootfs&quot;, .init_fs_context = rootfs_init_fs_context, .kill_sb = kill_litter_super,&#125;;static void __init init_mount_tree(void)&#123; ... struct vfsmount *mnt = vfs_kern_mount(&amp;rootfs_fs_type, 0, &quot;rootfs&quot;, NULL); struct mnt_namespace *ns = alloc_mnt_ns(&amp;init_user_ns, false); m = real_mount(mnt); m-&gt;mnt_ns = ns; ns-&gt;root = m; init_task.nsproxy-&gt;mnt_ns = ns; ...&#125; init_mount_treeå®ŒæˆrootfsæŒ‚è½½ï¼Œè‹¥rootfsä¸ºtmpfsï¼Œåˆ™ä½¿ç”¨shmem_init_fs_contextåˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ã€‚å¹¶åˆå§‹åŒ–0å·è¿›ç¨‹init_taskçš„mnt_namespace(mntå‘½åç©ºé—´)ä¸ºrootfsã€‚ rest_initåˆ›å»º1å·è¿›ç¨‹å’Œ2å·è¿›ç¨‹ï¼Œ1å·è¿›ç¨‹æ˜¯initè¿›ç¨‹ï¼Œå®Œæˆåç»­çš„ç³»ç»Ÿåˆå§‹åŒ–å·¥ä½œï¼Œæœ€ç»ˆå®Œæˆå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„åˆ‡æ¢ï¼›2å·è¿›ç¨‹æ˜¯kthreaddè¿›ç¨‹ï¼Œè´Ÿè´£å®Œæˆå†…æ ¸kernel_threadåˆ›å»ºè¿›ç¨‹çš„å·¥ä½œã€‚ 12345ps -efUID PID PPID C STIME TTY TIME CMDroot 1 0 0 Jun17 ? 00:00:40 /usr/lib/systemd/systemd --switched-root --system --droot 2 0 0 Jun17 ? 00:00:01 [kthreadd]... pså‘½ä»¤æŸ¥çœ‹åˆ°çš„1å·è¿›ç¨‹æ˜¯åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ä¹‹åçš„systemdè¿›ç¨‹ï¼Œå¹¶éå½“å‰rest_initåˆ›å»ºçš„1å·è¿›ç¨‹ã€‚ 123456789noinline void __ref rest_init(void)&#123; ... pid = kernel_thread(kernel_init, NULL, CLONE_FS); pid = kernel_thread(kthreadd, NULL, CLONE_FS | CLONE_FILES); ... complete(&amp;kthreadd_done); ...&#125; kernel_init process covers allkernel_initåœ¨æ‰§è¡Œä¹‹å¤„è°ƒç”¨wait_for_completion(&amp;kthreadd_done)ï¼Œå³ç­‰å¾…2å·è¿›ç¨‹åˆ›å»ºå¹¶åˆå§‹åŒ–æˆåŠŸä¹‹åæ‰å¼€å§‹åç»­å·¥ä½œï¼š 12345678910111213kernel_init|-&gt; kernel_init_freeable | -&gt; do_basic_setup | -&gt; do_initcalls -&gt; wait_for_initramfs -&gt; console_on_rootfs // æ‰“å¼€/dev/consoleï¼Œåˆ›å»ºæ ‡å‡†è¾“å…¥(0)ã€æ ‡å‡†è¾“å‡º(1)ã€æ ‡å‡†é”™è¯¯(2)æ–‡ä»¶æè¿°ç¬¦ -&gt; init_eaccess(ramdisk_execute_command) // æ£€æŸ¥å½“å‰rootfsä¸­æ˜¯å¦å­˜åœ¨&#x27;/init&#x27; \\_ (NO) prepare_namespace // é€šè¿‡initrdå®Œæˆå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½è‡³rootfsæ ¹ç›®å½•/-&gt; run_init_process(ramdisk_execute_command|execute_command|CONFIG_DEFAULT_INIT)-&gt; try_to_run_init_process(&quot;/sbin/init&quot;|&quot;/etc/init&quot;|&quot;/bin/init&quot;|&quot;/bin/sh&quot;) kernel_init_freeableå®Œæˆå†…æ ¸éƒ¨åˆ†å­ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¦‚workqueueã€å¯åŠ¨å…¶ä»–CPUã€SMPåˆå§‹åŒ–ç­‰æ“ä½œã€‚å¾…æ‰€æœ‰CPUä¸Šçº¿ã€è¿›ç¨‹ã€å†…å­˜æ ¸å¿ƒå­ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œè°ƒç”¨do_basic_setupå®Œæˆå…¶ä»–åˆå§‹åŒ–æ“ä½œï¼Œå…¶ä¸­åŒ…æ‹¬do_initcallsæ‰§è¡Œinitæ®µä¸­çš„å‡½æ•°å³è°ƒç”¨initcallå›è°ƒå‡½æ•°ï¼Œpopulate_rootfsè°ƒç”¨do_populate_rootfså®Œæˆinitramfsè§£å‹åˆ°rootfsçš„å·¥ä½œï¼Œæˆ–è€…é€šè¿‡prepare_namespaceé€šè¿‡initrdå®Œæˆå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚é€šè¿‡run_init_processå¯åŠ¨å¯æ‰§è¡Œç¨‹åºï¼Œå®Œæˆä»å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„åˆ‡æ¢ï¼Œå¯ä»¥æ˜¯å¦‚ä¸‹ç¨‹åºï¼š var initial value kernel cmdline/CONFIG description ramdisk_execute_command â€œ/initâ€ â€œrdinit=â€ Run specified binary instead of /init from the ramdisk,used for early userspace startup. execute_command NULL â€œinit=â€ Run specified binary instead of /sbin/init as init process. CONFIG_DEFAULT_INIT â€œâ€ CONFIG_DEFAULT_INIT Default init path å¦‚æœä¸Šè¿°è·¯å¾„çš„initç¨‹åºæœªæˆåŠŸæ‰§è¡Œï¼Œåˆ™ä¾æ¬¡å°è¯•è¿è¡Œå¦‚ä¸‹ç¨‹åºï¼š/sbin/initã€/etc/initã€/bin/initã€/bin/shã€‚é€šè¿‡initramfsè¿‡æ¸¡å’Œé€šè¿‡initrdè¿‡æ¸¡è·å¾—çš„initç¨‹åºèŒè´£æ˜¯ä¸åŒçš„ã€‚é€šè¿‡initrdè¿‡æ¸¡ï¼Œç”±äºå·²ç»å®Œæˆäº†å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼Œè¿™é‡Œè¿è¡Œçš„initç¨‹åºæ˜¯å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„initç¨‹åºã€‚ç„¶è€Œï¼Œinitramfsè¿‡æ¸¡å¾—åˆ°çš„initç¨‹åºè¿˜è‚©è´Ÿç€æŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„è´£ä»»ï¼ initramfs unpack123456789101112131415161718void wait_for_initramfs(void)&#123; if (!initramfs_cookie) return; async_synchronize_cookie_domain(initramfs_cookie + 1, &amp;initramfs_domain);&#125;EXPORT_SYMBOL_GPL(wait_for_initramfs);static int __init populate_rootfs(void)&#123; initramfs_cookie = async_schedule_domain(do_populate_rootfs, NULL, &amp;initramfs_domain); usermodehelper_enable(); if (!initramfs_async) wait_for_initramfs(); return 0;&#125;rootfs_initcall(populate_rootfs); async_schedule_domainã€async_synchronize_cookie_domainæ˜¯å†…æ ¸çš„å¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œé€šè¿‡å¹¶è¡ŒåŒ–initramfsçš„è§£å‹å·¥ä½œåŠ å¿«å†…æ ¸å¯åŠ¨ï¼š async_schedule_domainï¼šè°ƒåº¦å‡½æ•°å¼‚æ­¥æ‰§è¡Œï¼Œè¿”å›å¼‚æ­¥æ‰§è¡Œå‡½æ•°çš„async cookie async_synchronize_cookie_domain: åŒæ­¥å°äºasync cookieçš„å¼‚æ­¥å‡½æ•°æ‰§è¡Œ é»˜è®¤æƒ…å†µä¸‹ï¼Œinitramfsè§£å‹æ“ä½œdo_populate_rootfsä¼šè¢«å¼‚æ­¥æ‰§è¡Œï¼›è°ƒç”¨wait_for_initramfså‡½æ•°ç­‰å¾…initramfsè§£å‹æ“ä½œå®Œæˆã€‚ä¹Ÿå¯ä»¥é€šè¿‡å†…æ ¸å¯åŠ¨é¡¹å‚æ•°initramfs_async=falseå°†initramfsè§£å‹æµç¨‹å˜æ›´ä¸ºé¡ºåºæ‰§è¡Œã€‚ 12345678910111213141516171819202122232425static void __init do_populate_rootfs(void *unused, async_cookie_t cookie)&#123; /* Load the built in initramfs */ char *err = unpack_to_rootfs(__initramfs_start, __initramfs_size); if (!initrd_start || IS_ENABLED(CONFIG_INITRAMFS_FORCE)) goto done; err = unpack_to_rootfs((char *)initrd_start, initrd_end - initrd_start); if (err) &#123;#ifdef CONFIG_BLK_DEV_RAM populate_initrd_image(err);#else printk(KERN_EMERG &quot;Initramfs unpacking failed: %s\\n&quot;, err);#endif &#125;done: if (!do_retain_initrd &amp;&amp; initrd_start &amp;&amp; !kexec_free_initrd()) free_initrd_mem(initrd_start, initrd_end); initrd_start = 0; initrd_end = 0; flush_delayed_fput();&#125; do_populate_rootfså°†initramfs/initrdè§£å‹åˆ°rootfsä¸­ï¼š å°†é“¾æ¥è¿›å†…æ ¸çš„initramfsè§£å‹è‡³rootfsä¸­ï¼Œé“¾æ¥åˆ°å†…æ ¸çš„initramfsåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€æ˜¯__initramfs_startï¼Œå¤§å°æ˜¯__initramfs_size è‹¥å†…æ ¸æœªé…ç½®CONFIG_INITRAMFS_FORCEï¼ˆå¿½ç•¥bootloaderä¼ å…¥çš„initramfsï¼‰ä¸”(é€šè¿‡initrd=&lt;path&gt;æˆ–è€…initrdmem=&lt;physical addr&gt;)æŒ‡å®šäº†initramfsåœ°å€(initrd_startä¸ä¸º0)ï¼Œåˆ™å°†æŒ‡å®šçš„initramfsè§£å‹è‡³rootfsä¸­ï¼Œå¦åˆ™ç›´æ¥è·³è‡³4 è‹¥2ä¸­çš„initramfsè§£å‹å¤±è´¥ï¼Œåˆ™è®¤ä¸º2ä¸­è§£å‹çš„imageä¸æ˜¯initramfsï¼Œè€Œæ˜¯initrdã€‚è°ƒç”¨populate_initrd_imageåœ¨rootfsä¸­åˆ›å»º/initrd.imageæ–‡ä»¶ï¼Œå¹¶å°†initrdçš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ å¦‚æœæ²¡é…ç½®å†…æ ¸å¯åŠ¨é¡¹å‚æ•°retain_initrdã€keepinitrdï¼Œè€Œä¸”æŒ‡å®šäº†initramfsåœ°å€ï¼Œåˆ™è°ƒç”¨kexec_free_initrdé‡Šæ”¾initramfsä¸crashkernelä¸é‡å éƒ¨åˆ†çš„å†…å­˜åŒºåŸŸï¼Œè‹¥ä¸¤è€…æ— é‡å ï¼Œåˆ™å®Œå…¨é‡Šæ”¾æŒ‡å®šçš„initramfså†…å­˜åŒºåŸŸ __initramfs_startåœ¨include/asm-generic/vmlinux.lds.hä¸­å®šä¹‰ï¼Œåœ¨include/linux/initrd.hä¸­å¯¹å¤–å£°æ˜ï¼Œå†…æ ¸åŒ…å«include/linux/initrd.hæ–‡ä»¶ï¼Œå³å¯è®¿é—®__initramfs_startå˜é‡ï¼š 123456789101112131415161718192021222324252627282930include/linux/initrd.h:extern char __initramfs_start[];include/asm-generic/vmlinux.lds.h:#ifdef CONFIG_BLK_DEV_INITRD#define INIT_RAM_FS \\ . = ALIGN(4); \\ __initramfs_start = .; \\ KEEP(*(.init.ramfs)) \\ . = ALIGN(8); \\ KEEP(*(.init.ramfs.info))#else#define INIT_RAM_FS#endifarch/x86/kernel/vmlinux.lds.S:#include &lt;asm-generic/vmlinux.lds.h&gt;arch/x86/boot/compressed/vmlinux.lds.S:#include &lt;asm-generic/vmlinux.lds.h&gt;scripts/Makefile.build:# Linker scripts preprocessor (.lds.S -&gt; .lds)# ---------------------------------------------------------------------------quiet_cmd_cpp_lds_S = LDS $@ cmd_cpp_lds_S = $(CPP) $(cpp_flags) -P -U$(ARCH) \\ -D__ASSEMBLY__ -DLINKER_SCRIPT -o $@ $&lt;$(obj)/%.lds: $(src)/%.lds.S FORCE $(call if_changed_dep,cpp_lds_S) vmlinux.ldsæ˜¯å†…æ ¸æ„å»ºè¿‡ç¨‹æ‰€ä½¿ç”¨çš„é“¾æ¥è„šæœ¬ï¼Œè¿™é‡Œvmlinux.ldsé€šè¿‡vmlinux.lds.Sé¢„ç¼–è¯‘ç”Ÿæˆï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨æ¡ä»¶ç¼–è¯‘ï¼Œæ ¹æ®ä¸åŒçš„å†…æ ¸é…ç½®ç”Ÿæˆä¸åŒçš„é“¾æ¥è„šæœ¬ã€‚å‚è€ƒå†…æ ¸æ–‡æ¡£Documentation/kbuild/makefiles.rst When the vmlinux image is built, the linker script arch/$(SRCARCH)/kernel/vmlinux.lds is used. The script is a preprocessed variant of the file vmlinux.lds.S located in the same directory. kbuild knows .lds files and includes a rule `*lds.S` -&gt; `*lds`. Example:: #arch/x86/kernel/Makefile extra-y := vmlinux.lds The assignment to extra-y is used to tell kbuild to build the target vmlinux.lds. The assignment to $(CPPFLAGS_vmlinux.lds) tells kbuild to use the specified options when building the target vmlinux.lds. When building the `*.lds` target, kbuild uses the variables:: KBUILD_CPPFLAGS : Set in top-level Makefile cppflags-y : May be set in the kbuild makefile CPPFLAGS_$(@F) : Target-specific flags. Note that the full filename is used in this assignment. The kbuild infrastructure for `*lds` files is used in several architecture-specific files. Documentation/kbuild/makefiles.rstè¿æ¥è„šæœ¬å®šä¹‰äº†ç¬¦å·__initramfs_startæ‰€åœ¨åœ°å€ï¼š special symbol â€˜.â€™, which is the location counter. é“¾æ¥è„šæœ¬å®šä¹‰çš„ç¬¦å·ä¸æ™®é€šç¬¦å·ï¼ˆåœ¨ç¨‹åºä¸­å®šä¹‰çš„ç¬¦å·ï¼‰çš„åŒºåˆ«æ˜¯é“¾æ¥è„šæœ¬ä¸­çš„ç¬¦å·ä»…ä»£è¡¨ä¸€ä¸ªåœ°å€ï¼Œè€Œæ™®é€šç¬¦å·ä¸ä»…ä»£è¡¨ä¸€ä¸ªåœ°å€ï¼Œè¿˜æœ‰è¯¥åœ°å€çš„å†…å­˜ç©ºé—´ã€‚ å…³äºinitrdå†…æ ¸å¯åŠ¨é¡¹å‚æ•°å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›å›°æƒ‘ï¼Œå…ˆæŸ¥çœ‹å†…æ ¸æ–‡æ¡£ä¸­çš„ä»‹ç»ï¼š 123456789Documentation/admin-guide/initrd.rst: initrd=&lt;path&gt; (e.g. LOADLIN) Loads the specified file as the initial RAM disk. When using LILO, you have to specify the RAM disk image file in /etc/lilo.conf, using the INITRD configuration variable.Documentation/admin-guide/kernel-parameters.txt: initrd= [BOOT] Specify the location of the initial ramdisk ç›¸åº”å†…æ ¸å¯åŠ¨é¡¹å‚æ•°çš„ä»£ç ï¼š 1234567891011121314151617181920212223init/do_mounts_initrd.c:static int __init early_initrdmem(char *p) &#123; phys_addr_t start; unsigned long size; char *endp; start = memparse(p, &amp;endp); if (*endp == &#x27;,&#x27;) &#123; size = memparse(endp + 1, NULL); phys_initrd_start = start; phys_initrd_size = size; &#125; return 0;&#125;early_param(&quot;initrdmem&quot;, early_initrdmem);static int __init early_initrd(char *p) &#123; return early_initrdmem(p);&#125;early_param(&quot;initrd&quot;, early_initrd); å†…æ ¸ä»£ç ä¸­çš„initrdå†…æ ¸å¯åŠ¨é¡¹å‚æ•°å°±æ˜¯initrdmemå†…æ ¸å¯åŠ¨é¡¹å‚æ•°ï¼ŒæŒ‡å®šinitramfsçš„ç‰©ç†åœ°å€ã€‚é‚£ä¹ˆDocumentation/admin-guide/initrd.rstä¸­æè¿°initrd=&lt;path&gt;çš„å†…æ ¸å¯åŠ¨é¡¹å‚æ•°æ˜¯ä¸æ˜¯é”™è¯¯å‘¢ï¼Ÿ éä¹Ÿï¼Œä»x86_64å’Œarm64ä¸­initrd_startèµ‹å€¼è¿›è¡Œæ’æŸ¥ï¼Œåº”è¯¥èƒ½å‘ç°ç«¯å€ªï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667x86_64:static u64 __init get_ramdisk_image(void)&#123; u64 ramdisk_image = boot_params.hdr.ramdisk_image; ramdisk_image |= (u64)boot_params.ext_ramdisk_image &lt;&lt; 32; if (ramdisk_image == 0) ramdisk_image = phys_initrd_start; return ramdisk_image;&#125;static void __init reserve_initrd(void)&#123; /* Assume only end is not page aligned */ u64 ramdisk_image = get_ramdisk_image(); u64 ramdisk_size = get_ramdisk_size(); u64 ramdisk_end = PAGE_ALIGN(ramdisk_image + ramdisk_size); if (!boot_params.hdr.type_of_loader || !ramdisk_image || !ramdisk_size) return; /* No initrd provided by bootloader */ initrd_start = 0; printk(KERN_INFO &quot;RAMDISK: [mem %#010llx-%#010llx]\\n&quot;, ramdisk_image, ramdisk_end - 1); if (pfn_range_is_mapped(PFN_DOWN(ramdisk_image), PFN_DOWN(ramdisk_end))) &#123; /* All are mapped, easy case */ initrd_start = ramdisk_image + PAGE_OFFSET; initrd_end = initrd_start + ramdisk_size; return; &#125; relocate_initrd(); memblock_phys_free(ramdisk_image, ramdisk_end - ramdisk_image);&#125;arm64:static void __init early_init_dt_check_for_initrd(unsigned long node)&#123; ... prop = of_get_flat_dt_prop(node, &quot;linux,initrd-start&quot;, &amp;len); start = of_read_number(prop, len/4); prop = of_get_flat_dt_prop(node, &quot;linux,initrd-end&quot;, &amp;len); end = of_read_number(prop, len/4); __early_init_dt_declare_initrd(start, end); phys_initrd_start = start; phys_initrd_size = end - start;&#125;void __init arm64_memblock_init(void)&#123; ... if (IS_ENABLED(CONFIG_BLK_DEV_INITRD) &amp;&amp; phys_initrd_size) &#123; /* the generic initrd code expects virtual addresses */ initrd_start = __phys_to_virt(phys_initrd_start); initrd_end = initrd_start + phys_initrd_size; &#125; ...&#125; x86_64å¹³å°ä¸‹ï¼Œbootloaderå¯åŠ¨å†…æ ¸éµå¾ªLinux/x86 Boot Protocolï¼Œçº¦æŸäº†åŠ è½½åˆ°å†…æ ¸çš„å†…å­˜å¸ƒå±€ï¼Œä¹Ÿè§„å®šäº†bootloaderä¸å†…æ ¸äº¤äº’æ¥å£ã€‚x86 64bit boot protocolè§„å®šï¼ŒbootloaderåŠ è½½å†…æ ¸ä¼šåˆå§‹åŒ–æ¸…é›¶boot parametersï¼ˆstruct boot_paramsï¼Œä¹Ÿç§°ä¸ºzero pageï¼‰ï¼›éšåè¯»å–å†…æ ¸çš„Real-Mode kernel header(struct setup_headerï¼Œå†…æ ¸é•œåƒ0x01f1åç§»å¤„)è‡³zero pageçš„setup_headerï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œbootloaderå®Œæˆinitramfsåœ°å€çš„è®¾ç½®ã€‚arm64å¹³å°é€šè¿‡FDT(flatten device tree)ä¸­çš„chosenèŠ‚ç‚¹è®¾ç½®å†…æ ¸å¯åŠ¨é¡¹å‚æ•°(bootargs)ä»¥åŠinitramfs(initrd-startã€initrd-end)[1]ã€‚ Compatible with initrdinitramfsè§£å‹å®Œæˆä¹‹åï¼Œæ£€æŸ¥rootfsä¸­æ˜¯å¦å­˜åœ¨early userspace startup initç¨‹åºã€‚å†…æ ¸å˜é‡ramdisk_execute_commandæŒ‡å®šinitç¨‹åºè·¯å¾„ï¼Œé»˜è®¤æ˜¯/initï¼Œä¹Ÿå¯ä»¥é€šè¿‡rdinit=&lt;full_path&gt;å†…æ ¸å¯åŠ¨é¡¹å‚æ•°æŒ‡å®šç¨‹åºè·¯å¾„ã€‚è‹¥rootfsä¸­ä¸å­˜åœ¨initç¨‹åºï¼Œåˆ™è®¤ä¸ºæŒ‡å®šçš„æ˜¯initrdï¼Œè€Œéinitramfsã€‚ä¹‹å‰é€šè¿‡è§£å‹initramfsçš„æ–¹å¼è§£å‹initrdä¸æˆåŠŸï¼Œåˆ™å½“å‰rootfsä¸­è‡ªç„¶ä¸å­˜åœ¨initç¨‹åºï¼Œè§do_populate_rootfsä¸­çš„æµç¨‹3ã€‚éœ€è¦è°ƒç”¨prepare_namespaceé€šè¿‡initrdå®Œæˆå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚ 1234567891011121314151617181920212223242526272829303132void __init prepare_namespace(void)&#123; ... wait_for_device_probe(); // ç­‰å¾…è®¾å¤‡åˆå§‹åŒ–å®Œæˆ md_run_setup(); // åˆå§‹åŒ–MDè®¾å¤‡ï¼ˆè½¯raidï¼‰ if (saved_root_name[0]) &#123; root_device_name = saved_root_name; if (!strncmp(root_device_name, &quot;mtd&quot;, 3) || !strncmp(root_device_name, &quot;ubi&quot;, 3)) &#123; mount_block_root(root_device_name, root_mountflags); goto out; &#125; ROOT_DEV = name_to_dev_t(root_device_name); if (strncmp(root_device_name, &quot;/dev/&quot;, 5) == 0) root_device_name += 5; &#125; // é€šè¿‡initrdæŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»ŸæˆåŠŸï¼Œåˆ™è¿”å›true if (initrd_load()) goto out; // é€šè¿‡initrdæŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿä¸æˆåŠŸï¼Œæˆ–è€…ramdiskå°±æ˜¯å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ™ç›´æ¥å°è¯•å¯¹æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ mount_root();out: // æŒ‚è½½devtmpfs devtmpfs_mount(); // å°†å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„å†…å®¹ç§»åŠ¨åˆ°rootfsçš„æ ¹ç›®å½•/ä¸‹ init_mount(&quot;.&quot;, &quot;/&quot;, NULL, MS_MOVE, NULL); init_chroot(&quot;.&quot;);&#125; saved_root_nameå˜é‡ä¿å­˜æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡ï¼Œç”±å†…æ ¸å¯åŠ¨é¡¹å‚æ•°root=æŒ‡å®šï¼Œé»˜è®¤ä¸ºç©ºã€‚saved_root_nameå­˜åœ¨ä¸¤ç§æƒ…å†µ: è‹¥æ ¹æ–‡ä»¶ç³»ç»Ÿå­˜åœ¨äºmtd/ubiè®¾å¤‡ï¼Œé©±åŠ¨ç¨‹åºåœ¨å†…æ ¸åˆå§‹åŒ–é˜¶æ®µå·²ç»å®‰è£…ï¼Œå¯ä»¥ç›´æ¥æŒ‚è½½ï¼Œæ— éœ€initrdè¿‡æ¸¡æ–‡ä»¶ç³»ç»Ÿ æ ¹æ–‡ä»¶ç³»ç»Ÿå­˜åœ¨äºå…¶ä»–è®¾å¤‡ï¼Œåˆ™éœ€å…ˆæŒ‚è½½å…ˆæŒ‚è½½initrdè¿‡æ¸¡ï¼Œæ’å…¥å­˜å‚¨åœ¨initrdæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨å­˜å‚¨è®¾å¤‡çš„é©±åŠ¨ï¼Œæœ€åå†æŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ªè¿‡ç¨‹ç”±initrd_loadå®Œæˆã€‚ initrd_loadå¯ä»¥æ‹†åˆ†ä¸ºå¦‚ä¸‹ä¸¤æ­¥ï¼š rd_load_imageå°†initrdè§£å‹/è¯»å…¥åˆ°ramdiskä¸­(/dev/ramè®¾å¤‡èŠ‚ç‚¹) handle_initrdå®Œæˆå®é™…æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788int __init rd_load_image(char *from)&#123; ... out_file = filp_open(&quot;/dev/ram&quot;, O_RDWR, 0); in_file = filp_open(from, O_RDONLY, 0); // é€šè¿‡å†…æ ¸å¯åŠ¨é¡¹å‚æ•°ramdisk_startæŒ‡å®šramdiskåœ¨initrd imageä¸­çš„èµ·å§‹åœ°å€(offset)ï¼Œé»˜è®¤å€¼ä¸º0 in_pos = rd_image_start * BLOCK_SIZE; nblocks = identify_ramdisk_image(in_file, in_pos, &amp;decompressor); if (nblocks &lt; 0) goto done; if (nblocks == 0) &#123; if (crd_load(decompressor) == 0) goto successful_load; goto done; &#125; // rd_blocksè¡¨ç¤º/dev/ram ramdiskå®é™…å¤§å° rd_blocks = nr_blocks(out_file); // initrd imageä¸­è¦è¯»å…¥çš„å¤§å°è¶…è¿‡äº†ramdiskçš„å¤§å° if (nblocks &gt; rd_blocks) &#123; printk(&quot;RAMDISK: image too big! (%dKiB/%ldKiB)\\n&quot;, nblocks, rd_blocks); goto done; &#125; buf = kmalloc(BLOCK_SIZE, GFP_KERNEL); for (i = 0; i &lt; nblocks; i++) &#123; kernel_read(in_file, buf, BLOCK_SIZE, &amp;in_pos); kernel_write(out_file, buf, BLOCK_SIZE, &amp;out_pos); &#125; ...&#125;static void __init handle_initrd(void)&#123;... // real_root_devç¼–ç ä¿å­˜å®é™…æ ¹è®¾å¤‡ real_root_dev = new_encode_dev(ROOT_DEV); // åˆ›å»ºRoot_RAM0çš„è®¾å¤‡æ–‡ä»¶/dev/root.old create_dev(&quot;/dev/root.old&quot;, Root_RAM0); // å°†initrdæŒ‚è½½åˆ°rootfsçš„rootç›®å½• mount_block_root(&quot;/dev/root.old&quot;, root_mountflags &amp; ~MS_RDONLY); // åˆ›å»º/root/oldç›®å½• init_mkdir(&quot;/old&quot;, 0700); init_chdir(&quot;/old&quot;); // æ‰§è¡Œç”¨æˆ·æ€ç¨‹åº/root/linuxrcåŠ è½½é©±åŠ¨æ¨¡å— info = call_usermodehelper_setup(&quot;/linuxrc&quot;, argv, envp_init, GFP_KERNEL, init_linuxrc, NULL, NULL); call_usermodehelper_exec(info, UMH_WAIT_PROC);... /* move initrd to rootfs&#x27; /old */ // å°†/rootæŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶ç§»åŠ¨åˆ°/root/oldç›®å½•ä¸‹ï¼šmount --move olddir newdir init_mount(&quot;..&quot;, &quot;.&quot;, NULL, MS_MOVE, NULL); // å°†/rootç›®å½•åˆ‡æ¢ä¸ºç³»ç»Ÿçš„æ ¹ç›®å½• init_chroot(&quot;..&quot;); // å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡æ˜¯å¦æ˜¯Root_RAM0 if (new_decode_dev(real_root_dev) == Root_RAM0) &#123; // åˆ‡æ¢åˆ°/oldç›®å½•ï¼Œå› ä¸º/oldç›®å½•å°±æ˜¯/dev/ramè®¾å¤‡å­˜å‚¨çš„å†…å®¹ init_chdir(&quot;/old&quot;); return; &#125; init_chdir(&quot;/&quot;); ROOT_DEV = new_decode_dev(real_root_dev); // å°†å®é™…æ ¹è®¾å¤‡æŒ‚è½½åˆ°/rootç›®å½• mount_root(); // å°†/oldæŒ‚è½½ç‚¹çš„å†…å®¹ç§»åŠ¨åˆ°/root/initrdç›®å½•ä¸‹æ˜¾ç¤º error = init_mount(&quot;/old&quot;, &quot;/root/initrd&quot;, NULL, MS_MOVE, NULL);&#125;bool __init initrd_load(void)&#123; if (mount_initrd) &#123; // åˆ›å»º/dev/ramè®¾å¤‡èŠ‚ç‚¹ï¼Œä»£è¡¨è®¾å¤‡ç¼–å·Root_RAM0 create_dev(&quot;/dev/ram&quot;, Root_RAM0); // å¦‚æœ/initrd.imageä¸­å­˜åœ¨initrdï¼Œå°†å…¶è£…è½½åˆ°/dev/ramä¸­ï¼Œä¸”/dev/ramä¸æ˜¯æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ if (rd_load_image(&quot;/initrd.image&quot;) &amp;&amp; ROOT_DEV != Root_RAM0) &#123; init_unlink(&quot;/initrd.image&quot;); handle_initrd(); return true; &#125; &#125; init_unlink(&quot;/initrd.image&quot;); // åˆ é™¤æ–‡ä»¶/initrd.image return false;&#125; mount_initrdåˆå§‹å€¼ä¸º1ï¼Œè¡¨ç¤ºæ˜¯å¦åŠ è½½initrdã€‚é€šè¿‡noinitrdå†…æ ¸å¯åŠ¨é¡¹å‚æ•°è®¾ç½®mount_initrdä¸º0ï¼Œè¡¨ç¤ºå†…æ ¸ä¸åŠ è½½ä»»ä½•é…ç½®çš„initrdã€‚rd_load_imageå°†initrdè¯»å…¥åˆ°å†…å­˜è™šæ‹Ÿçš„ramdiskä¸­ã€‚initrdå¯èƒ½è¢«å‹ç¼©å¤„ç†ï¼Œæ ¹æ®identify_ramdisk_imageè¿”å›å€¼initrdæ˜¯å¦è¢«å‹ç¼©ï¼š -1, initdä¸­çš„magic numberæœ‰è¯¯ 0ï¼Œinitrdè¢«å‹ç¼©ï¼Œéšåè°ƒç”¨crd_load(decompressor)è§£å‹initrdåˆ°/dev/ram nblocks(&gt; 0)ï¼Œinitrdæœªè¢«å‹ç¼©ï¼Œnblocksè¡¨ç¤ºinitrdçš„å¤§å°ï¼Œä»¥block(1024byte)ä¸ºå•ä½è¡¨ç¤ºï¼Œéšåç›´æ¥ä»/initrd.imageè¯»å…¥åˆ°/dev/ram initrdå¯ä»¥æ˜¯minixã€ext2ã€romfsã€cramfsã€squashfsæ–‡ä»¶ç³»ç»Ÿã€‚å‹ç¼©ç®—æ³•æ”¯æŒgzipã€bzip2ã€lzmaã€xzã€lzoã€lz4ã€‚ handle_initrdé¦–å…ˆå°†è½½æœ‰initrdçš„ramdiskæŒ‚è½½åˆ°rootfsçš„/rootç›®å½•ï¼Œéšåæ‰§è¡Œç”¨æˆ·æ€ç¨‹åº/root/linuxrcåŠ è½½æœ€ç»ˆæ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€éœ€çš„é©±åŠ¨æ¨¡å—ã€‚å†…æ ¸æ–‡æ¡£Documentation/driver-api/early-userspace/early_userspace_support.rstè¯´æ˜äº†linuxrcç¨‹åºçš„ä½œç”¨: some device and filesystem drivers built as modules and stored in an initrd. The initrd must contain a binary â€˜/linuxrcâ€™ which is supposed to load these driver modules. It is also possible to mount the final root filesystem via linuxrc and use the pivot_root syscall. The initrd is mounted and executed via prepare_namespace(). æœ€åè°ƒç”¨mount_rootæŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹åï¼Œrootfsä¸­çš„ç›®å½•ç»“æ„å¦‚ä¸‹: 123456æœ€ç»ˆæ ¹æ–‡ä»¶ç³»ç»Ÿä¸åœ¨/dev/ram/root //æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ/root/initrd // initrdä¸­çš„å†…å®¹æœ€ç»ˆæ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨/dev/ram/root/old // initrdä¸­çš„å†…å®¹ï¼Œä¹Ÿæ˜¯æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ å¦‚æœæ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨å—è®¾å¤‡ä¸Šï¼Œmount_rootè°ƒç”¨mount_block_rootå®Œæˆæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼š 123456789101112131415161718192021222324252627282930void __init mount_block_root(char *name, int flags)&#123; struct page *page = alloc_page(GFP_KERNEL); char *fs_names = page_address(page); if (root_fs_names) // å°†å†…æ ¸å¯åŠ¨é¡¹å‚æ•°&quot;rootfstype=&quot;ä¸­çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¿å­˜åˆ°fs_names num_fs = split_fs_names(fs_names, PAGE_SIZE, root_fs_names); else // å°†ç³»ç»Ÿä¸­å½“å‰æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¿å­˜åˆ°fs_names num_fs = list_bdev_fs_names(fs_names, PAGE_SIZE);... // root_mount_dataä¿å­˜å†…æ ¸å¯åŠ¨é¡¹å‚æ•°&quot;rootflags=&quot;è®¾ç½®çš„æ ¹æ–‡ä»¶ç³»ç»Ÿé€‰é¡¹ for (i = 0, p = fs_names; i &lt; num_fs; i++, p += strlen(p)+1) err = do_mount_root(name, p, flags, root_mount_data);...&#125;static int __init do_mount_root(const char *name, const char *fs, const int flags, const void *data)&#123;... // å°†è®¾å¤‡èŠ‚ç‚¹æŒ‚è½½åˆ°/rootç›®å½• ret = init_mount(name, &quot;/root&quot;, fs, flags, data_page); init_chdir(&quot;/root&quot;); s = current-&gt;fs-&gt;pwd.dentry-&gt;d_sb; // ROOT_DEVçš„è®¾å¤‡å³æŒ‚è½½è®¾å¤‡ ROOT_DEV = s-&gt;s_dev;...&#125; Summary and exampleå†…æ ¸å¯åŠ¨è¿‡ç¨‹çš„initramfsé˜¶æ®µå…¼å®¹äº†initrdå¯åŠ¨æ–¹å¼ï¼Œæµç¨‹æ€»ç»“å¦‚ä¸‹: æŒ‚è½½rootfs åˆ›å»º1å·è¿›ç¨‹kernel_initï¼Œå¯åŠ¨è¿‡ç¨‹çš„initramfsé˜¶æ®µçš„åˆå§‹åŒ–å·¥ä½œç”±1å·è¿›ç¨‹å®Œæˆ æ‰§è¡Œå†…æ ¸åˆå§‹åŒ–å‡½æ•°populate_rootfsï¼Œè§£å‹initramfsè‡³rootfs è‹¥æ­¥éª¤3æœªé…ç½®initramfsï¼Œåˆ™è®¤ä¸ºä½¿ç”¨çš„æ˜¯legacy initrdï¼Œè°ƒç”¨prepare_namespaceé€šè¿‡initrdå®Œæˆå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ è°ƒç”¨rootfsä¸­çš„initç¨‹åºå®Œæˆåç»­åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæˆä¸ºå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„1å·è¿›ç¨‹ã€‚ç”±äºinitrdçš„è¿‡æ¸¡æ–¹å¼å·²ç»æŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ—¶æ‰§è¡Œçš„æ˜¯å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„initç¨‹åºã€‚è€Œinitramfsçš„è¿‡æ¸¡æ–¹å¼ï¼Œæ‰§è¡Œçš„æ˜¯initramfsä¸­çš„initç¨‹åºï¼Œè¿˜éœ€è¦å®ŒæˆæŒ‚è½½å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å·¥ä½œã€‚ è§£å‹CentOS8çš„initramfsï¼Œå‘ç°initramfsçš„initç¨‹åºæ˜¯systemdç¨‹åºçš„è½¯è¿æ¥ï¼š 123456789$ mkdir -p ~/centos-initramfs &amp;&amp; cd ~/centos-initramfs$ /usr/lib/dracut/skipcpio initramfs-3.10.0-229.el7.x86_64.img | zcat | cpio -ivd$ llinit -&gt; usr/lib/systemd/systemd./usr/lib/systemd/system/default.target -&gt; initrd.targetsysroot/$ ll /usr/lib/systemd/system/default.target/usr/lib/systemd/system/default.target -&gt; graphical.target ä¸‹å›¾[3]æ€»ç»“äº†systemdåœ¨å¯åŠ¨é˜¶æ®µçš„å·¥ä½œï¼š å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿå°šæœªæŒ‚è½½ï¼Œç›¸å…³çš„systemdç¨‹åºä»¥åŠtargetæºäºinitramfs1.1. sysinit.target: è¯»ç³»ç»Ÿç¯å¢ƒåšåˆå§‹åŒ–1.2. basic.target: å®Œæˆæ—©æœŸå¼€æœºè‡ªå¯åŠ¨çš„åˆå§‹åŒ–å·¥ä½œ1.3. default.targetæ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼ŒæŒ‡å‘initrd.targetï¼Œä¸ºåç»­åˆ‡æ¢åˆ°å®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿåšåˆå§‹åŒ–å‡†å¤‡1.4 å°†å®é™…æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°/sysrootç›®å½•ï¼Œå°†/sysrootç›®å½•æŒ‚è½½åˆ°å½“å‰çš„æ ¹ç›®å½•ï¼Œå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿå®ŒæˆæŒ‚è½½ã€‚execå®é™…æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„systemdï¼Œå®Œæˆåˆ°ç”¨æˆ·ç©ºé—´è¿›ç¨‹çš„åˆ‡æ¢ å®é™…æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åï¼Œæ‰§è¡Œçš„systemdåŠtargetæºäºæ ¹æ–‡ä»¶ç³»ç»Ÿã€‚åŒæ ·ä¼šç»å†sysinit.targetã€basic.targeté˜¶æ®µï¼Œä¸è®ºæ˜¯initramfsï¼Œè¿˜æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸ºdefault.targeté˜¶æ®µåšå‡†å¤‡ã€‚default.targetä¹Ÿæ˜¯ä¸ªè½¯é“¾æ¥,å†³å®šç›¸åº”çš„â€œè¿è¡Œçº§åˆ«â€ï¼Œå½“å‰ç³»ç»ŸæŒ‡å‘graphical.targetè¡¨ç¤ºè¿›å…¥çš„æ˜¯å›¾å½¢ç»ˆç«¯ã€‚ä¹Ÿå¯ä»¥æŒ‡å‘multi-user.targetè¿›å…¥æ— å›¾å½¢åŒ–ç»ˆç«¯[4]ã€‚ ä»¥ â€œ.targetâ€ ä¸ºåç¼€çš„å•å…ƒæ–‡ä»¶ï¼Œ å°è£…äº†ä¸€ä¸ªç”± systemd ç®¡ç†çš„å¯åŠ¨ç›®æ ‡ï¼Œ ç”¨äºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å°†ä¸€ç»„å•å…ƒæ±‡èšåˆ°ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„åŒæ­¥ç‚¹ã€‚ Reference[1] https://stackoverflow.com/questions/64877292/how-does-the-bootloader-pass-the-kernel-command-line-to-the-kernel[2] https://zhuanlan.zhihu.com/p/489819324[3] https://www.junmajinlong.com/linux/systemd/systemd_bootup/[4] https://unix.stackexchange.com/questions/404667/systemd-service-what-is-multi-user-target","categories":[{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/categories/boot/"}],"tags":[{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/tags/boot/"},{"name":"initramfs","slug":"initramfs","permalink":"https://system-thoughts.github.io/tags/initramfs/"}]},{"title":"Understanding gzip - Huffman coding","slug":"Understanding gzip - Huffman coding","date":"2022-03-07T06:37:32.000Z","updated":"2023-01-18T05:32:06.152Z","comments":true,"path":"posts/bbc4c4ba/","link":"","permalink":"https://system-thoughts.github.io/posts/bbc4c4ba/","excerpt":"DEFLATEç®—æ³•é¦–å…ˆé€šè¿‡LZ77ç®—æ³•å¯¹æ•°æ®æµå‹ç¼©ï¼Œå‹ç¼©æ•°æ®æµä¸­ä»…åŒ…å«literalã€lengthã€distanceä¸‰ç§ç±»å‹çš„æ•°æ®ã€‚","text":"DEFLATEç®—æ³•é¦–å…ˆé€šè¿‡LZ77ç®—æ³•å¯¹æ•°æ®æµå‹ç¼©ï¼Œå‹ç¼©æ•°æ®æµä¸­ä»…åŒ…å«literalã€lengthã€distanceä¸‰ç§ç±»å‹çš„æ•°æ®ã€‚ æ•°æ®æ˜¯é€šè¿‡å­—ç¬¦è¡¨(alphabet)ä¸­çš„ç¼–ç è¡¨ç¤ºï¼Œå¦‚ASCIIç¼–ç çš„çº¯æ–‡æœ¬æ–‡ä»¶ä¸­çš„æ•°æ®éƒ½æ¥æºäºASCIIå­—ç¬¦è¡¨ã€‚å­—æ¯è¡¨ä¸­çš„å­—ç¬¦åœ¨è®¡ç®—æœºä¸­ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨ï¼Œå¦‚ASCIIè¡¨ä¸­çš„å­—ç¬¦Açš„äºŒè¿›åˆ¶ç¼–ç æ˜¯é•¿åº¦ä¸º1å­—èŠ‚çš„1000001Bã€‚DEFLATEç®—æ³•å®šä¹‰äº†ä¸¤å¼ å­—ç¬¦è¡¨ç¼–ç ä¸Šè¿°ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼šliteralå’Œlengthä½¿ç”¨ä¸€å¼ å­—ç¬¦è¡¨ï¼Œdistanceå•ç‹¬ä¸€å¼ å­—ç¬¦è¡¨ã€‚ alphabetliteralå’Œlengthä½¿ç”¨ä¸€å¼ 285ä¸ªç¼–ç (codes)çš„å­—ç¬¦è¡¨ã€‚(0..255)æ˜¯literalçš„ç¼–ç ï¼Œç›´æ¥ä½¿ç”¨ASCIIç¼–ç ã€‚lengthçš„å–å€¼èŒƒå›´æ˜¯(3..258)ï¼Œä½¿ç”¨(257..285)ç¼–ç åŒºé—´ï¼Œå­—ç¬¦256ä»£è¡¨end-of-blockï¼ŒDEFLATEç®—æ³•çš„å‹ç¼©æ•°æ®ä»¥blockå½¢å¼ç»„ç»‡ï¼Œend-of-blockæ˜¯blockçš„ç»“æŸæ ‡è¯†ã€‚literalè¿™ç§ä¸€ä¸€å¯¹åº”çš„ç¼–ç å¾ˆå¥½ç†è§£ï¼Œlengthçš„å–å€¼èŒƒå›´æ˜æ˜¾å¤§äºç¼–ç èŒƒå›´ï¼Œè¯¦ç»†çœ‹çœ‹DEFLATEç®—æ³•å¦‚ä½•ç¼–ç lengthï¼šDEFLATEå°†lengthçš„å–å€¼ä»(3..258)ç¼–ç åˆ°(257..285)çš„ç¼–ç èŒƒå›´ï¼Œå› æ­¤ï¼Œä¸€äº›lengthä¼šå…±ç”¨åŒä¸€ç¼–ç ã€‚ç´§éšç¼–ç ä¹‹åçš„Extra bitsè§£å†³äº†åŒä¸€ç¼–ç å…±äº«çš„é—®é¢˜ã€‚ä»¥lengthçš„å–å€¼11ã€12ä¸ºä¾‹ï¼Œå®ƒä»¬å…±äº«åŒä¸€ç¼–ç 265ï¼Œå¦‚æœç¼–ç 265åœ¨è®¡ç®—æœºä¸­ä»¥3-bitçš„äºŒè¿›åˆ¶ç¼–ç 110Bå­˜å‚¨ï¼Œåˆ™length 11çš„äºŒè¿›åˆ¶ç¼–ç æ˜¯1100B,length 12çš„äºŒè¿›åˆ¶ç¼–ç æ˜¯1101Bã€‚literal &amp; lengthå­—ç¬¦è¡¨ä¸­ï¼Œlengthè¶Šé•¿ï¼ŒExtra bitsè¶Šé•¿ï¼›åŒæ—¶ä¹Ÿæ„å‘³ç€å­—ç¬¦ä¸²åŒ¹é…çš„é•¿åº¦è¶Šé•¿ï¼Œå‡ºç°çš„æ¦‚ç‡è¶Šå°ã€‚å¯è§ï¼ŒDEFLATEç®—æ³•åœ¨å­—ç¬¦é•¿åº¦å’Œè®¡ç®—å¤æ‚åº¦ä¹‹é—´åšäº†trade offçš„ã€‚ä¸è¿‡ï¼Œ285è¿™ä¸ªå­—ç¬¦Extra bitsé•¿åº¦ä¸º0ï¼Œå¯èƒ½å› ä¸º285ä½œä¸ºDEFLATEç®—æ³•è§„å®šçš„æœ€å¤§åŒ¹é…é•¿åº¦ï¼Œå‡ºç°çš„æ¦‚ç‡ä¹Ÿä¼šæ›´é«˜ã€‚ distanceçš„å­—ç¬¦è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸å†è¿‡å¤šè§£é‡Šï¼š Huffman codingå­—ç¬¦è¡¨ä¸­çš„ç¼–ç æœ‰ä¸¤ç§äºŒè¿›åˆ¶ç¼–ç æ–¹å¼ï¼šå®šé•¿(fixed-length)ç¼–ç ã€å˜é•¿(variable-length)ç¼–ç ã€‚ASCIIç¼–ç æ˜¯å®šé•¿ç¼–ç ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½ç”¨é•¿åº¦ä¸º1å­—èŠ‚çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚å®šé•¿ç¼–ç å…·æœ‰æ˜ç¡®æ˜“è§£æçš„ä¼˜ç‚¹ï¼Œæ¯è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¾¿å¯è§£æ(decode)å¾—åˆ°ç›¸åº”çš„å­—ç¬¦ï¼Œå¦‚è¯»å–åˆ°1å­—èŠ‚çš„æ•°æ®1000001Bï¼Œä¾¿å¯è§£æå¾—åˆ°å­—ç¬¦Aã€‚Huffmanç¼–ç æ˜¯å˜é•¿ç¼–ç çš„ä»£è¡¨ï¼ŒåŸºäºå­—ç¬¦å®é™…å‡ºç°çš„é¢‘æ¬¡ï¼Œå‡ºç°é¢‘æ¬¡é«˜çš„å­—ç¬¦çš„ç¼–ç é•¿åº¦è¶ŠçŸ­ï¼Œåä¹‹åˆ™æ›´é•¿ã€‚Huffmanç¼–ç è¦æ±‚æ‰€æœ‰ç¼–ç å…·æœ‰prefix propertyï¼šä»»ä¸€ç¼–ç ä¸èƒ½æ˜¯å¦ä¸€æ›´é•¿ç¼–ç çš„å‰ç¼€ã€‚Huffmanç¼–ç ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ•´ä½“çš„ç¼–ç é•¿åº¦æ›´çŸ­ã€‚DEFLATEç®—æ³•é€‰æ‹©Huffmanç¼–ç è¡¨ç¤ºLZ77å‹ç¼©æ•°æ®ã€‚ DEFLATEç®—æ³•å°†æ ¹æ®å­—ç¬¦åœ¨LZ77ç¼–ç å­—ç¬¦æµä¸­å‡ºç°çš„å®é™…é¢‘æ¬¡è€Œæ„å»ºçš„Huffmanæ ‘ï¼Œç§°ä¸ºdynamic Huffman codesã€‚dynamic Huffman codesæ¨¡å¼ä¸‹ï¼Œä¸¤å¼ å­—ç¬¦è¡¨çš„å­—ç¬¦Huffmanç¼–ç é¢„å…ˆæ˜¯ä¸ç¡®å®šçš„ï¼Œè€Œæ˜¯åœ¨å‹ç¼©è¿‡ç¨‹ä¸­ï¼Œè¯»å–LZ77å‹ç¼©å­—ç¬¦æµã€ç»Ÿè®¡å­—ç¬¦å‡ºç°çš„å®é™…é¢‘æ¬¡è€Œæ„å»ºçš„ã€‚å› æ­¤ï¼Œéœ€è¦å°†ä¸¤å¼ å­—ç¬¦è¡¨çš„Huffmanç¼–ç ä¿¡æ¯åŠ å…¥åˆ°æœ€ç»ˆçš„å‹ç¼©æ•°æ®æµä¸­ï¼Œä»¥ä¾¿åç»­è§£å‹ç¼©è¿‡ç¨‹ä¸­çš„è§£ç ã€‚fixed Huffman codesæ˜¯DEFLATEç®—æ³•é¢„å…ˆå®šä¹‰çš„å­—ç¬¦è¡¨çš„Huffmanç¼–ç ã€‚ fixed Huffman codesfixed Huffman codesç¼–ç æ¨¡å¼ä¸‹ï¼Œliteral/lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç éƒ½æ˜¯å›ºå®šçš„ï¼Œä¸‹å›¾æ˜¯literal &amp; lengthå­—ç¬¦è¡¨çš„Huffmanç¼–ç ï¼šdistanceå­—ç¬¦è¡¨(0..29)ä½¿ç”¨å›ºå®šé•¿åº¦çš„5-bitç¼–ç (ç¼–ç èŒƒå›´ï¼š0-31)ã€‚åˆ°è¿™ï¼Œæ‚¨å¯èƒ½ä¼šé—®fixed Huffman codeså­˜åœ¨çš„æ„ä¹‰ï¼Ÿå®ƒå¹¶ä¸æ˜¯æ ¹æ®å­—ç¬¦å‡ºç°çš„å®é™…é¢‘æ¬¡è€Œäº§ç”Ÿçš„Huffmanç¼–ç ï¼Œè‚¯å®šä¸é€‚ç”¨äºä»»ä½•è¾“å…¥æ•°æ®é›†ã€‚å‰é¢æˆ‘ä»¬æåˆ°dynamic Huffman codeè¿˜éœ€è¦å°†ä¸¤å¼ å­—ç¬¦è¡¨å¯¹åº”çš„Huffmanç¼–ç ä¿¡æ¯åŠ å…¥åˆ°å‹ç¼©æ•°æ®æµä»¥æ”¯æŒåç»­çš„è§£å‹æ“ä½œã€‚é‚£ä¹ˆï¼Œå¾…å‹ç¼©çš„æ•°æ®é‡è¾ƒå°æ—¶ï¼Œdynamic Huffman codesç¼–ç ä¼šé¢å¤–å­˜å‚¨çš„è¿™äº›metadataï¼Œä»è€Œæ¯”ç›´æ¥ä½¿ç”¨fixed Huffman codesçš„ç¼–ç é•¿åº¦æ›´é•¿ã€‚ dynamic Huffman codesRun Length Encodingdynamic Huffman codesæ ¹æ®å­—ç¬¦åœ¨LZ77å‹ç¼©å­—ç¬¦æµä¸­å‡ºç°çš„å®é™…é¢‘æ¬¡ï¼Œæ„å»ºHuffmanæ ‘ã€å¯¹å­—ç¬¦Huffmanç¼–ç ã€‚ç›´æ¥ä¿å­˜å­—ç¬¦è¡¨ä¸­æ¯ä¸ªå­—ç¬¦çš„Huffmanç¼–ç ä¼šæåº¦æµªè´¹ç©ºé—´ï¼Œè¿™è®©LZ77ç®—æ³•çš„å‹ç¼©å˜å¾—æ¯«æ— æ„ä¹‰ã€‚DEFLATEç®—æ³•çº¦æŸHuffmanç¼–ç ï¼š ç›¸åŒé•¿åº¦çš„Huffmanç¼–ç åœ¨æ•°å€¼ä¸Šæ˜¯è¿ç»­çš„ï¼Œç¼–ç é¡ºåºä¸å­—ç¬¦åœ¨å­—ç¬¦è¡¨ä¸­çš„å…ˆåé¡ºåºä¿æŒä¸€è‡´ é•¿åº¦æ›´çŸ­çš„Huffmanç¼–ç ï¼Œå…¶ç¼–ç å€¼æ›´å° å¦‚ä¸‹çš„å­—ç¬¦è¡¨åªæœ‰å››ä¸ªå­—ç¬¦ï¼šABCDï¼Œå­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦é¡ºåºä»¥åŠç›¸åº”çš„Huffmanç¼–ç å¦‚è¡¨æ‰€ç¤ºï¼š Symbol Code A 10 B 110 C 0 D 111 å­—ç¬¦Bå’Œå­—ç¬¦Dçš„Huffmanç¼–ç é•¿åº¦éƒ½æ˜¯3ï¼Œä¸¤è€…çš„Huffmanç¼–ç æ˜¯è¿ç»­çš„ï¼Œä¸”ç¼–ç é¡ºåºä¸å­—ç¬¦åœ¨å­—ç¬¦è¡¨ä¸­å‡ºç°çš„å…ˆåé¡ºåºä¿æŒä¸€è‡´ã€‚æŒ‰ç…§Huffmanç¼–ç é•¿åº¦æ’åºï¼š0ã€10ã€110ã€111ã€‚é•¿åº¦æ›´çŸ­çš„Huffmanç¼–ç ï¼Œå…¶ç¼–ç å€¼ä¹Ÿæ›´å°ã€‚è‹¥ä¸è€ƒè™‘ä¸Šè¿°ä¸¤ä¸ªçº¦å®šï¼Œå­—ç¬¦è¡¨çš„å­—ç¬¦åœ¨ç›¸åŒç¼–ç é•¿åº¦ä¸‹ï¼Œå¯ä»¥æœ‰å¤šç§ç¼–ç ï¼Œå¦‚ABCDçš„Huffmanç¼–ç ä¹Ÿå¯ä»¥æ˜¯00ã€011ã€1ã€010ã€‚ä½†æ˜¯è¿™ç§Huffmanç¼–ç å°±æœªéµå®ˆä¸Šè¿°çº¦å®šã€‚ä¸Šè¿°ä¸¤ä¸ªçº¦å®šçš„ç›®çš„æ˜¯ï¼Œä»…é€šè¿‡Huffmanç¼–ç é•¿åº¦(code length)ä¾¿å¯ä»¥ç¡®å®šæ•´ä¸ªHuffmanæ ‘ã€‚å› æ­¤ï¼ŒABCDå­—ç¬¦è¡¨çš„Huffmanç¼–ç å¯ä»¥ä½¿ç”¨(2,3,1,3)æ¥è¡¨ç¤ºã€‚gzipé€šè¿‡build_treeå¯¹å­—ç¬¦è¡¨ä¸­å‡ºç°çš„å­—ç¬¦Huffmanç¼–ç ï¼š æŒ‰ç…§å­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦å‡ºç°çš„é¢‘æ¬¡æ„å»ºHuffmanæ ‘ è°ƒç”¨gen_bitlenå‡½æ•°è·å–å„å‡ºç°å­—ç¬¦çš„ç¼–ç é•¿åº¦ï¼Œå¦‚æœèŠ‚ç‚¹è¶…å‡ºMAX_BITSï¼ˆ15ï¼‰ï¼Œè°ƒæ•´èŠ‚ç‚¹çš„ä½ç½® è°ƒç”¨gen_codeså‡½æ•°æ ¹æ®Huffmanæ ‘ä¸­å¶å­èŠ‚ç‚¹çš„ç¼–ç é•¿åº¦ï¼Œéµå¾ªDEFLATEç®—æ³•çš„Huffmanç¼–ç çº¦æŸè¿›è¡Œç¼–ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980#define HEAP_SIZE (2*L_CODES+1)/* maximum heap size *local int near heap[2*L_CODES+1]; /* heap used to build the Huffman trees *//* =========================================================================== * Compares to subtrees, using the tree depth as tie breaker when * the subtrees have equal frequency. This minimizes the worst case length. */#define smaller(tree, n, m) \\ (tree[n].Freq &lt; tree[m].Freq || \\ (tree[n].Freq == tree[m].Freq &amp;&amp; depth[n] &lt;= depth[m]))local void build_tree(desc) tree_desc near *desc; /* the tree descriptor */&#123; ct_data near *tree = desc-&gt;dyn_tree; ct_data near *stree = desc-&gt;static_tree; int elems = desc-&gt;elems; int n, m; /* iterate over heap elements */ // å­—ç¬¦è¡¨ä¸­å‡ºç°è¿‡çš„æœ€å¤§å­—ç¬¦ int max_code = -1; /* largest code with non zero frequency */ int node = elems; /* next internal node of the tree */ heap_len = 0, heap_max = HEAP_SIZE; // heapæ•°ç»„ä¸­æŒ‰ç…§å­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦é¡ºåºå­˜å‚¨å‡ºç°è¿‡çš„å­—ç¬¦ for (n = 0; n &lt; elems; n++) &#123; if (tree[n].Freq != 0) &#123; heap[++heap_len] = max_code = n; depth[n] = 0; &#125; else &#123; // å¿½ç•¥å­—ç¬¦è¡¨ä¸­æœªå‡ºç°çš„å­—ç¬¦ï¼ŒHuffmanç¼–ç é•¿åº¦ä¸º0ï¼Œå³æœªå‚ä¸Huffmanç¼–ç  tree[n].Len = 0; &#125; &#125; ... desc-&gt;max_code = max_code; /* The elements heap[heap_len/2+1 .. heap_len] are leaves of the tree, * establish sub-heaps of increasing lengths: */ // å°†heapæ„å»ºä¸ºæŒ‰ç…§å­—ç¬¦å‡ºç°é¢‘æ¬¡æ¯”è¾ƒçš„å°é¡¶å † for (n = heap_len/2; n &gt;= 1; n--) pqdownheap(tree, n); /* Construct the Huffman tree by repeatedly combining the least two * frequent nodes. */ do &#123; pqremove(tree, n); /* n = node of least frequency */ m = heap[SMALLEST]; /* m = node of next least frequency */ // må’Œnæ˜¯Huffmanæ ‘çš„å…„å¼ŸèŠ‚ç‚¹ heap[--heap_max] = n; /* keep the nodes sorted by frequency */ heap[--heap_max] = m; /* Create a new node father of n and m */ tree[node].Freq = tree[n].Freq + tree[m].Freq; // åŒFreqçš„ä¸­é—´èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹ï¼ŒæŒ‰ç…§smalleræ¯”è¾ƒï¼Œå¶å­èŠ‚ç‚¹æ¯”ä¸­é—´èŠ‚ç‚¹å° depth[node] = (uch) (MAX(depth[n], depth[m]) + 1); tree[n].Dad = tree[m].Dad = (ush)node;... /* and insert the new node in the heap */ heap[SMALLEST] = node++; pqdownheap(tree, SMALLEST); &#125; while (heap_len &gt;= 2); // heap[heap_max..HEAP_SIZE]åŒ…å«äº†Huffmanæ ‘çš„ä¸­é—´èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹ï¼ˆå­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦ï¼‰ heap[--heap_max] = heap[SMALLEST]; /* At this point, the fields freq and dad are set. We can now * generate the bit lengths. */ gen_bitlen((tree_desc near *)desc); /* The field len is now set, we can generate the bit codes */ gen_codes ((ct_data near *)tree, max_code);&#125; build_treeé¦–å…ˆforå¾ªç¯è°ƒç”¨pqdownheapå®Œæˆå°é¡¶å †çš„å †åŒ–(heapify)æ“ä½œï¼Œå°é¡¶å †ä¸­çš„å­—ç¬¦æ˜¯æŒ‰ç…§å­—ç¬¦çš„é¢‘æ¬¡æ’åºçš„ï¼ˆè¯¦æƒ…è§smallerå®ï¼‰ã€‚éšåçš„do-whileå¾ªç¯å®ŒæˆHuffmanæ ‘çš„æ„å»ºã€‚å½“å‰å¾—åˆ°çš„æ˜¯ä¸€æ£µâ€œç¼–ç ä¸æ˜â€çš„Huffmanæ ‘ï¼Œè¿™é‡Œçš„â€œç¼–ç ä¸æ˜â€æŒ‡å…„å¼ŸèŠ‚ç‚¹çš„å·¦å³é¡ºåºæœªç¡®å®šï¼Œå¯¹Huffmanæ ‘çš„å¶å­èŠ‚ç‚¹ç¼–ç ä¸æ˜¯é€šè¿‡ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è·¯å¾„æ‰€ç¡®å®šçš„ã€‚ gen_bitlenå‡½æ•°ä¸ºäº†è·å–å„å‡ºç°å­—ç¬¦çš„ç¼–ç é•¿åº¦ï¼Œå› ä¸ºæœ€ç»ˆå­—ç¬¦çš„Huffmanç¼–ç æ˜¯æ ¹æ®å­—ç¬¦çš„ç¼–ç é•¿åº¦ç¡®å®šçš„ã€‚gen_bitlenå‡½æ•°ä¼šè°ƒæ•´build_treeç”Ÿæˆçš„Huffmanæ ‘çš„ç¼–ç è¿‡é•¿(&gt; MAX_BITS)èŠ‚ç‚¹çš„ä½ç½®ã€‚gen_bitlenè¿˜ä¼šç»Ÿè®¡dynamic Huffman codesç¼–ç ä¹‹åçš„é•¿åº¦opt_lenä»¥åŠfixed Huffman codesç¼–ç åçš„é•¿åº¦static_lenã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354local void gen_bitlen(desc) tree_desc near *desc; /* the tree descriptor */&#123;... for (bits = 0; bits &lt;= MAX_BITS; bits++) bl_count[bits] = 0; // rootèŠ‚ç‚¹çš„Huffmanç¼–ç é•¿åº¦ä¸º0ï¼ŒrootèŠ‚ç‚¹æ˜¯ä¸­é—´èŠ‚ç‚¹ tree[heap[heap_max]].Len = 0; /* root of the heap */ for (h = heap_max+1; h &lt; HEAP_SIZE; h++) &#123; n = heap[h]; bits = tree[tree[n].Dad].Len + 1; if (bits &gt; max_length) bits = max_length, overflow++; tree[n].Len = (ush)bits; if (n &gt; max_code) continue; /* not a leaf node */ bl_count[bits]++; xbits = 0; if (n &gt;= base) xbits = extra[n-base]; f = tree[n].Freq; // ä»¥dynamic Huffman codesç¼–ç çš„ç¼–ç é•¿åº¦ opt_len += (ulg)f * (bits + xbits); // ä»¥fixed Huffman codesç¼–ç çš„ç¼–ç é•¿åº¦ if (stree) static_len += (ulg)f * (stree[n].Len + xbits); &#125; if (overflow == 0) return; // è°ƒæ•´ç¼–ç é•¿åº¦è¿‡é•¿èŠ‚ç‚¹çš„ä½ç½® do &#123; bits = max_length-1; while (bl_count[bits] == 0) bits--; bl_count[bits]--; /* move one leaf down the tree */ bl_count[bits+1] += 2; /* move one overflow item as its brother */ bl_count[max_length]--; /* The brother of the overflow item also moves one step up, * but this does not affect bl_count[max_length] */ overflow -= 2; &#125; while (overflow &gt; 0); for (bits = max_length; bits != 0; bits--) &#123; n = bl_count[bits]; while (n != 0) &#123; m = heap[--h]; if (m &gt; max_code) continue; if (tree[m].Len != (unsigned) bits) &#123; // è°ƒæ•´overflowèŠ‚ç‚¹ä¹‹åï¼Œæ ¹æ®å®é™…ç¼–ç é•¿åº¦é‡æ–°è®¡ç®—dynamic Huffman codesç¼–ç é•¿åº¦ opt_len += ((long)bits-(long)tree[m].Len)*(long)tree[m].Freq; tree[m].Len = (ush)bits; &#125; n--; &#125; &#125;&#125; gen_bitlenå‡½æ•°æœ€åçš„do-whileå¾ªç¯å’Œforå¾ªç¯å®Œæˆè¶…é•¿èŠ‚ç‚¹çš„è°ƒæ•´ï¼Œå…¶å®ç°ä¸»è¦æ˜¯è°ƒæ•´bl_countæ•°ç»„å’Œè°ƒæ•´èŠ‚ç‚¹mçš„å®é™…ç¼–ç é•¿åº¦tree[m].Lenã€‚å¯è§ï¼Œbuild_treeæœ€åˆç”Ÿæˆçš„Huffmanæ ‘ç¡®å®æ˜¯ä¸€æ£µâ€œç¼–ç ä¸æ˜â€çš„Huffmanæ ‘ï¼Œå³æ— éœ€ç¡®å®šå¶å­èŠ‚ç‚¹çš„å…·ä½“ä½ç½®ï¼ˆæ— æ³•ç¡®å®šæ˜¯å·¦/å³å­èŠ‚ç‚¹ï¼‰ï¼Œåªè¦è¯¥èŠ‚ç‚¹çš„ç¼–ç é•¿åº¦æ­£ç¡®å³å¯ã€‚ä¸‹å›¾å±•ç¤ºäº†è¶…é•¿èŠ‚ç‚¹çš„è°ƒæ•´è¿‡ç¨‹ï¼š å­—ç¬¦è¡¨ä¸­å­—ç¬¦å‡ºç°çš„é¢‘ç‡æ˜¯(2, 3, 3, 4, 5, 7, 10)ï¼Œä¸ºç®€åŒ–æè¿°ï¼Œåé¢ç”¨é¢‘æ¬¡ä»£æŒ‡ç›¸åº”çš„ç¼–ç  build_treeæ„å»ºHuffmanæ ‘åï¼ŒèŠ‚ç‚¹çš„çˆ¶å­å…³ç³»ç¡®å®šï¼Œå„ä¸ªèŠ‚ç‚¹çš„ç¼–ç é•¿åº¦ç¡®å®šã€‚å‡è®¾å½“å‰çš„MAX_BITS=4ï¼Œåˆ™å¶å­èŠ‚ç‚¹3ã€2è¶…å‡ºäº†æœ€å¤§ç¼–ç é•¿åº¦ gen_bitlenå°†è¶…é•¿ç¼–ç 2è°ƒæ•´åˆ°å’Œç¼–ç 7æ‰€åœ¨åŒä¸€å±‚ï¼Œé‚£ä¹ˆç¼–ç 7å’Œç¼–ç 2ç§°ä¸ºå…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™ç¼–ç 7è¦ä¸‹ç§»ä¸€å±‚ï¼ŒåŸæ¥ç¼–ç 7çš„ä½ç½®å˜ä¸ºä¸­é—´èŠ‚ç‚¹ã€‚è¶…é•¿ç¼–ç 2çš„å…„å¼ŸèŠ‚ç‚¹3ï¼ŒæŒªåˆ°å…¶çˆ¶èŠ‚ç‚¹çš„ä½ç½®ã€‚å› ä¸ºï¼ŒHuffmanæ ‘çš„èŠ‚ç‚¹è¦ä¹ˆä¸å­˜åœ¨å­èŠ‚ç‚¹ï¼Œè¦ä¹ˆå°±æ˜¯ä¸¤ä¸ªå­èŠ‚ç‚¹ã€‚æ‰€ä»¥ç§»åŠ¨å®Œä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªå­èŠ‚ç‚¹ç§»åŠ¨åˆ°çˆ¶èŠ‚ç‚¹ä½ç½®æ‰ç¬¦åˆHuffmanç¼–ç ï¼Œæ‰€ä»¥do-whileå¾ªç¯æ˜¯overflow -= 2ã€‚æ³¨æ„ï¼Œå‰é¢æè¿°çš„èŠ‚ç‚¹ç§»åŠ¨åªæ˜¯ä¸€ä¸ªé€»è¾‘è¿‡ç¨‹ï¼Œä»£ç ä¸­å¹¶æœªé€šè¿‡æ”¹å˜èŠ‚ç‚¹çš„DadæŒ‡ä»£æ–°çš„çˆ¶èŠ‚ç‚¹ï¼Œæ›´ä¸è°ˆæ”¹å˜çˆ¶èŠ‚ç‚¹çš„å®é™…é¢‘æ¬¡ã€‚å› ä¸ºåé¢çš„gen_codesä»…å…³å¿ƒèŠ‚ç‚¹çš„ç¼–ç é•¿åº¦ä¾¿å¯ç”Ÿæˆæ­£ç¡®çš„Huffmanç¼–ç ï¼Œè€Œä¸æ˜¯å®é™…çš„Huffmanæ ‘é•¿å•¥æ ·ï¼Œæ‰€ä»¥ï¼Œæˆ‘åå¤å¼ºè°ƒè¿™é¢—Huffmanæ ‘æ˜¯ä¸€ä¸ªâ€œç¼–ç ä¸æ˜â€çš„Huffmanæ ‘ æœ€åï¼Œgen_codeså‡½æ•°æ ¹æ®å­—ç¬¦è¡¨çš„Huffmanç¼–ç é•¿åº¦æ•°ç»„(code length sequence)å¯¹å­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯RFC 1951, Section 3.2.2ç®—æ³•çš„å®ç°ã€‚å­—ç¬¦è¡¨ä¸­å­—ç¬¦mçš„é•¿åº¦å­˜å‚¨åœ¨tree[m].Lenä¸­ï¼ŒHuffmanç¼–ç å­˜å‚¨åœ¨tree[m].Codeä¸­ã€‚ 1234567891011121314151617181920212223242526272829303132// bl_count[i]: Huffmanç¼–ç é•¿åº¦ä¸ºiçš„ä¸ªæ•°// tree[i].Code: å­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦iå¯¹åº”çš„Huffmanç¼–ç // tree[i].Len: å­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦iå¯¹åº”çš„Huffmanç¼–ç é•¿åº¦#define MAX_BITS 15/* All codes must not exceed MAX_BITS bits */// max_codeæ˜¯å­—ç¬¦è¡¨ä¸­é¢‘æ¬¡é0çš„æœ€å¤§å­—ç¬¦ï¼Œå³max_code + 1è‡³å­—ç¬¦è¡¨æœ€åä¸€ä¸ªå­—ç¬¦åœ¨æ•°æ®æµä¸­å‡ºç°æ¬¡æ•°éƒ½ä¸º0local void gen_codes (tree, max_code) ct_data near *tree; /* the tree to decorate */ int max_code; /* largest code with non zero frequency */&#123; ush next_code[MAX_BITS+1]; /* next code value for each bit length */ ush code = 0; /* running code value */ int bits; /* bit index */ int n; /* code index */ // next_code[bits]æ˜¯é•¿åº¦ä¸ºbitsçš„æ‰€æœ‰Huffmanç¼–ç çš„ç¬¬ä¸€ä¸ªç¼–ç  for (bits = 1; bits &lt;= MAX_BITS; bits++) &#123; // éµå®ˆçº¦æŸ2ï¼Œbits+1çš„ç¬¬ä¸€ä¸ªç¼–ç  ä¼šæ˜¯(bitsçš„æœ€åä¸€ä¸ªç¼–ç +1)çš„2å€ next_code[bits] = code = (code + bl_count[bits-1]) &lt;&lt; 1; &#125; ... for (n = 0; n &lt;= max_code; n++) &#123; int len = tree[n].Len; // ä¸å¯¹æœªå‡ºç°çš„å­—ç¬¦ç¼–ç  if (len == 0) continue; /* Now reverse the bits */ // éµå®ˆçº¦æŸ1 tree[n].Code = bi_reverse(next_code[len]++, len); ... &#125; &#125; å¯ä»¥æ³¨æ„åˆ°ï¼Œliteral/lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„æœ€å¤§é•¿åº¦æ˜¯15ã€‚åŸºäºä¸Šè¿°ä¸¤ä¸ªçº¦æŸï¼Œå¯ä»¥é€šè¿‡å­—ç¬¦è¡¨ä¸­å„ä¸ªå­—ç¬¦çš„ç¼–ç é•¿åº¦(code length)æ¥è¡¨ç¤ºæ•´ä¸ªå­—ç¬¦è¡¨çš„Huffmanç¼–ç ã€‚å®é™…ä¸Šï¼ŒDEFLATEç®—æ³•é€šè¿‡Run Length Encodingè¿›ä¸€æ­¥ç¼–ç code lengthæ•°ç»„ã€‚å¦‚å­—ç¬¦è¡¨çš„code lengthæ•°ç»„æ˜¯(5, 5, 5, 5, 6, 6, 6, 6, 6, 6)ï¼Œç»è¿‡RLEç¼–ç åçš„è¡¨ç¤ºæ˜¯((5,4),(6,6))ï¼Œå³code length 5è¿ç»­å‡ºç°4æ¬¡ï¼Œcode length 6è¿ç»­å‡ºç°6æ¬¡ã€‚DEFLATEç®—æ³•å°†literal/lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„code lengthæ•°ç»„çš„RELç¼–ç ä¿å­˜åˆ°å‹ç¼©æ•°æ®æµä¸­ä»¥è¡¨ç¤ºè¿™ä¸¤å¼ å­—ç¬¦è¡¨çš„Huffmanç¼–ç ã€‚åŒæ ·ï¼ŒRELç¼–ç ä¹Ÿéœ€è¦ä¸€å¼ å­—ç¬¦è¡¨æ¥è¡¨ç¤ºï¼ŒRELç¼–ç æœ‰ä¸¤ç§ç±»å‹çš„æ•°æ®ï¼š code lengthï¼šHuffmanç¼–ç é•¿åº¦ï¼Œå–å€¼èŒƒå›´æ˜¯(0..15) repeat times: code lengthé‡å¤æ¬¡æ•° DEFLATEç®—æ³•è®¾è®¡äº†RELç¼–ç çš„å­—ç¬¦è¡¨ï¼š code extra bits meaning 0-15 0 code lengths of 0-15 16 2 Copy the previous code length 3 - 6 timesThe next 2 bits indicate repeat length(0 = 3, â€¦ , 3 = 6) 17 3 Repeat a code length of 0 for 3 - 10 times 18 7 Repeat a code length of 0 for 11 - 138 times ä¸¾ä¸ªä¾‹å­ï¼Œ8, 16(+2 bits 11), 16(+2 bits 10)ä¼šå±•å¼€æˆ12(1 + (3 + 3) + (3 + 2))ä¸ªcode lengthä¸º8çš„æ•°æ®æµã€‚code lengthä¸º0è¡¨ç¤ºliteral/lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨ä¸­çš„è¯¥å­—ç¬¦æœªå‡ºç°è¿‡ï¼Œè¿™ä¸ªå­—ç¬¦æ˜¯ä¸å‚ä¸Huffmanæ ‘æ„å»ºçš„ã€‚ Huffman on RLE alphabetè‡³æ­¤ï¼Œliteral/lengthã€distanceå­—ç¬¦è¡¨ä¸­å­—ç¬¦çš„Huffmanç¼–ç å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªRLEåºåˆ—è¡¨ç¤ºã€‚ä¸Šä¸€èŠ‚ä¹Ÿç»™å‡ºäº†RLEç¼–ç çš„å­—ç¬¦è¡¨ï¼ŒRLEå­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦ä¹Ÿæ˜¯ä½¿ç”¨Huffmanç¼–ç ï¼Œå’Œå¯¹literal/lengthã€distanceå­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦è¿›è¡ŒHuffmanç¼–ç ä¸€æ ·ã€‚å› æ­¤ï¼ŒDEFLATEä¹Ÿè¦å°†RLEå­—ç¬¦è¡¨çš„Huffmanç¼–ç åŠ å…¥åˆ°å‹ç¼©æ•°æ®æµï¼Œä»¥è§£æliteral/lengthã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„RLEåºåˆ—è¡¨ç¤ºã€‚åˆ°è¿™ä¸€æ­¥ï¼ŒDEFLATEç®—æ³•è²Œä¼¼é™·å…¥äº†â€œæ— é™å¾ªç¯â€ï¼Œå…¶å®ä¸ç„¶ï¼Œç¬¬ä¸€æ¬¡Huffmanç¼–ç ï¼Œå°†literal/lengthã€distanceå­—ç¬¦è¡¨ä¸­å­—ç¬¦çš„Huffmanç¼–ç ä»¥RLEåºåˆ—è¡¨ç¤ºï¼Œå­—ç¬¦è¡¨çš„ç¼–ç èŒƒå›´ä»(0..285)|(0..29)ç¼©å°åˆ°(0..18)ã€‚å†å¯¹RLEå­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç ï¼Œç¼–ç èŒƒå›´ä¼šä»(0..18)ç»§ç»­ç¼©å‡ã€‚å¯è§ï¼Œç¬¬äºŒæ¬¡Huffmanç¼–ç å¯ä»¥å°†å­—ç¬¦è¡¨çš„ç¼–ç èŒƒå›´ç¼©çŸ­çš„æ›´å°ï¼Œå› æ­¤å°±æ²¡æœ‰æ— é™â€œå¥—å¨ƒâ€çš„å¿…è¦äº†ï¼DEFLATEç®—æ³•è§„å®šå¯¹RLEå­—ç¬¦è¡¨çš„å­—ç¬¦çš„æœ€å¤§Huffmanç¼–ç é•¿åº¦é™åˆ¶ä¸º7ã€‚å› æ­¤ï¼Œå¯¹RLEå­—ç¬¦è¡¨è¿›è¡Œæ€§Huffmanç¼–ç å¾—åˆ°çš„code lengthåºåˆ—çš„å–å€¼èŒƒå›´ä¸º(0..7)ï¼ŒDEFLATEä½¿ç”¨å›ºå®šé•¿åº¦çš„3-bitç¼–ç è¡¨ç¤ºè¿™äº›code lengthã€‚è¿™é‡Œï¼ŒDEFLATEç®—æ³•å¯¹äºRLEå­—ç¬¦è¡¨çš„å­—ç¬¦æ’åºåšäº†ä¼˜åŒ–ï¼ŒRLEå­—ç¬¦è¡¨ä¸­çš„å­—ç¬¦å¹¶éæŒ‰ç…§(0..18)é¡ºåºæ’åºï¼Œè€Œæ˜¯å®é™…åˆ†æRLEå­—ç¬¦è¡¨ä¸­å­—ç¬¦å‡ºç°çš„é¢‘ç‡ï¼ŒæŒ‰ç…§å‡ºç°é¢‘ç‡ä»é«˜å¾€ä½æ’åºã€‚DEFLATEç®—æ³•è§„å®šRLEå­—ç¬¦è¡¨çš„å­—ç¬¦å®é™…é¡ºåºï¼š(16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15)ã€‚è¿™ä¸ªä¼˜åŒ–å¯ä»¥ç¼©çŸ­RLEå­—ç¬¦è¡¨çš„code lengthæ•°ç»„é•¿åº¦ï¼Œå¦‚literal/lengthã€distanceå­—ç¬¦è¡¨çš„ä¸¤ä¸ªRLEåºåˆ—ä¸­æ‰€æœ‰RELå­—ç¬¦åœ¨RELå­—ç¬¦è¡¨ä¸­çš„æœ€å¤§ç´¢å¼•ï¼ˆmax indexï¼‰æ˜¯RELå­—ç¬¦13æ‰€åœ¨çš„ä½ç½®ã€‚åˆ™2, 14, 1, 15ä¸éœ€è¦å‡ºç°åœ¨RLEå­—ç¬¦è¡¨çš„code lengthæ•°ç»„ä¸­ï¼Œå¯ä»¥å‚è€ƒå‰é¢ä»‹ç»gen_codeså‡½æ•°çš„max_codeå‚æ•°çš„æ„ä¹‰ã€‚æˆ‘åªèƒ½æ„Ÿå¹ï¼ŒDEFLATEç®—æ³•ä¸ºäº†æè‡´å‹ç¼©ï¼Œæœ‰å¤ªå¤štrickäº†ï¼ï¼ æ‰€ä»¥ï¼Œå‰é¢æåŠçš„dynamic Huffman codesçš„â€metadataâ€åŒ…å«ï¼š RLEå­—ç¬¦è¡¨å¯¹åº”çš„Huffmanç¼–ç ï¼Œä»¥code lengthæ•°ç»„è¡¨ç¤º literal/lengthã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç ï¼Œä»¥RELåºåˆ—è¡¨ç¤º Implementation Details ct_initåˆå§‹åŒ–å…¨å±€å˜é‡base_lengthã€length_codeã€base_distã€dist_codeæ–¹ä¾¿lengthã€distanceä¸literal/lengthã€distanceå­—ç¬¦è¡¨ä¸­çš„ç¼–ç è¿›è¡Œç›¸äº’è½¬æ¢ï¼ŒåŒæ—¶å®Œæˆliteral &amp; lengthå­—ç¬¦è¡¨çš„fixed huffmanç¼–ç ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121#define LENGTH_CODES 29/* number of length codes, not counting the special END_BLOCK code */#define LITERALS 256/* number of literal bytes 0..255 */#define L_CODES (LITERALS+1+LENGTH_CODES)/* number of Literal or Length codes, including the END_BLOCK code */#define D_CODES 30/* number of distance codes */local int near extra_lbits[LENGTH_CODES] /* extra bits for each length code */ = &#123;0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0&#125;;local int near extra_dbits[D_CODES] /* extra bits for each distance code */ = &#123;0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13&#125;;/* Data structure describing a single value and its code string. */typedef struct ct_data &#123; union &#123; ush freq; /* frequency count */ ush code; /* bit string */ &#125; fc; union &#123; ush dad; /* father node in Huffman tree */ ush len; /* length of bit string */ &#125; dl;&#125; ct_data;local ct_data near static_ltree[L_CODES+2];/* The static literal tree. Since the bit lengths are imposed, there is no * need for the L_CODES extra codes used during heap construction. However * The codes 286 and 287 are needed to build a canonical tree (see ct_init * below). */local ct_data near static_dtree[D_CODES];/* The static distance tree. (Actually a trivial tree since all codes use * 5 bits.) */local uch length_code[MAX_MATCH-MIN_MATCH+1];/* length code for each normalized match length (0 == MIN_MATCH) */local uch dist_code[512];/* distance codes. The first 256 values correspond to the distances * 3 .. 258, the last 256 values correspond to the top 8 bits of * the 15 bit distances. */local int near base_length[LENGTH_CODES];/* First normalized length for each code (0 = MIN_MATCH) */local int near base_dist[D_CODES];/* First normalized distance for each code (0 = distance of 1) */void ct_init(attr, methodp) ush *attr; /* pointer to internal file attribute */ int *methodp; /* pointer to compression method */&#123;... if (static_dtree[0].Len != 0) return; /* ct_init already called */ /* Initialize the mapping length (0..255) -&gt; length code (0..28) */ // base_length[i]ï¼šliteral/lengthå­—ç¬¦è¡¨ä¸­çš„ç¬¬iä¸ªlength codeè¡¨ç¤ºèŒƒå›´çš„ç¬¬ä¸€ä¸ªlength // length_code[i]: é•¿åº¦iåœ¨literal/lengthå­—ç¬¦è¡¨å¯¹åº”çš„length codeçš„é¡ºåº length = 0; for (code = 0; code &lt; LENGTH_CODES-1; code++) &#123; base_length[code] = length; for (n = 0; n &lt; (1&lt;&lt;extra_lbits[code]); n++) &#123; length_code[length++] = (uch)code; &#125; &#125;... length_code[length-1] = (uch)code; // dist_code[i]: è·ç¦»iå±äº(0..255)æ—¶,dist_code[i]è¡¨ç¤ºdistanceå­—ç¬¦è¡¨ä¸­çš„distance codeï¼ŒèŒƒå›´æ˜¯(0..15) // å½“iå±äº(256..511)æ—¶ï¼Œæ¯ä¸ªiä»£è¡¨128ä¸ªdistanceæ•°æ®ï¼Œå¦‚dist_code[258] = 16 dist_code[259] = 16 // dist_code[260] = 18 dist_code[260] = 18ï¼›å› ä¸ºç¼–ç 16ã€17çš„distanceæ•°æ®æœ‰128ä¸ªï¼Œç¼–ç 18çš„distanceæ•°æ®æœ‰256ä¸ªï¼›dist_codeçš„256å’Œ257ç´¢å¼•é¢„ç•™ /* Initialize the mapping dist (0..32K) -&gt; dist code (0..29) */ dist = 0; for (code = 0 ; code &lt; 16; code++) &#123; base_dist[code] = dist; for (n = 0; n &lt; (1&lt;&lt;extra_dbits[code]); n++) &#123; dist_code[dist++] = (uch)code; &#125; &#125; Assert (dist == 256, &quot;ct_init: dist != 256&quot;); dist &gt;&gt;= 7; /* from now on, all distances are divided by 128 */ for ( ; code &lt; D_CODES; code++) &#123; base_dist[code] = dist &lt;&lt; 7; for (n = 0; n &lt; (1&lt;&lt;(extra_dbits[code]-7)); n++) &#123; dist_code[256 + dist++] = (uch)code; &#125; &#125; Assert (dist == 256, &quot;ct_init: 256+dist != 512&quot;); /* Construct the codes of the static literal tree */ // å°†literal/lengthå­—ç¬¦è¡¨çš„fixed huffman codeé€šè¿‡code length sequenceè¡¨ç¤º for (bits = 0; bits &lt;= MAX_BITS; bits++) bl_count[bits] = 0; n = 0; while (n &lt;= 143) static_ltree[n++].Len = 8, bl_count[8]++; while (n &lt;= 255) static_ltree[n++].Len = 9, bl_count[9]++; while (n &lt;= 279) static_ltree[n++].Len = 7, bl_count[7]++; while (n &lt;= 287) static_ltree[n++].Len = 8, bl_count[8]++; /* Codes 286 and 287 do not exist, but we must include them in the * tree construction to get a canonical Huffman tree (longest code * all ones) */ // å¯¹literal/lengthå­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç  gen_codes((ct_data near *)static_ltree, L_CODES+1); // distanceå­—ç¬¦è¡¨çš„å›ºå®šç¼–ç ä½¿ç”¨5-bité•¿åº¦çš„é¡ºåºç¼–ç  for (n = 0; n &lt; D_CODES; n++) &#123; static_dtree[n].Len = 5; static_dtree[n].Code = bi_reverse(n, 5); &#125; /* Initialize the first block of the first file: */ init_block();&#125; ct_tallyç»Ÿè®¡literal &amp; lengthå­—ç¬¦è¡¨ä¸­literalã€lengthå­—ç¬¦å‡ºç°çš„é¢‘ç‡ï¼Œå¹¶å°†literalã€lengthä¿å­˜åˆ°l_bufä¸­ï¼›ç»Ÿè®¡distanceå­—ç¬¦è¡¨ä¸­çš„distanceå­—ç¬¦å‡ºç°çš„é¢‘ç‡ï¼Œå¹¶å°†distanceä¿å­˜åˆ°d_bufä¸­ï¼Œå…¶ä¸­ä¸€ä¸ªbufferæ»¡æ—¶ï¼Œå°†ä¸¤ä¸ªbufferä¸­ä¿å­˜çš„LZ77å‹ç¼©å­—ç¬¦æµç»„ç»‡æˆblockå‹ç¼©å—ã€‚l_bufã€d_bufä¿å­˜literalã€lengthã€distanceçš„æ–¹å¼åœ¨éšåä»‹ç»compress_blockå‡½æ•°ä¼šè¯¦ç»†è®²è§£ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950local ct_data near dyn_ltree[HEAP_SIZE]; /* literal and length tree */local ct_data near dyn_dtree[2*D_CODES+1]; /* distance tree */// å®Œæˆdistanceåˆ°distanceå­—ç¬¦è¡¨ä¸­çš„codeæ˜ å°„#define d_code(dist) \\ ((dist) &lt; 256 ? dist_code[dist] : dist_code[256+((dist)&gt;&gt;7)])/* Mapping from a distance to a distance code. dist is the distance - 1 and * must not have side effects. dist_code[256] and dist_code[257] are never * used. */// ç¼–ç literal: dist = 0, lc = literal// ç¼–ç &lt;length, distance&gt;: dist = distance, lc = length - MIN_MATCHint ct_tally (dist, lc) int dist; /* distance of matched string */ int lc; /* match length-MIN_MATCH or unmatched char (if dist==0) */&#123; // l_bufä¿å­˜literalã€length l_buf[last_lit++] = (uch)lc; if (dist == 0) &#123; /* lc is the unmatched char */ // ç»Ÿè®¡literal/lengthå­—ç¬¦è¡¨ä¸­ç›¸åº”çš„literal codeå‡ºç°é¢‘ç‡ dyn_ltree[lc].Freq++; &#125; else &#123; /* Here, lc is the match length - MIN_MATCH */ dist--; /* dist = match distance - 1 */ Assert((ush)dist &lt; (ush)MAX_DIST &amp;&amp; (ush)lc &lt;= (ush)(MAX_MATCH-MIN_MATCH) &amp;&amp; (ush)d_code(dist) &lt; (ush)D_CODES, &quot;ct_tally: bad match&quot;); // ç»Ÿè®¡literal/lengthå­—ç¬¦è¡¨ä¸­ç›¸åº”çš„length codeå‡ºç°é¢‘ç‡ dyn_ltree[length_code[lc]+LITERALS+1].Freq++; // ç»Ÿè®¡distanceå­—ç¬¦è¡¨ä¸­ç›¸åº”çš„distance codeå‡ºç°é¢‘ç‡ dyn_dtree[d_code(dist)].Freq++; // d_bufä¿å­˜distance d_buf[last_dist++] = (ush)dist; flags |= flag_bit; &#125; flag_bit &lt;&lt;= 1; /* Output the flags if they fill a byte: */ if ((last_lit &amp; 7) == 0) &#123; flag_buf[last_flags++] = flags; flags = 0, flag_bit = 1; &#125; ... return (last_lit == LIT_BUFSIZE-1 || last_dist == DIST_BUFSIZE);&#125; flush_blockå®Œæˆæ•´ä¸ªblockçš„ç¼–ç  è°ƒç”¨build_treeå®Œæˆå¯¹literal &amp; lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨Huffmanç¼–ç ã€‚ è°ƒç”¨build_bl_treeå¯¹literal &amp; lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„RELè¡¨ç¤ºæ‰€åœ¨çš„RELå­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç  æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯ç›´æ¥å°†æ•°æ®æœªç»å‹ç¼©è¾“å‡ºè¿˜æ˜¯ä»¥ä¸åŒtypeçš„blockå½¢å¼è¾“å‡º no compression blockï¼šè°ƒç”¨copy_blockç›´æ¥è¾“å‡ºæ•°æ® compressed with fixed Huffman codesï¼šcompress_blockæ ¹æ®static Huffman treeå¯¹LZ77å‹ç¼©æ•°æ®è¿›è¡ŒHuffmanç¼–ç  compressed with dynamic Huffman codesï¼šsend_all_treeså°†RELå­—ç¬¦è¡¨çš„code length sequenceã€literal &amp; lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„RELåºåˆ—è¾“å‡ºï¼›compress_blockæ ¹æ®dynamic Huffman treeå¯¹LZ77å‹ç¼©æ•°æ®ç¼–ç  è°ƒç”¨init_blockåˆå§‹åŒ–ä¸‹ä¸€block DEFLATEç®—æ³•è§„å®šblockæœ‰3bitçš„å¤´éƒ¨ä¿¡æ¯ï¼š first bit: BFINAL(last block set) next 2 bits: BTYPE BTYPEè¡¨ç¤ºblockçš„å‹ç¼©ç±»å‹ï¼š 00 - no compression 01 - compressed with fixed Huffman codes 10 - compressed with dynamic Huffman codes 11 - reserved (error) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778#define FLUSH_BLOCK(eof) \\ flush_block(block_start &gt;= 0L ? (char*)&amp;window[(unsigned)block_start] : \\ (char*)NULL, (long)strstart - block_start, flush-1, (eof))off_t flush_block(buf, stored_len, pad, eof) char *buf; /* input block, or NULL if too old */ ulg stored_len; /* length of input block */ int pad; /* pad output to byte boundary */ int eof; /* true if this is the last block for a file */&#123; ulg opt_lenb, static_lenb; /* opt_len and static_len in bytes */ int max_blindex; /* index of last bit length code of non zero freq */ flag_buf[last_flags] = flags; /* Save the flags for the last 8 items */ /* Check if the file is ascii or binary */ if (*file_type == (ush)UNKNOWN) set_file_type(); /* Construct the literal and distance trees */ build_tree((tree_desc near *)(&amp;l_desc)); build_tree((tree_desc near *)(&amp;d_desc)); // å¯¹literal|lengthå­—ç¬¦è¡¨ä»¥åŠdistanceå­—ç¬¦è¡¨çš„RELç¼–ç çš„RELå­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç ï¼Œmax_blindexæ˜¯å‡ºç°è¿‡è‡ªå¤§çš„RELå­—ç¬¦çš„ç´¢å¼• max_blindex = build_bl_tree(); // 3 header bits + 7 = (8 - 1)ï¼Œ(x + 7) &gt;&gt; 3è¡¨ç¤ºå®¹çº³x bitéœ€è¦å¤šå°‘å­—èŠ‚ opt_lenb = (opt_len+3+7)&gt;&gt;3; static_lenb = (static_len+3+7)&gt;&gt;3; input_len += stored_len; /* for debugging only */ if (static_lenb &lt;= opt_lenb) opt_lenb = static_lenb; /* If compression failed and this is the first and last block, * and if we can seek through the zip file (to rewrite the local header), * the whole file is transformed into a stored file: */ // æ•´ä¸ªæ–‡ä»¶éƒ½æ˜¯æœªç»å‹ç¼©å¤„ç†çš„æ–‡ä»¶ï¼Œå³stored file if (stored_len &lt;= opt_lenb &amp;&amp; eof &amp;&amp; compressed_len == 0L &amp;&amp; seekable()) &#123; ... // ç›¸æ¯”ä¸‹ä¸€ä¸ªifåˆ†æ”¯ï¼Œå®ƒéƒ½ä¸æ˜¯ä»¥blockå½¢å¼ç»„ç»‡æ•°æ®ï¼Œç›´æ¥å°†æ•°æ®åŸæ ·è¾“å‡º copy_block(buf, (unsigned)stored_len, 0); /* without header */ compressed_len = stored_len &lt;&lt; 3; *file_method = STORED; &#125; else if (stored_len+4 &lt;= opt_lenb &amp;&amp; buf != (char*)0) &#123; // 4: LEN + NLEN // å½“å‰blockæœªç»å‹ç¼©ï¼Œå³00(no compress) send_bits((STORED_BLOCK&lt;&lt;1)+eof, 3); /* send block type */ compressed_len = (compressed_len + 3 + 7) &amp; ~7L; compressed_len += (stored_len + 4) &lt;&lt; 3; copy_block(buf, (unsigned)stored_len, 1); /* with header */ &#125; else if (static_lenb == opt_lenb) &#123; // blockä½¿ç”¨Fixed Huffman codesç¼–ç  send_bits((STATIC_TREES&lt;&lt;1)+eof, 3); compress_block((ct_data near *)static_ltree, (ct_data near *)static_dtree); compressed_len += 3 + static_len; &#125; else &#123; // blockä½¿ç”¨dynamic Huffman codesç¼–ç  send_bits((DYN_TREES&lt;&lt;1)+eof, 3); send_all_trees(l_desc.max_code+1, d_desc.max_code+1, max_blindex+1); compress_block((ct_data near *)dyn_ltree, (ct_data near *)dyn_dtree); compressed_len += 3 + opt_len; &#125; Assert (compressed_len == bits_sent, &quot;bad compressed size&quot;); init_block(); if (eof) &#123; Assert (input_len == bytes_in, &quot;bad input size&quot;); bi_windup(); compressed_len += 7; /* align on byte boundary */ &#125; else if (pad &amp;&amp; (compressed_len % 8) != 0) &#123; send_bits((STORED_BLOCK&lt;&lt;1)+eof, 3); /* send block type */ compressed_len = (compressed_len + 3 + 7) &amp; ~7L; copy_block(buf, 0, 1); /* with header */ &#125; return compressed_len &gt;&gt; 3;&#125; 3.1 build_bl_treeé¦–å…ˆè°ƒç”¨scan_treeæ‰«æliteral &amp; lengthã€distanceå­—ç¬¦è¡¨çš„Run Length Encodingå¾—åˆ°RELå­—ç¬¦è¡¨çš„å­—ç¬¦å‡ºç°é¢‘æ¬¡(bl_tree[m].Freq)ã€‚éšåè°ƒç”¨build_treeå¯¹RELå­—ç¬¦è¡¨è¿›è¡ŒHuffmanç¼–ç ã€‚å¹¶è¿”å›Huffmanç¼–ç é•¿åº¦ä¸ä¸º0çš„RELå­—ç¬¦åœ¨RLEå­—ç¬¦è¡¨ä¸­çš„æœ€å¤§ç´¢å¼•max_blindexã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162local void scan_tree (tree, max_code) ct_data near *tree; /* the tree to be scanned */ int max_code; /* and its largest code of non zero frequency */&#123; int n; /* iterates over all tree elements */ int prevlen = -1; /* last emitted length */ int curlen; /* length of current code */ int nextlen = tree[0].Len; /* length of next code */ int count = 0; /* repeat count of the current code */ int max_count = 7; /* max repeat count */ int min_count = 4; /* min repeat count */ if (nextlen == 0) max_count = 138, min_count = 3; tree[max_code+1].Len = (ush)0xffff; /* guard */ for (n = 0; n &lt;= max_code; n++) &#123; curlen = nextlen; nextlen = tree[n+1].Len; if (++count &lt; max_count &amp;&amp; curlen == nextlen) &#123; continue; &#125; else if (count &lt; min_count) &#123; bl_tree[curlen].Freq += count; &#125; else if (curlen != 0) &#123; if (curlen != prevlen) bl_tree[curlen].Freq++; bl_tree[REP_3_6].Freq++; &#125; else if (count &lt;= 10) &#123; bl_tree[REPZ_3_10].Freq++; &#125; else &#123; bl_tree[REPZ_11_138].Freq++; &#125; count = 0; prevlen = curlen; if (nextlen == 0) &#123; max_count = 138, min_count = 3; &#125; else if (curlen == nextlen) &#123; max_count = 6, min_count = 3; &#125; else &#123; max_count = 7, min_count = 4; &#125; &#125;&#125;local int build_bl_tree()&#123; int max_blindex; /* index of last bit length code of non zero freq */ /* Determine the bit length frequencies for literal and distance trees */ scan_tree((ct_data near *)dyn_ltree, l_desc.max_code); scan_tree((ct_data near *)dyn_dtree, d_desc.max_code); /* Build the bit length tree: */ build_tree((tree_desc near *)(&amp;bl_desc)); /* opt_len now includes the length of the tree representations, except * the lengths of the bit lengths codes and the 5+5+4 bits for the counts. */ // max_blindex: RELå­—ç¬¦è¡¨ä¸­Huffmanç¼–ç é•¿åº¦ä¸ä¸º0çš„æœ€å¤§å­—ç¬¦åœ¨RLEå­—ç¬¦è¡¨ä¸­çš„ç´¢å¼• for (max_blindex = BL_CODES-1; max_blindex &gt;= 3; max_blindex--) &#123; if (bl_tree[bl_order[max_blindex]].Len != 0) break; &#125; /* Update opt_len to include the bit length tree and counts */ opt_len += 3*(max_blindex+1) + 5+5+4; return max_blindex;&#125; 3.2 send_all_treesé¦–å…ˆå¡«å……dynamic Huffman codesç¼–ç çš„blockè¦æ±‚çš„å¤´éƒ¨bitsï¼Œä¸‹è¡¨æ˜¯dynamic Huffman codesç¼–ç çš„blockæ ¼å¼ã€‚éšåè°ƒç”¨send_treeå°†literal &amp; lengthå­—ç¬¦è¡¨Huffmanç¼–ç çš„RELè¡¨ç¤ºä»¥åŠdistanceå­—ç¬¦è¡¨Huffmanç¼–ç çš„RELè¡¨ç¤ºè¾“å‡ºåˆ°blockä¸­ã€‚ length Meaning 5bits HLIT(literal &amp; length max code + 1) - 257 5bits HDIST(distance max code + 1) - 1 4bits HCLEN(REL max code index + 1) - 4 (HCLEN + 4) x 3 bits RELå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„code length sequenceè¡¨ç¤ºï¼Œæ¯ä¸ªcode lengthä»¥å›ºå®š3bitè¡¨ç¤º (HLIT + 257) ç¼–ç ä¸ªæ•° literal &amp; lengthå­—ç¬¦è¡¨Huffmanç¼–ç çš„RELè¡¨ç¤º (HDIST + 1) ç¼–ç ä¸ªæ•° distanceå­—ç¬¦è¡¨Huffmanç¼–ç çš„RELè¡¨ç¤º LZ77å‹ç¼©æ•°æ®ä½¿ç”¨literal&amp;lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç  The literal/length symbol 256 (end of data) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071local uch near bl_order[BL_CODES] = &#123;16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15&#125;;local void send_tree (tree, max_code) ct_data near *tree; /* the tree to be scanned */ int max_code; /* and its largest code of non zero frequency */&#123; int n; /* iterates over all tree elements */ int prevlen = -1; /* last emitted length */ int curlen; /* length of current code */ int nextlen = tree[0].Len; /* length of next code */ int count = 0; /* repeat count of the current code */ int max_count = 7; /* max repeat count */ int min_count = 4; /* min repeat count */ /* tree[max_code+1].Len = -1; */ /* guard already set */ if (nextlen == 0) max_count = 138, min_count = 3; for (n = 0; n &lt;= max_code; n++) &#123; curlen = nextlen; nextlen = tree[n+1].Len; if (++count &lt; max_count &amp;&amp; curlen == nextlen) &#123; continue; &#125; else if (count &lt; min_count) &#123; // code lengthçš„é‡å¤æ²¡æœ‰è¾¾åˆ°æœ€å°é‡å¤æ¬¡æ•°è¦æ±‚ï¼Œå°†code lengthä»¥RELå­—ç¬¦è¡¨ä¸­çš„(0-15)çš„Huffmanç¼–ç è¾“å‡º do &#123; send_code(curlen, bl_tree); &#125; while (--count != 0); &#125; else if (curlen != 0) &#123; // å½“å‰é‡å¤çš„code lengthå’Œä¹‹å‰çš„code lengthä¸åŒï¼Œåˆ™å…ˆè¾“å‡ºcode length if (curlen != prevlen) &#123; send_code(curlen, bl_tree); count--; &#125; Assert(count &gt;= 3 &amp;&amp; count &lt;= 6, &quot; 3_6?&quot;); // éšåè¾“å‡ºç¼–ç REP_3_6 Huffmanç¼–ç ï¼Œä»¥åŠ2bitçš„é‡å¤æ¬¡æ•° send_code(REP_3_6, bl_tree); send_bits(count-3, 2); &#125; else if (count &lt;= 10) &#123; // code length 0é‡å¤3-10æ¬¡ï¼Œè¾“å‡ºREPZ_3_10 Huffmanç¼–ç ï¼Œä»¥åŠ3bitçš„é‡å¤æ¬¡æ•° send_code(REPZ_3_10, bl_tree); send_bits(count-3, 3); &#125; else &#123; // code length 0é‡å¤11-128æ¬¡ï¼Œè¾“å‡ºREPZ_11_138 Huffmanç¼–ç ï¼Œä»¥åŠ7bitçš„é‡å¤æ¬¡æ•° send_code(REPZ_11_138, bl_tree); send_bits(count-11, 7); &#125; count = 0; prevlen = curlen; if (nextlen == 0) &#123; max_count = 138, min_count = 3; &#125; else if (curlen == nextlen) &#123; max_count = 6, min_count = 3; &#125; else &#123; max_count = 7, min_count = 4; &#125; &#125;&#125;local void send_all_trees(lcodes, dcodes, blcodes) int lcodes, dcodes, blcodes; /* number of codes for each tree */&#123; int rank; /* index in bl_order */ // å­˜åœ¨è‡³å°‘é•¿åº¦ä¸º3çš„lengthç¼–ç ï¼›å­˜åœ¨è‡³å°‘è·ç¦»ä¸º2çš„distanceç¼–ç ï¼›å­˜åœ¨è‡³å°‘é•¿åº¦ä¸ºä¸º4çš„code length RELç¼–ç  Assert (lcodes &gt;= 257 &amp;&amp; dcodes &gt;= 1 &amp;&amp; blcodes &gt;= 4, &quot;not enough codes&quot;); Assert (lcodes &lt;= L_CODES &amp;&amp; dcodes &lt;= D_CODES &amp;&amp; blcodes &lt;= BL_CODES, &quot;too many codes&quot;); // HLIT HDIST HCLEN send_bits(lcodes-257, 5); /* not +255 as stated in appnote.txt */ send_bits(dcodes-1, 5); send_bits(blcodes-4, 4); /* not -3 as stated in appnote.txt */ // RELå­—ç¬¦è¡¨Huffmanç¼–ç çš„code length sequenceè¡¨ç¤º for (rank = 0; rank &lt; blcodes; rank++) &#123; send_bits(bl_tree[bl_order[rank]].Len, 3); &#125; send_tree((ct_data near *)dyn_ltree, lcodes-1); /* send the literal tree */ send_tree((ct_data near *)dyn_dtree, dcodes-1); /* send the distance tree */&#125; 3.3 compress_blockå¯¹LZ77ç®—æ³•å‹ç¼©çš„å­—ç¬¦æµè¿›è¡ŒHuffmanç¼–ç ã€‚literal &amp; lengthå­—ç¬¦æµä¿å­˜åœ¨l_bufä¸­ï¼Œä½¿ç”¨ltreeä¸­å­—ç¬¦çš„Huffmanç¼–ç è¿›è¡Œç¼–ç ï¼Œdistanceå­—ç¬¦æµä¿å­˜åœ¨d_bufä¸­ï¼Œä½¿ç”¨dtreeä¸­å­—ç¬¦çš„Huffmanç¼–ç è¿›è¡Œç¼–ç ã€‚å¯¹å­—ç¬¦æµä¸­æ‰€æœ‰å­—ç¬¦Huffmanç¼–ç å®Œæˆåï¼ŒåŠ ä¸ŠEND_BLOCKçš„Huffmanç¼–ç ï¼Œæ ‡å¿—è¯¥blockç»“æŸã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445local void compress_block(ltree, dtree) ct_data near *ltree; /* literal tree */ ct_data near *dtree; /* distance tree */&#123; unsigned dist; /* distance of matched string */ int lc; /* match length or unmatched char (if dist == 0) */ unsigned lx = 0; /* running index in l_buf */ unsigned dx = 0; /* running index in d_buf */ unsigned fx = 0; /* running index in flag_buf */ uch flag = 0; /* current flags */ unsigned code; /* the code to send */ int extra; /* number of extra bits to send */ if (last_lit != 0) do &#123; if ((lx &amp; 7) == 0) flag = flag_buf[fx++]; lc = l_buf[lx++]; if ((flag &amp; 1) == 0) &#123; send_code(lc, ltree); /* send a literal byte */ Tracecv(isgraph(lc), (stderr,&quot; &#x27;%c&#x27; &quot;, lc)); &#125; else &#123; /* Here, lc is the match length - MIN_MATCH */ code = length_code[lc]; send_code(code+LITERALS+1, ltree); /* send the length code */ extra = extra_lbits[code]; if (extra != 0) &#123; lc -= base_length[code]; send_bits(lc, extra); /* send the extra length bits */ &#125; dist = d_buf[dx++]; /* Here, dist is the match distance - 1 */ code = d_code(dist); Assert (code &lt; D_CODES, &quot;bad d_code&quot;); send_code(code, dtree); /* send the distance code */ extra = extra_dbits[code]; if (extra != 0) &#123; dist -= base_dist[code]; send_bits(dist, extra); /* send the extra distance bits */ &#125; &#125; /* literal or match pair ? */ flag &gt;&gt;= 1; &#125; while (lx &lt; last_lit); // ä½¿ç”¨ltreeå­—ç¬¦è¡¨çš„Huffmanç¼–ç ï¼Œç¼–ç END_BLOCK send_code(END_BLOCK, ltree);&#125; ä»¥LZ77å‹ç¼©çš„å­—ç¬¦æµa(3,4)cd(4,7)befä¸ºä¾‹ï¼Œç›¸åº”çš„æ•°å€¼(å­—ç¬¦ä½¿ç”¨ASCIIç¼–ç è¡¨ç¤º)æ˜¯97,3,4,99,100,4,7,98,101,102ã€‚å®é™…å­˜å‚¨åœ¨flag_bufå’Œd_bufä¸­çš„æ•°æ®(è§ct_tallyçš„è°ƒç”¨ç‚¹)æ˜¯97,3-3,4,99,100,4-3,7,98,101,102å³97,0,4,99,100,1,7,98,101,102ã€‚ä¸‹å›¾å±•ç¤ºäº†å­—ç¬¦æµåœ¨l_bufå’Œd_bufä¸­çš„å­˜å‚¨ï¼šl_bufå­˜å‚¨äº†literalå’Œlength - 3ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½å­˜å‚¨ã€‚ä¸ºäº†åŒºåˆ†l_bufä¸­çš„literalå’Œlengthï¼Œä½¿ç”¨flag_bufä¸­çš„flagbitä½åŒºåˆ†ã€‚bitä½ä¸º0ï¼Œä»£è¡¨l_bufç›¸åº”ä½ç½®å­˜å‚¨çš„æ˜¯literalï¼Œè‹¥ä¸º1ï¼Œåˆ™å­˜å‚¨çš„æ˜¯lengthã€‚å› æ­¤æ¯å¤„ç†å®Œl_bufä¸­çš„1ä¸ªå­—ç¬¦ï¼Œflagè¦å‘å³ç§»åŠ¨ä¸€ä½ï¼›æ¯å¤„ç†å®Œl_bufä¸­çš„8ä¸ªå­—ç¬¦ï¼Œéœ€è¦è¯»å–flag_bufä¸­çš„ä¸‹ä¸€ä¸ªflagã€‚ 3.4 init_blockä¸ºæ–°çš„blockåšåˆå§‹åŒ–å·¥ä½œï¼š 12345678910111213141516local void init_block()&#123; int n; /* iterates over tree elements */ // åˆå§‹åŒ–literal&amp;lengthã€distanceã€RELå­—ç¬¦è¡¨å­—ç¬¦çš„é¢‘æ¬¡ä¸º0 for (n = 0; n &lt; L_CODES; n++) dyn_ltree[n].Freq = 0; for (n = 0; n &lt; D_CODES; n++) dyn_dtree[n].Freq = 0; for (n = 0; n &lt; BL_CODES; n++) bl_tree[n].Freq = 0; dyn_ltree[END_BLOCK].Freq = 1; // åˆå§‹åŒ–dynamic Huffman codesã€static Huffman codesç¼–ç é•¿åº¦ä¸º0 opt_len = static_len = 0L; // å°†l_bufã€d_bufã€flag_bufçš„ç´¢å¼•é‡ç½® last_lit = last_dist = last_flags = 0; flags = 0; flag_bit = 1; &#125; SummaryDEFLATEç®—æ³•çš„Huffmanç¼–ç çš„å‹ç¼©è¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š ç»Ÿè®¡LZ77ç®—æ³•å‹ç¼©æ•°æ®æµä¸­literalã€lengthå‡ºç°çš„é¢‘æ¬¡ï¼Œæ„å»ºliteral &amp; lengthå­—ç¬¦è¡¨çš„Huffmanæ ‘ï¼Œå¹¶ä»¥RLEè¡¨ç¤ºï¼›åŒæ ·å¾—åˆ°distanceå­—ç¬¦è¡¨çš„Huffmanç¼–ç çš„RLEè¡¨ç¤º ç»Ÿè®¡literal &amp; lengthå­—ç¬¦è¡¨ã€distanceå­—ç¬¦è¡¨Huffmanç¼–ç çš„RLEè¡¨ç¤ºä¸­RLEå­—ç¬¦å‡ºç°çš„é¢‘æ¬¡ï¼Œæ„å»ºRLEå­—ç¬¦è¡¨çš„Huffmanæ ‘ï¼Œå¾—åˆ°RLEå­—ç¬¦è¡¨Huffmanç¼–ç çš„code length sequenceè¡¨ç¤º å°†ç¬¬2æ­¥çš„code length sequenceä»¥å›ºå®š3bitç¼–ç è¾“å‡ºåˆ°å‹ç¼©æ•°æ®æµä¸­ï¼›å°†ç¬¬1æ­¥çš„2ä¸ªRLEä»¥ç¬¬2æ­¥å¾—åˆ°çš„RELå­—ç¬¦è¡¨Huffmanç¼–ç è¿›è¡Œç¼–ç ï¼Œå¹¶è¾“å‡ºåˆ°å‹ç¼©æ•°æ®æµä¸­ å°†LZ77ç®—æ³•å‹ç¼©æ•°æ®æµä¸­çš„æ‰€æœ‰å­—ç¬¦ä»¥ç¬¬1æ­¥å¾—åˆ°çš„ä¸¤ä¸ªå­—ç¬¦è¡¨çš„Huffmanç¼–ç è¿›è¡Œç¼–ç ï¼Œå¹¶è¾“å‡ºåˆ°å‹ç¼©æ•°æ®æµä¸­","categories":[{"name":"Base Service","slug":"base-service","permalink":"https://system-thoughts.github.io/categories/base-service/"}],"tags":[{"name":"gzip","slug":"gzip","permalink":"https://system-thoughts.github.io/tags/gzip/"},{"name":"deflate","slug":"deflate","permalink":"https://system-thoughts.github.io/tags/deflate/"}]},{"title":"Understanding gzip - LZ77","slug":"Understanding gzip - LZ77","date":"2022-03-02T11:34:59.000Z","updated":"2023-01-18T05:32:06.156Z","comments":true,"path":"posts/fb8cd772/","link":"","permalink":"https://system-thoughts.github.io/posts/fb8cd772/","excerpt":"gzipæ˜¯ä¸€ç§å‹ç¼©æ ¼å¼ä¹Ÿæ˜¯ç±»Unixä¸Šçš„æ–‡ä»¶å‹ç¼©/è§£å‹ç¼©è½¯ä»¶ï¼Œé€šå¸¸æŒ‡GNUè®¡åˆ’çš„å®ç°ï¼Œæ­¤å¤„gzipä»£è¡¨GNU zipã€‚gzipæ–‡ä»¶æ ¼å¼åœ¨RFC 1952 GZIP file format specification version 4.3ä¸­æ ‡å‡†åŒ–ï¼ŒgzipåŸºäºDEFLATEç®—æ³•å®ç°æ•°æ®å‹ç¼©ï¼ŒDEFLATEç®—æ³•åœ¨RFC 1951 DEFLATE Compressed Data Format Specification version 1.3ä¸­æ ‡å‡†åŒ–ã€‚","text":"gzipæ˜¯ä¸€ç§å‹ç¼©æ ¼å¼ä¹Ÿæ˜¯ç±»Unixä¸Šçš„æ–‡ä»¶å‹ç¼©/è§£å‹ç¼©è½¯ä»¶ï¼Œé€šå¸¸æŒ‡GNUè®¡åˆ’çš„å®ç°ï¼Œæ­¤å¤„gzipä»£è¡¨GNU zipã€‚gzipæ–‡ä»¶æ ¼å¼åœ¨RFC 1952 GZIP file format specification version 4.3ä¸­æ ‡å‡†åŒ–ï¼ŒgzipåŸºäºDEFLATEç®—æ³•å®ç°æ•°æ®å‹ç¼©ï¼ŒDEFLATEç®—æ³•åœ¨RFC 1951 DEFLATE Compressed Data Format Specification version 1.3ä¸­æ ‡å‡†åŒ–ã€‚ DEFLATEç®—æ³•åŸºäºLZ77ç®—æ³•å’ŒHuffmanç¼–ç å®ç°æµæ•°æ®å‹ç¼©ã€‚LZ77ç®—æ³•æ˜¯Abraham Lempelå’ŒJacob Ziväº1977å¹´å‘å¸ƒçš„æ— æŸæ•°æ®å‹ç¼©ç®—æ³•ã€‚LZ77ç®—æ³•æ˜¯å­—å…¸å‹ç¼©ç®—æ³•çš„ä¸€ç§ã€‚å­—å…¸æ˜¯encoderç»´æŠ¤çš„åŒ…å«ä¸€ç»„å­—ç¬¦ä¸²çš„æ•°æ®ç»“æ„ï¼Œå­—å…¸å‹ç¼©è¿‡ç¨‹ä¸­ï¼Œencoderå°†å¾…å‹ç¼©çš„æ–‡æœ¬åœ¨å­—å…¸ä¸­æœç´¢åŒ¹é…å­—ç¬¦ä¸²ï¼Œè‹¥æ‰¾åˆ°åŒ¹é…ï¼Œåˆ™å°†å½“å‰å¾…å‹ç¼©çš„å­—ç¬¦ä¸²ç”¨å­—å…¸ä¸­åŒ¹é…å­—ç¬¦ä¸²çš„ä½ç½®ç´¢å¼•æ¥æ›¿ä»£ï¼Œè¾¾åˆ°ç¼©å‡æ•°æ®çš„æ•ˆæœã€‚LZ77ç®—æ³•çš„å­—å…¸æ˜¯encoderä¹‹å‰å·²ç»ç¼–ç çš„å­—èŠ‚åºåˆ—ã€‚ LZ77ç®—æ³•åŸºæœ¬åŸç†LZ77ç®—æ³•åˆ©ç”¨æ–‡æœ¬ä¸­å­—ç¬¦ä¸²å…·æœ‰é‡å¤çš„ç‰¹ç‚¹ï¼Œå°†åç»­é‡å¤å‡ºç°çš„å­—ç¬¦ä¸²ä½¿ç”¨&lt;length, distance&gt;äºŒå…ƒç»„è¡¨ç¤ºï¼Œlengthè¡¨ç¤ºåŒ¹é…å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œdistanceè¡¨ç¤ºåˆ°ä¹‹å‰å‡ºç°çš„ç›¸åŒå­—ç¬¦ä¸²çš„è·ç¦»ã€‚æ–‡æœ¬ä¸­çš„é‡å¤å­—ç¬¦ä¸²è¶Šå¤šã€é‡å¤å­—ç¬¦ä¸²é•¿åº¦è¶Šé•¿ï¼ŒLZ77ç®—æ³•åˆ™ä¼šå–å¾—æ›´å¥½çš„å‹ç¼©æ•ˆæœã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒLZ77ç®—æ³•åŸºäºæ»‘åŠ¨çª—å£å®ç°ã€‚æ»‘åŠ¨çª—å£åŒ…å«ä¸¤éƒ¨åˆ†ï¼šå‰åŠéƒ¨åˆ†æ˜¯å·²ç»ç¼–ç çš„å­—ç¬¦æµï¼Œç§°ä¸ºå­—å…¸æˆ–è€…search bufferï¼›ååŠéƒ¨åˆ†æ˜¯å¾…ç¼–ç çš„å­—ç¬¦æµï¼Œç§°ä¸ºlook-ahead bufferã€‚LZ77ç®—æ³•ç¼–ç look-ahead bufferä¸­çš„å­—ç¬¦æ—¶ï¼Œä¼šåœ¨search bufferä¸­å¯»æ‰¾æœ€é•¿åŒ¹é…å­—ç¬¦ä¸²ï¼Œè‹¥æ— åŒ¹é…åˆ™ç›´æ¥è¾“å‡ºå­—ç¬¦(literal)ï¼Œè‹¥å­˜åœ¨åŒ¹é…å­—ç¬¦ä¸²ï¼Œåˆ™å°†åŒ¹é…å­—ç¬¦ä¸²é€šè¿‡&lt;length, distance&gt;ç¼–ç ã€‚DEFLATEç®—æ³•è§„å®šåŒ¹é…å­—ç¬¦ä¸²çš„é•¿åº¦èŒƒå›´æ˜¯[3, 258]ã€‚è¿™ä¸ªèŒƒå›´æ˜¯å‹ç¼©ç‡å’Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¹‹é—´çš„å¹³è¡¡ã€‚ ç”±å›¾å¯çŸ¥ï¼ŒLZ77ç¼–ç çš„å­—ç¬¦æµä»…åŒ…å«ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼šliteralã€lengthã€distanceã€‚å®é™…ä¸Šï¼Œlook-ahead bufferé•¿åº¦å°äºMIN_LOOKAHEADæ—¶ï¼Œæ»‘åŠ¨çª—å£ä¾¿ä¼šå‘å‰ç§»åŠ¨ä»¥å¡«å……åç»­æ•°æ®æµä»è€Œæ‰©å¤§look-ahead bufferã€‚ä¸Šå›¾æ‰€ç¤ºlook-ahead bufferè¢«åŒ¹é…å®Œçš„æƒ…å†µåªæœ‰åœ¨æ»‘åŠ¨çª—å£åˆ°è¾¾å­—èŠ‚æµæœ«å°¾ï¼Œæ— æ³•å‘å‰æ»‘åŠ¨æ—¶å‡ºç°ã€‚fill_windowå‡½æ•°è¡¨ç¤ºæ»‘åŠ¨çª—å£çš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354#define WSIZE 0x8000#define MAX_DIST (WSIZE-MIN_LOOKAHEAD)#define EOF (-1)static ulg window_size = (ulg)2*WSIZE; unsigned near strstart; /* start of string to insert */local unsigned near match_start; /* start of matching string */local int eofile; /* flag set at end of input file */local unsigned lookahead; /* number of valid bytes ahead in window */long block_start;/* window position at the beginning of the current output block. Gets * negative when the window is moved backwards. */local void fill_window()&#123; register unsigned n, m; //å½“strstartéå†å®Œæ»‘åŠ¨çª—å£æ—¶ï¼Œmore = EOFï¼›å¦åˆ™more = 0 unsigned more = (unsigned)(window_size - (ulg)lookahead - (ulg)strstart); if (more == (unsigned)EOF) &#123; more--; &#125; else if (strstart &gt;= WSIZE+MAX_DIST) &#123; // strstartä»åœ¨æ»‘åŠ¨çª—å£å†…éƒ¨ï¼Œlookahead &lt; MIN_LOOKAHEAD // æ»‘åŠ¨çª—å£å‘å‰ç§»åŠ¨WSIZE memcpy((char*)window, (char*)window+WSIZE, (unsigned)WSIZE); match_start -= WSIZE; strstart -= WSIZE; /* we now have strstart &gt;= MAX_DIST: */ ... block_start -= (long) WSIZE; // æ›´æ–°Search bufferä¸­çš„hashè¡¨ for (n = 0; n &lt; HASH_SIZE; n++) &#123; m = head[n]; head[n] = (Pos)(m &gt;= WSIZE ? m-WSIZE : NIL); &#125; for (n = 0; n &lt; WSIZE; n++) &#123; m = prev[n]; prev[n] = (Pos)(m &gt;= WSIZE ? m-WSIZE : NIL); &#125; more += WSIZE; &#125; /* At this point, more &gt;= 2 */ if (!eofile) &#123; n = read_buf((char*)window+strstart+lookahead, more); if (n == 0 || n == (unsigned)EOF) &#123; eofile = 1; /* Don&#x27;t let garbage pollute the dictionary. */ memzero (window + strstart + lookahead, MIN_MATCH - 1); &#125; else &#123; lookahead += n; &#125; &#125; &#125; ä¸»è¦è§£é‡Šä¸‹å‡ ä¸ªå…¨å±€å˜é‡ï¼š window_sizeï¼šæ»‘åŠ¨çª—å£å¤§å°ï¼Œé»˜è®¤ä¸º64KB lookahead: look-ahead bufferå¤§å° strstart: å½“å‰å¾…ç¼–ç çš„å­—ç¬¦åœ¨æ»‘åŠ¨çª—å£ä¸­çš„ä½ç½® å½“lookahead &lt; MIN_LOOKAHEAD &amp;&amp; !eofileæ—¶ä¼šè°ƒç”¨fill_windowæ›´æ–°æ»‘åŠ¨çª—å£ã€‚ä¼šå°†æ»‘åŠ¨çª—å£å‘å‰ç§»åŠ¨WSIZEï¼Œå¹¶æ›´æ–°match_startã€strstartã€block_startä»¥åŠsearch bufferä¸­çš„Hashè¡¨ä¸­hash chainä¸Šçš„ç´¢å¼•ã€‚DEFLATEç®—æ³•ä½¿ç”¨hashè¡¨ä¼˜åŒ–åŒ¹é…å­—ç¬¦ä¸²çš„æŸ¥æ‰¾ï¼Œhashè¡¨çš„å®ç°ä¼šåœ¨æœ€åä»‹ç»ã€‚æœ€åä»å­—ç¬¦æµä¸­è¯»å…¥æ•°æ®å¡«å……åˆ°æ»‘åŠ¨çª—å£çš„ååŠéƒ¨åˆ†ï¼šwindow+strstart+lookaheadèµ·å§‹ä½ç½®ã€‚ æƒ°æ€§åŒ¹é…ï¼ˆlazy matchingï¼‰ä¸Šå›¾æ‰€ç¤ºçš„LZ77ç®—æ³•å¹¶éæœ€ä¼˜å‹ç¼©ï¼Œå½“strstart = 8ï¼Œlook-ahead bufferä¸­çš„å†…å®¹ä¸ºabcdaæ—¶ï¼Œå³ä¾¿abcåœ¨search bufferä¸­èƒ½æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç´§é‚»çš„bcdaå¯ä»¥åœ¨search bufferä¸­æ‰¾åˆ°æ›´é•¿çš„åŒ¹é…ä¸²ï¼Œå¾—åˆ°çš„ç¼–ç ç»“æœæ˜¯abcda(3,3)a(4,8)ã€‚DEFLATEé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œè®¾è®¡äº†æƒ°æ€§åŒ¹é…ï¼ˆlazy matchingï¼‰çš„ä¼˜åŒ–æœºåˆ¶ï¼šå½“å‰åŒ¹é…çš„å­—ç¬¦ä¸²é•¿åº¦ä¸ºN(N &gt;= MIN_MATCH)ï¼Œä¼šå°è¯•åœ¨ä¸‹ä¸€ä¸ªå­—ç¬¦å¯»æ‰¾æ›´é•¿çš„åŒ¹é…ï¼Œè‹¥åœ¨ä¸‹ä¸€ä¸ªå­—ç¬¦èƒ½æ‰¾åˆ°æ›´é•¿çš„åŒ¹é…(&gt; N)ï¼Œåˆ™å°†å‰ä¸€ä¸ªå­—ç¬¦ç›´æ¥è¾“å‡ºåˆ°ç¼–ç æµä¸­ï¼Œå³literalï¼›é‡å¤è¿™ä¸€è¿‡ç¨‹ç›´è‡³æ‰¾ä¸åˆ°æ›´é•¿çš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œåˆ™å°†å‰ä¸€ä¸ªå­—ç¬¦æ‰¾åˆ°çš„åŒ¹é…ä»¥&lt;length, distance&gt;äºŒå…ƒç»„è¾“å‡ºåˆ°ç¼–ç æµä¸­ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879local unsigned int near prev_length;/* Length of the best match at previous step. Matches not greater than this * are discarded. This is used in the lazy match evaluation. */local unsigned int max_lazy_match;/* Attempt to find a better match only when the current match is strictly * smaller than this value. This mechanism is used only for compression * levels &gt;= 4. */off_tdeflate (int pack_level)&#123;... /* Process the input block. */ while (lookahead != 0) &#123; // å°†å­—ç¬¦ä¸²window[strstart .. strstart+2]æ’å…¥åˆ°hashè¡¨ INSERT_STRING(strstart, hash_head); /* Find the longest match, discarding those &lt;= prev_length. */ prev_length = match_length, prev_match = match_start; match_length = MIN_MATCH-1; // search bufferä¸­å­˜åœ¨åŒ¹é…å­—ç¬¦ä¸²ï¼›lazy matchè¿‡ç¨‹ä¸­ä¹‹å‰çš„æœ€é•¿åŒ¹é…å­—ç¬¦ä¸²é•¿åº¦ &lt; max_lazy_matchï¼› // å½“å‰å­—ç¬¦ä¸åŒ¹é…å­—ç¬¦ä¸²ä¹‹é—´çš„è·ç¦» &lt;= MAX_DIST if (hash_head != NIL &amp;&amp; prev_length &lt; max_lazy_match &amp;&amp; strstart - hash_head &lt;= MAX_DIST &amp;&amp; strstart &lt;= window_size - MIN_LOOKAHEAD) &#123; // é€šè¿‡hashè¡¨ï¼Œæ‰¾åˆ°å½“å‰å­—ç¬¦ä¸²çš„æœ€é•¿åŒ¹é…å­—ç¬¦ä¸² match_length = longest_match (hash_head); // å¦‚æœåŒ¹é…çš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡look-ahead bufferå¤§å°ï¼Œåˆ™å°†åŒ¹é…å­—ç¬¦ä¸²çš„é•¿åº¦è®¾ç½®ä¸ºlookahead if (match_length &gt; lookahead) match_length = lookahead; ... &#125; // lazy matchç»“æŸï¼Œstrstart-1å­˜åœ¨æœ‰æ•ˆåŒ¹é…ï¼Œä½†æ˜¯strstartçš„åŒ¹é…é•¿åº¦ &lt;= strstart-1çš„æœ€é•¿åŒ¹é…é•¿åº¦ if (prev_length &gt;= MIN_MATCH &amp;&amp; match_length &lt;= prev_length) &#123; // double checkï¼Œç¡®è®¤strstart-1çš„åŒ¹é…æ— è¯¯ check_match(strstart-1, prev_match, prev_length); // å°†strstart-1å­—ç¬¦ä»¥&lt;length, distance&gt;ç¼–ç  flush = ct_tally(strstart-1-prev_match, prev_length - MIN_MATCH); // å› ä¸ºè¿™é‡Œç”¨çš„æ˜¯å‰ä¸€ä¸ªå­—ç¬¦çš„åŒ¹é…ï¼Œåˆ°å½“å‰å­—ç¬¦åŒ¹é…æ—¶lookaheadå·²ç»-1ï¼Œæ‰€ä»¥æ­¤å¤„æ˜¯-(prev_length-1) lookahead -= prev_length-1; // strstart-1ä»¥åŠstrstartå¼€å§‹çš„å­—ç¬¦ä¸²å·²ç»æ’å…¥åˆ°hashè¡¨ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦å¯¹è¿™ä¸¤ä¸ªå­—ç¬¦å¼€å§‹çš„å­—ç¬¦ä¸²æ±‚hash prev_length -= 2; // æ±‚åŒ¹é…å­—ç¬¦ä¸²ä¸­æ¯ä¸ªå­—ç¬¦å¼€å§‹çš„é•¿åº¦ä¸º3çš„å­—ç¬¦ä¸²çš„hashå€¼ do &#123; strstart++; INSERT_STRING(strstart, hash_head); &#125; while (--prev_length != 0); // ä¸å­˜åœ¨å‰ä¸€ä¸ªå­—ç¬¦çš„åŒ¹é…ï¼Œå¼€å§‹lazy matchçš„æœ€å¼€å§‹åŒ¹é… match_available = 0; match_length = MIN_MATCH-1; strstart++; ... if (flush) FLUSH_BLOCK(0), block_start = strstart; &#125; else if (match_available) &#123; // lazy matchè¿‡ç¨‹ä¸­å­˜åœ¨æœ‰æ•ˆçš„å‰ä¸€ä¸ªå­—ç¬¦åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œå½“å‰å­—ç¬¦ä¸²åŒ¹é…æ›´é•¿ï¼›æˆ–è€…å‰ä¸€ä¸ªå­—ç¬¦åœ¨search bufferä¸­æ— åŒ¹é…çš„å­—ç¬¦ä¸² // å°†strstart-1å­—ç¬¦ä»¥literalç¼–ç  flush = ct_tally (0, window[strstart-1]); ... if (flush) FLUSH_BLOCK(0), block_start = strstart; strstart++; lookahead--; &#125; else &#123; // search bufferä¸­æ— åŒ¹é…çš„å­—ç¬¦ä¸² match_available = 1; strstart++; lookahead--; &#125; // å½“look-ahead bufferç©ºé—´ä¸è¶³æ—¶ï¼Œæ»‘åŠ¨çª—å£ while (lookahead &lt; MIN_LOOKAHEAD &amp;&amp; !eofile) fill_window(); &#125; // å¦‚æœå‰ä¸€ä¸ªå­—ç¬¦åœ¨search bufferä¸­æ— åŒ¹é…å­—ç¬¦ä¸²ï¼Œå°†strstart-1å­—ç¬¦ä»¥literalç¼–ç  if (match_available) ct_tally (0, window[strstart-1]); return FLUSH_BLOCK(1); /* eof */&#125; lazy matchçš„å®é™…å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š å½“å‰å­—ç¬¦ä¸åŒ¹é…å­—ç¬¦ä¸²çš„è·ç¦»ä¸è¶…è¿‡MAX_DIST(32768 - 258 - 3 - 1)ï¼ŒDEFLATEç®—æ³•è§„å®šæœ€å¤§è·ç¦»ä¸º32768 å½“å‰å­—ç¬¦çš„æœ€é•¿åŒ¹é…é•¿åº¦ä¸è¶…è¿‡look-ahead bufferé•¿åº¦ match_available = 0è¡¨ç¤ºlazy matchè¿‡ç¨‹ç»“æŸï¼Œå³å½“å‰å­—ç¬¦çš„åŒ¹é…å­—ç¬¦ä¸²æ¯”å‰ä¸€ä¸ªå­—ç¬¦çš„åŒ¹é…å­—ç¬¦ä¸²è¦æ®µï¼Œé‡æ–°å¼€å§‹æŸ¥æ‰¾æœ€åˆçš„åŒ¹é…å­—ç¬¦ä¸²ã€‚match_available = 1åœ¨é‡æ–°å¼€å§‹lazy matchè¿›è¡Œç¬¬ä¸€æ¬¡åŒ¹é…æ—¶è®¾ç½®ã€‚å› æ­¤ï¼Œlazy matchè¿‡ç¨‹ä¸­å­˜åœ¨æœ‰æ•ˆçš„å‰ä¸€ä¸ªå­—ç¬¦åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…å½“å‰å­—ç¬¦åœ¨search bufferä¸­æ— åŒ¹é…çš„å­—ç¬¦ä¸²çš„åœºæ™¯ä¸‹ï¼Œmatch_availableéƒ½ä¸º1ã€‚ Hashä¼˜åŒ–DEFLATEç®—æ³•é€šè¿‡é“¾å¼hashè¡¨åŠ é€Ÿsearch bufferä¸­çš„é‡å¤å­—ç¬¦ä¸²æŸ¥æ‰¾ï¼Œé“¾å¼hashè¡¨ä¸Šå­˜å‚¨çš„æ˜¯é•¿åº¦ä¸º3çš„å­—ç¬¦ä¸²çš„ç´¢å¼•ã€‚DEFLATEç®—æ³•çš„æ•£åˆ—å‡½æ•°è®¾è®¡çš„éå¸¸ç®€å•ã€é«˜æ•ˆï¼š 123456789101112131415161718192021222324252627local unsigned ins_h; /* hash index of string to be inserted */// åˆå§‹åŒ–hash keyfor (j=0; j&lt;MIN_MATCH-1; j++) UPDATE_HASH(ins_h, window[j])// æ›´æ–°hash key/* =========================================================================== * Update a hash value with the given input byte * IN assertion: all calls to UPDATE_HASH are made with consecutive * input characters, so that a running hash key can be computed from the * previous key instead of complete recalculation each time. */#define UPDATE_HASH(h,c) (h = (((h)&lt;&lt;H_SHIFT) ^ (c)) &amp; HASH_MASK)// å°†åç§»så¤„çš„é•¿åº¦ä¸º3çš„å­—ç¬¦ä¸²æ’å…¥åˆ°hashè¡¨ä¸­/* =========================================================================== * Insert string s in the dictionary and set match_head to the previous head * of the hash chain (the most recent string with same hash key). Return * the previous length of the hash chain. * IN assertion: all calls to INSERT_STRING are made with consecutive * input characters and the first MIN_MATCH bytes of s are valid * (except for the last MIN_MATCH-1 bytes of the input file). */#define INSERT_STRING(s, match_head) \\ (UPDATE_HASH(ins_h, window[(s) + MIN_MATCH-1]), \\ prev[(s) &amp; WMASK] = match_head = head[ins_h], \\ head[ins_h] = (s)) å½“å‰å­—ç¬¦å¼€å§‹é•¿åº¦ä¸º3çš„å­—ç¬¦ä¸²çš„hash keyå¯ä»¥é€šè¿‡ä¹‹å‰çš„hash keyä¸å½“å‰çš„å­—ç¬¦è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œåœ¨O(1)æ—¶é—´å†…æ±‚å¾—ã€‚å› æ­¤ï¼Œæ•´ä¸ªå­—ç¬¦æµçš„æ‰€æœ‰é•¿åº¦ä¸º3çš„å­—ç¬¦ä¸²çš„hash keyçš„è®¡ç®—æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚ æ•´ä¸ªé“¾å¼hashè¡¨çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼š head[HASH_SIZE]æ•°ç»„æŒ‰ç…§hash keyç´¢å¼•ï¼Œç›¸åº”ä½ç½®å­˜å‚¨çš„æ˜¯æœ€è¿‘ä¸€æ¬¡è®¡ç®—å¾—åˆ°çš„hash keyçš„å­—ç¬¦ä½ç½® prev[WSIZE]æ•°ç»„å­˜å‚¨çš„æ˜¯å½“å‰å­—ç¬¦ä½ç½®så‰ä¸€ä¸ªé‡å¤å­—ç¬¦ä¸²çš„å­—ç¬¦ä½ç½® å› æ­¤éå†hash chainå¯ä»¥ç”¨å¦‚ä¸‹å¾ªç¯ï¼š 123456INSERT_STRING(strstart, cur_match);// cur_match &lt;= limitæ—¶ï¼ŒåŒ¹é…å­—ç¬¦ä¸²è¶…è¿‡MAX_DISTIPos limit = strstart &gt; (IPos)MAX_DIST ? strstart - (IPos)MAX_DIST : NIL;do &#123; ...&#125; while ((cur_match = prev[cur_match &amp; WMASK]) &gt; limit); fill_windowæ»‘åŠ¨çª—å£å‘å‰ç§»åŠ¨WSIZEæ›´æ–°hashè¡¨æ—¶ï¼Œhash chainä¸­å°äºWSIZEçš„ç´¢å¼•è¢«æ›´æ–°ä¸ºNILï¼Œå› ä¸ºè¿™ä¸ªç´¢å¼•ä½ç½®çš„æ•°æ®å·²ç»ä»æ»‘åŠ¨çª—å£ç§»é™¤ï¼›å…¶ä»–ç´¢å¼•mè¢«æ›´æ–°ä¸ºm - WSIZEã€‚","categories":[{"name":"Base Service","slug":"base-service","permalink":"https://system-thoughts.github.io/categories/base-service/"}],"tags":[{"name":"gzip","slug":"gzip","permalink":"https://system-thoughts.github.io/tags/gzip/"},{"name":"deflate","slug":"deflate","permalink":"https://system-thoughts.github.io/tags/deflate/"}]},{"title":"å¼€æœºè¿‡ç¨‹åˆ†æ--BIOSé˜¶æ®µ","slug":"å¼€æœºè¿‡ç¨‹åˆ†æ--BIOSé˜¶æ®µ","date":"2021-12-09T13:27:09.000Z","updated":"2023-01-18T05:32:06.168Z","comments":true,"path":"posts/cbbcdbd9/","link":"","permalink":"https://system-thoughts.github.io/posts/cbbcdbd9/","excerpt":"æ— è®ºæ˜¯Linuxè¿˜æ˜¯å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œå¼€æœºå¯åŠ¨æœ€å¼€å§‹çš„æµç¨‹ç”±BIOSå®Œæˆã€‚å½“ç”µè„‘ä¸Šç”µåï¼ŒBIOSé¦–å…ˆä¼šåˆå§‹åŒ–BIOSå†…éƒ¨çŠ¶æ€ã€å¤–éƒ¨æ¥å£ã€æ£€æµ‹å¹¶setupç¡¬ä»¶ã€‚è¿™ä¸ªæœ€å¼€å§‹çš„é˜¶æ®µç§°ä¸ºå¼€æœºè‡ªæ£€(POST, Power On Self Test)ã€‚éšåBIOSè¿›å…¥å¯åŠ¨é˜¶æ®µï¼Œä¼šæ£€æŸ¥å¯åŠ¨ä»‹è´¨ï¼Œæ‰¾åˆ°bootloaderï¼Œå°†å…¶åŠ è½½è‡³å†…å­˜å¹¶è·³è½¬è‡³bootloaderæ‰§è¡Œã€‚æœ¬æ–‡ä»¥SeaBIOSä¸ºä¾‹ï¼Œä»‹ç»x86æ¶æ„ä¸‹BIOSåœ¨å¯åŠ¨æµç¨‹æ‰€åšçš„å·¥ä½œã€‚SeaBIOSæ˜¯16bit x86 BIOSçš„å¼€æºå®ç°ï¼Œä¹Ÿæ˜¯qemuå’Œkvmé»˜è®¤çš„BIOSã€‚","text":"æ— è®ºæ˜¯Linuxè¿˜æ˜¯å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œå¼€æœºå¯åŠ¨æœ€å¼€å§‹çš„æµç¨‹ç”±BIOSå®Œæˆã€‚å½“ç”µè„‘ä¸Šç”µåï¼ŒBIOSé¦–å…ˆä¼šåˆå§‹åŒ–BIOSå†…éƒ¨çŠ¶æ€ã€å¤–éƒ¨æ¥å£ã€æ£€æµ‹å¹¶setupç¡¬ä»¶ã€‚è¿™ä¸ªæœ€å¼€å§‹çš„é˜¶æ®µç§°ä¸ºå¼€æœºè‡ªæ£€(POST, Power On Self Test)ã€‚éšåBIOSè¿›å…¥å¯åŠ¨é˜¶æ®µï¼Œä¼šæ£€æŸ¥å¯åŠ¨ä»‹è´¨ï¼Œæ‰¾åˆ°bootloaderï¼Œå°†å…¶åŠ è½½è‡³å†…å­˜å¹¶è·³è½¬è‡³bootloaderæ‰§è¡Œã€‚æœ¬æ–‡ä»¥SeaBIOSä¸ºä¾‹ï¼Œä»‹ç»x86æ¶æ„ä¸‹BIOSåœ¨å¯åŠ¨æµç¨‹æ‰€åšçš„å·¥ä½œã€‚SeaBIOSæ˜¯16bit x86 BIOSçš„å¼€æºå®ç°ï¼Œä¹Ÿæ˜¯qemuå’Œkvmé»˜è®¤çš„BIOSã€‚ å®æ¨¡å¼x86å®æ¨¡å¼å‡ºç°äºIntel 8088æ—¶æœŸï¼Œ8088 CPUå…¬æœ‰20ä½åœ°å€æ€»çº¿ï¼Œ8ä¸ª16è¿›åˆ¶é€šç”¨å¯„å­˜å™¨ä»¥åŠ4ä¸ªæ®µå¯„å­˜å™¨(CS DS SS ES)ä»¥åŠ3ä¸ªä¸“ç”¨å¯„å­˜å™¨(IP SP FLAGS)ã€‚è¦é€šè¿‡16ä½å¯„å­˜å™¨å¯»å€20ä½åœ°å€ç©ºé—´ï¼Œ8088å¼•å…¥äº†åˆ†æ®µçš„æ–¹æ³•ï¼š ç‰©ç†åœ°å€ = æ®µå¯„å­˜å™¨ &lt;&lt; 4 + æ®µå†…åç§» å¦‚æ­¤ï¼Œé€šè¿‡16bitçš„æ®µå¯„å­˜å™¨å’Œæ®µå†…åç§»ä¾¿èƒ½å¯»å€20ä½åœ°å€ç©ºé—´ï¼Œè®¡ç®—å‡ºçš„åœ°å€ä¾¿æ˜¯å®é™…ç‰©ç†åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯â€œå®â€æ¨¡å¼çš„ç”±æ¥ã€‚ First Instructionç³»ç»Ÿä¸Šç”µåï¼ŒBIOSæœ€åˆä¾¿åœ¨16bitå®æ¨¡å¼ä¸‹å·¥ä½œã€‚x86-64ç¯å¢ƒä¸‹ï¼ŒBIOSçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä½äºCS(0xF000h):IP(0xFFF0h)æ‰€æŒ‡å‘çš„åœ°å€ã€‚åˆšæ‰æåŠï¼Œä¸Šç”µä¹‹åˆï¼ŒBIOSåœ¨16bitå®æ¨¡å¼ä¸‹å·¥ä½œï¼Œæœ€å¤§å¯»å€1MBï¼ŒæŒ‰ç…§å®æ¨¡å¼ä¸‹çš„å¯»å€è§„åˆ™ï¼š(0xF000h &lt;&lt; 4) + (0xFFF0h) = 0xFFFF0hã€‚é‚£ä¹ˆå¼€æœºå¯åŠ¨ä¹‹åï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤ä¼šåœ¨0xFFFF0hæ‰§è¡Œï¼Ÿå…¶å®ä¸ç„¶ï¼Œå¼€æœºæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨0xfffffff0hå¤„æ‰§è¡Œã€‚åˆ†æ®µæ¨¡å¼ä¸‹çš„æ¯ä¸ªæ®µå¯„å­˜å™¨å¯»å€çš„å®é™…ç‰©ç†åœ°å€ç¼“å­˜åœ¨æ®µæè¿°ç¬¦é«˜é€Ÿç¼“å†²å¯„å­˜å™¨ä¸­ï¼Œè¿™ä¸ªå¯„å­˜å™¨å¯¹äºç¨‹åºå‘˜æ˜¯ä¸å¯è§çš„ï¼Œæ®µæè¿°ç¬¦é«˜é€Ÿç¼“å†²å¯„å­˜å™¨å°±æ˜¯é€šè¿‡ç¡¬ä»¶åŠ é€Ÿåˆ†æ®µæ¨¡å¼ä¸‹çš„å¯»å€é€Ÿåº¦ã€‚CSæ®µå¯„å­˜å™¨å¯¹åº”çš„æ®µæè¿°ç¬¦é«˜é€Ÿç¼“å†²å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€0xFFFFFFF0hï¼Œè¯¥ç‰©ç†åœ°å€ç§°ä¸ºReset vectorã€‚ æ‰§è¡Œqemu-kvm -monitor stdio -Så‘½ä»¤æŸ¥çœ‹æœºå™¨å¯åŠ¨æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼š 1234567891011121314151617181920[root@192 lab1]# qemu-kvm -monitor stdio -SQEMU 2.12.0 monitor - type &#x27;help&#x27; for more information(qemu) VNC server running on ::1:5901(qemu) info registers EAX=00000000 EBX=00000000 ECX=00000000 EDX=000006d3ESI=00000000 EDI=00000000 EBP=00000000 ESP=00000000EIP=0000fff0 EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0ES =0000 00000000 0000ffff 00009300CS =f000 ffff0000 0000ffff 00009b00SS =0000 00000000 0000ffff 00009300DS =0000 00000000 0000ffff 00009300FS =0000 00000000 0000ffff 00009300GS =0000 00000000 0000ffff 00009300LDT=0000 00000000 0000ffff 00008200TR =0000 00000000 0000ffff 00008b00GDT= 00000000 0000ffffIDT= 00000000 0000ffffCR0=60000010 CR2=00000000 CR3=00000000 CR4=00000000... CSå¯„å­˜å™¨ä¸º0xf000ï¼ŒEIPå¯„å­˜å™¨ä¸º0000fff0ï¼ŒCSå¯„å­˜å™¨å¯¹åº”çš„æ®µåŸºå€æ˜¯0xffff0000ï¼Œè¯¥æ®µæœ€èƒ½å®¹çº³0x0000ffffå­—èŠ‚ã€‚å¦‚æ­¤ï¼Œèµ·å§‹ç‰©ç†åœ°å€ä¾¿æ˜¯0xfffffff0ï¼Œä¾¿æ˜¯Reset vectorã€‚ ä½†æ˜¯0xFFFFFFF0hä»ç„¶é«˜äºå®æ¨¡å¼ä¸‹çš„æœ€å¤§ç‰©ç†åœ°å€ç©ºé—´1MBï¼Œä¸ºå•¥BIOSå¯ä»¥è®¿é—®åˆ°äº†ï¼Ÿ0xFFFFFFF0hå®é™…æ˜¯BIOS ROMæ˜ å°„åˆ°åœ°å€ç©ºé—´çš„åœ°å€ï¼Œè€Œéåœ¨å®æ¨¡å¼å¯»å€RAMçš„ç‰©ç†åœ°å€ï¼š 0xFFFE_0000 - 0xFFFF_FFFF: 128 kByte ROM mapped into address space æŸ¥çœ‹SeaBIOSæºç ï¼ŒBIOSç¬¬ä¸€æ¡æŒ‡ä»¤ä¼šæ‰§è¡Œä»€ä¹ˆï¼š 1234 ORG 0xfff0 // Power-up Entry Point .global reset_vectorreset_vector: ljmpw $SEG_BIOS, $entry_post ORGæ˜¯ä¸€ä¸ªå®ï¼š 1234// Specify a location in the fixed part of bios area..macro ORG addr.section .fixedaddr.\\addr.endm ORG 0xfff0ä¼šå®šä¹‰ä¸€ä¸ªåä¸º.fixedaddr.0xfff0çš„ELF sectionï¼Œæ„å»ºé˜¶æ®µï¼Œlayoutrom.pyè„šæœ¬ä¼šæ£€æµ‹åç§°ä¸­åŒ…å«â€.fixedaddr.â€çš„sectionï¼Œå¹¶åœ¨æœ€ç»ˆçš„é“¾æ¥è„šæœ¬ä¸­æŒ‡å®šè¯¥sectionåŠ è½½åˆ°çš„ç‰©ç†åœ°å€ã€‚å¯è§ï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤ä¼šæ‰§è¡Œä¸€ä¸ªé•¿è·³è½¬ï¼ˆæ™®é€šè·³è½¬åªä¼šæ›´æ–°EIPå¯„å­˜å™¨ï¼Œé•¿è·³è½¬è¿˜ä¼šæ›´æ–°CSå¯„å­˜å™¨ï¼‰è‡³0xf000:0xe05b 123456789101112src/config.hï¼š// Important real-mode segments#define SEG_IVT 0x0000#define SEG_BDA 0x0040#define SEG_BIOS 0xf000src/romlayout.S: ORG 0xe05bentry_post: cmpl $0, %cs:HaveRunPost // Check for resume/reboot jnz entry_resume ENTRY_INTO32 _cfunc32flat_handle_post // Normal entry point ç¬¬ä¸€æ¡æŒ‡ä»¤ä¾¿æ˜¯è·³è½¬åˆ°1MBä»¥ä¸‹çš„0xfe05bå¤„æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯¥åœ°å€å¤„äºBIOS ROMåŒºåŸŸã€‚BIOS ROMå†…å­˜åŒºåŸŸæ˜¯BIOS shadowå†…å­˜åŒºåŸŸï¼Œå½“å‰è¯¥å†…å­˜åŒºåŸŸæ˜¯BIOSåœ¨ROM/flashå®é™…å­˜å‚¨ä¸­çš„ä¸€ä»½åªè¯»æ‹·è´ã€‚ç”±äºCPUè®¿é—®flash/ROMçš„é€Ÿåº¦/å¸¦å®½è¦æ…¢äºCPUè®¿é—®RAMçš„é€Ÿåº¦ï¼ŒBIOS shadowå¯ä»¥åŠ å¿«CPUè®¿é—®BIOSç¨‹åºçš„é€Ÿåº¦ã€‚ é¦–å…ˆé€šè¿‡HaveRunPostå…¨å±€å˜é‡åˆ¤æ–­æ˜¯å¦ç»å†è¿‡POSTé˜¶æ®µï¼Œè‹¥ç»è¿‡POSTé˜¶æ®µï¼Œåˆ™è·³è¿‡POSTé˜¶æ®µæ‰§è¡Œresumeã€‚å¦åˆ™åˆ‡æ¢åˆ°32bitä¿æŠ¤æ¨¡å¼æ‰§è¡Œhandle_postå‡½æ•°è¿›å…¥POSTé˜¶æ®µã€‚ 12// Indicator if POST phase has been started (and if it has completed).int HaveRunPost VARFSEG; POST Phaseåˆ‡æ¢åˆ°32bitä¿æŠ¤æ¨¡å¼æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹è¿›å…¥32bitä¿æŠ¤æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„ï¼š 12345678910111213src/entryfuncs.S: // Reset stack, transition to 32bit mode, and call a C function. .macro ENTRY_INTO32 cfunc xorw %dx, %dx movw %dx, %ss movl $ BUILD_STACK_ADDR , %esp movl $ \\cfunc , %edx jmp transition32 .endmsrc/config.hï¼š// Various memory addresses used by the code.#define BUILD_STACK_ADDR 0x7000 é¦–å…ˆè®¾ç½®å †æ ˆæ®µå¯„å­˜å™¨ssä¸º0ï¼ŒBIOS ROMçš„ç¨‹åºå †æ ˆå¤„äºlow memoryåœ°å€ç©ºé—´(0x7000)ã€‚è¿™é‡Œçš„cfuncæ˜¯å‡½æ•°Labelï¼Œè¢«ä¼ é€’åˆ°edxå¯„å­˜å™¨ï¼Œtransition32åˆ‡æ¢åˆ°32bitä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œä¼šè·³è½¬åˆ°è¯¥åœ°å€æ‰§è¡Œã€‚ transition32å°†CPUè½¬æ¢æˆ32bitï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455src/entryfuncs.S: // Declare a function .macro DECLFUNC func .section .text.asm.\\func .global \\func .endmsrc/romlayout.S:// Place CPU into 32bit mode from 16bit mode.// %edx = return location (in 32bit mode)// Clobbers: ecx, flags, segment registers, cr0, idt/gdt DECLFUNC transition32 .global transition32_nmi_offtransition32: // Disable irqs (and clear direction flag) cli cld // Disable nmi movl %eax, %ecx movl $CMOS_RESET_CODE|NMI_DISABLE_BIT, %eax outb %al, $PORT_CMOS_INDEX inb $PORT_CMOS_DATA, %al // enable a20 inb $PORT_A20, %al orb $A20_ENABLE_BIT, %al outb %al, $PORT_A20 movl %ecx, %eax transition32_nmi_off: // Set segment descriptors lidtw %cs:pmode_IDT_info lgdtw %cs:rombios32_gdt_48 // Enable protected mode movl %cr0, %ecx andl $~(CR0_PG|CR0_CD|CR0_NW), %ecx orl $CR0_PE, %ecx movl %ecx, %cr0 // start 32bit protected mode code ljmpl $SEG32_MODE32_CS, $(BUILD_BIOS_ADDR + 1f) .code32 // init data segments1: movl $SEG32_MODE32_DS, %ecx movw %cx, %ds movw %cx, %es movw %cx, %ss movw %cx, %fs movw %cx, %gs jmpl *%edx DECLFUNCå®å®šä¹‰åä¸º.text.asm.transition32çš„sectionï¼Œtransition32ä»¥åŠtransition32_nmi_offéƒ½åœ¨è¯¥sectionï¼Œè¿™ä¸¤ä¸ªç¬¦å·é€šè¿‡.globalå¯¹é“¾æ¥å™¨å¯è§ã€‚ é¦–å…ˆå…³ä¸­æ–­å¹¶æ¸…ç©ºæ–¹å‘æ ‡å¿—ä½ã€‚è¿‡å»ï¼Œä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½è¢«åˆå¹¶é›†æˆåœ¨ä¸€ä¸ªæœ‰â€œç©ºé—´â€çš„èŠ¯ç‰‡ä¸Šï¼Œæ§åˆ¶NMIä¸­æ–­ä½¿èƒ½ã€CMOSæ§åˆ¶å™¨ã€RTCæ—¶é’Ÿéƒ½æ”¾åœ¨CMOSä¸­ã€‚ 12345678src/hw/rtc.h:#define PORT_CMOS_INDEX 0x0070#define PORT_CMOS_DATA 0x0071// PORT_CMOS_INDEX nmi disable bit#define NMI_DISABLE_BIT 0x80...#define CMOS_RESET_CODE 0x0f å…³é—­NMIä¸­æ–­çš„æ­¥éª¤å¦‚ä¸‹ï¼š å‘0x70ç«¯å£ï¼Œå†™å…¥NMI diable bit(0x80)ä»¥åŠé€‰æ‹©CMOSå¯„å­˜å™¨ï¼Œæ¥ç€è¦é€šè¿‡0x71ç«¯å£ä»åŒä¸€é€‰æ‹©CMOSå¯„å­˜å™¨è¯»å–æ‰ç®—å®Œæˆå…³é—­NMIæ“ä½œï¼š1outb (0x70, (NMI_disable_bit &lt;&lt; 7) | (selected CMOS register number)); ä»0x71ç«¯å£è¯»å–é€‰æ‹©CMOSå¯„å­˜å™¨å®Œæˆå…³é—­NMIä¸­æ–­ï¼š1inb (0x71, (NMI_disable_bit &lt;&lt; 7) | (selected CMOS register number)); éšåå¼€å¯A20æ€»çº¿ä»¥ä¾¿è®¿é—®1MBä»¥ä¸Šçš„ç‰©ç†åœ°å€ç©ºé—´ã€‚8086/8088å®æ¨¡å¼ä¸‹ï¼Œæœ€å¤§èƒ½å¤Ÿè®¿é—®çš„ç‰©ç†åœ°å€æ˜¯0xFFFF:0xFFFFå³0x10FFEFã€‚è®¿é—®è¯¥ç‰©ç†åœ°å€éœ€è¦21æ ¹åœ°å€çº¿ï¼Œç„¶è€Œ8086/8088ä»…æœ‰20æ ¹åœ°å€æ€»çº¿ï¼Œå› æ­¤æ”¹åœ°å€ä¼šè¢«æˆªæ–­æˆ0x0FFEFã€‚åç»­80x86 CPUä¸ºäº†å…¼å®¹è¿™ç§å›ç¯ç°è±¡ï¼Œè®¾è®¡äº†A20æ€»çº¿ï¼Œå½“A20æ€»çº¿ä¸º1ï¼Œç¬¬21ä½ä»¥åŠæ›´é«˜ä½éƒ½æœ‰æ•ˆï¼›åä¹‹ï¼Œé«˜ä½ä¸º0ï¼Œå…¼å®¹å›ç¯ç°è±¡ã€‚123// PORT_A20 bitdefs#define PORT_A20 0x0092#define A20_ENABLE_BIT 0x02 å¯è§é€šè¿‡å¾€A20 0x92I/Oç«¯å£ç½®ä½ç¬¬2 bitä½å¼€å¯A20æ€»çº¿ã€‚éšåé€šè¿‡lidtwå’Œlgdtwä¸¤æ¡å‘½ä»¤åŠ è½½idtrå’Œgdtrå¯„å­˜å™¨ï¼Œè®¾å®šä¸­æ–­æè¿°ç¬¦è¡¨å’Œå…¨å±€æè¿°ç¬¦è¡¨ã€‚32bitä¿æŠ¤æ¨¡å¼ä¸‹çš„åˆ†æ®µå¯»å€å’Œå®æ¨¡å¼æœ‰è¾ƒå¤§å·®å¼‚ã€‚åç§»å€¼åŒå®æ¨¡å¼ä¸€æ ·ï¼Œåªä¸è¿‡å˜æˆäº†32bitã€‚æ®µå€¼ä»ç„¶æ”¾åœ¨ä»¥å‰çš„16bitå¯„å­˜å™¨ï¼Œä¸è¿‡å¯„å­˜å™¨å­˜æ”¾çš„ä¸æ˜¯æ®µåŸºå€ï¼Œè€Œæ˜¯æ®µé€‰æ‹©ç¬¦ã€‚é€šè¿‡æ®µé€‰æ‹©ç¬¦ä¸ä»…èƒ½å¤Ÿç´¢å¼•å…¨å±€/å±€éƒ¨æè¿°ç¬¦è¡¨è·å–æ®µæè¿°ç¬¦ä¸­çš„åŸºå€ï¼Œè¿˜èƒ½å¤Ÿæè¿°å½“å‰è®¿é—®æ“ä½œçš„ç‰¹æƒçº§å®ç°æ®µä¿æŠ¤ã€‚ æ®µæè¿°ç¬¦è¡¨rombios32_gdt_48å¦‚ä»£ç æ‰€ç¤ºï¼Œå¯¹æ¯”æ®µæè¿°ç¬¦ç»“æ„ï¼Œåˆ™ä¸€ç›®äº†ç„¶ã€‚ 123456789101112131415161718192021222324252627282930313233// Dummy IDT that forces a machine shutdown if an irq happens in// protected mode.u8 dummy_IDT VARFSEG;// Protected mode IDT descriptorstruct descloc_s pmode_IDT_info VARFSEG = &#123; .length = sizeof(dummy_IDT) - 1, .addr = (u32)&amp;dummy_IDT,&#125;;// GDTu64 rombios32_gdt[] VARFSEG __aligned(8) = &#123; // First entry can&#x27;t be used. 0x0000000000000000LL, // 32 bit flat code segment (SEG32_MODE32_CS) GDT_GRANLIMIT(0xffffffff) | GDT_CODE | GDT_B, // 32 bit flat data segment (SEG32_MODE32_DS) GDT_GRANLIMIT(0xffffffff) | GDT_DATA | GDT_B, // 16 bit code segment base=0xf0000 limit=0xffff (SEG32_MODE16_CS) GDT_LIMIT(BUILD_BIOS_SIZE-1) | GDT_CODE | GDT_BASE(BUILD_BIOS_ADDR), // 16 bit data segment base=0x0 limit=0xffff (SEG32_MODE16_DS) GDT_LIMIT(0x0ffff) | GDT_DATA, // 16 bit code segment base=0xf0000 limit=0xffffffff (SEG32_MODE16BIG_CS) GDT_GRANLIMIT(0xffffffff) | GDT_CODE | GDT_BASE(BUILD_BIOS_ADDR), // 16 bit data segment base=0 limit=0xffffffff (SEG32_MODE16BIG_DS) GDT_GRANLIMIT(0xffffffff) | GDT_DATA,&#125;;// GDT descriptorstruct descloc_s rombios32_gdt_48 VARFSEG = &#123; .length = sizeof(rombios32_gdt) - 1, .addr = (u32)rombios32_gdt,&#125;; éšåé€šè¿‡è®¾ç½®CR0å¯„å­˜å™¨ï¼šå…³é—­åˆ†é¡µæ¨¡å¼ã€ä½¿èƒ½CPU cacheã€è®¾ç½®CPU cache Write-throughã€å¹¶å¼€å¯ä¿æŠ¤æ¨¡å¼ï¼š 123456src/x86.h:// CR0 flags#define CR0_PG (1&lt;&lt;31) // Paging#define CR0_CD (1&lt;&lt;30) // Cache disable#define CR0_NW (1&lt;&lt;29) // Not Write-through#define CR0_PE (1&lt;&lt;0) // Protection enable æœ€ç»ˆï¼Œé€šè¿‡é•¿è·³è½¬ljmplè·³è½¬è‡³32bitä¿æŠ¤æ¨¡å¼ï¼ŒCSå¯„å­˜å™¨å­˜å‚¨çš„æ®µé€‰æ‹©ç¬¦ä¸º01000B,å³RPL = 0,æ‰§è¡Œåœ¨ç‰¹æƒçº§0ä¸Šï¼›TI = 0ï¼Œæ®µé€‰æ‹©ç¬¦ç´¢å¼•GDTï¼›Index = 1ï¼Œç´¢å¼•GDTä¸­çš„ç¬¬ä¸€ä¸ªæ®µæè¿°ç¬¦ã€‚æ®µæè¿°ç¬¦ä¸­åŸºå€æ˜¯0x0ï¼ŒSegment Limitæ˜¯0xfffffï¼ŒG(Granularity)flagç½®ä½ï¼Œè¡¨ç¤ºè¯¥æ®µçš„èŒƒå›´æ˜¯0x100000 * 4KB = 4GBã€‚ 1234src/config.h:// Segment definitions in protected mode (see rombios32_gdt in misc.c)#define SEG32_MODE32_CS (1 &lt;&lt; 3)#define SEG32_MODE32_DS (2 &lt;&lt; 3) è¿™é‡Œçš„1fè¦åŒºåˆ†æ¸…æ¥šã€‚æŒ‡çš„æ˜¯å‰æ–¹ç¬¬ä¸€ä¸ªæ ‡ç­¾ä¸ºâ€œ1â€çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ä»£è¡¨åå…­è¿›åˆ¶æ•°0x1Fã€‚ä¸‹ä¸€ä¸ªæ ‡ç­¾â€œ1â€å°±æ˜¯è¿™ä¸ªæŒ‡ä»¤çš„ä¸‹ä¸€æ¡ã€‚æ‰€ä»¥ï¼Œçœ‹èµ·æ¥è¿™ä¸ªè·³è½¬æ˜¯æ²¡æœ‰ä»·å€¼çš„ã€‚å®é™…ä¸Šï¼Œåœ¨cr0å¯„å­˜å™¨è¢«è®¾å®šå¥½ä¹‹å‰ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤å·²ç»è¢«æ”¾å…¥æµæ°´çº¿ã€‚è€Œå†æ”¾å…¥çš„æ—¶å€™è¿™æ¡æŒ‡ä»¤è¿˜æ˜¯åœ¨å®æ¨¡å¼ä¸‹çš„ã€‚æ‰€ä»¥è¿™ä¸ªljmpæŒ‡ä»¤æ˜¯ä¸ºäº†æ¸…ç©ºæµæ°´çº¿ï¼Œç¡®ä¿ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æ‰§è¡Œã€‚[1] éšååˆå§‹åŒ–æ‰€æœ‰çš„æ•°æ®æ®µå¯„å­˜å™¨ssã€dsã€esã€fsã€gsä¸º$SEG32_MODE32_DSã€‚æ®µæè¿°ç¬¦ä¸­åŸºå€æ˜¯0x0ï¼ŒSegment Limitæ˜¯0xfffffï¼ŒG(Granularity)flagç½®ä½ï¼Œæ®µçš„å¤§å°éƒ½æ˜¯4GBã€‚è¿›å…¥å®æ¨¡å¼åï¼Œæ‰€æœ‰æ®µå¯»å€çš„åœ°å€ç©ºé—´éƒ½æ˜¯[0, 4G),å½“å‰åœ°å€ç©ºé—´ä¸å†æ˜¯åˆ†æ®µçš„ï¼Œè€Œæ˜¯å®Œæ•´çš„ä¸€å¤§å—ï¼Œå³â€œå¹³å¦æ¨¡å‹â€ã€‚ éšåè·³è½¬åˆ°32bitä¿æŠ¤æ¨¡å¼ä¸‹çš„handle_postå‡½æ•°ã€‚ handle_post12345678910111213141516171819202122src/post.c:// Entry point for Power On Self Test (POST) - the BIOS initilization// phase. This function makes the memory at 0xc0000-0xfffff// read/writable and then calls dopost().void VISIBLE32FLAThandle_post(void)&#123; if (!CONFIG_QEMU &amp;&amp; !CONFIG_COREBOOT) return; serial_debug_preinit(); debug_banner(); // Check if we are running under Xen. xen_preinit(); // Allow writes to modify bios area (0xf0000) make_bios_writable(); // Now that memory is read/writable - start post process. dopost();&#125; posté˜¶æ®µæœ€å¼€å§‹çš„å¯åŠ¨ä¸²å£è°ƒè¯•ç­‰ç»†èŠ‚æˆ‘ä»¬å°±å¿½ç•¥ï¼Œç€é‡å…³æ³¨make_bios_writableå’Œdopostã€‚ å‰é¢æåˆ°BIOS ROMå†…å­˜åŒºåŸŸæ˜¯BIOS shadowå†…å­˜åŒºåŸŸï¼Œè¯¥å†…å­˜åŒºåŸŸæ˜¯BIOS ROM/flashåœ¨å†…å­˜ä¸­çš„åªè¯»æ‹·è´ã€‚make_bios_writableå°±æ˜¯ç”¨äºè®©è¿™æ®µå†…å­˜å¯å†™ï¼Œä»¥ä¾¿åç»­æ›´æ”¹ä¸€äº›é™æ€åˆ†é…çš„å…¨å±€å˜é‡ã€‚ 1234567891011121314// Setup for code relocation and then relocate.void VISIBLE32INITdopost(void)&#123; code_mutable_preinit(); // Detect ram and setup internal malloc. qemu_preinit(); coreboot_preinit(); malloc_preinit(); // Relocate initialization code and call maininit(). reloc_preinit(maininit, NULL);&#125; code_mutable_preinité€šè¿‡è®¾ç½®å…¨å±€å˜é‡HaveRunPostä¸º1ï¼Œé˜²æ­¢é‡å¤è¿›å…¥POSTé˜¶æ®µã€‚ æ ¹æ®SeaBIOSå®˜æ–¹æ–‡æ¡£[2]æè¿°ï¼ŒPOSTé˜¶æ®µå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å››ä¸ªå­é˜¶æ®µï¼š preinit: ä»£ç é‡å®šä½ä¹‹å‰çš„åˆå§‹åŒ–æ“ä½œ init: åˆå§‹åŒ–å†…éƒ¨å˜é‡å’Œæ¥å£ setup: setupç¡¬ä»¶å’Œé©±åŠ¨ preboot: æ‰€æœ‰æ¥å£åˆå§‹åŒ–å·¥ä½œå®Œæˆï¼Œå‡†å¤‡å¯åŠ¨ SeaBIOSçš„ä»£ç é‡å®šä½æ˜¯ä¸ºäº†é‡Šæ”¾éƒ¨åˆ†å ç”¨çš„BIOS ROMç©ºé—´ï¼Œå°†åŸæœ¬å¾ˆå°çš„å†…å­˜ç©ºé—´ç•™ç»™Option ROMã€BIOS tableä»¥åŠè¿è¡Œæ—¶çš„å­˜å‚¨ç©ºé—´ã€‚ç›´æ¥çœ‹maininitçš„æœ€åä»£ç éƒ¨åˆ†startBootå‡†å¤‡å¯åŠ¨ï¼š 12345678910111213// Begin the boot process by invoking an int0x19 in 16bit mode.void VISIBLE32FLATstartBoot(void)&#123; // Clear low-memory allocations (required by PMM spec). memset((void*)BUILD_STACK_ADDR, 0, BUILD_EBDA_MINIMUM - BUILD_STACK_ADDR); dprintf(3, &quot;Jump to int19\\n&quot;); struct bregs br; memset(&amp;br, 0, sizeof(br)); br.flags = F_IF; call16_int(0x19, &amp;br);&#125; bootloaderå·¥ä½œåœ¨16bitçš„å®æ¨¡å¼ï¼Œcall16_intåˆ‡æ¢è‡³å®æ¨¡å¼å¹¶è°ƒç”¨int 0x19hè½¯ä»¶ä¸­æ–­(software-generated interrupt)ï¼Œè¿›å…¥BIOSçš„BOOTé˜¶æ®µã€‚ The INT n instruction permits interrupts to be generated from within software by supplying an interrupt vector number as an operand. è½¯ä»¶ï¼ˆç”Ÿæˆï¼‰ä¸­æ–­æºè‡ªCPUä¸»åŠ¨æ‰§è¡Œç‰¹å®šçš„æŒ‡ä»¤ï¼ˆx86ä¸‹çš„intæŒ‡ä»¤ï¼‰äº§ç”Ÿä¸­æ–­ï¼Œè€Œéæºè‡ªCPUæ¥æ”¶çš„å¤–éƒ¨ç¡¬ä»¶äº§ç”Ÿçš„ä¸­æ–­ã€‚ 1234567891011121314151617181920212223242526src/stacks.h:#define call16_int(nr, callregs) do &#123; \\ extern void irq_trampoline_ ##nr (void); \\ __call16_int((callregs), (u32)&amp;irq_trampoline_ ##nr ); \\ &#125; while (0)src/romlayout.S:// IRQ trampolines .macro IRQ_TRAMPOLINE num DECLFUNC irq_trampoline_0x\\num irq_trampoline_0x\\num : int $0x\\num lretw .endm IRQ_TRAMPOLINE 02 IRQ_TRAMPOLINE 05 IRQ_TRAMPOLINE 10 IRQ_TRAMPOLINE 13 IRQ_TRAMPOLINE 15 IRQ_TRAMPOLINE 16 IRQ_TRAMPOLINE 18 IRQ_TRAMPOLINE 19 IRQ_TRAMPOLINE 1b IRQ_TRAMPOLINE 1c IRQ_TRAMPOLINE 4a å¯è§irq_trampoline_0x19å®é™…æ‰§è¡Œ: 12int $0x19lretw maininit-&gt;interface_init-&gt;ivt_initåˆå§‹åŒ–ä¸­æ–­å‘é‡è¡¨ï¼š 1234567891011121314151617181920212223242526src/post.c: // Initialize software handlers. SET_IVT(0x02, FUNC16(entry_02)); SET_IVT(0x05, FUNC16(entry_05)); SET_IVT(0x10, FUNC16(entry_10)); SET_IVT(0x11, FUNC16(entry_11)); SET_IVT(0x12, FUNC16(entry_12)); SET_IVT(0x13, FUNC16(entry_13_official)); SET_IVT(0x14, FUNC16(entry_14)); SET_IVT(0x15, FUNC16(entry_15_official)); SET_IVT(0x16, FUNC16(entry_16)); SET_IVT(0x17, FUNC16(entry_17)); SET_IVT(0x18, FUNC16(entry_18)); SET_IVT(0x19, FUNC16(entry_19_official)); SET_IVT(0x1a, FUNC16(entry_1a_official)); SET_IVT(0x40, FUNC16(entry_40));src/romlayout.S: // int 18/19 are special - they reset stack and call into 32bit mode. DECLFUNC entry_19entry_19: ENTRY_INTO32 _cfunc32flat_handle_19... .global entry_19_officialentry_19_official: jmp entry_19 0x19è½¯ä»¶ä¸­æ–­ä¼šæ‰§è¡Œhandle_19ï¼ŒBIOSè¿›å…¥äº†BOOTé˜¶æ®µã€‚ BOOT Phase123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051src/boot.c:// Determine next boot method and attempt a boot using it.static void do_boot(int seq_nr)&#123; if (! CONFIG_BOOT) panic(&quot;Boot support not compiled in.\\n&quot;); if (seq_nr &gt;= BEVCount) boot_fail(); // Boot the given BEV type. struct bev_s *ie = &amp;BEV[seq_nr]; switch (ie-&gt;type) &#123; case IPL_TYPE_FLOPPY: printf(&quot;Booting from Floppy...\\n&quot;); boot_disk(0x00, CheckFloppySig); break; case IPL_TYPE_HARDDISK: printf(&quot;Booting from Hard Disk...\\n&quot;); boot_disk(0x80, 1); break; case IPL_TYPE_CDROM: boot_cdrom((void*)ie-&gt;vector); break; case IPL_TYPE_CBFS: boot_cbfs((void*)ie-&gt;vector); break; case IPL_TYPE_BEV: boot_rom(ie-&gt;vector); break; case IPL_TYPE_HALT: boot_fail(); break; &#125; // Boot failed: invoke the boot recovery function struct bregs br; memset(&amp;br, 0, sizeof(br)); br.flags = F_IF; call16_int(0x18, &amp;br);&#125;// INT 19h Boot Load Service Entry Pointvoid VISIBLE32FLAThandle_19(void)&#123; debug_enter(NULL, DEBUG_HDL_19); BootSequence = 0; do_boot(0);&#125; do_bootä»ç¬¬ä¸€ä¸ªå¯åŠ¨é¡¹è¿›è¡Œå¯åŠ¨ï¼Œä»¥å¸¸è§çš„ç¡¬ç›˜(IPL_TYPE_HARDDISK)ä¸ºä¾‹: 123456789101112131415161718192021222324252627282930313233343536373839src/boot.c// Boot from a disk (either floppy or harddrive)static void boot_disk(u8 bootdrv, int checksig)&#123; u16 bootseg = 0x07c0; // Read sector struct bregs br; memset(&amp;br, 0, sizeof(br)); br.flags = F_IF; br.dl = bootdrv; br.es = bootseg; br.ah = 2; br.al = 1; br.cl = 1; call16_int(0x13, &amp;br); if (br.flags &amp; F_CF) &#123; printf(&quot;Boot failed: could not read the boot disk\\n\\n&quot;); return; &#125; if (checksig) &#123; struct mbr_s *mbr = (void*)0; if (GET_FARVAR(bootseg, mbr-&gt;signature) != MBR_SIGNATURE) &#123; printf(&quot;Boot failed: not a bootable disk\\n\\n&quot;); return; &#125; &#125; tpm_add_bcv(bootdrv, MAKE_FLATPTR(bootseg, 0), 512); /* Canonicalize bootseg:bootip */ u16 bootip = (bootseg &amp; 0x0fff) &lt;&lt; 4; bootseg &amp;= 0xf000; call_boot_entry(SEGOFF(bootseg, bootip), bootdrv);&#125; int 0x13Hä»ç¡¬ç›˜è¯»å–ç¬¬ä¸€ä¸ªæ‰‡åŒº(MBR)è‡³ES:BX,BXåˆå§‹åŒ–ä¸º0ï¼Œå› æ­¤MBRçš„å†…å®¹è¯»å–åˆ°0x07c0:0x0ã€‚ int 0x13Hç›¸å…³å¯„å­˜å™¨å‚æ•°[3]:GET_FARVAR(bootseg, mbr-&gt;signature)ä¾¿æ˜¯æ ¡éªŒMBRç­¾å0xaa55ï¼Œç¡®è®¤è¯»å–åˆ°çš„å†…å®¹å°±æ˜¯MBRæ‰‡åŒºã€‚æœ€åçš„è§„èŒƒåŒ–(Canonicalize)æ“ä½œä¸ºäº†è®©åç»­è°ƒç”¨bootloaderæ—¶ï¼Œæ®µåœ°å€:åç§»åœ°å€ä¸º0x0:0x7c00è€Œé0x07c0:0x0ã€‚æœ€åè°ƒç”¨call_boot_entryè·³è½¬è‡³0x0:0x7c00åœ°å€ï¼Œè½¬ç§»è‡³bootloaderæ‰§è¡Œï¼Œæ­¤æ—¶ç³»ç»Ÿä»å¤„äº16bitå®æ¨¡å¼ã€‚ æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„bootloaderï¼Œçœ‹çœ‹BIOSå¯åŠ¨è·³è½¬åˆ°bootloaderçš„æ•ˆæœï¼š 12345678910111213141516boot.S:.global _start.text.code16_start: mov $0x21, %al mov $0x0e, %ah mov $0x00, %bh mov $0x07, %bl int $0x10 jmp ..space 510-(.-_start).word 0xaa55 æ„å»º[4]å¹¶è¿è¡Œï¼š 12# gcc -Wl,--oformat=binary -Wl,-Ttext=0x7c00 -Wl,--build-id=none -nostartfiles -nostdlib -m32 -o boot.bin boot.S# qemu-kvm -nographic -drive format=raw,file=boot.bin bootloaderç¨‹åºå¾ˆç®€å•ï¼Œå°±æ˜¯å‘å±å¹•è¾“å‡º!ã€‚ Reference[1] SeaBIOSå®ç°ç®€å•åˆ†æ[2] Execution_and_code_flow[3] INT 13H Wikipedia[4] Calculating padding length with GAS AT&amp;T directives for a boot sector?","categories":[{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/categories/boot/"}],"tags":[{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/tags/boot/"},{"name":"BIOS","slug":"bios","permalink":"https://system-thoughts.github.io/tags/bios/"}]},{"title":"shellå‘½ä»¤è¡Œå‚æ•°å¤„ç†","slug":"shellå‘½ä»¤è¡Œå‚æ•°å¤„ç†","date":"2021-04-09T16:15:04.000Z","updated":"2023-01-18T05:32:06.164Z","comments":true,"path":"posts/c0186fb6/","link":"","permalink":"https://system-thoughts.github.io/posts/c0186fb6/","excerpt":"æˆ‘ä½¿ç”¨Linuxå·²æœ‰8å¹´æœ‰ä½™ï¼Œç»å¸¸ä¼šç¼–å†™shellè„šæœ¬è¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç†ã€‚ç„¶è€Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä¾ç„¶ä¸èƒ½åƒç†Ÿç»ƒä½¿ç”¨Cè¯­è¨€ä¸€æ ·ç¼–å†™shellè„šæœ¬ã€‚ç¡®å®ï¼Œæˆ‘çš„ä¸»åŠ›ç¼–ç¨‹è¯­è¨€æ˜¯Cè¯­è¨€ï¼Œä»…åœ¨åšè‡ªåŠ¨åŒ–è„šæœ¬æˆ–è€…ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨shellã€‚å¦å¤–ä¸€æ–¹é¢ï¼Œshellè„šæœ¬çš„è¯­æ³•çš„å˜ç§å¤ªå¤šï¼Œä¾‹å¦‚ï¼Œifè¯­å¥åœ¨åšå­—ç¬¦ä¸²ã€æ•°å€¼ã€æ–‡ä»¶æ¯”è¾ƒæ—¶çš„åˆ¤æ–­è¯­å¥éƒ½ç›¸å·®å¾ˆå¤§ï¼›ç‰¹æ®Šç¬¦å·å¤šï¼Œ$#ã€$@ã€$?ç­‰ç­‰ï¼Œå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦shellè„šæœ¬ï¼Œå¿…ç„¶ä¼šæ‰‹è¶³æ— æªï¼Œæ›´å‘çˆ¹çš„æ˜¯ï¼Œè¿™äº›ç‰¹æ®Šç¬¦å·ä½¿ç”¨çš„åœºæ™¯ç›¸å·®å¾ˆå¤§ï¼Œè®°å¿†è´Ÿæ‹…çœŸçš„å¤§ï¼ï¼è¿˜æœ‰ï¼Œshellè„šæœ¬ä¼šä¾èµ–å¤ªå¤šå°ç¨‹åºï¼Œæ­£å¦‚unixå“²å­¦æ‰€è¨€ï¼šä¸€ä¸ªå·¥å…·è‚©è´Ÿå•ä¸€ä½¿å‘½ï¼Œè¿™äº›ç¨‹åºçš„å„è‡ªç”¨é€”ã€å„è‡ªé€‰é¡¹å·®å¼‚å¾ˆå¤§ï¼Œä½ æ ¹æœ¬æ²¡æœ‰åŠæ³•ä¸€ä¸‹å­å°±è®°ä½æ‰€æœ‰ç”¨æ³•ï¼ï¼ï¼","text":"æˆ‘ä½¿ç”¨Linuxå·²æœ‰8å¹´æœ‰ä½™ï¼Œç»å¸¸ä¼šç¼–å†™shellè„šæœ¬è¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç†ã€‚ç„¶è€Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä¾ç„¶ä¸èƒ½åƒç†Ÿç»ƒä½¿ç”¨Cè¯­è¨€ä¸€æ ·ç¼–å†™shellè„šæœ¬ã€‚ç¡®å®ï¼Œæˆ‘çš„ä¸»åŠ›ç¼–ç¨‹è¯­è¨€æ˜¯Cè¯­è¨€ï¼Œä»…åœ¨åšè‡ªåŠ¨åŒ–è„šæœ¬æˆ–è€…ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨shellã€‚å¦å¤–ä¸€æ–¹é¢ï¼Œshellè„šæœ¬çš„è¯­æ³•çš„å˜ç§å¤ªå¤šï¼Œä¾‹å¦‚ï¼Œifè¯­å¥åœ¨åšå­—ç¬¦ä¸²ã€æ•°å€¼ã€æ–‡ä»¶æ¯”è¾ƒæ—¶çš„åˆ¤æ–­è¯­å¥éƒ½ç›¸å·®å¾ˆå¤§ï¼›ç‰¹æ®Šç¬¦å·å¤šï¼Œ$#ã€$@ã€$?ç­‰ç­‰ï¼Œå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦shellè„šæœ¬ï¼Œå¿…ç„¶ä¼šæ‰‹è¶³æ— æªï¼Œæ›´å‘çˆ¹çš„æ˜¯ï¼Œè¿™äº›ç‰¹æ®Šç¬¦å·ä½¿ç”¨çš„åœºæ™¯ç›¸å·®å¾ˆå¤§ï¼Œè®°å¿†è´Ÿæ‹…çœŸçš„å¤§ï¼ï¼è¿˜æœ‰ï¼Œshellè„šæœ¬ä¼šä¾èµ–å¤ªå¤šå°ç¨‹åºï¼Œæ­£å¦‚unixå“²å­¦æ‰€è¨€ï¼šä¸€ä¸ªå·¥å…·è‚©è´Ÿå•ä¸€ä½¿å‘½ï¼Œè¿™äº›ç¨‹åºçš„å„è‡ªç”¨é€”ã€å„è‡ªé€‰é¡¹å·®å¼‚å¾ˆå¤§ï¼Œä½ æ ¹æœ¬æ²¡æœ‰åŠæ³•ä¸€ä¸‹å­å°±è®°ä½æ‰€æœ‰ç”¨æ³•ï¼ï¼ï¼ ä¸Šé¢å°±æ˜¯å¯¹è‡ªå·±å†™ä¸å¥½shellè„šæœ¬çš„ä¸€äº›åæ€ï¼Œç ´å±€è¿˜æ˜¯æœ‰åŠæ³•çš„ã€‚æ—¢ç„¶shellè„šæœ¬çš„ç”¨æ³•è¯¡è°²å¤šå˜ã€å……æ»¡å¥‡æ·«æŠ€å·§ï¼Œä¾é å¤§è„‘çš„è®°å¿†è‚¯å®šæ˜¯ä¸é è°±çš„ï¼Œåº”è¯¥å»ºç«‹codebaseè®°å½•é‚£äº›ä¸å¤ªå¥½è®°å¿†çš„shellè¯­æ³•ã€æŒ‡ä»¤çš„å…¸å‹åº”ç”¨ç¤ºä¾‹ã€‚å½“å¿˜è®°äº†ç›¸å…³çš„shellå‘½ä»¤æ—¶ï¼Œä¾¿å¯ç¿»é˜…codebaseå”¤é†’ä»£ç è®°å¿†ã€‚å½“ç„¶ï¼Œé‚£äº›å·²æ·±åˆ»åœ¨ä½ è®°å¿†ä¸­çš„çŸ¥è¯†å°±å†—ä½™æ— éœ€è®°å½•ã€‚æœ¬ç¯‡æ–‡ç« æ˜¯shell codebaseçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦ä»‹ç»shellå‘½ä»¤è¡Œå‚æ•°çš„å¤„ç†ã€‚ å‘½ä»¤è¡Œå‚æ•°åŸºç¡€å‘shellè„šæœ¬ä¼ è¾“æ•°æ®æœ€åŸºæœ¬çš„æ–¹æ³•æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ã€‚ä¼ å…¥çš„å‘½ä»¤è¡Œå‚æ•°é€šè¿‡ä½ç½®å‚æ•°(positional parameter)çš„ç‰¹æ®Šå˜é‡è¿›è¡ŒåŒºåˆ†ï¼š$0è¡¨ç¤ºç¨‹åºåï¼Œ$1ã€$2åˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€ã€ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¾æ¬¡ç±»æ¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯$0è¡¨ç¤ºçš„æ˜¯å‘½ä»¤è¡Œä¸­æ‰§è¡Œshellè„šæœ¬çš„è·¯å¾„ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œ$0ä¸­çš„å†…å®¹ä¼šç›¸åº”æ”¹å˜ã€‚å¯ä½¿ç”¨basenameæå–æ–‡ä»¶åã€‚shellå°†ç©ºæ ¼ä½œä¸ºå‚æ•°çš„åˆ†å‰²ç¬¦ï¼Œè‹¥å‚æ•°ä¸­éœ€è¦åŒ…å«ç©ºæ ¼ï¼Œåˆ™éœ€è¦ç”¨å¼•å·ï¼ˆå•å¼•å·ã€åŒå¼•å·å‡å¯ï¼‰å®Œæ•´åœ°åŒ…å«å‚æ•°ã€‚ æœ‰ä¸ªå°èªæ˜å•Šï¼Œå¯ä»¥ç¼–å†™åŸºäºè„šæœ¬åæ¥æ‰§è¡Œä¸åŒåŠŸèƒ½çš„è„šæœ¬: 123456789101112# cat filename_as_func.sh #!/bin/bash# implement the corresponding function according to the file namename=$(basename $0)if [ $name = &quot;add&quot; ]; then total=$[ $1 + $2 ]elif [ $name = &quot;mul&quot; ]; then total=$[ $1 * $2 ]fiecho The caculation value is $total å°†filename_as_func.shé“¾æ¥åˆ°ä¸åŒçš„æ–‡ä»¶åï¼ŒæŸ¥çœ‹è¿è¡Œç»“æœï¼š 123456# ln -s filename_as_func.sh add# ln -s filename_as_func.sh mul# ./add 2 3The caculation value is 5# ./mul 2 3The caculation value is 6 æ£€æŸ¥é¢„æœŸçš„å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦å­˜åœ¨æ˜¯ä¸€ç§è‰¯å¥½çš„ç¼–ç é£æ ¼ï¼Œè®©è„šæœ¬ç›´æ¥æŠ¥é”™ä¸å¯å–ã€‚å¦‚ä¸‹æ˜¯æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦å­˜åœ¨ï¼š 1234if [ -z &quot;$1&quot; ]; then echo parameter is needed! exit 1fi bash shellä¸­æœ‰äº›ç‰¹æ®Šå˜é‡è®°å½•å‘½ä»¤è¡Œå‚æ•°ã€‚$#è¡¨ç¤ºå‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°ã€‚å¾ˆç›´è§‚åœ°ï¼Œæˆ‘ä»¬ä¼šè€ƒè™‘å€ŸåŠ©$#è¡¨ç¤ºæœ€åä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š$&#123;$#&#125;ã€‚ç„¶è€Œè¿™ç§è¡¨ç¤ºå¹¶ä¸æ­£ç¡®ï¼Œä¸èƒ½åœ¨èŠ±æ‹¬å·ä¸­ä½¿ç”¨ç¾å…ƒç¬¦ï¼Œå¿…é¡»å°†ç¾å…ƒç¬¦æ›¿æ¢ä¸ºæ„Ÿå¹å·ï¼Œå³$&#123;!#&#125;ã€‚ 1234567[root@localhost parameters]# cat last_parameter.sh #!/bin/bash# use $# represent the last parameterecho The last parameter is $&#123;!#&#125;[root@localhost parameters]# ./last_parameter.sh 1 2 3 4The last parameter is 4 $@å’Œ$*ç‰¹æ®Šå˜é‡éƒ½èƒ½è¡¨ç¤ºæ‰€æœ‰å‚æ•°ã€‚ $*ä¼šå°†å‘½ä»¤è¡Œæä¾›çš„æ‰€æœ‰å‚æ•°å½“ä½œå•ä¸ªå•è¯è¿›è¡Œè®¿é—®ã€‚ $@ä¼šå°†å‘½ä»¤è¡Œä¸Šæä¾›çš„æ‰€æœ‰å‚æ•°å½“ä½œåŒä¸€ä¸ªå­—ç¬¦ä¸²ä¸­å¤šä¸ªç‹¬ç«‹çš„å•è¯ã€‚å®ƒå…è®¸ä½ éå†æ‰€æœ‰å€¼ã€‚1234567891011121314151617181920212223[root@localhost parameters]# cat all_parameter.sh #!/bin/bash# test $* and $@ difference, they both represent all the parameterscount=1for param in &quot;$*&quot;do echo &quot;\\$* parameter #$count = $param&quot; count=$[ $count + 1 ]donecount=1for param in &quot;$@&quot;do echo &quot;\\$@ parameter #$count = $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./all_parameter.sh 1 2 3 4$* parameter #1 = 1 2 3 4$@ parameter #1 = 1$@ parameter #2 = 2$@ parameter #3 = 3$@ parameter #4 = 4 å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹æ‰§è¡Œè„šæœ¬é€šå¸¸ä¼šæŒ‡å®šå‘½ä»¤è¡Œé€‰é¡¹ï¼Œå®é™…ä¸Šï¼Œå¯ä»¥åƒå¤„ç†å‘½ä»¤è¡Œå‚æ•°ä¸€æ ·ï¼Œå¤„ç†å‘½ä»¤è¡Œé€‰é¡¹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœ€ç¡¬æ ¸çš„â€œæ‰‹æ’•shellå‘½ä»¤è¡Œé€‰é¡¹â€çš„å¤„ç†æ–¹å¼ã€‚ 12345678910111213141516171819[root@localhost parameters]# cat basic_options.sh #!/bin/bash# handle options by handwhile [ -n &quot;$1&quot; ]do case &quot;$1&quot; in -a) echo &quot;Found the -a option&quot; ;; -b) echo &quot;Found the -b option&quot; ;; -c) echo &quot;Found the -c option&quot; ;; *) echo &quot;$1 is not an option&quot; ;; esac shiftdone[root@localhost parameters]# ./basic_options.sh -a -b -c 1Found the -a optionFound the -b optionFound the -c option1 is not an option shiftå‘½ä»¤ä¼šå°†æ¯ä¸ªå‚æ•°å˜é‡å‡ä¸€ã€‚æ‰€ä»¥å˜é‡$2ä¼šç§»åŠ¨åˆ°$1ï¼Œè€ŒåŸæ¥çš„$1ä¼šè¢«åˆ é™¤ï¼Œä¾æ¬¡ç±»æ¨ã€‚æ³¨æ„ï¼šå˜é‡$0çš„å€¼æ˜¯ä¸ä¼šæ”¹å˜ï¼Œå³ç¨‹åºåä¸ä¼šæ”¹å˜ã€‚æ‰€ä»¥é€šè¿‡whileå¾ªç¯é…åˆshiftå‘½ä»¤ä¾¿èƒ½å¤Ÿå¤„ç†æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°ã€‚é€šè¿‡caseè¯­å¥åˆ¤æ–­å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå¹¶åšç›¸åº”å¤„ç†ã€‚ ä¸Šé¢çš„è„šæœ¬å¯ä»¥è¯†åˆ«é€‰é¡¹ï¼Œä½†åŒæ—¶ä½¿ç”¨é€‰é¡¹å’Œå‚æ•°ï¼Œåˆ™å¯¹å‚æ•°æ— æ³•å¾ˆå¥½åœ°å¤„ç†ã€‚Linuxä¸­å¤„ç†è¿™ä¸ªé—®é¢˜çš„æ ‡å‡†æ–¹æ³•æ˜¯ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ï¼ˆåŒç ´æŠ˜çº¿â€“ï¼‰å°†é€‰é¡¹å’Œå‚æ•°åˆ†å¼€ï¼Œç‰¹æ®Šå­—ç¬¦ä¼šå‘Šè¯‰è„šæœ¬ï¼Œé€‰é¡¹ä½•æ—¶ç»“æŸä»¥åŠæ™®é€šå‚æ•°ä½•æ—¶å¼€å§‹ã€‚ 123456789101112131415161718192021222324252627282930[root@localhost parameters]# cat extract_parameters.sh #!/bin/bash# extract options and parameterswhile [ -n &quot;$1&quot; ]do case &quot;$1&quot; in -a) echo &quot;Found the -a option&quot; ;; -b) echo &quot;Found the -b option&quot; ;; -c) echo &quot;Found the -c option&quot; ;; --) shift break ;; *) echo &quot;$1 is not an option&quot; esac shiftdonecount=1for param in $@do echo &quot;parameter #$count is $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./extract_parameters.sh -a -b -c -- 1 2 3Found the -a optionFound the -b optionFound the -c optionparameter #1 is 1parameter #2 is 2parameter #3 is 3 å½“è„šæœ¬é‡åˆ°åŒç ´æŠ˜çº¿æ—¶ï¼Œå°±åœæ­¢å¤„ç†é€‰é¡¹ï¼Œå°†å‰©ä¸‹çš„å‚æ•°éƒ½ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ã€‚ç„¶è€Œï¼Œæ­¤ç§æ–¹å¼å°†å‘½ä»¤è¡Œé€‰é¡¹å’Œå‚æ•°æ³¾æ¸­åˆ†æ˜ã€‚å¦‚æœå‘½ä»¤è¡Œé€‰é¡¹ä¼šå¸¦æœ‰é¢å¤–çš„å‚æ•°ï¼Œæ­¤ç§æ–¹å¼ä¾¿æ— æ³•åŒºåˆ†ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†é€‰é¡¹å‚æ•°ï¼š 12345678910111213141516171819202122232425262728293031[root@localhost parameters]# cat basic_option_parameter.sh #!/bin/bash# extract option parameter by handwhile [ -n &quot;$1&quot; ]do case &quot;$1&quot; in -a) echo &quot;Found the -a option&quot; ;; -b) param=&quot;$2&quot; echo &quot;Found the -b option, with parameter value $param&quot; shift ;; -c) echo &quot;Found the -c option&quot; ;; --) shift break ;; *) echo &quot;$1 is not an option&quot; esac shiftdonecount=1for param in $@do echo &quot;parameter #$count is $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./basic_option_parameter.sh -a -b 2 -c -- 56 78Found the -a optionFound the -b option, with parameter value 2Found the -c optionparameter #1 is 56parameter #2 is 78 å½“å‰shellè„šæœ¬å·²ç»å…·å¤‡å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹çš„åŸºæœ¬èƒ½åŠ›ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›é™åˆ¶ï¼Œå¦‚æ— æ³•åŒºåˆ†åˆå¹¶çš„å‘½ä»¤è¡Œé€‰é¡¹ã€‚å¦å¤–ï¼Œæ²¡æœ‰ç”¨æˆ·æ„¿æ„é€šè¿‡è¾“å…¥â€â€“â€åŒºåˆ†é€‰é¡¹å’Œå‚æ•°ï¼Œè¿™ä¸ªå·¥ä½œæœ€å¥½ç”±shellè„šæœ¬è‡ªåŠ¨å®Œæˆã€‚ä¸‹é¢ä»‹ç»çš„getoptå‘½ä»¤å°±æ˜¯ä¸ºäº†æ‘†è„±è¿™ç§æœ€ç¡¬æ ¸çš„é€‰é¡¹è§£ææ–¹å¼ã€‚ getoptå‘½ä»¤getoptå‘½ä»¤æ˜¯å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹å’Œå‚æ•°çš„ä¸€ä¸ªéå¸¸å¼ºæœ‰åŠ›çš„å·¥å…·ï¼Œåœ¨CentOSä¸­ï¼Œå…¶ç”±util-linuxæä¾›ã€‚getoptå‘½ä»¤å‚æ•°å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š1.å‘½ä»¤è¡Œé€‰é¡¹[options] 2. getoptå¾…è§£æçš„å‘½ä»¤è¡Œå‚æ•°parametersï¼Œparametersæ˜¯ä»ç¬¬ä¸€ä¸ªégetoptå‘½ä»¤è¡Œé€‰é¡¹å¼€å§‹çš„ï¼Œæˆ–è€…åœ¨--ä¹‹åã€‚æ ¹æ®getoptå‘½ä»¤ç¬¬ä¸€éƒ¨åˆ†çš„çŠ¶æ€ï¼Œgetoptçš„è°ƒç”¨æ–¹å¼å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š æ— å‘½ä»¤è¡Œé€‰é¡¹ï¼Œæ­¤ç§é€‰é¡¹è§£ææœ€ä¸ºç®€å•ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ï¼Œä½†æ˜¯åªèƒ½è§£æçŸ­é€‰é¡¹ï¼š1getopt optstring parameters parametersï¼šgetoptè¦è§£æçš„å‘½ä»¤è¡Œå‚æ•°12# getopt &quot;ab:cd&quot; -a 1 -b 2 -cd 3 4 -a -b 2 -c -d -- 1 3 4 æœ‰å‘½ä»¤è¡Œé€‰é¡¹ï¼Œä½†æ˜¯æ²¡æœ‰-o|--optionsé€‰é¡¹ï¼Œ-oé€‰é¡¹æ¯”è¾ƒç‰¹æ®Šï¼Œç”¨æ¥æŒ‡å®šçŸ­é€‰é¡¹(shortopts)ï¼š1getopt [options] [--] optstring parameters optionsè¡¨ç¤ºæ‰€æœ‰çš„é-oé€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰--ï¼Œåˆ™ç¬¬ä¸€ä¸ªégetopté€‰é¡¹çš„å‚æ•°å°±æ˜¯shortoptsï¼Œéšåä¾¿æ˜¯å¾…è§£æå‚æ•°ã€‚1234567891011[root@localhost ~]# getopt &quot;ab:cd&quot; -c 1 -b 2 -ade 3 4getopt: invalid option -- &#x27;e&#x27; -c -b 2 -a -d -- 1 3 4[root@localhost ~]# getopt -q &quot;ab:cd&quot; -c 1 -b 2 -ade 3 4 -c -b &#x27;2&#x27; -a -d -- &#x27;1&#x27; &#x27;3&#x27; &#x27;4&#x27;[root@localhost ~]# echo $?1[root@localhost ~]# getopt -q -- &quot;ab:cd&quot; -c 1 -b 2 -ade 3 4 -c -b &#x27;2&#x27; -a -d -- &#x27;1&#x27; &#x27;3&#x27; &#x27;4&#x27;[root@localhost ~]# echo $?1 å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªä¸å­˜åœ¨optstringçš„é€‰é¡¹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œgetoptä¼šæŠ¥é”™ï¼Œé€šè¿‡-qé€‰é¡¹ä¼šå¿½ç•¥è¿™æ¡é”™è¯¯ä¿¡æ¯ï¼Œä½†æ˜¯getoptè¿˜æ˜¯ä¼šè¿”å›é”™è¯¯å€¼ã€‚ä¸Šé¢ä¾‹å­çš„æœ€åä¸¤æ¡æŒ‡ä»¤è¡¨æ˜äº†shortoptsçš„ä½ç½®ã€‚è¿™ç§éšå¼æŒ‡æ˜shortoptsä½ç½®çš„æ–¹å¼åœ¨æœ‰-l|--longoptionså‚æ•°çš„æ—¶å€™å¾ˆå®¹æ˜“é€ æˆè¯¯è§£ã€‚åŒshortoptsæŒ‡å®šå‚æ•°çš„æ–¹å¼ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œlongoptsçš„æ¯ä¸ªå‚æ•°é€šè¿‡é€—å·åˆ†éš”ã€‚1234[root@localhost ~]# getopt -l extract:,tar:,help,directory -- file --extract a.tar --extract &#x27;a.tar&#x27; --[root@localhost ~]# getopt -l extract:,tar:,help,directory -- file --extract a.tar -f -i abc --extract &#x27;a.tar&#x27; -f -i -- &#x27;abc&#x27; ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬æ‰“ç®—åªå®šä¹‰é•¿å‘½ä»¤è¡Œé€‰é¡¹ã€‚ç„¶è€Œç¬¬ä¸€æ¡shellå‘½ä»¤æœªè§£æåˆ°å‚æ•°fileã€‚å†çœ‹çœ‹åä¸€æ¡å‘½ä»¤ï¼Œå¤§æ¦‚å°±å¿ƒé‡Œæœ‰æ•°äº†ã€‚å¦‚æœgetoptå‘½ä»¤å¸¦æœ‰é€‰é¡¹ï¼Œä½†æ˜¯æœªå¸¦æœ‰-oé€‰é¡¹ï¼Œgetoptä¼šå°†å‘½ä»¤ç¬¬äºŒéƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå‚æ•°å³fileä½œä¸ºshortoptsã€‚è¿™è¯´æ˜getopté»˜è®¤æ€»æ˜¯ä¼šè§£æçŸ­é€‰é¡¹ï¼Œå…¶å¿…é¡»æŒ‡å®šshortoptsã€‚ç„¶è€Œï¼Œè¿™ç§éšå¼çš„æŒ‡å®šï¼Œå¯¹äºå‘½ä»¤çš„ç†è§£æå…¶ä¸å‹å¥½ã€‚ è‹¥è¦æŒ‡å®šé•¿å‘½ä»¤é€‰é¡¹ï¼Œæœ€å¥½é€šè¿‡-o|--optionsæ˜¾å¼åœ°æŒ‡æ˜çŸ­å‘½ä»¤é€‰é¡¹ï¼š1getopt [options] -o|--options optstrin [options] [--] parameters è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œä½†åŒæ—¶æŒ‡æ˜çŸ­å‘½ä»¤é€‰é¡¹ï¼š1234[root@localhost ~]# getopt -o e:t:hd -l extract:,tar:,help,directory -- file --extract a.tar --extract &#x27;a.tar&#x27; -- &#x27;file&#x27;[root@localhost ~]# getopt -o &#x27;&#x27; -l extract:,tar:,help,directory -- file --extract a.tar --extract &#x27;a.tar&#x27; -- &#x27;file&#x27; å¯è§ï¼Œå³ä¾¿ä½ ä¸æƒ³æŒ‡å®šçŸ­é€‰é¡¹ï¼Œæ˜¾å¼åœ°é€šè¿‡å°†-oé€‰é¡¹æŒ‡å®šä¸ºç©ºã€‚ä¹Ÿèƒ½å¤Ÿæ­£ç¡®åœ°è§£æå‡ºå‚æ•°fileã€‚ ä½¿ç”¨getoptå¤„ç†è„šæœ¬çš„å‘½ä»¤è¡Œå‚æ•°ï¼š 123456789101112131415161718192021222324252627282930313233[root@localhost parameters]# cat basic_getopt.sh #!/bin/bash# use getopt handle parametersset -- $(getopt -q &quot;ab:c&quot; &quot;$@&quot;)while [ -n &quot;$1&quot; ]do case &quot;$1&quot; in -a) echo &quot;Found the -a option&quot; ;; -b) param=&quot;$2&quot; echo &quot;Found the -b option, with parameter value $param&quot; shift ;; -c) echo &quot;Found the -c option&quot; ;; --) shift break ;; *) echo &quot;$1 is not an option&quot; esac shiftdonecount=1for param in $@do echo &quot;parameter #$count is $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./basic_getopt.sh -c 1 -b 2 -ad 3 4Found the -c optionFound the -b option, with parameter value &#x27;2&#x27;Found the -a optionparameter #1 is &#x27;1&#x27;parameter #2 is &#x27;3&#x27;parameter #3 is &#x27;4&#x27; å…¶ä¸­æœ€ä¸ºå…³é”®çš„æ˜¯setä¸getoptçš„é…åˆä½¿ç”¨ã€‚å‰é¢ï¼Œæˆ‘ä»¬å·²ç»æåˆ°--æ˜¯é€‰é¡¹å’Œå‚æ•°çš„åˆ†ç•Œç¬¦ï¼Œ--ä¹‹åéƒ½ä»£è¡¨setå‘½ä»¤çš„å‚æ•°ï¼Œå³ä¾¿å…¶ä¸­åŒ…å«-ï¼Œä¹Ÿä¸ä¼šè¢«è¯†åˆ«ä¸ºsetå‘½ä»¤çš„é€‰é¡¹ã€‚ä¸Šè¿°setå‘½ä»¤ä¼šå°†å½“å‰ç¯å¢ƒå˜é‡$@è®¾ç½®ä¸ºgetopt -q &quot;ab:c&quot; &quot;$@&quot;çš„è¾“å‡ºã€‚é‚£ä¹ˆï¼Œè¿™æ¡setå‘½ä»¤å°±æ˜¯ä¸ºäº†ç”¨getoptæ ¼å¼åŒ–åçš„å‘½ä»¤è¡Œå‚æ•°æ¥æ›¿æ¢åŸå§‹çš„å‘½ä»¤è¡Œå‚æ•°ã€‚åç»­whileå¾ªç¯å¤„ç†çš„ä¾¿æ˜¯æ ¼å¼åŒ–çš„å‘½ä»¤è¡Œå‚æ•°å³ï¼š 12[root@localhost parameters]# getopt -q &quot;ab:c&quot; -c 1 -b 2 -ad 3 4 -c -b &#x27;2&#x27; -a -- &#x27;1&#x27; &#x27;3&#x27; &#x27;4&#x27; getoptså‘½ä»¤bash shellåŒ…å«äº†getoptså‘½ä»¤ã€‚ä¸getoptå°†å‘½ä»¤è¡Œä¸Šæ‰¾åˆ°çš„é€‰é¡¹å’Œå‚æ•°å¤„ç†ååªç”Ÿæˆä¸€ä¸ªè¾“å‡ºä¸åŒã€‚æ¯æ¬¡è°ƒç”¨getoptsï¼Œå®ƒåªå¤„ç†ä¸€ä¸ªå‘½ä»¤è¡Œä¸Šæ£€æµ‹åˆ°çš„å‚æ•°ã€‚å¤„ç†å®Œæ‰€æœ‰å‚æ•°åï¼Œå®ƒä¼šé€€å‡ºå¹¶è¿”å›ä¸€ä¸ªå¤§äºé›¶çš„é€€å‡ºçŠ¶æ€ç ã€‚å› æ­¤ï¼Œgetoptséå¸¸é€‚åˆç”¨äºè§£æå‘½ä»¤è¡Œæ‰€æœ‰å‚æ•°çš„å¾ªç¯ä¸­ã€‚getoptså‘½ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š 1getopts optstring variable optstringåŒgetoptå‘½ä»¤çš„shortoptsã€‚è‹¥getoptsè¦å¿½ç•¥é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥åœ¨optstringä¹‹å‰åŠ ä¸Šå†’å·ã€‚variableè¡¨ç¤ºå¾…è§£æçš„å‘½ä»¤è¡Œå‚æ•°ã€‚ getoptsä¼šç”¨åˆ°ä¸¤ä¸ªç¯å¢ƒå˜é‡ã€‚å¦‚æœé€‰é¡¹åé¢è·Ÿå‚æ•°ï¼ŒOPTARGç¯å¢ƒå˜é‡ä¿å­˜è¯¥å‚æ•°å€¼ã€‚OPTINDç¯å¢ƒå˜é‡ä¿å­˜äº†å‚æ•°åˆ—è¡¨ä¸­getoptsæ­£åœ¨å¤„ç†çš„å‚æ•°ä½ç½®ã€‚ 1234567891011121314151617181920212223242526272829[root@localhost parameters]# cat getopts_OPTIND.sh #!/bin/bash# processing options and prameters with getopts, show OPTIND and shift combination to get parameterswhile getopts :ab:cd optdo case &quot;$opt&quot; in a) echo &quot;Found the -a option&quot; ;; b) echo &quot;Found the -b option, with value $OPTARG&quot; ;; c) echo &quot;Found the -c option&quot; ;; d) echo &quot;Found the -d option&quot; ;; *) echo &quot;Unknown option $opt&quot; ;; esacdoneshift $[ $OPTIND - 1 ]count=1for param in &quot;$@&quot;do echo &quot;Parameter $count: $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./getopts_OPTIND.sh -a -btest1 -d -f &quot;test2 test3&quot; Found the -a optionFound the -b option, with value test1Found the -d optionUnknown option ?Parameter 1: test2 test3 ç”±ä¸Šé¢çš„ç¤ºä¾‹å¯çŸ¥ï¼Œgetoptså¤„ç†æ¯ä¸ªé€‰é¡¹æ—¶ï¼Œå®ƒä¼šå°†OPTINDç¯å¢ƒå˜é‡çš„å€¼å¢1ã€‚åœ¨getoptså®Œæˆå¤„ç†åï¼Œå¯ä»¥å°†OPTINDå’Œshiftå‘½ä»¤ä¸€èµ·ä½¿ç”¨ç§»åŠ¨å‚æ•°ã€‚ä¸getoptå‘½ä»¤ä¸åŒçš„æ˜¯ï¼šgetoptsè§£æå‘½ä»¤è¡Œé€‰é¡¹æ—¶ï¼Œä¼šç§»é™¤å¼€å¤´çš„ç ´æŠ˜å·ã€‚å®ƒèƒ½å¤Ÿå°†å‘½ä»¤è¡Œä¸Šæ‰¾åˆ°çš„æ‰€æœ‰æœªå®šä¹‰çš„é€‰é¡¹ç»Ÿä¸€è¾“å‡ºé—®å·ã€‚åŒæ—¶getoptsä¸æ”¯æŒé•¿é€‰é¡¹çš„è§£æã€‚ä½†æ˜¯getoptså‘½ä»¤å¹¶ä¸çµæ´»ï¼š 123456[root@localhost parameters]# ./getopts_OPTIND.sh -a -btest1 -d &quot;test2 test3&quot; -cFound the -a optionFound the -b option, with value test1Found the -d optionParameter 1: test2 test3Parameter 2: -c å¦‚æœå‚æ•°å‡ºç°åœ¨é€‰é¡¹ä¹‹å‰ï¼Œgetoptsä¾¿ä¸èƒ½å¤Ÿè§£æåˆ°é€‰é¡¹äº†ã€‚ å› æ­¤getoptæä¾›äº†è¾ƒä¸ºå¼ºå¤§ä¸”å®šåˆ¶çš„åŠŸèƒ½ï¼Œgetoptsæä¾›äº†å¿«æ·çš„å‘½ä»¤è¡Œå‚æ•°é€‰é¡¹è§£æåŠŸèƒ½ï¼Œä½†å¹¶ä¸çµæ´»ã€‚ è§£æé€‰é¡¹å†²çªåŒä¸€å‘½ä»¤çš„ä¸åŒé€‰é¡¹å­˜åœ¨å†²çªè¯­ä¹‰çš„æƒ…å†µï¼Œä¾‹å¦‚tarå‘½ä»¤çš„-xé€‰é¡¹è¡¨ç¤ºè§£å‹taråŒ…ï¼Œ-té€‰é¡¹è¡¨ç¤ºæ‰“åŒ…æ“ä½œã€‚æ˜¾ç„¶ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹çš„è¯­ä¹‰äº’ç›¸å†²çªã€‚getoptå’Œgetoptså¹¶æœªå®šä¹‰é€‰é¡¹ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨è§£æé€‰é¡¹ä¹‹é—´çš„å…³ç³»ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344[root@localhost parameters]# cat option-relation.sh #!/bin/bash# handle options&#x27; relationshipset -- $(getopt -q &quot;t:x:h&quot; &quot;$@&quot;)while [ -n &quot;$1&quot; ]do case &quot;$1&quot; in -t) tar=true tar_param=&quot;$2&quot; shift ;; -x) extract=true extract_param=&quot;$2&quot; shift ;; --) shift break ;; *) echo &quot;$1 is unrecognized&quot; esac shiftdoneif [[ $tar == true &amp;&amp; $extract == true ]]; then echo &quot;Cannot specify -t -x options at the same time&quot; exit 1elif [[ $tar == true ]]; then echo &quot;Exec $(basename $0) -t $tar_param ...&quot;elif [[ $extract == true ]]; then echo &quot;Exec $(basename $0) -x $extract_param ...&quot;ficount=1for param in $@do echo &quot;parameter #$count is $param&quot; count=$[ $count + 1 ]done[root@localhost parameters]# ./option-relation.sh -x a.tar -t file file2Cannot specify -t -x options at the same time[root@localhost parameters]# ./option-relation.sh -x a.tar file2Exec option-relation.sh -x &#x27;a.tar&#x27; ...parameter #1 is &#x27;file2&#x27;[root@localhost parameters]# ./option-relation.sh -t file file2Exec option-relation.sh -t &#x27;file&#x27; ...parameter #1 is &#x27;file2&#x27; è¿™ä¸ä¸€å®šæ˜¯æœ€å¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯ä»£ç è¾ƒä¸ºæ¸…æ™°ã€‚å‰åŠéƒ¨åˆ†è§£æé€‰é¡¹ï¼Œæ ‡è®°ç›¸åº”çš„flagã€‚ç„¶åæ ¹æ®flagæƒ…å†µåˆ¤æ–­ç›¸åº”çš„ä¾èµ–å…³ç³»ï¼Œè¿›è¡Œå®é™…çš„å‘½ä»¤è¡Œé€‰é¡¹å¤„ç†ã€‚","categories":[{"name":"shell","slug":"shell","permalink":"https://system-thoughts.github.io/categories/shell/"}],"tags":[{"name":"shell","slug":"shell","permalink":"https://system-thoughts.github.io/tags/shell/"},{"name":"codebase","slug":"codebase","permalink":"https://system-thoughts.github.io/tags/codebase/"}]},{"title":"Head first for mutt","slug":"mutt","date":"2021-03-31T11:21:52.000Z","updated":"2023-01-18T05:32:06.156Z","comments":true,"path":"posts/48e1f01b/","link":"","permalink":"https://system-thoughts.github.io/posts/48e1f01b/","excerpt":"ç»™ç¤¾åŒºå‘é€é‚®ä»¶è®¨è®ºè¡¥ä¸æ—¶ï¼Œé€‰æ‹©ä¸€ä¸ªè¶æ‰‹çš„å®¢æˆ·ç«¯ä¼šæå¤§æé«˜æ²Ÿé€šæ•ˆç‡ã€‚æ›¾ç»æˆ‘é€šè¿‡â€git send-email + thunderbirdâ€çš„å·¥å…·ç»„åˆè¿›è¡Œé‚®ä»¶çš„å‘é€å’Œè¯»å–ï¼Œthunderbirdå¦‚åŒoutlookçš„cloneç‰ˆæœ¬ï¼Œå¯¹äºä½¿ç”¨GUIå®¢æˆ·ç«¯çš„ç”¨æˆ·æä¸ºå‹å¥½ã€‚ç„¶è€Œå¤§å¤šæ•°å†…æ ¸å¼€å‘è€…è¿˜æ˜¯ä¼šé€‰ç”¨mutté‚®ä»¶å®¢æˆ·ç«¯ï¼Œå…¶å¯é…ç½®æ€§æä½³ï¼Œå®Œå…¨å‘½ä»¤è¡Œçš„äº¤äº’æ–¹å¼å¯¹äºkernel hackeræ¥è¯´æ˜¯æä¸ºå‹å¥½çš„ã€‚","text":"ç»™ç¤¾åŒºå‘é€é‚®ä»¶è®¨è®ºè¡¥ä¸æ—¶ï¼Œé€‰æ‹©ä¸€ä¸ªè¶æ‰‹çš„å®¢æˆ·ç«¯ä¼šæå¤§æé«˜æ²Ÿé€šæ•ˆç‡ã€‚æ›¾ç»æˆ‘é€šè¿‡â€git send-email + thunderbirdâ€çš„å·¥å…·ç»„åˆè¿›è¡Œé‚®ä»¶çš„å‘é€å’Œè¯»å–ï¼Œthunderbirdå¦‚åŒoutlookçš„cloneç‰ˆæœ¬ï¼Œå¯¹äºä½¿ç”¨GUIå®¢æˆ·ç«¯çš„ç”¨æˆ·æä¸ºå‹å¥½ã€‚ç„¶è€Œå¤§å¤šæ•°å†…æ ¸å¼€å‘è€…è¿˜æ˜¯ä¼šé€‰ç”¨mutté‚®ä»¶å®¢æˆ·ç«¯ï¼Œå…¶å¯é…ç½®æ€§æä½³ï¼Œå®Œå…¨å‘½ä»¤è¡Œçš„äº¤äº’æ–¹å¼å¯¹äºkernel hackeræ¥è¯´æ˜¯æä¸ºå‹å¥½çš„ã€‚ what is mutt and how dose it work? â€œAll mail clients suck. This one just sucks less.â€ â€“ Michael Elkins, circa 1995 muttæ˜¯ä¸€ä¸ªé‚®ä»¶å®¢æˆ·ç«¯ï¼Œç›´æ¥ä¸ç»ˆç«¯ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼ŒInternetè§„èŒƒå’ŒRFCä½¿ç”¨æœ¯è¯­MUA(Message User Agent)æè¿°é‚®ä»¶å®¢æˆ·ç«¯ã€‚MUAå¯ä»¥æ˜¯æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œå¦‚Microsoft Outlookã€Thunderbirdç­‰ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºäºWebçš„åº”ç”¨ç¨‹åºï¼Œå¦‚Gmailã€Hotmailç­‰ï¼ˆåè€…ä¹Ÿç§°ä¸ºWebmailï¼‰ã€‚ç”¨æˆ·ä½¿ç”¨muttåº”è¯¥èƒ½å¤Ÿå®ŒæˆåŸºæœ¬çš„é‚®ä»¶ç¼–å†™ã€æ¥æ”¶ã€å‘é€ã€‚ä½†muttå°†è¿™äº›åŸºæœ¬åŠŸèƒ½éƒ½æ¨¡å—åŒ–å¹¶äº¤ç»™å…¶ä»–ç¨‹åºå®Œæˆï¼Œå¦‚muttå¯ä»¥é…ç½®ç¯å¢ƒä¸­çš„ç¼–è¾‘å™¨ä½œä¸ºæ’°å†™é‚®ä»¶çš„å·¥å…·ï¼Œæ¯”å¦‚æˆ‘ä¼šé…ç½®è¶æ‰‹çš„vimã€‚ä¸ºäº†ç¡®å®šè¿˜éœ€è¦å“ªäº›è¾…åŠ©ç¨‹åºå¸®åŠ©muttå®ŒæˆåŸºæœ¬çš„é‚®ä»¶æ”¶å‘åŠŸèƒ½ã€‚æˆ‘ä»¬éœ€è¦äº†è§£emailçš„ä¼ é€è¿‡ç¨‹ï¼šä¸ºäº†å°†é‚®ä»¶ä»å‘é€è€…é€šè¿‡Internetä¼ é€’ç»™æ¥æ”¶è€…ï¼Œè¿˜éœ€è¦MTA(Message Transfer Agent)è¿›è¡Œé‚®ä»¶è½¬å‘ï¼Œä¸€ä¸ªç®€ç•¥çš„é‚®ä»¶ä¼ é€æµç¨‹ï¼š 12sender -&gt; transfer -&gt; recipientMUA â†’ MTA â†’ â€¦ â†’ MTA â†’ MUA å¯ä»¥å°†ä¸Šè¿°æµç¨‹è¿›è¡Œç»†åŒ–ï¼š 123push steps: â†’pull steps: â†’â†’MUA â†’ MSA â†’ MTA â†’ â€¦ â†’ MTA â†’ MDA â†’â†’ MRA â†’â†’ MUA è¿™é‡Œå¯¹ä¸Šè¿°æœ¯è¯­åšä¸€ä¸ªæ¸…æ™°çš„è§£é‡Šï¼š MUA(Message User Agent): MUAæ˜¯ç»ˆç«¯ç”¨æˆ·ç®¡ç†å’Œè¯»å–å­˜å‚¨åˆ°ç”¨æˆ·é‚®ç®±çš„ç”µå­é‚®ä»¶çš„å‰ç«¯ï¼Œå¹¶å¯åœ¨å…¶ä¸­è¿›è¡Œé‚®ä»¶ç¼–è¾‘(compose)ä¸”é€šè¿‡MSAå‘é€å‡ºå»ã€‚ MTA(Message Transfer Agent)ï¼šMTAå¯¹é‚®ä»¶è¿›è¡Œæ’é˜Ÿ(queue)ã€æ¥æ”¶(receive from)ã€å¹¶å‘é€(send)ç»™ä¸‹ä¸€MTAã€‚è¿™åŒ…æ‹¬é‚®ä»¶è·¯ç”±(routing mail)ã€æ’é˜Ÿ(queuing)å’Œé‡è¯•(retrying)ï¼Œå¦‚æœä¸‹ä¸€MTAæœªèƒ½ç«‹å³æ¥æ”¶æˆ–è€…å¤„ç†emailæˆ–è€…ä¾¿å‘åŸå§‹å‘ä»¶äººå‘é€é€šçŸ¥ã€‚ MSA(Message Submission Agent)ï¼šæ¥æ”¶æ¥è‡ªMUAå‘é€çš„é‚®ä»¶ï¼Œä½œä¸ºSMTP clientï¼Œä»…èƒ½å‘é€emailï¼Œè€Œä¸èƒ½åƒFull-fledged MTAæ¥æ”¶emailè¿›è¡Œè½¬å‘ã€‚MTAä½¿ç”¨ç«¯å£25ï¼ŒMSAä¸ä»…å¯ä»¥ä½¿ç”¨ç«¯å£25ï¼Œè¿˜æœ‰offical port 587ã€‚MSAä½¿ç”¨ESMTP(SMTPåè®®çš„å˜ç§)ã€‚MSAæœ‰æ—¶å€™ä¹Ÿå½¢è±¡åœ°ç§°ä¸ºMail Sending Agentã€‚ MDA(Message Delivery Agent)ï¼šMDAæ”¶åˆ°é‚®ä»¶ä¹‹åä¸ä¼šå¾€ä¸‹è½¬å‘ï¼Œå³é‚®ä»¶å·²ç»æŠ•é€’åˆ°ä½ã€‚MDAå°†é‚®ä»¶æ”¾å…¥æ”¶ä»¶ç®±(incoming mailbox)ï¼ŒMDAå¯ä»¥è°ƒç”¨procmail MRA(Mail Retrieval Agent)ï¼šä¸è¿œç¨‹é‚®ç®±å»ºç«‹è¿æ¥å¹¶è·å–é‚®ä»¶åˆ°æœ¬åœ°ä½¿ç”¨ï¼ŒMRAæ˜¯ä»é‚®ä»¶æ¥æ”¶è€…çš„è§†è§’æ¥å‘½åï¼ŒIETFä¸æ”¯æŒè¯¥æœ¯è¯­ï¼Œè®¤ä¸ºå…¶æ˜¯MUA[1]ã€‚ è‹¥æ˜¯è¦é€šè¿‡muttå®Œæˆé‚®ä»¶çš„æ”¶å‘ï¼Œè¿˜éœ€è¦å…·å¤‡MSAå’ŒMRAåŠŸèƒ½çš„è½¯ä»¶é…åˆmuttã€‚æ˜¾ç„¶ï¼Œåœ¨æˆ‘ä»¬å·¥ä½œçš„å®¢æˆ·ç«¯ä¸éœ€è¦Full-fledeged MTAå®Œæˆé‚®ä»¶çš„ä¸­è½¬ï¼Œæˆ‘ä»¬ä»…éœ€å°†é‚®ä»¶å‘å‡ºå³å¯ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦MDAå¯¹é‚®ä»¶è¿›è¡ŒæŠ•é€’ï¼ˆå¦‚æœæ‚¨æ˜¯ä¸ºä¸ªäººæˆ–è€…å…¬å¸æ­å»ºé‚®ä»¶æœåŠ¡å™¨ï¼Œå°±å½“æˆ‘æ²¡è¯´ğŸ™Šï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„é‚®ç®±ï¼Œè¯¸å¦‚Gmailçš„é‚®ä»¶æœåŠ¡å™¨å·²ç»å®Œæˆé‚®ä»¶æŠ•é€’å·¥ä½œï¼Œæˆ‘ä»¬ä»…éœ€é€šè¿‡POP3/IMAPåè®®æ¥æ”¶é‚®ä»¶ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬é€šè¿‡æœç´¢å¼•æ“é…ç½®æœç´¢muttçš„é…ç½®ï¼Œç»å¸¸ä¼šå‡ºç°å„ç§mutt + x + y + ...çš„æœç´¢ç»“æœä»¤äººçœ¼èŠ±ç¼­ä¹±ã€‚è¿™æ˜¯å› ä¸ºåŒä¸€åŠŸèƒ½ï¼Œä½ çš„é€‰æ‹©å¾ˆå¤šï¼Œå°±æ‹¿MSAæ¥è¯´ï¼Œæ‚¨å¯ä»¥é€‰æ‹©postfixã€sendmailã€msmtpç­‰[2]ã€‚è€Œä¸”ï¼ŒåŒä¸€è½¯ä»¶å…·å¤‡çš„å¤šç§åŠŸèƒ½ï¼Œå¦‚sendmailã€postfixä¸ä»…å…·æœ‰MTAåŠŸèƒ½ï¼Œè¿˜é›†æˆäº†MDAåŠŸèƒ½ã€‚ğŸ˜¤å®³ï¼Œè¿™ä¸æ˜¯è¿èƒŒäº†Unixå“²å­¦â€one task per toolâ€ï¼æ˜¯çš„ï¼Œç”šè‡³è¿muttä¹ŸèƒŒç¦»åˆå¿ƒ: mutt was developed with the concept of â€œone task per toolâ€, enabling performance through combination with other high quality modular programs. ä½†æ˜¯muttç°åœ¨å®é™…å˜æˆäº†å½“åˆå®ƒè®¨åŒçš„æ ·å­ğŸ˜…ï¼š â€¦ or why mutt should not but slowly becomes an â€œall-in-1â€ program. muttå·²ç»å¼•å…¥äº†æœ€ç®€å•çš„MRAã€MSAåŠŸèƒ½æ”¯æŒSMTPã€POP3ã€IMAPè¿›è¡Œé‚®ä»¶æ”¶å‘ã€‚ä¸ºä½•ä¼šèƒŒç¦»åˆå¿ƒï¼š â€œThis entire concept is rubbish and the mutt developers are just plain lazy [to add all the good stuff].â€ å¥½å§ï¼Œçœ‹æ¥ç¾¤ä¼—çš„åŠ›é‡æ˜¯å¾ˆéš¾æ‰¿å—çš„â€¦â€¦å¦å¤–æœ‰äº›åŠŸèƒ½çš„ç•Œé™å®é™…éš¾ä»¥åŒºåˆ†ï¼Œæ¯”å¦‚MDAå’ŒMRAã€‚ OK, è¯´äº†è¿™ä¹ˆå¤šå…³äºé‚®ä»¶çš„åŸºæœ¬æ¦‚å¿µï¼Œletâ€™s get hands dirtyï¼Œç¬¬ä¸€æ­¥å…ˆå®‰è£…muttï¼ˆæœ¬æ–‡ä½¿ç”¨CentOS8ç¯å¢ƒï¼ŒUbuntuç”¨æˆ·åº”è¯¥ä¼šæ›´æ–¹ä¾¿ï¼‰: 1yum install mutt Basic Configurationmutté»˜è®¤ä»ç³»ç»ŸèŒƒå›´çš„é…ç½®æ–‡ä»¶ï¼ˆâ€œ/etc/Muttrcâ€ï¼‰è¯»å–å…¶é…ç½®çš„é»˜è®¤å€¼ï¼Œè¯¥æ–‡ä»¶é€šå¸¸æ§åˆ¶ç³»ç»Ÿè®¾ç½®å¹¶ä¸ºæ‰€æœ‰ç”¨æˆ·æä¾›å¯è¡Œçš„é»˜è®¤é…ç½®ã€‚ç„¶åè¯»å–ä¸ªäººé…ç½®æ–‡ä»¶ï¼ˆâ€œ/.muttrcâ€æˆ–â€œ/.mutt/muttrcâ€ï¼‰ï¼Œè¿™æ ·ï¼Œä¸ªäººè®¾ç½®ä¼šæ ¹æ®éœ€è¦è¦†ç›–ç³»ç»Ÿè®¾ç½®ã€‚æˆ‘ä»¬é‡‡ç”¨~/.mutt/muttrcå¯¹muttè¿›è¡Œé…ç½®ã€‚ muttä¸­çš„å˜é‡é€šè¿‡set var=valueæ–¹å¼é…ç½®ã€‚å­˜åœ¨ä»…éœ€è®¾ç½®yes/noçš„toggle varï¼ˆå¸ƒå°”å˜é‡ï¼‰ï¼Œä½ å¯ä»¥ä¸ºtoggle varè®¾ç½®â€ask-yesâ€æˆ–è€…â€ask-noâ€ä»¥æŒ‡å®šæ¯æ¬¡ä½¿ç”¨æ—¶ç»™å®šé»˜è®¤ç­”æ¡ˆè¿›è¡Œæç¤ºã€‚ä¹Ÿå¯ä»¥é€šè¿‡ â€œunsetâ€ã€â€set varâ€ã€â€set novarâ€ç®€åŒ–å¸ƒå°”å˜é‡çš„è®¾ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ é…ç½®çš„muttå˜é‡å¯¹åº”çš„åŠŸèƒ½åœ¨ç¼–è¯‘muttæ—¶å·²å¯ç”¨æ‰ä¼šæˆåŠŸè®¾ç½®ï¼Œå¦åˆ™ä½ ä¼šå¾—åˆ°â€œunknown variableâ€çš„å‘Šè­¦ã€‚æ‰€æœ‰çš„mutté…ç½®å‚æ•°åˆ†ç±»å¯å‚è€ƒConfigListã€‚ä¸‹é¢ç»™å‡ºæœ€åŸºæœ¬çš„mutté…ç½®ï¼š 123456# Basic configurationset ssl_force_tls = yesset abort_nosubject = noset timeout = 10set mail_check = 60set sort = &quot;reverse-date-received&quot; ssl_force_tlsè¡¨ç¤ºmuttä¸æ‰€æœ‰çš„è¿œç«¯æœåŠ¡å™¨çš„è¿æ¥éœ€è¦é€šè¿‡TLSåè®®åŠ å¯†ï¼Œå¦‚æœä¸èƒ½æˆåŠŸå»ºç«‹è¿æ¥ï¼Œä¸­æ–­é€šä¿¡ã€‚mutt -v | grep tlsèƒ½å¤Ÿæ‰“å°--with-gnutlsè¡¨ç¤ºmuttæ”¯æŒTLSã€‚ abort_nosubjectçš„é»˜è®¤å€¼æ˜¯â€ask-yesâ€ï¼Œè¡¨ç¤ºæˆ‘ä»¬å‘é€é‚®ä»¶è¿˜æœªå†™é‚®ä»¶ä¸»é¢˜æ—¶ï¼Œè¯¥é…ç½®å°†ä¼šæç¤ºï¼Œé»˜è®¤å€¼ä¸ºâ€yesâ€ã€‚å°†è¯¥é¡¹è®¾ç½®ä¸ºâ€noâ€ï¼Œä¾¿æ— éœ€ç¡®è®¤ã€‚ muttæ¯æ¬¡æ¥æ”¶åˆ°é”®ç›˜è¾“å…¥æ—¶ä¾¿ä¼šæ›´æ–°æ‰€æœ‰ç›®å½•çš„çŠ¶æ€ã€‚æˆ‘ä»¬ä¹Ÿå¸Œæœ›å³ä½¿åœ¨ç©ºé—²æ—¶ä¹Ÿèƒ½æ”¶åˆ°æ–°é‚®ä»¶çš„é€šçŸ¥ï¼Œè€Œä¸éœ€è¦æŒ‰ä¸‹æŒ‰é”®ã€‚æ§åˆ¶è¿™ç§è¡Œä¸ºçš„å˜é‡æ˜¯timeoutã€‚å®ƒè¡¨ç¤ºç­‰å¾…ç”¨æˆ·è¾“å…¥çš„æœ€å¤§æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´å†…æ²¡æœ‰æ¥æ”¶åˆ°ç”¨æˆ·è¾“å…¥ï¼Œä¾¿æ‰§è¡Œæ›´æ–°æ“ä½œã€‚å˜é‡çš„é»˜è®¤å€¼æ˜¯600ç§’ï¼Œè¡¨ç¤ºåœ¨æ²¡æœ‰è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œæ¯10åˆ†é’Ÿæ¥æ”¶ä¸€æ¬¡æ›´æ–°ã€‚é»˜è®¤å€¼å¤ªé«˜ï¼Œæˆ‘ä»¬è®¾ç½®ä¸º10ã€‚ å¦‚å‰æ‰€è¿°ï¼Œæ¯æ¬¡æ”¶åˆ°ç”¨æˆ·è¾“å…¥æ—¶ï¼Œmuttéƒ½ä¼šæŸ¥æ‰¾æ›´æ–°ã€‚é”®ç›˜æ´»åŠ¨å¤ªé¢‘ç¹ä¼šå¯¼è‡´è¿‡å¤šçš„è®¿é—®æ“ä½œï¼Œä¸ºäº†é™åˆ¶è¿™ä¸ªé¢‘ç‡ï¼Œä½¿ç”¨mail checkå˜é‡ã€‚è¯¥å˜é‡è¡¨ç¤ºä¸¤æ¬¡æ‰«æä¹‹é—´çš„æœ€å°æ—¶é—´(ä»¥ç§’ä¸ºå•ä½)ã€‚è¯¥å˜é‡çš„é»˜è®¤å€¼æ˜¯5ï¼Œå³ä½¿ç»å¸¸æŒ‰ä¸‹é”®ï¼Œmuttä¹Ÿå°†æ¯5ç§’æœç´¢ä¸€æ¬¡æ–°é‚®ä»¶ã€‚è¯¥å€¼è¿˜æ˜¯å¤ªå°ï¼Œå°¤å…¶æ˜¯åœ¨å¤šé‚®ç®±çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½å› ä¸ºé¢‘ç¹è®¿é—®é™ä½é€Ÿåº¦ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç´¢å¼•èœå•(æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨)ä¸­çš„ç”µå­é‚®ä»¶æŒ‰æ—¥æœŸå‡åºæ’åºï¼Œå› æ­¤æ›´æ–°çš„ç”µå­é‚®ä»¶å°†æ˜¾ç¤ºåœ¨åº•éƒ¨ã€‚è¦æ›´æ”¹ç”µå­é‚®ä»¶çš„æ’åºæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å’Œè®¾ç½®sortå˜é‡çš„å€¼ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®reverse-data-receivedè®©æ›´æ–°çš„ç”µå­é‚®ä»¶å‡ºç°åœ¨åˆ—è¡¨çš„é¡¶éƒ¨ã€‚å…¶ä»–å‚æ•°ä¹Ÿå¯ä»¥ç”¨ä½œæ’åºå› å­ï¼Œä¾‹å¦‚subjectå’Œsizeã€‚ Retrieve emailMUAä½¿ç”¨POP3/IMAPåè®®ä»é‚®ä»¶æœåŠ¡å™¨ä¸‹è½½é‚®ä»¶ã€‚ä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹[3]ï¼š POP3(Post Office Protocol 3)ï¼šä»…ä»…ä¸‹è½½é‚®ä»¶æœåŠ¡å™¨çš„inboxç›®å½•ä¸­çš„é‚®ä»¶åˆ°æœ¬åœ°ï¼Œä¸ä¼šä¸‹è½½sentã€draftã€deletedç›®å½•ä¸‹çš„é‚®ä»¶ã€‚å¹¶ä¸”POP3ä¸ä¼šåŒæ­¥ï¼Œå¹¶ä¸”å½“emailè¢«ä¸‹è½½åˆ°ä¸€å°è®¾å¤‡ä¸Šæ—¶ï¼Œemailä¼šä»é‚®ä»¶æœåŠ¡å™¨ä¸­åˆ é™¤ã€‚ IMAP(Internet Message Access Protocol)ï¼šå…è®¸åœ¨å¤šä¸ªå®¢æˆ·ç«¯ä¸ŠæŸ¥çœ‹é‚®ä»¶ï¼ˆåŒæ­¥ï¼‰ï¼ŒIMAPä¼šå°†é‚®ä»¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚IMAPè¿˜ä¼šåŒæ­¥å„ä¸ªè®¾å¤‡çš„ç›®å½•ç»“æ„ ä¸Šå›¾å±•ç¤ºäº†ä¸¤å°ç”µè„‘éƒ½ä»åŒä¸€emailè´¦å·ä¸‹è½½é‚®ä»¶ï¼ˆå‡ä½¿ç”¨POP3åè®®ï¼‰ï¼Œä¸¤å°ç”µè„‘ä¸Šçš„ç›®å½•ç»“æ„æˆªç„¶ä¸åŒï¼Œå› ä¸ºPOP3ä¸ä¼šåŒæ­¥ä¸¤å°ç”µè„‘ä¸­çš„ç›®å½•ã€‚å½“æœ‰æ–°é‚®ä»¶åˆ°æ¥æ—¶ï¼Œç¬¬ä¸€å°ç”µè„‘å…ˆä¸‹è½½äº†é‚®ä»¶ï¼Œé‚®ä»¶ä¾¿ä¼šä»é‚®ä»¶æœåŠ¡å™¨ä¸­åˆ é™¤ï¼Œç¬¬äºŒèƒç”µè„‘æ˜¯è·å–ä¸åˆ°æ–°é‚®ä»¶çš„ã€‚ä¸è¿‡åé¢è¿™ä¸ªé—®é¢˜è¿˜å¥½ï¼Œå¾ˆå¤šé‚®ä»¶å®¢æˆ·ç«¯å¯ä»¥è®¾ç½®leave a copy of messages on the serverã€‚ POP3å’ŒIMAPçš„æ¯”è¾ƒï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š metrics POP3 IMAP view without Internet Yes NO All the folders can be seen NO YES All the folders and emails are synchronized NO YES Email stored on the mail server NO YES ç”±äºIMAPé»˜è®¤åœ¨æœ¬åœ°ä»…ç¼“å­˜(cache)é‚®ä»¶ï¼Œå¹¶ä¸ä¸‹è½½é‚®ä»¶ï¼Œæ‰€ä»¥é»˜è®¤åœ¨æ— ç½‘ç»œçš„æ¡ä»¶ä¸‹ï¼Œä½¿ç”¨IMAPçš„MUAæ˜¯æ— æ³•é˜…è¯»é‚®ä»¶çš„ï¼Œä½†æ˜¯ç°åœ¨å¾ˆå¤šä½¿ç”¨IMAPçš„MUAéƒ½å¯ä»¥è®¾ç½®å°†é‚®ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè€Œéä»…ä»…ç¼“å­˜ã€‚POP3åè®®ç”±äºä¼šå°†é‚®ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼ˆä¸‹è½½ä¼šåˆ é™¤é‚®ä»¶æœåŠ¡å™¨ä¸­çš„é‚®ä»¶ï¼‰ï¼Œä»è€Œèƒ½å¤ŸèŠ‚çº¦é‚®ä»¶æœåŠ¡å™¨çš„ç©ºé—´ï¼Œç„¶è€Œæœ¬åœ°ä¸‹è½½çš„é‚®ä»¶éœ€è¦å¤‡ä»½ä»¥å…ç£ç›˜æŸåé‚®ä»¶ä¸¢å¤±ã€‚ mutt -v | grep IMAPèƒ½å¤Ÿæ‰“å°+USE_IMAPè¡¨ç¤ºmuttæ”¯æŒIMAPã€‚å½“å‰muttç‰ˆæœ¬å·²ç»æ”¯æŒIMAPã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨muttè‡ªå¸¦çš„IMAPåŠŸèƒ½ä¸‹è½½é‚®ä»¶ï¼Œå…³äºIMAPç›¸å…³çš„é…ç½®å¦‚ä¸‹ï¼š 12345678910111213set from = &quot;foo.bar@gmail.com&quot;set realname = &quot;Foo Bar&quot;# Imap settingsset imap_user = &quot;foo.bar@gmail.com&quot;set imap_pass = &quot;&lt;mutt-app-specific-password&gt;&quot;# Remote gmail foldersset folder = &quot;imaps://imap.gmail.com/&quot;set spoolfile = &quot;+INBOX&quot;set postponed = &quot;+[Gmail]/Drafts&quot;set record = &quot;+[Gmail]/Sent Mail&quot;set trash = &quot;+[Gmail]/Trash&quot; fromæŒ‡å®šçš„æ˜¯email headerï¼Œæ­¤å¤„å¡«å†™ä½ çš„é‚®ç®±åœ°å€ã€‚realnameå¡«å†™ä½ çš„çœŸå®å§“åã€‚ imap_useræ˜¯åœ¨IMAPæœåŠ¡å™¨ä¸Šè®¿é—®å…¶é‚®ä»¶çš„ç”¨æˆ·åï¼Œå’Œfromå˜é‡ä¿æŒä¸€è‡´ï¼Œæ­¤å¤„ä»¥gmailè´¦æˆ·ä¸ºä¾‹ã€‚imap_passæ˜¯IMAPè´¦æˆ·çš„å¯†ç ï¼Œè°·æ­Œè¦æ±‚ä¸ä½¿ç”¨Oauth2èº«ä»½éªŒè¯æ–¹æ³•çš„åº”ç”¨å¿…é¡»ä½¿ç”¨ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¯†ç ã€‚ä¸ºäº†èƒ½å¤Ÿä»muttè®¿é—®æˆ‘ä»¬çš„gmailå¸æˆ·ï¼Œæˆ‘ä»¬å¿…é¡»æ‰“å¼€2-Step Verificationï¼Œéšåç”Ÿæˆç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¯†ç ã€‚ folderï¼šmailboxçš„é»˜è®¤ä½ç½® spoolfile:æ–°é‚®ä»¶åˆ°è¾¾mailboxæ—¶ï¼Œå½’æ¡£çš„ç›®å½• postponedï¼šå­˜å‚¨å¾…å‘é€çš„é‚®ä»¶(è‰ç¨¿)çš„æ–‡ä»¶å¤¹ recordï¼šå­˜å‚¨å·²å‘é€çš„é‚®ä»¶çš„æ–‡ä»¶å¤¹ trashï¼šå­˜å‚¨å·²åˆ é™¤é‚®ä»¶çš„æ–‡ä»¶å¤¹ åœ¨å®¢æˆ·ç«¯æ‰§è¡Œmuttæ‰“å¼€é‚®ç®±æŸ¥çœ‹gmailé‚®ä»¶ï¼š Send emailMTAè¿›è¡Œé‚®ä»¶è½¬å‘ä½¿ç”¨SMTPåè®®(Simple Mail Transfer Protocol)ã€‚å¦‚ä¸‹è¿™æ®µè¯ï¼Œæˆ‘è®¤ä¸ºæ˜¯å¯¹SMTPåè®®çš„åŠŸèƒ½çš„ä¸€ä¸ªè‰¯å¥½æ¦‚æ‹¬[4]ã€‚ SMTP is basically a set of commands that authenticates and directs the transfer of email æ›´ç®€å•æ–¹å¼çš„è®°ä½S(ending) M(ail) T(o) P(eople)ã€‚ä¸‹å›¾å±•ç¤ºäº†é€šè¿‡SMTPåè®®å°†é‚®ä»¶ä»SMTP clienté€”å¾„SMTP serverä¼ é€’åˆ°æ”¶ä»¶äººçš„SMTP serverï¼Œæœ€ç»ˆæ”¶ä»¶ç”¨æˆ·ç™»å½•ä¿¡ç®±é€šè¿‡POP3/IMAPä¸‹è½½é‚®ä»¶ã€‚ MTAå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šä»…è½¬å‘(relay-only)ã€å…¨åŠŸèƒ½(full-fledged)[5]ã€‚ Relay-only MTAs: æˆ–è€…ç§°ä¸ºSend-only MTAsã€small MTAs(SMTP clients)[6]ï¼Œæ­¤ç±»MTAä»…å°†ä½ çš„emailè½¬å‘åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå¦‚æœä½ åƒæˆ‘ä¸€æ ·ä»…ä»…æƒ³å‘é€è‡ªå·±çš„Gmailé‚®ä»¶ï¼Œæ­¤ç±»MTAæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚SMTP clientä»…æ‰§è¡ŒæŸäº›ç‰¹å®šçš„åŠŸèƒ½ï¼Œè€Œä¸åƒFull-fledged MTAä¸€æ ·è¿è¡Œå®Œæˆçš„SMTPæœåŠ¡å™¨ï¼Œå ç”¨å¤§é‡çš„èµ„æºå¼€é”€ã€‚è¿™æ ·çš„MTAä¸ä¼šç›‘å¬ä¼ å…¥çš„æ¶ˆæ¯ï¼Œå°½åœ¨éœ€è¦å‘é€é‚®ä»¶çš„æ—¶å€™è¿è¡Œã€‚small MTAé€šå¸¸ä½œä¸ºMSAå³é‚®ä»¶å‘é€çš„ç¬¬ä¸€ç«™ã€‚ Full-fledged MTAsï¼šä¹Ÿç§°ä¸ºmail hubï¼Œèƒ½å¤Ÿå¤„ç†Interneté‚®ä»¶ä¼ é€çš„æ‰€æœ‰ç»†èŠ‚ï¼Œé€šå¸¸è¿™ç±»MTAä»Relay-Only MTAæ¥æ”¶é‚®ä»¶å†è¿›è¡Œè½¬å‘ã€‚é‚®ä»¶åœ¨Internetçš„ä¸­é—´MTAè½¬å‘æ¼«æ¸¸æ—¶ï¼Œè¿™äº›MTAä½¿ç”¨full-fledged MTAæ¯”è¾ƒåˆé€‚ã€‚ æœ¬æ–‡ä»…è€ƒè™‘MSAå³Relay-only MTAï¼Œé€‰å–è½¯ä»¶ä½œä¸ºMSAåº”è¯¥è€ƒè™‘å¦‚ä¸‹å› ç´ ï¼š MTAæ˜¯å¦å¯ä»¥å¯¹é‚®ä»¶è¿›è¡Œæ’é˜Ÿï¼Œä»¥ä¾¿åœ¨å‡ºç°æ•…éšœæ—¶ç¨åå‘é€ MTAå¯ä»¥å–ä»£MDA?å¦‚æœå¯ä»¥ï¼Œå®ƒå°†å¤„ç†æ¥è‡ªç³»ç»Ÿçš„æ‰€æœ‰é‚®ä»¶ã€‚ MTAæ˜¯å¦æ”¯æŒè¿æ¥åˆ°ISP SMTPæœåŠ¡å™¨çš„è¦æ±‚ï¼Ÿè¿™äº›è¦æ±‚å¯èƒ½åŒ…æ‹¬ç‰¹å®šçš„èº«ä»½éªŒè¯æˆ–TLSã€‚ muttæ—©å·²æ”¯æŒESMTP/SMTPï¼Œmutt -v | grep SMTPèƒ½å¤Ÿæ‰“å°+USE_SMTPè¡¨ç¤ºmuttæ”¯æŒSMTPã€‚å½“å‰muttç‰ˆæœ¬å·²ç»æ”¯æŒSMTPã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨muttè‡ªå¸¦çš„SMTPåŠŸèƒ½å‘é€é‚®ä»¶ï¼Œæ­¤æ—¶ï¼Œmuttè‡ªå·±å¯ä»¥ä½œä¸ºMSAã€‚å¦‚æœæ‚¨éœ€è¦é€‰æ‹©åŠŸèƒ½æ›´ä¸ºå¤æ‚çš„MSAï¼Œè¯·å‚è€ƒSendmailAgentsã€‚å…³äºSMTPç›¸å…³çš„é…ç½®å¦‚ä¸‹ï¼š 123# smtpset smtp_url = &quot;smtp://foo.bar@smtp.gmail.com:587&quot;set smtp_pass = $imap_pass æµ‹è¯•é‚®ä»¶å‘é€: 123456[root@localhost ~]# proxychains4 echo &quot;mail test&quot; | mutt -s &quot;test email&quot; buweilv@qq.com[proxychains] config file found: /etc/proxychains.conf[proxychains] preloading /usr/local/lib/libproxychains4.so[proxychains] DLL initCould not connect to smtp.gmail.com (Connection refused).Could not send the message. é‚®ä»¶å‘é€å¤±è´¥ã€‚ä½¿ç”¨mutt -dé€‰é¡¹è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œè°ƒè¯•çº§åˆ«ä»15ï¼Œæ—¥å¿—è¯¦ç»†çº§åˆ«ç›¸åº”æé«˜ã€‚è°ƒè¯•ä¿¡æ¯è¾“å‡ºåˆ°â€™/.muttdebug*â€™ã€‚ä¸Šé¢çš„å‘é€å¤±è´¥å¾ˆå¯èƒ½æ˜¯å› ä¸ºç½‘ç»œä¸ç¨³å®šã€‚gmail smtpä½¿ç”¨æ›´ä¸ºå®‰å…¨çš„TLSåè®®ï¼Œç«¯å£ä¸º587ã€‚ssl_ca_certificates_fileæŒ‡å®šçš„æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰å—ä¿¡ä»»çš„CAè¯ä¹¦ã€‚ä½¿ç”¨è¿™äº›CAè¯ä¹¦ä¹‹ä¸€ç­¾åçš„ä»»ä½•æœåŠ¡å™¨è¯ä¹¦ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¥å—(ä»…GnuTLS)ã€‚ä½¿ç”¨mutt -DæŸ¥çœ‹é»˜è®¤é…ç½®ï¼š 1234[root@localhost ~]# mutt -D | grep ssl_ca_certificates_filessl_ca_certificates_file=&quot;/etc/ssl/certs/ca-bundle.crt&quot;[root@localhost ~]# rpm -qf /etc/ssl/certs/ca-bundle.crtca-certificates-2020.2.41-80.0.el8_2.noarch æ•…ä½¿ç”¨TLSåè®®çš„SMTPæœåŠ¡åº”è¯¥å®‰è£…ca-certificatesã€‚Ubuntuç¯å¢ƒä¸‹çš„æ–‡ä»¶å‘½åä¸åŒï¼ŒåŒ…åä¹Ÿä¸åŒã€‚ Interact with muttä¹‹å‰æˆ‘ä»¬ä½¿ç”¨ç®€å•çš„muttå‘½ä»¤è¡Œå®Œæˆé‚®ä»¶çš„æ”¶å‘å·¥ä½œã€‚ä½†æ˜¯ï¼Œè¿›å…¥muttäº¤äº’ç•Œé¢ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¯»å–é‚®ä»¶ï¼Œå¯¹é‚®ä»¶åˆ†ç±»ï¼Œå¹¶ä¸”åœ¨muttå®¢æˆ·ç«¯å†…ç¼–è¾‘é‚®ä»¶ã€å›å¤é‚®ä»¶å‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬å¾—äº†è§£muttç•Œé¢çš„åŠŸèƒ½åŒºåŸŸã€‚muttæä¾›ä¸åŒçš„çª—å£(menu)ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼Œè¿™äº›çª—å£å¤§å¤šåŸºäºè¡Œ(line-based)/æ¡ç›®(entry-based)æˆ–åŸºäºé¡µé¢(page-based)ã€‚ åŸºäºè¡Œçš„çª—å£æ˜¯æ‰€è°“çš„â€œç´¢å¼•â€(index)çª—å£ï¼ˆåˆ—å‡ºå½“å‰æ‰“å¼€çš„æ–‡ä»¶å¤¹çš„æ‰€æœ‰é‚®ä»¶ï¼‰æˆ–â€œåˆ«åâ€(alias)çª—å£ï¼ˆå…è®¸æ‚¨ä»åˆ—è¡¨ä¸­é€‰æ‹©æ”¶ä»¶äººï¼‰ã€‚ åŸºäºé¡µé¢çš„çª—å£çš„ä¾‹å­æ˜¯â€œpagerâ€ï¼ˆä¸€æ¬¡æ˜¾ç¤ºä¸€å°é‚®ä»¶ï¼‰æˆ–â€œå¸®åŠ©â€çª—å£ï¼Œå…¶ä¸­åˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨çš„ç»‘å®šé”®ã€‚ä¸‹å›¾ä»¥ç´¢å¼•çª—å£ä¸ºä¾‹ï¼Œå±•ç¤ºmuttäº¤äº’ç•Œé¢çš„åŸºæœ¬æ„æˆã€‚å›¾ä¸­çš„context senstiveè¡¨ç¤ºæ­¤å¤„çš„å†…å®¹å’Œçª—å£ç±»å‹æœ‰å…³ã€‚äº¤äº’ç•Œé¢ä¸»è¦ç”±ä»¥ä¸‹å…ƒç´ æ„æˆï¼š context sensitive help line çª—å£å…·ä½“å†…å®¹ context sensitive status line å‘½ä»¤è¡Œï¼šæ˜¾ç¤ºä¿¡æ¯å’Œé”™è¯¯æ¶ˆæ¯ä»¥åŠæç¤ºå’Œè¾“å…¥äº¤äº’å¼å‘½ä»¤ muttå…±å­˜åœ¨å¦‚ä¸‹çª—å£(menu)ï¼š index: å¯åŠ¨Muttæ—¶æœ€å…ˆçœ‹åˆ°çš„çª—å£ï¼Œå±•ç¤ºå½“å‰æ‰“å¼€é‚®ç®±ä¸­çš„emailã€‚indexçª—å£æ˜¯line-basedï¼Œæ¯ä¸€è¡Œä»å·¦åˆ°å³åˆ†åˆ«è¡¨ç¤ºé‚®ä»¶ç¼–å·ã€æ ‡å¿—ï¼ˆæ–°ç”µå­é‚®ä»¶ï¼Œé‡è¦ç”µå­é‚®ä»¶ï¼Œå·²è½¬å‘æˆ–å›å¤çš„ç”µå­é‚®ä»¶ï¼Œå·²æ ‡è®°ç”µå­é‚®ä»¶ï¼Œâ€¦ï¼‰ã€é‚®ä»¶å‘é€æ—¥æœŸã€emailå¤§å°ã€ä¸»é¢˜ã€‚å¦‚æœmutté…ç½®set sort = &quot;threads&quot;ï¼Œé‚®ä»¶æŒ‰ç…§threadï¼ˆå¯¹è¯ï¼‰çš„å½¢å¼å±‚çº§å±•å¼€ï¼šå½“æ‚¨å›å¤çš„ç”µå­é‚®ä»¶ï¼Œè¢«å¯¹æ–¹å›å¤ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹é¢çš„â€œå­æ ‘â€ä¸­çœ‹åˆ°å¯¹æ–¹çš„ç”µå­é‚®ä»¶ã€‚å¦‚æœæ‚¨è®¢é˜…äº†é‚®ä»¶åˆ—è¡¨ï¼Œè¿™ç§æ˜¾ç¤ºæ–¹å¼éå¸¸æœ‰æ•ˆã€‚ pagerï¼šè´Ÿè´£æ˜¾ç¤ºç”µå­é‚®ä»¶å†…å®¹ã€‚pagerçš„é¡¶éƒ¨æœ‰email headerä¸­çš„ä¸»è¦ä¿¡æ¯ï¼Œå¦‚å‘ä»¶äººï¼Œæ”¶ä»¶äººï¼Œä¸»é¢˜ç­‰ã€‚ä½ å¯ä»¥é…ç½®muttå±•ç¤ºæ›´å¤šemail headerå†…å®¹ã€‚email headerä¸‹æ–¹ä¾¿æ˜¯é‚®ä»¶æ­£æ–‡ï¼Œå¦‚æœé‚®ä»¶åŒ…å«é™„ä»¶ï¼Œä¼šåœ¨é‚®ä»¶æ­£æ–‡ä¸‹æ–¹æ˜¾ç¤ºã€‚å¦‚æœé™„ä»¶å°±æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶å†…å®¹ä¼šç›´æ¥åœ¨pagerä¸­æ˜¾ç¤ºã€‚ä¸ºäº†æœ‰æ›´å¥½çš„è§‚æ„Ÿï¼Œå¯ä»¥åœ¨muttä¸­é…ç½®åœ¨pagerä¸­ä¸ºä¸åŒå†…å®¹æ˜¾ç¤ºä¸åŒé¢œè‰²ã€‚å®é™…ä¸Šï¼Œä»»ä½•å¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼æè¿°çš„å†…å®¹éƒ½å¯ä»¥ç€è‰²ï¼Œä¾‹å¦‚ç½‘å€ã€é‚®ç®±åœ°å€æˆ–è¡¨æƒ…ç¬¦å·ã€‚ file browserï¼šæ˜¯æœ¬åœ°æˆ–è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œå°šæœªé‡åˆ°ã€‚ sidebarï¼šæ˜¾ç¤ºäº†æ‰€æœ‰é‚®ç®±çš„åˆ—è¡¨ã€‚è¯¥åˆ—è¡¨å¯ä»¥æ‰“å¼€å’Œå…³é—­ï¼Œå®ƒå¯ä»¥ä¸»é¢˜åŒ–ï¼Œåˆ—è¡¨æ ·å¼å¯ä»¥é…ç½®ã€‚ helpï¼šæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›å¿«é€Ÿå¸®åŠ©ã€‚å®ƒåˆ—å‡ºäº†é”®ç»‘å®šçš„å½“å‰é…ç½®åŠå…¶ç›¸å…³å‘½ä»¤(commands)ï¼ŒåŒ…æ‹¬ç®€çŸ­çš„æè¿°ï¼Œä»¥åŠå½“å‰æœªç»‘å®šå‡½æ•°(æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡Muttå‘½ä»¤æç¤ºç¬¦è°ƒç”¨å®ƒä»¬)ã€‚ compose menuï¼šæ’°å†™çª—å£å…·æœ‰ä¸€ä¸ªæ‹†åˆ†çª—å£ï¼Œå…¶ä¸­åŒ…å«æ”¶ä»¶äººã€æŠ„é€äººçš„ä¿¡æ¯ã€‚å¦å¤–ç”¨æˆ·è¿˜å¯ä»¥å¯¹é‚®ä»¶è¿›è¡ŒåŠ å¯†ã€ç­¾åã€‚ attachment menuï¼šmuttæ”¯æŒå‘é€å’Œæ¥æ”¶ä»»æ„MIMEç±»å‹çš„æ¶ˆæ¯ï¼Œé™„ä»¶çª—å£è¯¦ç»†åœ°å±•ç¤ºäº†é‚®ä»¶çš„ç»“æ„ã€‚ alias menuï¼šå¸®åŠ©ç”¨æˆ·æŸ¥æ‰¾æ¶ˆæ¯çš„æ”¶ä»¶äººã€‚å¯¹äºéœ€è¦è”ç³»å¾ˆå¤šäººçš„ç”¨æˆ·æ¥è¯´ï¼Œä¸éœ€è¦å®Œå…¨è®°ä½åœ°å€æˆ–åå­—ã€‚muttçš„åˆ«åæœºåˆ¶ä»¥åŠåˆ«åçª—å£è¿˜å…·æœ‰æŒ‰æ›´çŸ­çš„åˆ«å(å®é™…åˆ«å)å¯¹å¤šä¸ªåœ°å€è¿›è¡Œåˆ†ç»„çš„åŠŸèƒ½ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸å¿…æ‰‹åŠ¨é€‰æ‹©æ¯ä¸ªæ”¶ä»¶äººã€‚ muttä½œä¸ºæ–‡æœ¬é‚®ä»¶å®¢æˆ·ç«¯ï¼Œéœ€è¦å®Œå…¨ä¾èµ–é”®ç›˜å®ŒæˆåŸºæœ¬æ“ä½œã€‚å½“å‰ä»‹ç»åŸºäºè¡Œ/æ¡ç›®çª—å£çš„å¸¸è§„æŒ‰é”®ï¼Œä»¥indexçª—å£ä¸ºä¾‹ï¼š ç§»åŠ¨ï¼šk/j ä¸Šä¸‹ç§»åŠ¨, Z/z ä¸Šä¸‹ç¿»é¡µ, =/* è·³è½¬åˆ°ç¬¬ä¸€å°/æœ€åä¸€å°é‚®ä»¶ï¼Œ è·³è‡³åºå·å¤„ï¼ˆä¸è¿›å…¥é‚®ä»¶ï¼‰ åŸºæœ¬æ“ä½œï¼šqé€€å‡ºå½“å‰çª—å£ï¼Œæ‰“å¼€é€‰ä¸­é‚®ä»¶ï¼Œ? æŸ¥çœ‹å½“å‰çª—å£çš„é”®ç»‘å®š /åœ¨å½“å‰æ–‡ä»¶å¤¹æœç´¢ é’ˆå¯¹indexçª—å£æœ‰äº›ä¸“æœ‰åŠŸèƒ½çš„æŒ‰é”®ï¼š d:åˆ é™¤å½“å‰é‚®ä»¶, s:å°†é‚®ä»¶ç§»åŠ¨è‡³æŒ‡å®šæ–‡ä»¶å¤¹, m:åˆ›å»ºæ–°é‚®ä»¶, r:å›å¤å½“å‰é‚®ä»¶ Reference[1] Email agent (infrastructure) https://en.wikipedia.org/wiki/Email_agent_(infrastructure)#cite_note-modularmonolithic-schroder-1[2] SendmailAgents https://gitlab.com/muttmua/mutt/-/wikis/SendmailAgents[3] POP3 vs IMAP - Whatâ€™s the difference? https://www.youtube.com/watch?v=SBaARws0hy4&amp;t=337s[4] What is SMTP - Simple Mail Transfer Protocol https://www.youtube.com/watch?v=PJo5yOtu7o8[5] Postfix vs. Sendmail vs. Exim https://blog.mailtrap.io/postfix-sendmail-exim/?amp=1[6] MTA: Mail Transport Agent (SMTP server) https://gitlab.com/muttmua/mutt/-/wikis/MailConcept","categories":[{"name":"tools","slug":"tools","permalink":"https://system-thoughts.github.io/categories/tools/"}],"tags":[{"name":"mutt","slug":"mutt","permalink":"https://system-thoughts.github.io/tags/mutt/"},{"name":"ç¤¾åŒº","slug":"ç¤¾åŒº","permalink":"https://system-thoughts.github.io/tags/%E7%A4%BE%E5%8C%BA/"}]},{"title":"ã€è¯‘æ–‡ã€‘Memory Ordering at Compile Time","slug":"ã€è¯‘æ–‡ã€‘Memory Ordering at Compile Time","date":"2021-03-22T11:21:52.000Z","updated":"2023-01-18T05:32:06.164Z","comments":true,"path":"posts/6c068df6/","link":"","permalink":"https://system-thoughts.github.io/posts/6c068df6/","excerpt":"æˆ‘ä»¬ç¼–å†™çš„C/C++ä»£ç åœ¨å¤„ç†å™¨ä¸Šå®é™…çš„æ‰§è¡Œé¡ºåºå’Œå…¶åœ¨æºç ä¸­çš„é¡ºåºå¯èƒ½å¹¶ä¸ç›¸åŒã€‚ç¼–è¯‘å™¨ä¼šé€šè¿‡æŒ‡ä»¤é‡æ’ä¼˜åŒ–ç¼–è¯‘æ•ˆæœï¼ŒCPUä¹Ÿä¼šé€šè¿‡ä¹±åºæ‰§è¡Œä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ã€‚æœ¬æ–‡å°†ä»‹ç»ç¼–è¯‘æ—¶çš„å†…å­˜é‡æ’ã€‚","text":"æˆ‘ä»¬ç¼–å†™çš„C/C++ä»£ç åœ¨å¤„ç†å™¨ä¸Šå®é™…çš„æ‰§è¡Œé¡ºåºå’Œå…¶åœ¨æºç ä¸­çš„é¡ºåºå¯èƒ½å¹¶ä¸ç›¸åŒã€‚ç¼–è¯‘å™¨ä¼šé€šè¿‡æŒ‡ä»¤é‡æ’ä¼˜åŒ–ç¼–è¯‘æ•ˆæœï¼ŒCPUä¹Ÿä¼šé€šè¿‡ä¹±åºæ‰§è¡Œä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ã€‚æœ¬æ–‡å°†ä»‹ç»ç¼–è¯‘æ—¶çš„å†…å­˜é‡æ’ã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://preshing.com/20120625/memory-ordering-at-compile-time/ æ‚¨å†™çš„C/C++æºç ä¸å…¶å®é™…åœ¨CPUä¸Šæ‰§è¡Œçš„å†…å­˜æ“ä½œé¡ºåºå¯èƒ½ä¸åŒï¼Œå†…å­˜æ“ä½œå¯èƒ½ä¼šæ ¹æ®æŸäº›è§„åˆ™é‡æ–°æ’åºã€‚ä¸ºäº†è®©ä»£ç è¿è¡Œå¾—æ›´å¿«ï¼Œç¼–è¯‘å™¨(åœ¨ç¼–è¯‘æ—¶)å’Œå¤„ç†å™¨(åœ¨è¿è¡Œæ—¶)éƒ½ä¼šå¯¹å†…å­˜é¡ºåºè¿›è¡Œæ›´æ”¹ã€‚ç¼–è¯‘å™¨å¼€å‘äººå‘˜å’ŒCPUä¾›åº”å•†æ™®ééµå¾ªçš„å†…å­˜é‡æ’çš„åŸºæœ¬è§„åˆ™å¯ä»¥è¡¨è¿°ä¸ºï¼š Thou shalt not modify the behavior of a single-threaded program. ä¾æ®å•çº¿ç¨‹ç¨‹åºè¡Œä¸ºä¸å¯ä¿®æ”¹çš„åŸåˆ™ï¼Œç¨‹åºå‘˜åœ¨å†™å•çº¿ç¨‹çš„ä»£ç æ—¶åŸºæœ¬ä¸ä¼šæ³¨æ„åˆ°å†…å­˜é‡æ’ã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå®ƒä¹Ÿç»å¸¸è¢«å¿½ç•¥ï¼Œå› ä¸ºäº’æ–¥(mutexes)ã€ä¿¡å·é‡(semaphores)å’Œäº‹ä»¶(events)éƒ½æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å®ƒä»¬çš„è°ƒç”¨ä½ç½®é™„è¿‘è¿›è¡Œå†…å­˜é‡æ’è€Œè®¾è®¡çš„ã€‚åªæœ‰åœ¨ä½¿ç”¨æ— é”æŠ€æœ¯æ—¶ï¼ˆçº¿ç¨‹ä¹‹é—´å…±äº«å†…å­˜è€Œæ²¡æœ‰ä»»ä½•ç›¸äº’æ’æ–¥çš„æƒ…å†µï¼‰ï¼Œå†…å­˜é‡æ’çš„æ•ˆæœæ‰èƒ½å¤Ÿè¢«æ˜æ˜¾åœ°è§‚å¯Ÿåˆ°ã€‚ æ³¨æ„ï¼Œåœ¨ä¸ºå¤šæ ¸å¹³å°ç¼–å†™æ— é”ä»£ç æ—¶ï¼Œæœ‰äº›æƒ…å†µå¯ä»¥é¿å…å†…å­˜é‡æ’çš„éº»çƒ¦ï¼Œæ­£å¦‚æˆ‘åœ¨introduction to lock-free programmingä¸­æåˆ°çš„é‚£æ ·ï¼Œå¯ä»¥åˆ©ç”¨é¡ºåºä¸€è‡´(sequentially consistent)çš„ç±»å‹ï¼Œä¾‹å¦‚Javaçš„volatileå˜é‡æˆ–C ++ 11åŸå­å˜é‡ï¼Œè¿™å¯èƒ½ä¼šç‰ºç‰²ä¸€ç‚¹æ€§èƒ½ã€‚æœ¬æ–‡æˆ‘ä¸ä¼šç»†ç©¶è¿™äº›æƒ…å†µï¼Œæˆ‘å°†é‡ç‚¹è®¨è®ºç¼–è¯‘å™¨å¯¹å¸¸è§„ã€éé¡ºåºä¸€è‡´æ€§ç±»å‹çš„å†…å­˜æ’åºçš„å½±å“ã€‚ Compiler Instruction Reorderingå¦‚æ‚¨æ‰€çŸ¥ï¼Œç¼–è¯‘å™¨çš„å·¥ä½œæ˜¯å°†äººç±»å¯è¯»çš„æºä»£ç è½¬æ¢ä¸ºCPUå¯è¯»çš„æœºå™¨ä»£ç ã€‚åœ¨æ­¤è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æœ‰å¾ˆå¤§çš„è‡ªç”±åº¦ã€‚ç¼–è¯‘å™¨åœ¨ä¿è¯å•çº¿ç¨‹è¡Œä¸ºä¸å˜çš„æƒ…å†µä¸‹æœ‰æŒ‡ä»¤é‡æ’çš„è‡ªç”±ã€‚æŒ‡ä»¤é‡æ’é€šå¸¸åœ¨å¯ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–æ—¶å‘ç”Ÿï¼Œè€ƒè™‘ä»¥ä¸‹å‡½æ•°ï¼š 1234567int A, B;void foo()&#123; A = B + 1; B = 0;&#125; ä½¿ç”¨GCC 4.6.1åœ¨æ²¡æœ‰ç¼–è¯‘ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä¼šç”Ÿæˆå¦‚ä¸‹æœºå™¨ä»£ç ï¼š 12345678$ gcc -S -masm=intel foo.c$ cat foo.s ... mov eax, DWORD PTR _B (redo this at home...) add eax, 1 mov DWORD PTR _A, eax mov DWORD PTR _B, 0 ... å¯¹å…¨å±€å˜é‡Bçš„å†…å­˜å­˜å‚¨å‘ç”Ÿåœ¨å¯¹Açš„å†…å­˜å­˜å‚¨ä¹‹åï¼Œå’Œæºç ä¸­ä¸€æ ·ã€‚-O2ç¼–è¯‘ä¼˜åŒ–ä¹‹åçš„æœºå™¨ä»£ç å¦‚ä¸‹ï¼š 12345678$ gcc -O2 -S -masm=intel foo.c$ cat foo.s ... mov eax, DWORD PTR B mov DWORD PTR B, 0 add eax, 1 mov DWORD PTR A, eax ... è¿™ä¸€æ¬¡ï¼Œç¼–è¯‘å™¨å°†å…¨å±€å˜é‡Bçš„å­˜å‚¨æ”¾åˆ°å…¨å±€å˜é‡Açš„å­˜å‚¨ä¹‹å‰ã€‚è¿™å¹¶æœªæ‰“ç ´å†…å­˜æ’åºçš„åŸºæœ¬è§„åˆ™ï¼Œå•çº¿ç¨‹æ°¸è¿œæ„ŸçŸ¥ä¸åˆ°å·®åˆ«ã€‚ ç„¶è€Œï¼Œåœ¨ç¼–å†™æ— é”ä»£ç æ—¶ï¼Œæ­¤ç±»ç¼–è¯‘å™¨é‡æ–°æ’åºå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚ä¸‹é¢çš„ä»£ç æ˜¯ä¸€ä¸ªç»å¸¸è¢«å¼•ç”¨çš„ç¤ºä¾‹ï¼Œå…¨å±€å˜é‡IsPublishedç”¨äºæŒ‡ç¤ºå…¨å±€å˜é‡Valueçš„ä¿®æ”¹å·²ç»å®Œæˆï¼š 12345678int Value;int IsPublished = 0; void sendValue(int x)&#123; Value = x; IsPublished = 1;&#125; æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœç¼–è¯‘å™¨å°†IsPublishedçš„å†…å­˜å†™é‡æ’åˆ°Valueå†…å­˜å†™ä¹‹å‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå³ä½¿æ˜¯åœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œä¹Ÿä¼šé‡åˆ°é—®é¢˜:ä¸€ä¸ªçº¿ç¨‹çš„ä¸¤æ¬¡å†…å­˜å†™æ“ä½œå¯èƒ½ä¼šè¢«OSæŠ¢å ï¼Œè®©å…¶ä»–çº¿ç¨‹ç›¸ä¿¡Valueå·²ç»æ›´æ–°ï¼Œè€Œå®é™…å´æ²¡æœ‰ã€‚å½“ç„¶ï¼Œç¼–è¯‘å™¨å¯èƒ½æœªå¯¹è¿™äº›æ“ä½œè¿›è¡Œé‡æ–°æ’åºï¼Œç”Ÿæˆçš„æœºå™¨ä»£ç ä½œä¸ºæ— é”æ“ä½œå¯ä»¥åœ¨ä»»ä½•å¼ºå†…å­˜æ¨¡å‹(strong memory model)çš„å¤šæ ¸CPUï¼ˆä¾‹å¦‚x86/64ï¼‰ä¸Šæˆ–åœ¨å•å¤„ç†å™¨ç¯å¢ƒä¸­æ­£å¸¸è¿è¡Œã€‚å¦‚æœæ²¡æœ‰å‘ç”Ÿå†…å­˜é‡æ’ï¼Œæˆ‘ä»¬ä¼šå¾ˆå¹¸è¿ã€‚ç„¶è€Œï¼Œæ›´å¥½çš„åšæ³•æ˜¯è®¤è¯†åˆ°å…±äº«å˜é‡å­˜åœ¨å†…å­˜é‡æ–°æ’åºçš„å¯èƒ½æ€§ï¼Œå¹¶ç¡®ä¿æ­£ç¡®çš„æ‰§è¡Œé¡ºåºã€‚ Explicit Compiler Barriersé˜²æ­¢ç¼–è¯‘å™¨å†…å­˜é‡æ’æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç¼–è¯‘å™¨å±éšœ(compiler barrier)æŒ‡ä»¤ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»æåŠç¼–è¯‘å™¨å±éšœã€‚ä¸‹é¢æ˜¯GCCçš„å®Œå…¨ç¼–è¯‘å™¨å±éšœ(full compiler barrier)ã€‚Microsoft C++çš„_ReadWriteBarrierå…·æœ‰ç›¸åŒåŠŸèƒ½ã€‚ 12345678int A, B;void foo()&#123; A = B + 1; asm volatile(&quot;&quot; ::: &quot;memory&quot;); B = 0;&#125; åŠ ä¸Šå®Œå…¨ç¼–è¯‘å™¨å±éšœå¹¶ä¿æŒç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œè§‚å¯Ÿå†…å­˜å­˜å‚¨æŒ‡ä»¤å¹¶æœªé‡æ’ï¼š 12345678$ gcc -O2 -S -masm=intel foo.c$ cat foo.s ... mov eax, DWORD PTR _B add eax, 1 mov DWORD PTR _A, eax mov DWORD PTR _B, 0 ... åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¿è¯sendMessageç¤ºä¾‹åœ¨å•å¤„ç†å™¨ç³»ç»Ÿæ•°æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡³å°‘å¿…é¡»åœ¨æ­¤å¤„å¼•å…¥ç¼–è¯‘å™¨å±éšœã€‚ä¸ä»…å‘é€æ“ä½œéœ€è¦ç¼–è¯‘å™¨å±éšœé˜²æ­¢å†…å­˜å†™æ“ä½œé‡æ’ï¼Œæ¥æ”¶æ–¹ä¹Ÿéœ€è¦åœ¨å†…å­˜è¯»æ“ä½œä¹‹é—´åŠ å…¥å±éšœã€‚ 123456789101112131415161718192021#define COMPILER_BARRIER() asm volatile(&quot;&quot; ::: &quot;memory&quot;)int Value;int IsPublished = 0;void sendValue(int x)&#123; Value = x; COMPILER_BARRIER(); // prevent reordering of stores IsPublished = 1;&#125;int tryRecvValue()&#123; if (IsPublished) &#123; COMPILER_BARRIER(); // prevent reordering of loads return Value; &#125; return -1; // or some other value to mean not yet received&#125; å¦‚å‰æ‰€è¿°ï¼Œç¼–è¯‘å™¨å±éšœè¶³ä»¥é˜²æ­¢å•å¤„ç†å™¨ç³»ç»Ÿä¸Šçš„å†…å­˜é‡æ’ã€‚å¦‚ä»Šåœ¨å¤šæ ¸è®¡ç®—å·²ç»æˆä¸ºå¸¸æ€ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ç¡®ä¿æˆ‘ä»¬çš„æŒ‡ä»¤äº¤äº’åœ¨ä»»ä½•æ¶æ„çš„å¤šå¤„ç†å™¨ç¯å¢ƒä¸­éƒ½ä»¥æœŸæœ›çš„é¡ºåºå‘ç”Ÿï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å±éšœæ˜¯ä¸å¤Ÿçš„ã€‚æˆ‘ä»¬éœ€è¦å‘é€CPU fenceæŒ‡ä»¤ï¼Œæˆ–æ‰§è¡Œä»»ä½•åœ¨è¿è¡Œæ—¶å……å½“å†…å­˜å±éšœçš„æ“ä½œã€‚æˆ‘å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä¼šæ›´å¤šåœ°ä»‹ç»è¿™å—å†…å®¹ï¼Œå†…å­˜å±éšœå°±åƒæºä»£ç ç‰ˆæœ¬æ§åˆ¶æ“ä½œä¸€æ ·ã€‚ Linuxå†…æ ¸ä»¥å®çš„å½¢å¼æä¾›äº†å¤šä¸ªCPU fenceæŒ‡ä»¤ï¼Œä¾‹å¦‚smb_rmbã€‚è¿™äº›å®åœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸­ä¼šè¢«ç¼–è¯‘æˆç®€å•çš„ç¼–è¯‘å™¨å±éšœã€‚ Implied Compiler Barriersè¿˜æœ‰å…¶ä»–æ–¹æ³•é˜²æ­¢ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ã€‚åˆšåˆšæåŠçš„CPU fenceæŒ‡ä»¤ä¹Ÿå¯ä»¥å……å½“ç¼–è¯‘å™¨å±éšœã€‚è¿™æ˜¯PowerPCçš„CPU fenceæŒ‡ä»¤ï¼Œåœ¨GCCä¸­å®šä¹‰ä¸ºå®ï¼š 1#define RELEASE_FENCE() asm volatile(&quot;lwsync&quot; ::: &quot;memory&quot;) åœ¨ä»£ç ä¸­åŠ å…¥RELEASE_FENCEä¸ä»…å¯ä»¥é˜²æ­¢æŸäº›ç±»å‹çš„å¤„ç†å™¨é‡æ’ï¼Œè€Œä¸”èƒ½å¤Ÿç¡®ä¿é˜»æ­¢ç¼–è¯‘å™¨é‡æ’ã€‚åœ¨sendValueå‡½æ•°ä¸­ä½¿ç”¨RELEASE_FENCEå¯ä»¥ç¡®ä¿å…¶åœ¨å¤šå¤„ç†å™¨ç¯å¢ƒä¸­å®‰å…¨ã€‚ 123456void sendValue(int x)&#123; Value = x; RELEASE_FENCE(); IsPublished = 1;&#125; åœ¨C++11åŸå­æ ‡å‡†åº“ä¸­ï¼Œæ¯ä¸ªnon-releaxedçš„åŸå­æ“ä½œéƒ½å¯ä»¥ä½œä¸ºç¼–è¯‘å™¨å±éšœï¼š 123456789int Value;std::atomic&lt;int&gt; IsPublished(0);void sendValue(int x)&#123; Value = x; // &lt;-- reordering is prevented here! IsPublished.store(1, std::memory_order_release);&#125; å¦‚æ‚¨æ‰€æ–™ï¼Œæ¯ä¸ªåŒ…å«ç¼–è¯‘å™¨å±éšœçš„å‡½æ•°(å³ä½¿æ˜¯å†…è”å‡½æ•°)ä¹Ÿå¯å……å½“ç¼–è¯‘å™¨å±éšœã€‚ï¼ˆä½†æ˜¯ï¼ŒMicrosoftæ–‡æ¡£è¡¨æ˜ï¼Œæ—©æœŸç‰ˆæœ¬çš„Visual C++ç¼–è¯‘å™¨ä¸­å¯èƒ½ä¸æ˜¯è¿™ç§æƒ…å†µã€‚Tskï¼Œtskï¼ï¼‰ 123456void doSomeStuff(Foo* foo)&#123; foo-&gt;bar = 5; sendValue(123); // prevents reordering of neighboring assignments foo-&gt;bar2 = foo-&gt;bar;&#125; äº‹å®ä¸Šï¼Œä¸è®ºå‡½æ•°ä¸­æ˜¯å¦åŒ…å«ç¼–è¯‘å™¨å±éšœæŒ‡ä»¤ï¼Œå¤§å¤šæ•°å‡½æ•°è°ƒç”¨å¯ä»¥ä½œä¸ºç¼–è¯‘å™¨å±éšœã€‚ä¹Ÿæœ‰å‡½æ•°è°ƒç”¨ä¸ä¼šä½œä¸ºç¼–è¯‘å™¨å±éšœï¼šå†…è”å‡½æ•°ã€ä½¿ç”¨pureå±æ€§å£°æ˜çš„å‡½æ•°ä»¥åŠé“¾æ¥æ—¶ç”Ÿæˆçš„ä»£ç ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨ç”šè‡³æ¯”ç¼–è¯‘å™¨å±éšœæ›´ä¸ºå¼ºå¤§ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¸çŸ¥é“å¤–éƒ¨å‡½æ•°çš„å‰¯ä½œç”¨ã€‚ä»”ç»†æƒ³æƒ³ï¼Œè¿˜æ˜¯å¾ˆæœ‰é“ç†ã€‚å‡è®¾ä¸Šé¢ä»£ç ç‰‡æ®µä¸­sendValueçš„å®ç°åœ¨å¤–éƒ¨åº“ä¸­ã€‚ç¼–è¯‘å™¨å¦‚ä½•çŸ¥é“sendValueä¸ä¾èµ–äºfoo-&gt;barçš„å€¼?å®ƒå¦‚ä½•çŸ¥é“sendValueå°†ä¸ä¼šä¿®æ”¹foo-&gt;barçš„å†…å­˜?ç¼–è¯‘å™¨æ— æ³•åšå‡ºæ­¤ç±»å‡è®¾ï¼Œå› æ­¤ï¼Œä¸ºäº†éµå®ˆå†…å­˜æ’åºçš„åŸºæœ¬è§„åˆ™ï¼Œå®ƒä¸èƒ½å¯¹sendValueå‘¨å›´çš„ä»»ä½•å†…å­˜æ“ä½œé‡æ’ã€‚åŒæ ·ï¼Œå³ä¾¿å¼€å¯äº†ç¼–è¯‘ä¼˜åŒ–ï¼ŒsendValueå‡½æ•°è°ƒç”¨å®Œæˆä¹‹åï¼Œä¸èƒ½å‡è®¾foo-&gt;barçš„å€¼ä»ç„¶ä¸º5ï¼Œéœ€è¦ä»å†…å­˜ä¸­è¯»å–foo-&gt;barçš„å€¼ã€‚ 12345678910$ gcc -O2 -S -masm=intel dosomestuff.c$ cat dosomestuff.s ... mov ebx, DWORD PTR [esp+32] mov DWORD PTR [ebx], 5 // Store 5 to foo-&gt;bar mov DWORD PTR [esp], 123 call sendValue // Call sendValue mov eax, DWORD PTR [ebx] // Load fresh value from foo-&gt;bar mov DWORD PTR [ebx+4], eax ... å¦‚æ‚¨æ‰€è§ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’æ˜¯è¢«ç¦æ­¢çš„ï¼Œç”šè‡³ç¼–è¯‘å™¨éœ€è¦ä»å†…å­˜é‡æ–°åŠ è½½æŸäº›å€¼ã€‚æˆ‘æƒ³ï¼Œæ­£æ˜¯å› ä¸ºè¿™äº›éšè—è§„åˆ™å¯¼è‡´äººä»¬é•¿æœŸä»¥æ¥ä¸€ç›´è®¤ä¸ºvolatileæ•°æ®ç±»å‹åœ¨æ­£ç¡®ç¼–å†™çš„å¤šçº¿ç¨‹ä»£ç ä¸­ä¸æ˜¯å¿…éœ€çš„ã€‚ Out-Of-Thin-Air StoresæŒ‡ä»¤é‡æ’ä¼šè®©æ— é”ç¼–ç¨‹å˜å¾—æ£˜æ‰‹å—?åœ¨c++ 11æ ‡å‡†åŒ–ä¹‹å‰ï¼ŒæŠ€æœ¯ä¸Šï¼Œæ²¡æœ‰ä»»ä½•è§„åˆ™å¯ä»¥é˜»æ­¢ç¼–è¯‘å™¨ä½¿ç”¨æ›´ç³Ÿç³•çš„æŠ€å·§ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä»¥å‰æ²¡æœ‰å¯¹å…±äº«å†…å­˜å†™çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°å¼•å…¥å…±äº«å†…å­˜å†™æ“ä½œã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­åœ¨Hans Boehmåœ¨å¤šç¯‡æ–‡ç« ä¸­å‡æœ‰æåŠï¼š 1234567int A, B;void foo()&#123; if (A) B++;&#125; å°½ç®¡å®é™…ä¸Šä¸å¤ªå¯èƒ½å†™è¿™æ ·çš„ä»£ç ï¼Œä½†æ˜¯æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢ç¼–è¯‘å™¨åœ¨æ£€æŸ¥Aä¹‹å‰ï¼Œå°†Bæå‡åˆ°å¯„å­˜å™¨ï¼Œä»è€Œä¼šæœ‰ä»¥ä¸‹çš„ç­‰æ•ˆå†…å®¹ï¼š 1234567void foo()&#123; register int r = B; // Promote B to a register before checking A. if (A) r++; B = r; // Surprise! A new memory store where there previously was none.&#125; ä¸Šè¿°ä»£ç ä»ç„¶éµå®ˆäº†æœ€åŸºæœ¬çš„å†…å­˜æ’åºè§„åˆ™ã€‚å•çº¿ç¨‹åº”ç”¨ç¨‹åºå¯¹â€œå°†Bæå‡åˆ°å¯„å­˜å™¨â€æ¯«æ— æ„ŸçŸ¥ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œfooå‡½æ•°ä¼šæ¸…é™¤åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰€åšçš„ä»»ä½•ä¿®æ”¹â€“å³ä¾¿æ˜¯Aä¸º0çš„æƒ…å†µä¸‹ã€‚fooå‡½æ•°çš„æœ¬æ„å¹¶éå¦‚æ­¤ã€‚å°½ç®¡æˆ‘ä»¬æ•°åå¹´æ¥ä¸€ç›´åœ¨ä½¿ç”¨C/++å†™å¤šçº¿ç¨‹å’Œæ— é”ä»£ç ï¼Œå› ä¸ºè¿™ç§æ™¦æ¶©ã€æŠ€æœ¯ä¸Šçš„ä¸å¯èƒ½æ€§è®©äººä»¬ä¸€ç›´è¯´C++ä¸æ”¯æŒçº¿ç¨‹ã€‚ æˆ‘ä¸çŸ¥é“æ˜¯å¦æœ‰äººåœ¨å®è·µä¸­æˆä¸ºè¿™ç§â€œout-of-thin-airâ€çš„å—å®³è€…ã€‚æˆ–è®¸æ˜¯æˆ‘ä»¬é€šå¸¸ç¼–å†™çš„æ— é”ä»£ç ç±»å‹æ²¡æœ‰è¿™æ ·çš„ä¼˜åŒ–æ¨¡å¼ã€‚å¦‚æœæˆ‘é‡åˆ°äº†è¿™ç§ç¼–è¯‘å™¨è½¬æ¢ï¼Œæˆ‘æƒ³æˆ‘å¾—å¥½å¥½è°ƒæ•™ä¸‹æˆ‘çš„ç¼–è¯‘å™¨ã€‚æ— è®ºå¦‚ä½•ï¼Œåœ¨ä¼šå¼•å…¥æ•°æ®ç«äº‰çš„æƒ…å†µä¸‹ï¼Œæ–°çš„C++11æ ‡å‡†æ˜ç¡®ç¦æ­¢ç¼–è¯‘å™¨çš„æ­¤ç±»è¡Œä¸ºã€‚C++11å·¥ä½œè‰æ¡ˆçš„Â§1.10.22ä¸­å¯ä»¥æ‰¾åˆ°ï¼š Compiler transformations that introduce assignments to a potentially shared memory location that would not be modified by the abstract machine are generally precluded by this standard. Why Compiler Reordering?æ­£å¦‚æˆ‘åœ¨æ–‡ç« å¼€å¤´æåˆ°çš„ï¼Œç¼–è¯‘å™¨ä¿®æ”¹å†…å­˜äº¤äº’é¡ºåºçš„åŸå› ä¸å¤„ç†å™¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„åŸå› ç›¸åŒã€‚è¿™ç§ä¼˜åŒ–æ˜¯ç°ä»£CPUå¤æ‚æ€§çš„ç›´æ¥ç»“æœã€‚æˆ‘æœ‰ä¸ªå¤§èƒ†çš„æ€€ç–‘ï¼šåœ¨80å¹´ä»£æ—©æœŸï¼Œå½“cpuæœ€å¤šåªæœ‰å‡ åä¸‡ä¸ªæ™¶ä½“ç®¡çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨åšäº†å¤§é‡çš„æŒ‡ä»¤é‡æ’ã€‚ä½†ä»é‚£ä»¥åï¼Œæ‘©å°”å®šå¾‹ä¸ºCPUè®¾è®¡è€…æä¾›äº†å¤§çº¦10000å€æ•°é‡çš„æ™¶ä½“ç®¡ï¼Œè€Œè¿™äº›æ™¶ä½“ç®¡è¢«èŠ±è´¹åœ¨è¯¸å¦‚æµæ°´çº¿ã€å†…å­˜é¢„å–ã€ILPä»¥åŠæœ€è¿‘çš„å¤šæ ¸ç­‰æŠ€å·§ä¸Šã€‚ç”±äºè¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°æŸäº›æ¶æ„ä¸­ç¨‹åºæŒ‡ä»¤çš„é¡ºåºä¼šå¯¹æ€§èƒ½äº§ç”Ÿæ˜¾è‘—çš„å½±å“ã€‚1993å¹´Intelå‘å¸ƒçš„ç¬¬ä¸€æ¬¾å¥”è…¾å¤„ç†å™¨ï¼Œå¸¦æœ‰æ‰€è°“çš„Uå’Œvç®¡é“ï¼Œæ˜¯æˆ‘è®°å¾—çš„ç¬¬ä¸€ä¸ªæµæ°´çº¿å’ŒæŒ‡ä»¤é¡ºåºçš„é‡è¦æ€§çš„å¤„ç†å™¨ã€‚ç„¶è€Œï¼Œæœ€è¿‘ï¼Œæˆ‘åœ¨Visual Studioä¸­æ‰§è¡Œx86åæ±‡ç¼–æ—¶ï¼Œæˆ‘æƒŠè®¶åœ°å‘ç°æŒ‡ä»¤çš„é‡æ’æ˜¯å¦‚æ­¤ä¹‹å°‘ã€‚å¦ä¸€æ–¹é¢ï¼Œæˆ‘åœ¨Playstation 3ä¸Šè¿›è¡ŒSPUæ‹†è§£çš„æ—¶å€™ï¼Œå‘ç°ç¼–è¯‘å™¨çœŸçš„å¾ˆå‰å®³ã€‚è¿™äº›åªæ˜¯è½¶äº‹ã€‚å®ƒå¯èƒ½æ— æ³•åæ˜ å…¶ä»–äººçš„ç»éªŒï¼Œä¹Ÿä¸åº”è¯¥å½±å“æˆ‘ä»¬åœ¨æ— é”ä»£ç ä¸­å¼ºåˆ¶æ‰§è¡Œå†…å­˜æ’åºçš„æ–¹å¼ã€‚","categories":[{"name":"translation","slug":"translation","permalink":"https://system-thoughts.github.io/categories/translation/"},{"name":"lock-free","slug":"translation/lock-free","permalink":"https://system-thoughts.github.io/categories/translation/lock-free/"}],"tags":[{"name":"lock-free","slug":"lock-free","permalink":"https://system-thoughts.github.io/tags/lock-free/"},{"name":"memory-reordering","slug":"memory-reordering","permalink":"https://system-thoughts.github.io/tags/memory-reordering/"}]},{"title":"ã€è¯‘æ–‡ã€‘å½“åœºæŠ“è·å†…å­˜é‡æ’","slug":"å½“åœºæŠ“è·å†…å­˜é‡æ’","date":"2021-03-22T03:29:29.000Z","updated":"2023-01-18T05:32:06.168Z","comments":true,"path":"posts/8d2fe256/","link":"","permalink":"https://system-thoughts.github.io/posts/8d2fe256/","excerpt":"","text":"åŸæ–‡é“¾æ¥ï¼šhttps://preshing.com/20120515/memory-reordering-caught-in-the-act/ ç”¨C/C++ç¼–å†™æ— é”ä»£ç æ—¶ï¼Œå¿…é¡»ç‰¹åˆ«æ³¨æ„å¼ºåˆ¶æ‰§è¡Œæ­£ç¡®çš„å†…å­˜é¡ºåºã€‚å¦åˆ™ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä»¤äººæƒŠè®¶çš„äº‹æƒ…ã€‚Intel SDMå·3ç¬¬8.2.3èŠ‚ä¸¾äº†å‡ ä¸ªä¾‹å­ã€‚è¿™æ˜¯æœ€ç®€å•çš„ä¾‹å­ä¹‹ä¸€ã€‚å‡è®¾æ‚¨åœ¨å†…å­˜ä¸­ä¿å­˜äº†ä¸¤ä¸ªæ•´æ•°Xå’ŒYï¼Œåˆå§‹å€¼éƒ½ä¸º0ã€‚ä¸¤ä¸ªå¹¶è¡Œè¿è¡Œçš„å¤„ç†å™¨æ‰§è¡Œä»¥ä¸‹æœºå™¨ä»£ç ï¼šè¿™æ˜¯ä¸€ä¸ªç»ä½³çš„ä¾‹å­è¯´æ˜CPUæ’åº(CPU ordering)ã€‚æ¯ä¸ªå¤„ç†å™¨å°†1å­˜å‚¨åˆ°å…¶ä¸­ä¸€ä¸ªæ•´æ•°ä¸­ï¼Œç„¶åå°†å¦å¤–ä¸€ä¸ªæ•´æ•°åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚å¾ˆè‡ªç„¶åœ°æˆ‘ä»¬æœŸæœ›:æ— è®ºå“ªä¸ªå¤„ç†å™¨å…ˆå°†1å†™å…¥å†…å­˜ï¼Œå¦ä¸€ä¸ªå¤„ç†å™¨å¯ä»¥å°†è¯¥å€¼è¯»å›æ¥ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æœ€ç»ˆåº”è¯¥å¾—åˆ°r1 = 1, r2 = 1ï¼Œæˆ–è€…ä¸¤è€…éƒ½æœ‰ã€‚ç„¶è€ŒIntelè§„èŒƒè¡¨æ˜r1å’Œr2éƒ½ç­‰äº0ä¹Ÿæ˜¯ä¸€ç§åˆæ³•çš„ç»“æœã€‚Intel x86/64å¤„ç†å™¨ä¸å¤§å¤šæ•°å¤„ç†å™¨ç³»åˆ—ä¸€æ ·ï¼Œå…è®¸æ ¹æ®æŸäº›è§„åˆ™å¯¹å†…å­˜æ“ä½œçš„æœºå™¨æŒ‡ä»¤è¿›è¡Œé‡æ–°æ’åºï¼Œåªè¦ä¸æ”¹å˜å•ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœå³å¯ã€‚å…·ä½“åœ°è¯´ï¼Œå…è®¸æ¯ä¸ªå¤„ç†å™¨å°†å…¶ä¸Šçš„å†…å­˜å†™æ“ä½œ(store)æ¨è¿Ÿ(delay)åˆ°ä¸åŒä½ç½®çš„å†…å­˜åŠ è½½(load)æ“ä½œä¹‹åã€‚æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„æŒ‡ä»¤å¯ä»¥é‡æ’å¦‚ä¸‹ï¼š Letâ€™s Make It Happençœ¼è§ä¸ºå®ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªå°ç¤ºä¾‹ç¨‹åºæ¥å±•ç¤ºè¿™ç§é‡æ–°æ’åºã€‚ä½ å¯ä»¥åœ¨æ­¤ä¸‹è½½æºç ã€‚ç¤ºä¾‹ä»£ç åŒ…å«Win32ç‰ˆæœ¬å’ŒPOSIXç‰ˆæœ¬ã€‚å®ƒäº§ç”Ÿä¸¤ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå®ƒä»¬æ— é™æœŸåœ°é‡å¤å›¾ä¸­çš„ä¾‹å­ï¼Œè€Œä¸»çº¿ç¨‹åˆ™åŒæ­¥å®ƒä»¬çš„å·¥ä½œå¹¶æ£€æŸ¥æ¯ä¸ªç»“æœã€‚ä¸‹é¢æ˜¯ç¬¬ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„æºä»£ç ã€‚X, Y, r1å’Œr2éƒ½æ˜¯å…¨å±€å˜é‡ï¼ŒPOSIXä¿¡å·é‡ç”¨äºåè°ƒæ¯ä¸ªå¾ªç¯çš„å¼€å§‹å’Œç»“æŸä»¥åŠä¸»çº¿ç¨‹çš„æ£€æŸ¥å·¥ä½œã€‚ 1234567891011121314151617181920212223sem_t beginSema1;sem_t endSema;int X, Y;int r1, r2;void *thread1Func(void *param)&#123; MersenneTwister random(1); // Initialize random number generator for (;;) // Loop indefinitely &#123; sem_wait(&amp;beginSema1); // Wait for signal from main thread while (random.integer() % 8 != 0) &#123;&#125; // Add a short, random delay // ----- THE TRANSACTION! ----- X = 1; asm volatile(&quot;&quot; ::: &quot;memory&quot;); // Prevent compiler reordering r1 = Y; sem_post(&amp;endSema); // Notify transaction complete &#125; return NULL; // Never returns&#125;; åœ¨æ¯ä¸ªäº‹åŠ¡ä¹‹å‰æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„éšæœºå»¶è¿Ÿï¼Œä»¥é”™å¼€çº¿ç¨‹äº‹åŠ¡å¼€å§‹æ‰§è¡Œçš„æ—¶é—´ã€‚æˆ‘ä»¬å°½é‡è®©ä¸¤ä¸ªçº¿ç¨‹çš„æŒ‡ä»¤æ‰§è¡Œé‡å ï¼Œéšæœºå»¶è¿Ÿé€šè¿‡MersenneTwisterå®ç°ï¼Œæˆ‘ä»¬åœ¨æµ‹é‡é”ç«äº‰ä»¥åŠéªŒè¯é€’å½’äº’æ–¥é‡æ—¶ç”¨åˆ°è¿‡ã€‚ä¸è¦è¢«ä»£ç ä¸­çš„asm volatileè¡Œå“åˆ°ã€‚è¿™åªæ˜¯ä¸€ä¸ªä¼ªæŒ‡ä»¤ï¼Œå‘Šè¯‰GCCç¼–è¯‘å™¨åœ¨ç”Ÿæˆæœºå™¨ä»£ç æ—¶ä¸è¦é‡æ’å­˜å‚¨å’ŒåŠ è½½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ±‡ç¼–ä»£ç éªŒè¯ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œå­˜å‚¨å’ŒåŠ è½½æŒ‰ç…§é¢„æœŸçš„é¡ºåºè¿›è¡Œã€‚éšåçš„æŒ‡ä»¤å°†å¯„å­˜å™¨eaxä¸­çš„å†…å®¹å†™å…¥åˆ°å…¨å±€å˜é‡r1ä¸­ã€‚ 1234567$ gcc -O2 -c -S -masm=intel ordering.cpp$ cat ordering.s ... mov DWORD PTR _X, 1 mov eax, DWORD PTR _Y mov DWORD PTR _r1, eax ... ä¸»çº¿ç¨‹æºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚å®ƒæ‰§è¡Œæ‰€æœ‰ç®¡ç†å·¥ä½œã€‚åˆå§‹åŒ–åï¼Œå®ƒå°†æ— é™å¾ªç¯ï¼Œåœ¨æ¯æ¬¡è¿­ä»£å¯åŠ¨çº¿ç¨‹ä¹‹å‰ï¼Œå°†Xå’ŒYé‡ç½®ä¸º0ã€‚è¦ç‰¹åˆ«æ³¨æ„:æ‰€æœ‰å¯¹å…±äº«å†…å­˜çš„å†™æ“ä½œéƒ½åœ¨sem_postä¹‹å‰å‘ç”Ÿï¼Œè€Œæ‰€æœ‰å¯¹å…±äº«å†…å­˜çš„è¯»æ“ä½œéƒ½åœ¨sem_waitä¹‹åå‘ç”Ÿã€‚ ä¸ä¸»çº¿ç¨‹é€šä¿¡æ—¶ï¼Œå·¥ä½œçº¿ç¨‹èµ¢éµå¾ªç›¸åŒçš„è§„åˆ™ã€‚å¯ä»¥é€šè¿‡ä¿¡å·é‡è®©æˆ‘ä»¬åœ¨æ‰€æœ‰å¹³å°ä¸Šæ”¯æŒè·å–å’Œé‡Šæ”¾è¯­ä¹‰(acquire and release semantics)ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯X = 0å’ŒY = 0çš„åˆå§‹å€¼å°†å®Œå…¨ä¼ æ’­åˆ°å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”r1å’Œr2çš„ç»“æœå€¼ä¹Ÿä¼šä¼ æ’­åˆ°ä¸»çº¿ç¨‹ã€‚æ¢è¨€ä¹‹ï¼Œä¿¡å·é‡å¯ä»¥é˜²æ­¢å†…å­˜é‡æ’ï¼Œä½¿æˆ‘ä»¬å¯ä»¥å®Œå…¨ä¸“æ³¨äºå®éªŒæœ¬èº«ï¼ 12345678910111213141516171819202122232425262728293031323334int main()&#123; // Initialize the semaphores sem_init(&amp;beginSema1, 0, 0); sem_init(&amp;beginSema2, 0, 0); sem_init(&amp;endSema, 0, 0); // Spawn the threads pthread_t thread1, thread2; pthread_create(&amp;thread1, NULL, thread1Func, NULL); pthread_create(&amp;thread2, NULL, thread2Func, NULL); // Repeat the experiment ad infinitum int detected = 0; for (int iterations = 1; ; iterations++) &#123; // Reset X and Y X = 0; Y = 0; // Signal both threads sem_post(&amp;beginSema1); sem_post(&amp;beginSema2); // Wait for both threads sem_wait(&amp;endSema); sem_wait(&amp;endSema); // Check if there was a simultaneous reorder if (r1 == 0 &amp;&amp; r2 == 0) &#123; detected++; printf(&quot;%d reorders detected after %d iterations\\n&quot;, detected, iterations); &#125; &#125; return 0; // Never returns&#125; æˆ‘ä»¬çœ‹ä¸‹åœ¨CentOS8 AMD Ryzen 5 4600Hç¯å¢ƒä¸Šçš„è¿è¡Œç»“æœå‡è®¾æ‚¨ç°åœ¨æƒ³æ¶ˆé™¤å†…å­˜é‡æ’ã€‚è‡³å°‘æœ‰ä¸¤ä¸ªæ–¹æ³•å¯ä»¥åšåˆ°ï¼Œä¸€ç§æ–¹æ³•æ˜¯è®¾ç½®çº¿ç¨‹äº²å’Œæ€§ï¼Œä½¿å¾—ä¸¤ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ ¸ä¸Šå·¥ä½œã€‚æ²¡æœ‰ä¸€ç§å¯ç§»æ¤çš„æ–¹æ³•å¯ä»¥è®¾ç½®pthreadçš„äº²å’Œæ€§ï¼Œä½†åœ¨Linuxä¸Šå¯ä»¥å¦‚ä¸‹å®Œæˆï¼š 12345cpu_set_t cpus;CPU_ZERO(&amp;cpus);CPU_SET(0, &amp;cpus);pthread_setaffinity_np(thread1, sizeof(cpu_set_t), &amp;cpus);pthread_setaffinity_np(thread2, sizeof(cpu_set_t), &amp;cpus); æ›´æ”¹ä¹‹åï¼Œå†…å­˜é‡æ’æ¶ˆå¤±ã€‚å¤„ç†å™¨ä¸ä¼šçœ‹åˆ°è‡ªèº«çš„æ“ä½œä¹±åºï¼Œå³ä¾¿çº¿ç¨‹ä¼šåœ¨ä»»æ„æ—¶é—´è¢«æŠ¢å å’Œé‡æ–°è°ƒåº¦å›æ¥ã€‚å½“ç„¶å°†ä¸¤ä¸ªçº¿ç¨‹éƒ½ç»‘å®šåˆ°åŒä¸€CPU coreä¸Šä¼šå¯¼è‡´å…¶ä»–CPU coreæœªè¢«ä½¿ç”¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘åœ¨Playstation 3ä¸Šç¼–è¯‘å¹¶è¿è¡Œäº†è¿™ä¸ªç¤ºä¾‹ï¼Œæ²¡æœ‰æ£€æµ‹åˆ°å†…å­˜é‡æ’ã€‚è¿™è¡¨æ˜(ä½†æ²¡æœ‰è¯å®)PPUå†…éƒ¨çš„ä¸¤ä¸ªç¡¬ä»¶çº¿ç¨‹å¯ä»¥æœ‰æ•ˆåœ°å……å½“å•ä¸ªå¤„ç†å™¨æ”¯æŒéå¸¸ç»†ç²’åº¦çš„ç¡¬ä»¶è°ƒåº¦ã€‚ ä½¿ç”¨StoreLoadå±éšœé˜²æ­¢å†…å­˜é‡æ’æ­¤ç¤ºä¾‹ä¸­é˜²æ­¢å†…å­˜é‡æ’çš„å¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨ä¸¤æ¡æŒ‡ä»¤ä¹‹é—´å¼•å…¥CPUå±éšœ(CPU barrier)ã€‚æˆ‘ä»¬éœ€è¦StoreLoadå±éšœé˜²æ­¢å¯¹loadä¹‹åçš„storeè¿›è¡Œé‡æ’ã€‚åœ¨x86/64å¤„ç†å™¨ä¸Šï¼Œæ²¡æœ‰ç‰¹å®šçš„StoreLoadå±éšœæŒ‡ä»¤ï¼Œä½†æ˜¯æœ‰ä¸€äº›æŒ‡ä»¤å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œç”šè‡³æ›´å¤šã€‚mfenceæŒ‡ä»¤æ˜¯ä¸€ä¸ªå®Œå…¨çš„å†…å­˜å±éšœï¼Œå¯é˜²æ­¢ä»»ä½•ç±»å‹çš„å†…å­˜é‡æ–°æ’åºã€‚åœ¨GCCä¸­å¯ä»¥å®ç°å¦‚ä¸‹ï¼š 123456789101112for (;;) // Loop indefinitely&#123; sem_wait(&amp;beginSema1); // Wait for signal from main thread while (random.integer() % 8 != 0) &#123;&#125; // Add a short, random delay // ----- THE TRANSACTION! ----- X = 1; asm volatile(&quot;mfence&quot; ::: &quot;memory&quot;); // Prevent memory reordering r1 = Y; sem_post(&amp;endSema); // Notify transaction complete&#125; åŒæ ·åœ°ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹æ±‡ç¼–ä»£ç éªŒè¯å†…å­˜å±éšœçš„å­˜åœ¨ï¼š 123456...mov DWORD PTR _X, 1mfencemov eax, DWORD PTR _Ymov DWORD PTR _r1, eax... ç»è¿‡è¿™æ ·çš„ä¿®æ”¹ï¼Œå†…å­˜é‡æ’æ¶ˆå¤±äº†ï¼Œä¸”å…è®¸ä¸¤ä¸ªçº¿ç¨‹åœ¨ä¸åŒçš„CPUæ ¸ä¸Šè¿è¡Œã€‚ å…¶ä»–ç¡¬ä»¶å¹³å°ä¸Šçš„ç±»ä¼¼æŒ‡ä»¤mfenceå¹¶ä¸æ˜¯x86/64å¹³å°ä¸Šå”¯ä¸€çš„å®Œå…¨å†…å­˜å±éšœçš„æŒ‡ä»¤ã€‚ä»»ä½•é”å®šçš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚xchgï¼‰ä¹Ÿå°†å……å½“å®Œå…¨å†…å­˜å±éšœ-å‰ææ˜¯æ‚¨ä¸ä½¿ç”¨æœ¬ç¤ºä¾‹ä¸ä½¿ç”¨çš„SSEæŒ‡ä»¤æˆ–write-combined memoryã€‚åœ¨Visual Studio 2008ä¸­ï¼Œå½“æ‚¨ä½¿ç”¨MemoryBarrierå†…éƒ¨å‡½æ•°æ—¶ï¼ŒMicrosoft C ++ç¼–è¯‘å™¨ä¼šç”ŸæˆxchgæŒ‡ä»¤ã€‚mfenceæŒ‡ä»¤æ˜¯x86/64æ¶æ„ç‹¬æœ‰çš„ã€‚å¯ä»¥é€šè¿‡é¢„å¤„ç†å®ç¼–å†™æ›´å…·å¯ç§»æ¤æ€§çš„ä»£ç ã€‚Linuxå†…æ ¸å°†å…¶å°è£…åœ¨smp_mbå®ä¸­ï¼Œç›¸å…³çš„å®è¿˜æœ‰smp_rmbå’Œsmp_wmbï¼Œä»¥åŠå…¶ä»–æ¶æ„çš„å®ç°ã€‚ä¾‹å¦‚ï¼Œåœ¨PowerPCä¸Šï¼Œsmp_mbé€šè¿‡syncå®ç°ã€‚ ä¸åŒçš„CPUç³»åˆ—å…·æœ‰ç‰¹å®šçš„æŒ‡ä»¤å¼ºåˆ¶å†…å­˜æ’åºï¼Œæ¯ä¸ªç¼–è¯‘å™¨é€šè¿‡ä¸åŒçš„æŒ‡ä»¤å…¬å¼€å®ƒä»¬ï¼Œæ¯ä¸ªè·¨å¹³å°é¡¹ç›®éƒ½å®ç°è‡ªå·±çš„å¯ç§»æ¤å±‚â€¦â€¦è¿™äº›éƒ½ä¸èƒ½ç®€åŒ–æ— é”ç¼–ç¨‹ï¼è¿™ä¹Ÿæ˜¯æœ€è¿‘å¼•å…¥äº†C++ 11æ ‡å‡†åº“çš„éƒ¨åˆ†åŸå› ã€‚è¿™æ˜¯ä¸€ç§ä½¿äº‹æƒ…æ ‡å‡†åŒ–çš„å°è¯•ï¼Œç›®çš„æ˜¯ä½¿ç¼–å†™å¯ç§»æ¤çš„æ— é”ä»£ç æ›´åŠ å®¹æ˜“ã€‚","categories":[{"name":"translation","slug":"translation","permalink":"https://system-thoughts.github.io/categories/translation/"},{"name":"lock-free","slug":"translation/lock-free","permalink":"https://system-thoughts.github.io/categories/translation/lock-free/"}],"tags":[{"name":"lock-free","slug":"lock-free","permalink":"https://system-thoughts.github.io/tags/lock-free/"},{"name":"memory-reordering","slug":"memory-reordering","permalink":"https://system-thoughts.github.io/tags/memory-reordering/"}]},{"title":"ã€è¯‘æ–‡ã€‘Atomic vs. Non-Atomic Operations","slug":" Non-Atomic Operations","date":"2021-03-17T15:21:36.000Z","updated":"2023-01-18T05:32:06.128Z","comments":true,"path":"posts/cc000ee5/","link":"","permalink":"https://system-thoughts.github.io/posts/cc000ee5/","excerpt":"åœ¨é˜…è¯»å†…æ ¸æºç spin_lockçš„å®ç°æ—¶ï¼Œå‘ç°æœ‰å¤§é‡å…³äºlock-freeç¼–ç¨‹çš„çŸ¥è¯†ï¼Œå¦‚smp_cond_load_relaxedã€atomic_try_cmpxchg_acquireçš„å®ç°ã€‚å»¶å±•é˜…è¯»ï¼Œå‘ç°äº†è¿™äº›æ¶‰åŠåˆ°memory orderã€atomicã€cache consistencyç­‰çŸ¥è¯†ç‚¹ã€‚ç»è¿‡googleï¼Œæˆ‘å‘ç°Preshing on Programmingè¿™ä¸ªåšå®¢å¯¹lock-freeçš„æ–¹æ–¹é¢é¢ä»‹ç»çš„è¾ƒä¸ºè¯¦ç»†ï¼Œå¹¶ä¸”ä½œè€…å°†è¿™äº›çŸ¥è¯†ç‚¹åœ¨Mintomic(C/C++ lock-free programming API)é¡¹ç›®ä¸­ä»˜è¯¸å®è·µã€‚","text":"åœ¨é˜…è¯»å†…æ ¸æºç spin_lockçš„å®ç°æ—¶ï¼Œå‘ç°æœ‰å¤§é‡å…³äºlock-freeç¼–ç¨‹çš„çŸ¥è¯†ï¼Œå¦‚smp_cond_load_relaxedã€atomic_try_cmpxchg_acquireçš„å®ç°ã€‚å»¶å±•é˜…è¯»ï¼Œå‘ç°äº†è¿™äº›æ¶‰åŠåˆ°memory orderã€atomicã€cache consistencyç­‰çŸ¥è¯†ç‚¹ã€‚ç»è¿‡googleï¼Œæˆ‘å‘ç°Preshing on Programmingè¿™ä¸ªåšå®¢å¯¹lock-freeçš„æ–¹æ–¹é¢é¢ä»‹ç»çš„è¾ƒä¸ºè¯¦ç»†ï¼Œå¹¶ä¸”ä½œè€…å°†è¿™äº›çŸ¥è¯†ç‚¹åœ¨Mintomic(C/C++ lock-free programming API)é¡¹ç›®ä¸­ä»˜è¯¸å®è·µã€‚ åŸæ–‡é“¾æ¥ï¼š https://preshing.com/20130618/atomic-vs-non-atomic-operations/ ç½‘ç»œä¸Šå¯¹åŸå­æ“ä½œçš„ä»‹ç»è¿‡å¤šé›†ä¸­åœ¨åŸå­è¯»-ä¿®æ”¹-å†™ï¼ˆRMWï¼‰æ“ä½œä¸Šã€‚ç„¶è€Œï¼ŒåŸå­è¯»(atomic load)å’Œå†™(atomic store)åŒæ ·é‡è¦ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†åœ¨å¤„ç†å™¨çº§åˆ«å’ŒC/C++è¯­è¨€çº§åˆ«æ¯”è¾ƒåŸå­è¯»å’ŒåŸå­å†™ä»¥åŠå®ƒä»¬çš„éåŸå­æ“ä½œã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­æˆ‘ä»¬å°†é˜æ˜C++ 11çš„â€œæ•°æ®ç«äº‰â€(data race)çš„æ¦‚å¿µã€‚![](nonatomic.png atomic)åœ¨å…±äº«å†…å­˜ä¸Šçš„ä¸€ä¸ªæ“ä½œç›¸å¯¹äºå…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯å•æ­¥å®Œæˆçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå°±æ˜¯åŸå­çš„(atomic)ã€‚å½“åœ¨å…±äº«å˜é‡ä¸Šæ‰§è¡ŒåŸå­å­˜å‚¨(atomic store)æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è§‚å¯Ÿåˆ°ä¿®æ”¹åˆ°ä¸€åŠçš„çŠ¶æ€(modification half-complete)ã€‚å½“å¯¹å…±äº«å˜é‡æ‰§è¡ŒåŸå­åŠ è½½(atomic load)æ—¶ï¼Œå®ƒè¯»å–åœ¨æŸä¸ªæ—¶åˆ»å‡ºç°çš„å®Œæ•´å€¼(entire value)ã€‚éåŸå­åŠ è½½å’Œå­˜å‚¨ä¸èƒ½æä¾›è¿™äº›ä¿è¯ã€‚æ²¡æœ‰è¿™äº›ä¿è¯ï¼Œå°±ä¸å¯èƒ½è¿›è¡Œæ— é”ç¼–ç¨‹(lock-free programming)ï¼Œå› ä¸ºæ‚¨æ°¸è¿œä¸å¯èƒ½è®©ä¸åŒçš„çº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªå…±äº«å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒåˆ¶å®šä¸ºä¸€æ¡è§„åˆ™ï¼š ä»»ä½•æ—¶å€™ï¼Œä¸¤ä¸ªçº¿ç¨‹å¹¶å‘åœ°æ“ä½œä¸€ä¸ªå…±äº«å˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªæ“ä½œæ‰§è¡Œå†™æ“ä½œï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½å¿…é¡»ä½¿ç”¨åŸå­æ“ä½œã€‚ å¦‚æœè¿åäº†è¿™ä¸€è§„åˆ™ï¼Œå³ä»»ä½•ä¸€ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨äº†éåŸå­æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°C++ 11æ ‡å‡†æ‰€ç§°çš„æ•°æ®ç«äº‰(data raceï¼Œä¸è¦ä¸Javaçš„æ•°æ®ç«äº‰æ¦‚å¿µæ··æ·†ï¼Œè¿™æ˜¯ä¸åŒçš„ï¼Œæ˜¯ä¸€ç§æ›´é€šç”¨çš„ç«äº‰æ¡ä»¶)ã€‚C++ 11æ ‡å‡†å¹¶æ²¡æœ‰å‘Šè¯‰ä½ ä¸ºä»€ä¹ˆæ•°æ®ç«äº‰æ˜¯ç³Ÿç³•çš„ï¼Œåªæ˜¯å­˜åœ¨æ•°æ®ç«äº‰æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªæœªå®šä¹‰çš„è¡Œä¸º(1.10.21)ã€‚æ­¤ç±»æ•°æ®ç«äº‰ä¸ä½³çš„çœŸæ­£åŸå› å®é™…ä¸Šå¾ˆç®€å•ï¼šå®ƒä»¬å¯¼è‡´è¯»å–æŸå(torn reads)å’Œå†™å…¥æŸå(torn writes)ã€‚ä¸€ä¸ªå†…å­˜æ“ä½œå¯ä»¥æ˜¯éåŸå­çš„ï¼Œå› ä¸ºå®ƒä½¿ç”¨å¤šæ¡CPUæŒ‡ä»¤ï¼›å³ä¾¿æ˜¯ä½¿ç”¨å•ä¸ªCPUæŒ‡ä»¤çš„å†…å­˜æ“ä½œä¹Ÿå¯èƒ½æ˜¯éåŸå­çš„ã€‚äº¦æˆ–æ‚¨åœ¨ç¼–å†™å¯ç§»æ¤çš„ä»£ç æ—¶ä½ æ— æ³•åšå‡ºå‡è®¾è®¤ä¸ºå…¶å®åŸå­æ“ä½œï¼Œåˆ™è¯¥å†…å­˜æ“ä½œæœ‰å¯èƒ½ä¹Ÿæ˜¯éåŸå­çš„ã€‚è®©æˆ‘ä»¬çœ‹å‡ ä¸ªä¾‹å­ã€‚ ç”±äºå¤šæ¡CPUæŒ‡ä»¤å¯¼è‡´çš„éåŸå­æ“ä½œå‡è®¾æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„64ä½å…¨å±€å˜é‡ã€‚ 1uint64_t sharedValue = 0; æŸä¸ªæ—¶å€™ï¼Œä½ å¯ä»¥ä¸ºè¯¥å˜é‡èµ‹64ä½çš„æ•°å€¼ã€‚ 1234void storeValue()&#123; sharedValue = 0x100000002;&#125; ä½¿ç”¨GCCå°†æ­¤å‡½æ•°ç¼–è¯‘ä¸º32ä½x86ç¨‹åºï¼Œå®ƒå°†ç”Ÿæˆä»¥ä¸‹æœºå™¨ä»£ç ã€‚ 1234567$ gcc -O2 -S -masm=intel test.c$ cat test.s ... mov DWORD PTR sharedValue, 2 mov DWORD PTR sharedValue+4, 1 ret ... å¦‚æ‚¨æ‰€è§ï¼Œç¼–è¯‘å™¨ä½¿ç”¨ä¸¤æ¡å•â€‹â€‹ç‹¬çš„æœºå™¨æŒ‡ä»¤å®ç°äº†64ä½èµ‹å€¼æ“ä½œã€‚ç¬¬ä¸€æ¡æŒ‡ä»¤å°†ä½32ä½è®¾ç½®ä¸º0x00000002ï¼Œç¬¬äºŒæ¡æŒ‡ä»¤å°†é«˜32ä½è®¾ç½®ä¸º0x00000001ã€‚æ˜¾ç„¶ï¼Œæ­¤èµ‹å€¼æ“ä½œä¸æ˜¯åŸå­çš„ã€‚å¦‚æœsharedValueè¢«ä¸åŒçš„çº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œåˆ™å¯èƒ½ä¼šå‡ºé”™ï¼š çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒstoreValueæ“ä½œæœŸé—´çš„ä¸¤æ¡movæŒ‡ä»¤è¢«å…¶ä»–çº¿ç¨‹æŠ¢æ–­ï¼Œæ­¤æ—¶å…±äº«å†…å­˜ä¸­ä¿ç•™çš„æ˜¯0x0000000000000002 - å†™æŸåã€‚æ­¤æ—¶ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–sharedValueï¼Œå®ƒå°†æ¥æ”¶åˆ°è¿™ä¸ªå®Œå…¨é”™è¯¯çš„å€¼ã€‚ æ›´ç³Ÿç³•çš„æ˜¯ï¼Œçº¿ç¨‹æ­£åœ¨æ‰§è¡ŒstoreValueæ“ä½œæœŸé—´çš„ä¸¤æ¡movæŒ‡ä»¤è¢«å…¶ä»–çº¿ç¨‹æŠ¢æ–­ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹æ¢å¤ä¹‹å‰ä¿®æ”¹äº†sharedValueï¼Œè¿™å°†å¯¼è‡´æ°¸ä¹…çš„å†™æŸåï¼šä¸€ä¸ªçº¿ç¨‹å†™å…¥äº†é«˜32ä½ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†™å…¥äº†ä½32ä½ã€‚ åœ¨å¤šæ ¸ç¯å¢ƒä¸Šï¼Œç”šè‡³ä¸éœ€è¦æŠ¢å å°±ä¼šå¯¼è‡´å†™æŸåã€‚ä¸€ä¸ªæ ¸ä¸Šçš„çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒstoreValueï¼ŒåŒæ—¶å¦ä¸€ä¸ªæ ¸ä¸Šçš„çº¿ç¨‹æ­£åœ¨è¯»sharedValueï¼Œå…¶ä¼šçœ‹åˆ°å…±äº«å˜é‡è¢«éƒ¨åˆ†ä¿®æ”¹çš„çŠ¶æ€ å¹¶å‘è¯»`sharedValue``ä¼šå¸¦æ¥ä¸€ç³»åˆ—é—®é¢˜ï¼š 123456789101112uint64_t loadValue()&#123; return sharedValue;&#125;$ gcc -O2 -S -masm=intel test.c$ cat test.s ... mov eax, DWORD PTR sharedValue mov edx, DWORD PTR sharedValue+4 ret ... ç¼–è¯‘å™¨ä¹Ÿä½¿ç”¨ä¸¤æ¡æœºå™¨æŒ‡ä»¤å®ç°äº†åŠ è½½æ“ä½œ:ç¬¬ä¸€ä¸ªå°†è¾ƒä½çš„32ä½è¯»å–åˆ°eaxä¸­ï¼Œç¬¬äºŒä¸ªå°†è¾ƒé«˜çš„32ä½è¯»å–åˆ°edxä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå¯¹sharedValueçš„å¹¶å‘å­˜å‚¨åœ¨ä¸¤æ¡æŒ‡ä»¤ä¹‹é—´å˜å¾—å¯è§ï¼Œå³ä½¿å¹¶å‘å­˜å‚¨æ˜¯åŸå­çš„ï¼Œä¹Ÿä¼šå¯¼è‡´è¯»å–æŸåã€‚ ä¸Šè¿°é—®é¢˜ä¸ä»…ç†è®ºä¸Šå­˜åœ¨ã€‚Mintomicçš„æµ‹è¯•å¥—ä»¶åŒ…æ‹¬ä¸€ä¸ªç§°ä¸ºtest_load_store_64_failçš„æµ‹è¯•ç”¨ä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨æ™®é€šèµ‹å€¼è¿ç®—ç¬¦å°†64ä½å€¼å­˜å‚¨åˆ°å•ä¸ªå˜é‡ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ä»åŒä¸€å˜é‡é‡å¤æ‰§è¡Œæ™®é€šè¯»å–ï¼Œä»¥éªŒè¯æ¯ä¸ªç»“æœã€‚å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œåœ¨å¤šæ ¸x86-32ç¯å¢ƒä¸Šï¼Œè¯¥æµ‹è¯•å§‹ç»ˆå¤±è´¥ã€‚ éåŸå­CPUæŒ‡ä»¤å•æŒ‡ä»¤çš„å†…å­˜æ“ä½œä¹Ÿå¯èƒ½æ˜¯éåŸå­çš„ã€‚ä¾‹å¦‚ï¼ŒARMv7æŒ‡ä»¤é›†åŒ…å«strdæŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤å°†ä¸¤ä¸ª32ä½æºå¯„å­˜å™¨çš„å†…å®¹å­˜å‚¨åˆ°å†…å­˜ä¸­çš„å•ä¸ª64ä½å€¼ã€‚ 1strd r0, r1, [r2] æŸäº›ARMv7å¤„ç†å™¨ä¸Šï¼Œè¿™æ¡æŒ‡ä»¤ä¸æ˜¯åŸå­çš„ã€‚å½“å¤„ç†å™¨çœ‹åˆ°è¿™æ¡æŒ‡ä»¤æ—¶ï¼Œå®ƒå®é™…ä¸Šä¼šåœ¨å¹•åæ‰§è¡Œä¸¤ä¸ªå•ç‹¬çš„32ä½å­˜å‚¨(A3.5.3)ã€‚å¦ä¸€ä¸ªæ ¸ä¸Šè¿è¡Œçš„çº¿ç¨‹å¯èƒ½ä¼šè§‚å¯Ÿåˆ°å†™æŸåã€‚ç”šè‡³åœ¨å•æ ¸è®¾å¤‡ä¸Šä¹Ÿå¯èƒ½å‘ç”Ÿå†™å…¥ä¸­æ–­ï¼šåœ¨ä¸¤ä¸ªå†…éƒ¨32ä½å­˜å‚¨ä¹‹é—´å¯èƒ½ä¼šå‘ç”Ÿç³»ç»Ÿä¸­æ–­ï¼ˆä¾‹å¦‚ï¼Œç”¨äºè®¡åˆ’çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“çº¿ç¨‹ä»ä¸­æ–­ä¸­æ¢å¤æ—¶ï¼Œå®ƒå°†å†æ¬¡é‡æ–°å¯åŠ¨strdæŒ‡ä»¤ã€‚å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œåœ¨x86ä¸Šï¼Œå¦‚æœå†…å­˜æ“ä½œæ•°æ˜¯è‡ªç„¶å¯¹é½çš„ï¼Œåˆ™32ä½movæŒ‡ä»¤æ˜¯åŸå­çš„ï¼Œå¦åˆ™æ˜¯éåŸå­çš„ã€‚æ¢å¥è¯è¯´ï¼Œä»…å½“32ä½æ•´æ•°ä½äº4çš„ç²¾ç¡®å€æ•°çš„åœ°å€ä¸Šæ—¶ï¼ŒåŸå­æ€§æ‰èƒ½å¾—åˆ°ä¿è¯ã€‚Mintomicçš„å¦ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹test_load_store_32_failå¯ä»¥éªŒè¯ã€‚æ­¤æµ‹è¯•åœ¨x86ä¸Šä¸€ç›´æˆåŠŸï¼Œä½†å¦‚æœå°†sharedIntå¼ºåˆ¶æ”¾åˆ°æœªå¯¹é½çš„åœ°å€ï¼Œå®ƒå°†å¤±è´¥ã€‚åœ¨æˆ‘çš„Core 2 Quad Q6600ä¸Šï¼Œå½“sharedIntè¶Šè¿‡ç¼“å­˜è¡Œè¾¹ç•Œæ—¶ï¼Œæµ‹è¯•å¤±è´¥ï¼š 12345678// Force sharedInt to cross a cache line boundary:#pragma pack(2)MINT_DECL_ALIGNED(static struct, 64)&#123; char padding[62]; mint_atomic32_t sharedInt;&#125;g_wrapper; å·²ç»ä»‹ç»äº†è¶³å¤Ÿå¤šå¤„ç†å™¨çº§åˆ«çš„åŸå­æ€§ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹C/C++è¯­è¨€çº§åˆ«çš„åŸå­æ€§ã€‚ å‡å®šæ‰€æœ‰C/C++æ“ä½œéƒ½æ˜¯éåŸå­çš„åœ¨Cå’ŒC++ä¸­ï¼Œæ‰€æœ‰æ“ä½œéƒ½å‡å®šä¸ºéåŸå­æ“ä½œï¼Œå³ä¾¿æ˜¯æ™®é€šçš„32ä½æ•´æ•°èµ‹å€¼ã€‚é™¤éç¼–è¯‘å™¨æˆ–ç¡¬ä»¶ä¾›åº”å•†å¦è¡ŒæŒ‡å®šã€‚ 123456uint32_t foo = 0;void storeFoo()&#123; foo = 0x80286;&#125; è¯­è¨€æ ‡å‡†å¹¶æœªæåŠå†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚æ•´æ•°èµ‹å€¼ä¹Ÿè®¸æ˜¯åŸå­çš„ï¼Œä¹Ÿè®¸ä¸æ˜¯ã€‚ç”±äºéåŸå­æ“ä½œä¸ä½œä»»ä½•ä¿è¯ï¼Œæ ¹æ®å®šä¹‰ï¼ŒCè¯­è¨€ä¸­çš„æ™®é€šæ•´æ•°èµ‹å€¼æ˜¯éåŸå­çš„ã€‚ å®é™…æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸å¯¹ç¨‹åºè¿è¡Œçš„ç›®æ ‡å¹³å°æœ‰æ›´å¤šçš„äº†è§£ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰€æœ‰ç°ä»£x86ï¼Œx64ï¼ŒItaniumï¼ŒSPARCï¼ŒARMå’ŒPowerPCå¤„ç†å™¨ä¸Šï¼Œåªè¦ç›®æ ‡å˜é‡è‡ªç„¶å¯¹é½ï¼Œçº¯32ä½æ•´æ•°èµ‹å€¼å°±æ˜¯åŸå­çš„ã€‚æ‚¨å¯ä»¥é€šè¿‡æŸ¥é˜…å¤„ç†å™¨æ‰‹å†Œå’Œ/æˆ–ç¼–è¯‘å™¨æ–‡æ¡£æ¥è¿›è¡ŒéªŒè¯ã€‚åœ¨æ¸¸æˆè¡Œä¸šä¸­ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰æ‚¨ï¼Œå¾ˆå¤š32ä½æ•´æ•°åˆ†é…éƒ½ä¾èµ–äºæ­¤ç‰¹å®šä¿è¯ã€‚ ä½†æ˜¯ï¼Œåœ¨ç¼–å†™çœŸæ­£çš„å¯ç§»æ¤C/C++ç¨‹åºæ—¶ï¼Œé•¿æœŸä»¥æ¥æˆ‘ä»¬éµå¾ªâ€œå‡è£…é™¤äº†è¯­è¨€æ ‡å‡†å‘Šè¯‰æˆ‘ä»¬çš„çŸ¥è¯†ä¹‹å¤–ï¼Œä¸€æ— æ‰€çŸ¥â€çš„ä¼ ç»Ÿã€‚å¯ç§»æ¤çš„C/C++ç¨‹åºåº”è¯¥è¢«è®¾è®¡åœ¨è¿‡å»ã€ç°åœ¨å’Œæƒ³è±¡ä¸­çš„æ‰€æœ‰å¯èƒ½çš„è®¡ç®—è®¾å¤‡ä¸Šè¿è¡Œã€‚æˆ‘å€¾å‘äºå°†å†…å­˜æ“ä½œæƒ³è±¡ä¸ºåœ¨ä¸€å°æ‘‡æ†æœºä¸Šè¿›è¡Œæ‘‡æ†ï¼Œæ— æ³•å¾—çŸ¥æœ€ç»ˆçš„ç»“æœï¼šåœ¨è¿™æ ·çš„æœºå™¨ä¸Šï¼Œä½ è‚¯å®šä¸å¸Œæœ›åœ¨æ‰§è¡Œæ™®é€šèµ‹å€¼çš„åŒæ—¶æ‰§è¡Œå¹¶å‘è¯»;æœ€ç»ˆè¯»å–çš„å¯èƒ½æ˜¯ä¸€ä¸ªå®Œå…¨éšæœºçš„å€¼ã€‚ C++11ç»ˆäºå¼•å…¥äº†å¯ç§»æ¤çš„åŸå­åŠ è½½å’Œå­˜å‚¨:C++11åŸå­åº“ã€‚ä½¿ç”¨C++11åŸå­åº“æ‰§è¡Œçš„åŸå­åŠ è½½å’Œå­˜å‚¨ç”šè‡³å¯ä»¥åœ¨ä¸Šè¿°è™šæ‹Ÿè®¡ç®—æœºä¸Šå·¥ä½œï¼Œå³ä½¿C++11åŸå­åº“å¿…é¡»ç§˜å¯†åœ°åŠ äº’æ–¥é”ä¿è¯æ¯ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚æˆ‘ä¸Šä¸ªæœˆå‘å¸ƒçš„Mintomicåº“ï¼Œè¯¥åº“ä¸æ”¯æŒé‚£ä¹ˆå¤šå¹³å°ï¼Œä½†å¯ä»¥åœ¨å¤šä¸ªè¾ƒè€çš„ç¼–è¯‘å™¨ä¸Šè¿è¡Œï¼Œæ˜¯æ‰‹åŠ¨ä¼˜åŒ–ä¸”å¯ä»¥ä¿è¯æ˜¯æ— é”çš„ã€‚ å®½æ¾çš„åŸå­æ“ä½œå›é¡¾æœ¬æ–‡æœ€å¼€å§‹çš„sharedValueç¤ºä¾‹ã€‚æˆ‘ä»¬å°†ä½¿ç”¨Mintomicå¯¹å…¶è¿›è¡Œé‡å†™ä½¿å…¶èƒ½å¤Ÿåœ¨Mintomicæ”¯æŒçš„æ‰€æœ‰å¹³å°ä¸ŠåŸå­æ‰§è¡Œæ‰€ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»å°†sharedValueå£°æ˜ä¸ºMintomicçš„åŸå­æ•°æ®ç±»å‹ã€‚ 123#include &lt;mintomic/mintomic.h&gt;mint_atomic64_t sharedValue = &#123; 0 &#125;; mint_atomic64_tç±»å‹å¯ä»¥ä¿è¯æ¯ä¸ªå¹³å°ä¸ŠåŸå­è®¿é—®çš„æ­£ç¡®å†…å­˜å¯¹é½ã€‚è¿™å¾ˆé‡è¦ï¼Œä¾‹å¦‚ï¼Œä¸Xcode 3.2.5æ†ç»‘åœ¨ä¸€èµ·çš„ç”¨äºARMçš„GCC 4.2ç¼–è¯‘å™¨ä¸èƒ½ä¿è¯å°†uint64_t8å­—èŠ‚å¯¹é½ã€‚åœ¨storeValueä¸­ï¼Œå¿…é¡»æ‰§è¡Œmint_store_64_relaxedè€Œéæ‰§è¡Œç®€å•çš„éåŸå­èµ‹å€¼æ“ä½œã€‚ 1234void storeValue()&#123; mint_store_64_relaxed(&amp;sharedValue, 0x100000002);&#125; ç±»ä¼¼çš„ï¼ŒloadValueå¿…é¡»è°ƒç”¨mint_load_64_relaxedå®ç°ã€‚ 1234uint64_t loadValue()&#123; return mint_load_64_relaxed(&amp;sharedValue);&#125; ä½¿ç”¨C++ 11çš„æœ¯è¯­ï¼Œè¿™äº›å‡½æ•°ç°åœ¨ä¸å—æ•°æ®ç«äº‰ã€‚å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ— è®ºä»£ç æ˜¯åœ¨ARMv6/ARMv7ï¼ˆThumbæˆ–ARMæ¨¡å¼ï¼‰ã€x86ã€x64è¿˜æ˜¯PowerPCä¸Šè¿è¡Œï¼Œè¯»å–æˆ–å†™å…¥éƒ½ä¸ä¼šè¢«ç ´åã€‚å¦‚æœæ‚¨æƒ³çŸ¥é“mint_load_64_relaxedå’Œmint_store_64_relaxedçš„å®ç°ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šæ‰©å±•ä¸ºx86ä¸Šçš„å†…è”cmpxchg8bæŒ‡ä»¤ï¼›å…¶ä»–å¹³å°æŸ¥é˜…Mintomicçš„å®ç°ã€‚è¿™æ˜¯ç”¨C++11å†™æˆçš„å®Œå…¨ä¸€æ ·çš„ä¸œè¥¿: 12345678910111213#include &lt;atomic&gt;std::atomic&lt;uint64_t&gt; sharedValue(0);void storeValue()&#123; sharedValue.store(0x100000002, std::memory_order_relaxed);&#125;uint64_t loadValue()&#123; return sharedValue.load(std::memory_order_relaxed);&#125; æ‚¨ä¼šæ³¨æ„åˆ°ï¼ŒMintomicå’ŒC++ 11ç¤ºä¾‹éƒ½ä½¿ç”¨äº†å®½æ¾çš„åŸå­æ“ä½œï¼Œå„ç§æ ‡è¯†ç¬¦çš„_relaxedåç¼€å¾ˆæ˜æ˜¾åœ°å±•ç°äº†è¿™ä¸€ç‚¹ã€‚_relaxedåç¼€æé†’æ‚¨å‡ ä¹æ— æ³•ä¿è¯å†…å­˜çš„é¡ºåºã€‚ç‰¹åˆ«åœ°ï¼Œå®½æ¾çš„åŸå­æ“ä½œå’Œå…¶ä¹‹å‰ã€ä¹‹åçš„æŒ‡ä»¤é‡æ’æ˜¯åˆæ³•çš„ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç¼–è¯‘å™¨çš„é‡æ’(compiler reordering)æˆ–è€…å¤„ç†å™¨ä¸Šçš„å†…å­˜é‡æ’(memory reordering on the processor)ã€‚å°±åƒéåŸå­æ“ä½œä¸€æ ·ï¼Œç¼–è¯‘å™¨ç”šè‡³å¯ä»¥å¯¹å†—ä½™çš„å®½æ¾åŸå­æ“ä½œè¿›è¡Œä¼˜åŒ–ã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œè¯¥æ“ä½œä»ç„¶æ˜¯åŸå­çš„ã€‚å½“å¹¶å‘æ“ä½œå…±äº«å†…å­˜æ—¶ï¼Œå³ä½¿æ‚¨å·²ç»çŸ¥é“ç›®æ ‡å¹³å°ä¸Šçš„æ™®é€šåŠ è½½/å­˜å‚¨æ˜¯åŸå­çš„ï¼Œæœ€å¥½å§‹ç»ˆä½¿ç”¨Mintomicæˆ–C++ 11åŸå­åº“å‡½æ•°ã€‚åŸå­åº“åŠŸèƒ½æé†’æ‚¨å…±äº«å†…å­˜åœ¨å…¶ä»–åœ°æ–¹ä¼šè¢«å¹¶å‘æ•°æ®è®¿é—®ã€‚å¸Œæœ›æ‚¨ç°åœ¨å¯ä»¥æ›´æ¸…æ¥šåœ°äº†è§£ï¼Œä¸ºä»€ä¹ˆä¸–ç•Œä¸Šæœ€ç®€å•çš„æ— é”å“ˆå¸Œè¡¨ä½¿ç”¨Mintomicåº“å‡½æ•°è®©ä¸åŒçº¿ç¨‹åŒæ—¶æ“ä½œå…±äº«å†…å­˜ã€‚","categories":[{"name":"translation","slug":"translation","permalink":"https://system-thoughts.github.io/categories/translation/"},{"name":"lock-free","slug":"translation/lock-free","permalink":"https://system-thoughts.github.io/categories/translation/lock-free/"}],"tags":[{"name":"lock-free","slug":"lock-free","permalink":"https://system-thoughts.github.io/tags/lock-free/"},{"name":"atomic","slug":"atomic","permalink":"https://system-thoughts.github.io/tags/atomic/"}]},{"title":"ã€è¯‘æ–‡ã€‘ Becoming friends with NetworkManager","slug":"[è¯‘æ–‡] Becoming friends with NetworkManager","date":"2020-12-30T13:06:21.000Z","updated":"2023-01-18T05:32:06.156Z","comments":true,"path":"posts/b3973f42/","link":"","permalink":"https://system-thoughts.github.io/posts/b3973f42/","excerpt":"","text":"ç½‘ä¸Šå¾ˆå¤šCentOS7ç½‘ç»œé…ç½®çš„æ•™ç¨‹å¾€å¾€éƒ½ä¼šå»ºè®®å…³é—­Networkmanagerä½¿ç”¨network.serviceçš„æ–¹å¼è¿›è¡Œç½‘ç»œé…ç½®ï¼š1. é…ç½®/etc/sysconfig/network-scripts/ifcfg-&lt;net device&gt;.cfgï¼›2. systemctl restart networké‡å¯ç½‘ç»œç”Ÿæ•ˆã€‚ 3. å»ºè®®å…³é—­NetworkMangerï¼Œé˜²æ­¢å’Œnetwork.serviceå†²çªã€‚ç„¶è€Œï¼Œnetwork-scriptsåœ¨RHEL8ä¸­å·²ç»é»˜è®¤ä¸å®‰è£…äº†ã€‚RHEL8æ¨èä½¿ç”¨NetworkManagerçš„nmcliå‘½ä»¤è¿›è¡Œç½‘ç»œé…ç½®ã€‚å¦å¤–ï¼Œbridge-utilsé¡¹ç›®å®£å¸ƒå¼ƒç”¨,åœ¨RHEL8ä¸­æ— æ³•ä½¿ç”¨brctlå‘½ä»¤åˆ›å»ºç½‘æ¡¥ï¼Œéœ€è¦ä¾èµ–NetworkManagerçš„nmcliå‘½ä»¤åˆ›å»ºã€‚RHEL8å¼€å§‹ï¼Œè¶Šæ¥è¶Šå¤šçš„ç½‘ç»œç®¡ç†æ‰‹æ®µè²Œä¼¼åªèƒ½é€šè¿‡NetworkManagerè¿›è¡Œï¼Œç„¶è€ŒRedHatæ¨è¡Œå¤šå¹´çš„NetworkMangerå´ä¸€ç›´ä¸æ¸©ä¸ç«ï¼Œç©¶ç«Ÿä¸ºä½•ï¼ŸRedHatå·¥ç¨‹å¸ˆFrancesco Giudiciå†™çš„æœ¬ç¯‡æ–‡ç« å°±æ˜¯å‘å…¬ä¼—æ¨èNetworkManagerï¼Œå¹¶è¯•å›¾è§£é‡ŠNetworkManagerèƒŒåçš„åŸç†ã€‚ åŸæ–‡é“¾æ¥ï¼š https://www.redhat.com/sysadmin/becoming-friends-networkmanager æ‚¨å¯¹Linuxä¸»æœºè‡ªåŠ¨é…ç½®ç½‘ç»œæ„Ÿåˆ°æƒŠè®¶å—ï¼Ÿå¾ˆæœ‰å¯èƒ½æ˜¯NetworkManagerå¸®æ‚¨å®Œæˆè¿™é¡¹ä»»åŠ¡ã€‚NetworkManageræ˜¯å½“ä»ŠLinuxå‘è¡Œç‰ˆä¸­æœ€ä¸ºå¹¿æ³›ä½¿ç”¨çš„ç½‘ç»œé…ç½®å®ˆæŠ¤ç¨‹åºã€‚ç„¶è€Œï¼Œæ‚¨æ˜¯å¦ç¦ç”¨äº†NetworkManagerï¼Œå¹¶ä¸”æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæ‚¨é¦–é€‰çš„Linuxå‘è¡Œç‰ˆæ²¡æœ‰ä½¿ç”¨æ—§çš„IPå·¥å…·ä½œä¸ºé»˜è®¤çš„ç½‘ç»œé…ç½®æ–¹æ³•ï¼Ÿæ‚¨æ˜¯å¦è®¤ä¸ºNetworkManagerä»…é€‚ç”¨äºWiFiï¼Ÿå¦‚æœæ‚¨æœ‰ä¸Šè¿°ç–‘é—®ï¼Œè¿™ç¯‡æ–‡ç« æˆ–è®¸é€‚åˆæ‚¨ã€‚æ¥ä¸‹æ¥ï¼Œè¯·æŠ›å¼€åè§ï¼Œç»™NetworkManagerä¸€ä¸ªå…¬å¹³çš„æœºä¼šã€‚æˆ‘æ•¢æ‰“èµŒï¼Œæ‚¨åœ¨è¯»å®Œè¿™ç¯‡æ–‡ç« åï¼Œä¼šæ”¾ä¸‹å¯¹NetworkManagerçš„æˆè§ï¼Œç”šè‡³ä¼šå–œæ¬¢ä¸Šå®ƒã€‚æˆ‘ä¼šä»‹ç»ä¸ºä»€ä¹ˆNetworkManageræ˜¯è®¸å¤šåœºæ™¯ï¼ˆåŒ…æ‹¬å‘½ä»¤è¡Œå’ŒGUIï¼‰ä¸‹çš„ç†æƒ³é€‰æ‹©ã€‚éšåï¼Œæˆ‘å°†è§£é‡Šè¯¥å·¥å…·çš„åŸºæœ¬åŸç†ï¼ˆç»å¸¸è¢«è¯¯è§£ï¼‰ã€‚æœ€åï¼Œæˆ‘å°†é‡ç‚¹ä»‹ç»æ¯ä¸ªç”¨æˆ·åº”è¯¥æŒæ¡å…³äºNetworkManagerçš„ä¸€äº›å‘½ä»¤ã€‚ ä¸ºä»€ä¹ˆæ˜¯NetworkManagerï¼ŸLinuxä¸»æœºä¸­é…ç½®ç½‘ç»œçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå› æ­¤æ‚¨å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆè¦ä¸“é—¨ä½¿ç”¨NetworkManagerã€‚å°½ç®¡å·²ç»æœ‰å¾ˆå¤šä¸é”™çš„ç­”æ¡ˆï¼Œä½†æˆ‘æƒ³å¼ºè°ƒä¸€ä¸ªç»å¸¸è¢«å¿½ç•¥çš„è¦ç‚¹ï¼šNetworkManagerå…è®¸ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ£€ç´¢(retrieve)å’Œä¿®æ”¹ç½‘ç»œçš„é…ç½®ï¼Œä»è€Œç¡®ä¿è·å¾—ä¸€è‡´ä¸”æœ€æ–°çš„ç½‘ç»œè§†å›¾ã€‚å¯é€šè¿‡æ¡Œé¢GUIï¼ˆGnomeã€KDEã€nm-appletï¼‰ã€æ–‡æœ¬ç•Œé¢ï¼ˆnmtuiï¼‰ã€å‘½ä»¤è¡Œï¼ˆnmcliï¼‰ã€æ–‡ä»¶å’ŒWebæ§åˆ¶å°ï¼ˆCockpitï¼‰å¤šç§æ–¹å¼é…ç½®æ­¤å·¥å…·ã€‚NetworkManagerè¿˜ä¸ºåº”ç”¨ç¨‹åºæä¾›äº†APIï¼šD-Busæ¥å£ã€libnmåº“ã€‚ä»»ä½•å…¶ä»–ç½‘ç»œé…ç½®å·¥å…·éƒ½æ²¡æœ‰è¿™ä¹ˆçµæ´»ã€‚ NetworkManagerçš„åŸç†ä¸ºäº†ç†è§£å’ŒæŒæ¡NetworkManagerï¼Œæ‚¨é¦–å…ˆéœ€è¦äº†è§£å…¶åŸºç¡€é…ç½®åŸç†ã€‚ä»¥ä¸‹æ‘˜è‡ªman NetworkManagerï¼š â€œå°è¯•ä½¿ç½‘ç»œé…ç½®å’Œæ“ä½œå°½å¯èƒ½è½»æ¾ï¼Œè‡ªåŠ¨â€ è¿™ä¸æ ‡å‡†Unixå®ˆæŠ¤ç¨‹åºåŸç†æˆªç„¶ä¸åŒã€‚ä¼ ç»Ÿçš„Unixå®ˆæŠ¤ç¨‹åºé€šå¸¸è¦æ±‚ç”¨æˆ·é€šè¿‡é…ç½®æ–‡ä»¶æ˜¾å¼åœ°æä¾›é…ç½®ï¼Œç„¶åé‡å¯æœåŠ¡ã€‚æ²¡æœ‰é…ç½®ï¼Œå®ˆæŠ¤ç¨‹åºå°†ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ç›¸åï¼Œå½“åªæœ‰éƒ¨åˆ†é…ç½®æˆ–æ²¡æœ‰é…ç½®æ—¶ï¼ŒNetworkManagerä¼šæ£€æŸ¥å¯ç”¨è®¾å¤‡å¹¶å°½åŠ›æä¾›ä¸»æœºçš„ç½‘ç»œè¿æ¥ã€‚NetworkManagerçš„ç›®æ ‡æ˜¯æ»¡è¶³æ‰€æœ‰äººçš„éœ€æ±‚ï¼šåŒ…æ‹¬å¯»æ‰¾â€œå¯ä»¥æ­£å¸¸å·¥ä½œçš„ç½‘ç»œâ€çš„æ™®é€šç”¨æˆ·åˆ°éœ€è¦å®Œå…¨æ§åˆ¶ä¸»æœºç½‘ç»œçš„é«˜çº§ç½‘ç»œç®¡ç†å‘˜ã€‚NetworkManagerå¸Œæœ›é«˜çº§ç½‘ç»œç®¡ç†å‘˜æä¾›è‡ªå·±çš„é…ç½®ä»¥é¿å…ç½‘ç»œè‡ªåŠ¨é…ç½®ã€‚é€šè¿‡é…ç½®Linuxå®ˆæŠ¤ç¨‹åºæ¥é¿å…æ‰§è¡ŒæŸäº›æ“ä½œï¼ˆè‡ªåŠ¨åŒ–é…ç½®ï¼‰ç¡®å®ä¸å¸¸è§ï¼Œä½†è¿™çœ‹èµ·æ¥æ˜¯é€‚åº”ä»»ä½•åœºæ™¯çš„åˆç†æ–¹æ³•ã€‚ åŸºæœ¬çš„NetworkManageræ¦‚å¿µNetworkManagerçš„é…ç½®åŸºäºè®¾å¤‡(device)å’Œè¿æ¥(connection)ä¸¤å¤§æ¦‚å¿µã€‚è®¾å¤‡æ˜ å°„ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œå¤§è‡´ç›¸å½“äºæ‚¨æ‰§è¡Œip linkå‘½ä»¤çœ‹åˆ°çš„æ¥å£ã€‚æ¯ä¸ªè®¾å¤‡è·Ÿè¸ªï¼š æ˜¯å¦ç”±NetworkManagerç®¡ç† è®¾å¤‡çš„å¯ç”¨è¿æ¥ è®¾å¤‡ä¸Šçš„æ´»åŠ¨è¿æ¥ï¼ˆå¦‚æœæœ‰ï¼‰ è¿æ¥è¡¨ç¤ºè¦åœ¨è®¾å¤‡ä¸Šåº”ç”¨çš„å®Œæ•´é…ç½®ï¼Œå°±æ˜¯ä¸€ä¸ªå±æ€§åˆ—è¡¨ã€‚ å±äºåŒä¸€è®¾ç½®åŒºåŸŸçš„è®¾ç½®å±æ€§è¢«åˆ’åˆ†ä¸ºè®¾ç½®ç»„ï¼ˆä¾‹å¦‚ï¼Œipv4è®¾ç½®ç»„å±æ€§ï¼ŒåŒ…å«åœ°å€ï¼Œç½‘å…³å’Œè·¯ç”±ï¼‰ã€‚åœ¨NetworkManagerä¸­ï¼Œé…ç½®ç½‘ç»œå°±æ˜¯ç®€å•åœ°æ¿€æ´»è®¾å¤‡ä¸Šçš„è¿æ¥ï¼šè®¾å¤‡éšåä¼šè¢«é…ç½®ä¸ºè¿æ¥ä¸­çš„æ‰€æœ‰å±æ€§ã€‚å°½ç®¡å‰é¢æåŠçš„å¤šä¸ªå·¥å…·éƒ½å¯é…ç½®NetworkManagerï¼Œä½†ç°åœ¨ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨NetworkManagerè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·nmcliã€‚ æ³¨æ„ï¼šnmcliç¨‹åºå…·æœ‰é«˜çº§çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚ç¡®ä¿å®‰è£…äº†bash-completionè½¯ä»¶åŒ…ä»¥åˆ©ç”¨æ­¤ä¼˜åŠ¿ã€‚ nmcliåŸºç¡€è®©æˆ‘ä»¬çœ‹ä¸‹ä½¿ç”¨nmcliå¤„ç†ç½‘ç»œçš„å„ä¸ªæ–¹é¢ã€‚ è®¾å¤‡åˆ—å‡ºNetworkManageræ£€æµ‹åˆ°çš„è®¾å¤‡ï¼š 12345$ nmcli deviceDEVICE TYPE STATE CONNECTIONenp1s0 ethernet connected ether-enp1s0enp7s0 ethernet disconnected --enp8s0 ethernet disconnected -- ç”±è¾“å‡ºå¯è§ï¼ŒNetworkManagerå·²æ£€æµ‹åˆ°ç³»ç»Ÿä¸­çš„ä¸‰ä¸ªä»¥å¤ªç½‘è®¾å¤‡ã€‚ä»…ç¬¬ä¸€ä¸ªè®¾å¤‡enp1s0ä¸Šæœ‰æ´»åŠ¨è¿æ¥ï¼ˆè¡¨ç¤ºå·²é…ç½®ï¼‰ã€‚å¦‚æœæ‚¨å¸Œæœ›NetworkManagerä¸€æ®µæ—¶é—´å†…ä¸å†ç®¡ç†ä¸€ä¸ªè®¾å¤‡ï¼Œæ— éœ€å°†å…¶å…³é—­ï¼Œä»…éœ€æš‚æ—¶å–æ¶ˆç®¡ç†(unmanage)è¯¥è®¾å¤‡å³å¯ï¼š 123456$ nmcli device set enp8s0 managed no$ nmcli deviceDEVICE TYPE STATE CONNECTIONenp1s0 ethernet connected ether-ens3enp7s0 ethernet disconnected --enp8s0 ethernet unmanaged -- æ­¤æ›´æ”¹ä¸æ˜¯æŒä¹…åŒ–çš„ï¼Œé‡å¯ä¸ç”Ÿæ•ˆã€‚æŸ¥è¯¢æ¯ä¸ªè®¾å¤‡IPé…ç½®æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä¸å¸¦å‚æ•°çš„æ‰§è¡Œnmcliå‘½ä»¤ï¼š 12345678910111213141516171819$ nmclienp1s0: connected to enp1s0 &quot;Red Hat Virtio&quot; ethernet (virtio_net), 52:54:00:XX:XX:XX, hw, mtu 1500 ip4 default inet4 192.168.122.225/24 route4 0.0.0.0/0 route4 192.168.122.0/24 inet6 fe80::4923:6a4f:da44:6a1c/64 route6 fe80::/64 route6 ff00::/8enp7s0: disconnected &quot;Intel 82574L&quot; ethernet (e1000e), 52:54:00:XX:XX:XX, hw, mtu 1500enp8s0: unmanaged &quot;Red Hat Virtio&quot; ethernet (virtio_net), 52:54:00:XX:XX:XX, hw, mtu 1500 è¿æ¥åˆ—å‡ºå¯ç”¨è¿æ¥ï¼š 12345$ nmcli connectionNAME UUID TYPE DEVICEether-enp1s0 23e0d89e-f56c-3617-adf2-841e39a85ab4 ethernet enp1s0Wired connection 1 fceb885b-b510-387a-b572-d9172729cf18 ethernet --Wired connection 2 074fd16d-daa6-3b6a-b092-2baf0a8b91b9 ethernet -- ä»è¾“å‡ºå¯è§ï¼Œå”¯ä¸€çš„æ´»åŠ¨è¿æ¥æ˜¯åº”ç”¨äºè®¾å¤‡enp1s0çš„ether-enp1s0ã€‚ä¹Ÿå­˜åœ¨å…¶ä»–ä¸¤ä¸ªè¿æ¥ï¼Œä½†æ˜¯å®ƒä»¬ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚è¦åœç”¨è¿æ¥ï¼Œå³å–æ¶ˆé…ç½®å…³è”çš„è®¾å¤‡ï¼Œåªéœ€æŒ‡ç¤ºNetworkManageræ–­å¼€è¿æ¥å³å¯ã€‚ ä¾‹å¦‚ï¼Œè¦åœç”¨ether-enp1s0è¿æ¥ï¼š 1$ nmcli connection down ether-enp1s0 è¦é‡æ–°æ¿€æ´»å®ƒï¼Œå³é‡æ–°é…ç½®è®¾å¤‡ï¼š 1$ nmcli connection up ether-enp1s0 è¦æŸ¥çœ‹ç‰¹å®šè¿æ¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘ä»¬åº”è¯¥æ£€æŸ¥è¿æ¥çš„å±æ€§ï¼š 12345678910111213$ nmcli connection show ether-enp1s0connection.id: ether-enp1s0connection.uuid: 23e0d89e-f56c-3617-adf2-841e39a85ab4connection.stable-id: --connection.type: 802-3-ethernetconnection.interface-name: enp1s0connection.autoconnect: yesconnection.autoconnect-priority: -999connection.autoconnect-retries: -1 (default)connection.auth-retries: -1connection.timestamp: 1559320203connection.read-only: no[...] è¿æ¥å±æ€§çš„åˆ—è¡¨å¾ˆé•¿ï¼Œå¹¶ä¸”æŒ‰è®¾ç½®åˆ†ç»„ã€‚ å®é™…ä¸Šï¼Œæ¯ä¸ªå±æ€§éƒ½è¢«æŒ‡å®šä¸ºsetting_name.property_nameã€‚æˆ‘ä»¬é‡ç‚¹ä»‹ç»ä¸€äº›å±äºè¿æ¥å’ŒIPv4è®¾ç½®çš„åŸºæœ¬å±æ€§ï¼š å±æ€§ æè¿° åˆ«å connection.id è¿æ¥åç§°(nmcli connectionä¸­è¾“å‡º) con-name connection.uuid å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦UUIDï¼Œå”¯ä¸€æ ‡è¯†è¿æ¥ (none) connection.type è¿æ¥ç±»å‹ type connection.interface-name å°†è¿æ¥ç»‘å®šåˆ°ç‰¹å®šè®¾å¤‡ï¼Œåªèƒ½åœ¨è¯¥è®¾å¤‡ä¸Šæ¿€æ´»è¯¥è¿æ¥ ifname connection.autoconnect è¿æ¥æ˜¯å¦åº”è¯¥è¢«è‡ªåŠ¨æ¿€æ´» autoconnect ipv4.method è¿æ¥çš„IPv4æ–¹æ³•ï¼šè‡ªåŠ¨(auto)ï¼Œç¦ç”¨(disabled)ï¼Œé“¾æ¥æœ¬åœ°(link local)ï¼Œæ‰‹åŠ¨(manual)æˆ–å…±äº«(shared) (none) ipv4.addresses è¿æ¥çš„é™æ€IPv4åœ°å€ (none) è¯·æ³¨æ„ï¼Œå°‘æ•°å¸¸ç”¨å±æ€§å…·æœ‰åˆ«åï¼Œå³å¯ä»¥ç”¨æ¥ä»£æ›¿å®Œæ•´è®¾ç½®çš„çŸ­åç§°ã€‚ä¸Šè¡¨ç¬¬ä¸‰åˆ—æ˜¾ç¤ºåˆ«åã€‚æ‰€æœ‰nmcliå‘½ä»¤éƒ½å¯ä»¥è¢«æˆªæ–­ï¼Œä¸”èƒ½æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ ä¾‹å¦‚ï¼Œè¦å…³é—­ether-enp1s0è¿æ¥çš„è‡ªåŠ¨è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„modifyå‘½ä»¤ç¼©çŸ­ä¸ºï¼š$nmcli c m ether-ens1s0 autoconnect no autoconnectå±æ€§æ§åˆ¶è¿æ¥çš„è‡ªåŠ¨æ¿€æ´»ã€‚å¦‚æœå¯ç”¨äº†å®ƒï¼ˆ= yesï¼Œé»˜è®¤å€¼ï¼‰ï¼Œinterface-nameè®¾å¤‡å¤„äºå°±ç»ªçŠ¶æ€ä¸”å…¶ä¸Šæ— æ´»åŠ¨è¿æ¥æ—¶ï¼ŒNetworkManagerä¼šè‡ªåŠ¨æ¿€æ´»è¯¥è¿æ¥ã€‚å¦‚æœå°†ipv4.methodè®¾ç½®ä¸ºautoï¼Œåˆ™å¯ä»¥é€šè¿‡DHCPé…ç½®IPv4ã€‚å¦‚æœæ‚¨æ›´å–œæ¬¢é…ç½®é™æ€IPï¼Œåˆ™å°†ipv4.methodè®¾ç½®ä¸ºmanualï¼Œç„¶ååœ¨ipv4.addresseså±æ€§ä¸­è®¾å®šé™æ€IPåœ°å€å’Œå­ç½‘ï¼ˆä»¥CIDRè¡¨ç¤ºæ³•ï¼‰ã€‚æœ‰å…³æ‰€æœ‰å±æ€§åŠå…¶å«ä¹‰çš„å®Œæ•´è¯´æ˜ï¼Œè¯·å‚è§nm-settingsæ‰‹å†Œé¡µï¼ˆman nm-settingsï¼‰ã€‚ä½¿ç”¨nmcli connection Modifyå‘½ä»¤æ›´æ”¹è¿æ¥çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œå°†ether-enp1s0è¿æ¥æ›´æ”¹ä¸ºé™æ€IPv4åœ°å€ï¼ˆ10.10.10.1ï¼‰ï¼Œç½‘å…³ï¼ˆ10.10.10.254ï¼‰å’ŒDNSï¼ˆ10.10.10.254ï¼‰ï¼š 12$ nmcli connection modify ether-enp1s0 ipv4.method manual ipv4.addresses 10.10.10.1/24 \\ipv4.gateway 10.10.10.254 ipv4.dns 10.10.10.254 æ­¤å‘½ä»¤å°†æ°¸ä¹…æ›´æ”¹è¿æ¥ï¼Œä½†æ˜¯æ–°è®¾ç½®ä¸ä¼šç«‹å³åº”ç”¨åˆ°è®¾å¤‡ï¼šä¸‹æ¬¡åœ¨è¯¥è®¾å¤‡ä¸Šæ¿€æ´»è¿æ¥æ—¶æ‰ä¼šåº”ç”¨æ–°è®¾ç½®ã€‚å› æ­¤ï¼Œè¦ç«‹å³è®¾ç½®å¹¶è¿è¡Œæˆ‘ä»¬çš„è®¾ç½®ï¼Œè¯·é‡æ–°æ¿€æ´»è¿æ¥ï¼š 1$ nmcli connection up ether-enp1s0 æ‚¨å¯èƒ½è¿˜æƒ³é˜»æ­¢NetworkManagerè‡ªåŠ¨æ¿€æ´»ether-enp1s0è¿æ¥ï¼š 1$ nmcli connection modify ether-ens1s0 connection.autoconnect no ä»æ­¤å¼€å§‹ï¼Œæ‚¨å¿…é¡»è‡ªè¡Œæ¿€æ´»ether-enp1s0è¿æ¥ã€‚ ä½¿ç”¨nmcliåˆ›å»ºæ–°è¿æ¥ç°åœ¨ï¼Œæ˜¯æ—¶å€™ä½¿ç”¨nmcliåœ¨NetworkManagerä¸­åˆ›å»ºæ–°è¿æ¥äº†ï¼nmcli connectionå­å‘½ä»¤addçš„è¯­æ³•ç±»ä¼¼äºmodifyå­å‘½ä»¤ï¼š 1234567$ nmcli con add type ethernet ifname enp0s1 con-name enp0s1_dhcp autoconnect no$ nmcli conNAME UUID TYPE DEVICEether-enp1s0 23e0d89e-f56c-3617-adf2-841e39a85ab4 ethernet enp1s0enp0s1_dhcp 64b499cb-429f-4e75-a54d-b3fd980c39aa ethernet --Wired connection 1 fceb885b-b510-387a-b572-d9172729cf18 ethernet --Wired connection 2 074fd16d-daa6-3b6a-b092-2baf0a8b91b9 ethernet -- ç”±äºipv4.methodå±æ€§çš„é»˜è®¤å€¼ä¸ºautoï¼ŒæœªæŒ‡å®šä»»ä½•IPv4å±æ€§çš„æƒ…å†µä¸‹ï¼ŒIPv4é…ç½®å°†é€šè¿‡DHCPæ£€ç´¢è·å–ã€‚åˆ›å»ºè¿æ¥æ—¶ï¼Œå¼ºåˆ¶å±æ€§å–å†³äºconnection.typeï¼ˆethernetï¼Œwifiï¼Œbondï¼Œvpnç­‰ï¼‰ã€‚å¦‚æœç¼ºå°‘ä»»ä½•å¼ºåˆ¶å±æ€§ï¼Œnmcliå°†è¿”å›é”™è¯¯ï¼Œå¹¶æ‰“å°ç¼ºå°‘å±æ€§çš„åç§°ã€‚å¦‚æœæ‚¨å¸Œæœ›è·å¾—æ›´å…·äº¤äº’æ€§çš„ä½“éªŒï¼Œè¯·åœ¨æ‚¨çš„nmcliå‘½ä»¤ä¸­æ·»åŠ --askæ ‡å¿—ã€‚è¿™æ ·ï¼Œnmcliä¼šæç¤ºæ‚¨å®Œæˆå‘½ä»¤æ‰€éœ€çš„å†…å®¹ï¼Œè€Œä¸æ˜¯ç›´æ¥å¤±è´¥ï¼š 123456789101112$ nmcli --ask con addConnection type: ethernetInterface name [*]: enp0s1There are 3 optional settings for Wired Ethernet.Do you want to provide them? (yes/no) [yes] noThere are 2 optional settings for IPv4 protocol.Do you want to provide them? (yes/no) [yes] noThere are 2 optional settings for IPv6 protocol.Do you want to provide them? (yes/no) [yes] noThere are 4 optional settings for Proxy.Do you want to provide them? (yes/no) [yes] noConnection &#x27;ethernet-enp0s1&#x27; (64b499cb-429f-4e75-a54d-b3fd980c39aa) successfully added. å¯é€šè¿‡nmcli con editè®¿é—®ç¼–è¾‘å™¨æ¨¡å¼ã€‚æ­¤æ¨¡å¼æä¾›äº†å†…è”å¸®åŠ©å’Œæ›´åŠ äº¤äº’çš„ä½“éªŒã€‚ä¸å¸¦ä»»ä½•å‚æ•°è°ƒç”¨æ­¤æ¨¡å¼ä¼šå¯¼è‡´nmcliç¼–è¾‘å™¨æç¤ºæ‚¨è¾“å…¥è¦åˆ›å»ºçš„è¿æ¥ç±»å‹ã€‚è‹¥ä¼ å…¥è¿æ¥åç§°ï¼Œç¼–è¾‘å™¨å°†æ‰“å¼€è¯¥è¿æ¥ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ nmcliå¤‡å¿˜å•æ€»ç»“ä¸‹å‰é¢æåŠçš„nmcli connectionå­å‘½ä»¤ï¼š å‘½ä»¤ å‚æ•° æè¿° down connection æ–­å¼€æŒ‡å®šçš„è¿æ¥ï¼Œå–æ¶ˆé…ç½®å…³è”çš„è®¾å¤‡ up connection æ¿€æ´»æŒ‡å®šçš„è¿æ¥ show [connection] å½“ä¸å¸¦å‚æ•°ä½¿ç”¨æ—¶ï¼Œå¯ä»¥åƒé»˜è®¤å‘½ä»¤ä¸€æ ·çœç•¥showï¼šå®ƒåˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨çš„è¿æ¥ã€‚ å¦‚æœæä¾›è¿æ¥åç§°æˆ–UUIDä½œä¸ºå‚æ•°ï¼Œåˆ™å°†æ‰“å°è¿æ¥å±æ€§ modify connection {property_name property_value}â€¦ æ”¹å˜è¿æ¥çš„å±æ€§ add connection {property_name property_value}â€¦ åˆ›å»ºå…·æœ‰æŒ‡å®šå±æ€§çš„æ–°è¿æ¥ã€‚å¼ºåˆ¶å±æ€§å–å†³äºè¿æ¥ç±»å‹ï¼Œåº”å§‹ç»ˆæŒ‡å®šè¯¥ç±»å‹ æ¥ä¸‹æ¥ï¼Ÿç°åœ¨ï¼Œæˆ‘ä»¬ä»‹ç»äº†NetworkManagerçš„åŸºæœ¬åŸç†åŠå…¶åŸºæœ¬æ¦‚å¿µï¼ˆè®¾å¤‡å’Œè¿æ¥ï¼‰ã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°NetworkManagerå¯ä»¥é€šè¿‡å¤šç§å·¥å…·ä»¥å¤šç§æ–¹å¼ç®¡ç†å¹¶å‘è¯·æ±‚ã€‚æˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨NetworkManagerå‘½ä»¤è¡Œå·¥å…·nmcliæ˜¾ç¤ºå®é™…é…ç½®,åœ¨è®¾å¤‡ä¸Šæ·»åŠ ï¼Œä¿®æ”¹å’Œæ¿€æ´»/åœç”¨è¿æ¥ã€‚è¿™äº›çŸ¥è¯†ä¸ºæ‚¨æä¾›äº†äº†è§£å’ŒæŒæ¡NetworkManagerçš„åŸºç¡€ã€‚NetworkManagerå¯ä»¥åšåœ°æ›´å¤šã€‚è®¸å¤šåŠŸèƒ½éƒ½åº”æä¾›å•ç‹¬çš„åšå®¢æ–‡ç« ï¼Œä¾‹å¦‚è°ƒåº¦ç¨‹åºè„šæœ¬ï¼Œè¿æ¥æ£€æŸ¥å™¨ï¼Œæ‹†åˆ†çš„DNSï¼ŒMACåœ°å€éšæœºåŒ–ï¼Œçƒ­ç‚¹é…ç½®å’Œè‡ªåŠ¨é…ç½®ã€‚å› æ­¤ï¼Œè¯·ç»§ç»­å…³æ³¨è¿™é‡Œçš„ä¸‹ä¸€ç¯‡åšå®¢æ–‡ç« ã€‚æˆ–è€…ï¼Œå¦‚æœæ‚¨è¿«ä¸åŠå¾…ï¼Œè¯·å¼€å§‹åœ¨NetworkManageræ‰‹å†Œé¡µä¸­æŸ¥æ‰¾ï¼","categories":[{"name":"translation","slug":"translation","permalink":"https://system-thoughts.github.io/categories/translation/"},{"name":"tools","slug":"translation/tools","permalink":"https://system-thoughts.github.io/categories/translation/tools/"}],"tags":[{"name":"RedHat","slug":"redhat","permalink":"https://system-thoughts.github.io/tags/redhat/"},{"name":"NetworkManager","slug":"networkmanager","permalink":"https://system-thoughts.github.io/tags/networkmanager/"},{"name":"Network","slug":"network","permalink":"https://system-thoughts.github.io/tags/network/"}]},{"title":"Travis-CIæŒç»­é›†æˆHexoåšå®¢","slug":"Travis-CIæŒç»­é›†æˆHexoåšå®¢","date":"2020-12-15T04:15:39.000Z","updated":"2023-01-18T05:32:06.152Z","comments":true,"path":"posts/6bc45836/","link":"","permalink":"https://system-thoughts.github.io/posts/6bc45836/","excerpt":"Hexo is a fast, simple &amp; powerful blog framework, powered by Node.js.","text":"Hexo is a fast, simple &amp; powerful blog framework, powered by Node.js. hexoä¸ä»…å¯ä»¥ä½œä¸ºåšå®¢æ¡†æ¶ç”Ÿæˆåšå®¢ï¼Œæ›´èƒ½å¤Ÿå¹¿æ³›åœ°å¿«æ·ç”Ÿæˆä»»æ„é™æ€é¡µé¢ã€‚ hexo quick start å‡†å¤‡å·¥ä½œï¼šå®‰è£…nodejs 1$ yum install -y nodejs å®‰è£…hexo 1$ npm install hexo-cli -g åˆ›å»ºåšå®¢ç©ºç›®å½•ï¼Œä½¿ç”¨hexoåˆå§‹åŒ–è®¾ç½® 1$ mkdir -p blog &amp;&amp; cd blog &amp;&amp; hexo init . åšå®¢ç›®å½•å¿…é¡»ä¸ºç©ºï¼Œä¸èƒ½åŒ…å«ä»»ä½•æ–‡ä»¶ï¼Œå¦åˆ™hexo initä¼šåˆå§‹åŒ–å¤±è´¥ å¯åŠ¨æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹åšå®¢æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ 1$ hexo server è‹¥è¦åˆ›å»ºæ–°çš„åšæ–‡ 1$ hexo new [layout] &lt;title&gt; postæ¨¡æ¿æ˜¯é»˜è®¤çš„å¸ƒå±€ï¼Œé€šè¿‡ä¿®æ”¹_config.ymlä¸­çš„default_layouté¡¹ä¿®æ”¹æ–‡ç« çš„é»˜è®¤å¸ƒå±€ã€‚å¦‚æœä¸æƒ³ä½¿ç”¨ä»»ä½•å¸ƒå±€ï¼Œå¯ä»¥åœ¨æ–‡ç« çš„Front-matterä¸­disable layoutã€‚ ä½¿ç”¨ä¸åŒæ¨¡æ¿åˆ›å»ºçš„æ–‡ç« ä¿å­˜åœ¨sourceç›®å½•ä¸‹ä¸åŒçš„è·¯å¾„ï¼š layout path post source/_posts page source draft source/_drafts é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨æ–‡ç« åå­—ä½œä¸ºæ–‡ä»¶åç§°ã€‚ä¹Ÿå¯ä»¥ä¿®æ”¹_config.ymlä¸­new_post_nameé¡¹å®šä¹‰æ–‡ä»¶å‘½åæ ¼å¼ã€‚ hexoé»˜è®¤å®‰è£…äº†hexo-renderer-markedå’Œhexo-renderer-ejsï¼Œå› æ­¤hexoæ”¯æŒæ¸²æŸ“markdownä»¥åŠejsæ ¼å¼çš„æ–‡æœ¬ï¼Œè‹¥å®‰è£…äº†hexo-renderer-pugï¼Œä¹Ÿæ”¯æŒä½¿ç”¨pugæ¨¡æ¿è¿›è¡Œæ–‡ç« ä¹¦å†™é™¤äº†markdownè¯­æ³•æ ¼å¼ä¹‹å¤–ï¼Œè‹¥æƒ³åœ¨æ–‡ç« ä¸­æ·»åŠ å¼•ç”¨å—ã€ä»£ç å—ã€youtubeè§†é¢‘ï¼Œä¸ºäº†è®©è¿™äº›å†…å®¹ä¹Ÿèƒ½å¤Ÿå¾ˆå¥½åœ°æ¸²æŸ“ï¼Œhexoæä¾›äº†æ ‡ç­¾æ’ä»¶tag pluginsï¼Œæ— è®ºä½¿ç”¨markdownè¿˜æ˜¯å…¶ä»–æ ¼å¼è¿›è¡Œæ–‡ç« ä¹¦å†™ï¼Œæ ‡ç­¾æ’ä»¶çš„æ ¼å¼éƒ½æ˜¯ä¸å˜çš„ã€‚åœ¨å†™æ–‡ç« çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šåœ¨æ–‡ç« ä¸­æ’å…¥å…¶ä»–é™„ä»¶ï¼Œå¦‚å›¾ç‰‡ï¼Œä¸ºäº†è®©é¡µé¢æ¸²æŸ“æ›´å‡ºè‰²ï¼Œæœ‰æ—¶å€™ç”šè‡³ä¼šåœ¨æ–‡ç« ä¸­æ·»åŠ cssã€jsæ–‡ä»¶ã€‚hexoä¸­çš„èµ„æºï¼ˆAssetsï¼‰ä»£è¡¨çš„å°±æ˜¯sourceç›®å½•ä¸‹éæ–‡ç« ï¼ˆnon-postï¼‰æ–‡ä»¶ã€‚ä¸ºäº†åŒºåˆ†æ¯ç¯‡æ–‡ç« çš„èµ„æºï¼Œä½¿å¾—æ–‡ç« èµ„æºæ›´ä¸ºåˆç†åœ°ç®¡ç†ã€‚éœ€è¦å°†_config.ymlä¸­çš„post_asset_folderè®¾ç½®ä¸ºtrueï¼Œå¦‚æ­¤ï¼Œé€šè¿‡hexo newå‘½ä»¤ç”Ÿæˆçš„æ¯ç¯‡æ–°æ–‡ç« å°±ä¼šåˆ›å»ºåŒåçš„èµ„æºæ–‡ä»¶å¤¹ï¼Œå°†æ–‡ç« ç›¸å…³çš„èµ„æºéƒ½æ”¾åˆ°è¿™ä¸ªåŒåæ–‡ä»¶å¤¹ä¸­ã€‚åœ¨æ–‡ç« ä¸­é€šè¿‡ç›¸å¯¹è·¯åŠ²å³å¯é«˜æ•ˆåœ°å¼•ç”¨è¿™äº›èµ„æºã€‚ ä½¿ç”¨markdownç¼–è¾‘å¥½åšæ–‡ä¹‹åï¼Œç”Ÿæˆé™æ€é¡µé¢1$ hexo generate hexoç›®å½•åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œhexoç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 12345678910111213[root@localhost blog]# ls -alhtotal 108Kdrwxr-xr-x. 6 root root 168 Nov 20 22:46 .dr-xr-x---. 30 root root 4.0K Nov 20 22:44 ..-rw-r--r--. 1 root root 2.4K Nov 19 20:34 _config.yml-rw-r--r--. 1 root root 21K Nov 20 03:37 db.json-rw-r--r--. 1 root root 65 Nov 19 20:34 .gitignoredrwxr-xr-x. 164 root root 8.0K Nov 19 20:36 node_modules-rw-r--r--. 1 root root 581 Nov 19 20:36 package.json-rw-r--r--. 1 root root 55K Nov 19 20:36 package-lock.jsondrwxr-xr-x. 2 root root 52 Nov 19 20:34 scaffoldsdrwxr-xr-x. 3 root root 20 Nov 19 20:34 sourcedrwxr-xr-x. 3 root root 23 Nov 19 20:34 themes å„ç›®å½•è§£é‡Šå¦‚ä¸‹ï¼š ç›®å½•/æ–‡ä»¶ ç”¨é€” node_modules(D) npmå®‰è£…çš„å„ç§ä¾èµ–åŒ… scaffolds(D) æ¨¡æ¿æ–‡ä»¶å¤¹ï¼Œåˆå§‹åŒ…æ‹¬pageã€postã€draftä¸‰ç§æ¨¡æ¿ï¼Œæ¨¡æ¿å®šä¹‰äº†å†™ä½œå†…å®¹çš„å¸ƒå±€ source(D) ç”Ÿæˆé™æ€é¡µé¢çš„æºæ–‡ä»¶ï¼ŒåŒ…æ‹¬markdownæ–‡æ¡£ã€å›¾ç‰‡ç­‰ themes(D) ä¸»é¢˜æ–‡ä»¶å¤¹ï¼Œthemesç›®å½•ä¸‹ï¼Œæ¯ä¸ªä¸»é¢˜éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œé»˜è®¤ä¸»é¢˜ä¸ºlandscape _config.yml(T) åšå®¢é…ç½®æ–‡ä»¶ package.json(T) åº”ç”¨ç¨‹åºä¿¡æ¯ï¼Œç½—åˆ—äº†Hexoç‰ˆæœ¬åŠå…¶ä¾èµ–ç¨‹åºçš„ç‰ˆæœ¬ package-lock.json(T) hexo initæ‰§è¡Œè¿‡ç¨‹çš„npm installæ‰€ç”Ÿæˆï¼Œç”¨ä»¥è®°å½•å½“å‰çŠ¶æ€ä¸‹å®é™…å®‰è£…çš„å„ä¸ªnpm packageçš„å…·ä½“æ¥æºå’Œç‰ˆæœ¬å·ã€‚https://docs.npmjs.com/cli/v6/configuring-npm/package-lock-json hexo blogéƒ¨ç½²hexoæä¾›äº†ä¾¿æ·çš„ä¸€é”®éƒ¨ç½²å‘½ä»¤ï¼š 1$ hexo deploy hexoå°†ç½‘ç«™éƒ¨ç½²çš„ç›®çš„åœ°æœ‰å¤šç§ï¼Œä¸»è¦åˆ†ä¸ºæœåŠ¡å™¨å’Œè¿œç«¯ä»“åº“ã€‚è¿œç«¯ä»“åº“å¦‚github pageï¼Œè¯¥ä»“åº“åŒ…å«é™æ€ç«™ç‚¹çš„HTMLã€CSSå’Œjsæ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨åœ°å¯¹å¤–å‘å¸ƒç½‘ç«™ã€‚ GitHub Pages æ˜¯ä¸€é¡¹é™æ€ç«™ç‚¹æ‰˜ç®¡æœåŠ¡ï¼Œå®ƒç›´æ¥ä» GitHub ä¸Šçš„ä»“åº“è·å– HTMLã€CSS å’Œ JavaScript æ–‡ä»¶ï¼Œï¼ˆå¯é€‰ï¼‰é€šè¿‡æ„å»ºè¿‡ç¨‹è¿è¡Œæ–‡ä»¶ï¼Œç„¶åå‘å¸ƒç½‘ç«™ã€‚ Coding.netã€giteeã€gitlabéƒ½æœ‰åŒæ ·çš„æœåŠ¡ï¼Œéƒ¨ç½²æ–¹å¼å‚è€ƒgithub pageå³å¯ã€‚å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯å°†é™æ€ç«™ç‚¹éƒ¨ç½²åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é€šè¿‡ftpã€sftpç­‰æ–¹å¼ä¸€é”®å°†é™æ€ç«™ç‚¹å‘å¸ƒåˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·éœ€è¦å®‰è£…hexo-deployer-ftpsyncã€hexo-deployer-sftpæ’ä»¶ï¼Œæ¯ç§æ’ä»¶éƒ½æœ‰ç›¸å…³çš„éƒ¨ç½²é…ç½®ã€‚å…¶ä»–å°ä¼—çš„éƒ¨ç½²æ–¹å¼å‚è€ƒï¼šOne-Command Deployment æœ¬æ–‡ä»¥å°†é™æ€ç«™ç‚¹éƒ¨ç½²åˆ°github pageä¸ºä¾‹ã€‚ åœ¨githubä¸Šåˆ›å»ºå¸¦æœ‰è‡ªå·±ç”¨æˆ·åçš„ä»£ç ä»“ï¼š&lt;username&gt;.github.io å®‰è£…hexo-deployer-gitæ’ä»¶1$ npm install hexo-deployer-git --save é…ç½®_config.yml12345deploy: type: git repo: &lt;repository url&gt; # https://github.com/system-thoughts/system-thoughts.github.io.git branch: [branch] message: [message] deployçš„å„é¡¹è§£é‡Šå¦‚ä¸‹ï¼š é€‰é¡¹ æè¿° é»˜è®¤å€¼ repo ä»£ç ä»“åœ°å€ branch éƒ¨ç½²çš„åˆ†æ”¯åç§° master (GitHub)coding-pages (Coding.net) master (others) message è‡ªå®šä¹‰éƒ¨ç½²æäº¤çš„ä¿¡æ¯ Site updated: å½“å‰æ—¶é—´ï¼Œæ ¼å¼ï¼šâ€™YYYY-MM-DD HH:mm:ssâ€™ token éªŒè¯ä»£ç ä»“çš„token å…³äºhexo-deploy-gitç›¸å…³çš„é…ç½®é€‰é¡¹æ›´å¤šçš„ä»‹ç»å¯å‚è€ƒï¼šhexo-deployer-gitã€‚æ­¤å¤„ï¼Œé…ç½®typeå’Œrepoå³å¯ï¼Œå…¶ä»–é¡¹ä½¿ç”¨é»˜è®¤å€¼ã€‚4. éƒ¨ç½²ç½‘ç«™ 1$ hexo clean &amp;&amp; hexo deploy hexo cleanç”¨æ¥æ¸…é™¤ç¼“å­˜æ–‡ä»¶(db.json) å’Œå·²ç”Ÿæˆçš„é™æ€æ–‡ä»¶ (public)ã€‚åœ¨æŸäº›æƒ…å†µï¼ˆå°¤å…¶æ˜¯æ›´æ¢ä¸»é¢˜åï¼‰ï¼Œå¦‚æœå‘ç°æ‚¨å¯¹ç«™ç‚¹çš„æ›´æ”¹æ— è®ºå¦‚ä½•ä¹Ÿä¸ç”Ÿæ•ˆï¼Œæ‚¨å¯èƒ½éœ€è¦è¿è¡Œè¯¥å‘½ä»¤ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦è¿è¡Œæ­¤å‘½ä»¤ã€‚hexo deployå‘½ä»¤å°±æ˜¯éƒ¨ç½²é™æ€ç«™ç‚¹ï¼Œå½“ç„¶ä¹‹å‰è¦ä½¿ç”¨hexo generateç”Ÿæˆé™æ€é¡µé¢ã€‚å¯ä»¥å°†è¿™ä¸¤æ¡å‘½ä»¤ç®€åŒ–ä¸ºï¼š 12345$ hexo d -g // åœ¨éƒ¨ç½²ä¹‹å‰ç”Ÿæˆä¸€æŠŠor$ hexo g -d // ç”Ÿæˆä¹‹åç«‹é©¬éƒ¨ç½²or$ hexo generate &amp;&amp; hexo deploy æ­¤æ—¶ä¼šæç¤ºä½ è¾“å…¥githubçš„ç”¨æˆ·åå’Œå¯†ç ï¼Œé™¤éä½ ä½¿ç”¨tokenæˆ–è€…ssh-keyçš„æ–¹å¼è®¤è¯ã€‚æ­¤å¤„ç®€å•é…ç½®ä¸‹ï¼Œgitç”¨æˆ·åå’Œå¯†ç ï¼š 12$ git config --global user.name &quot;lvying&quot;$ git config --global user.email &quot;lvying.system.thoughts@gmail.com&quot; ç”Ÿæˆsshkeyå°±ä¸ä»‹ç»ï¼Œæ­¤å¤„åšä¸‹æµ‹è¯•ï¼Œå½“å‰ç³»ç»Ÿä¸­çš„sshkeyæ˜¯å¦æ˜¯è‡ªå·±çš„githubè´¦æˆ·ï¼š 123[root@localhost blog]# ssh -T git@github.comWarning: Permanently added the RSA host key for IP address &#x27;192.30.255.112&#x27; to the list of known hosts.Hi **system-thoughts**! You&#x27;ve successfully authenticated, but GitHub does not provide shell access. ä¹‹å‰çš„sshkeyå› ä¸ºä¸æ˜¯æˆ‘è‡ªå·±çš„githubè´¦æˆ·ï¼Œå› æ­¤æˆ‘åˆé‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªã€‚åœ¨_config.ymlä¸­æˆ‘æ˜¯ç”¨httpsçš„ä»“åº“åœ°å€ï¼Œæäº¤ä¼šé‡åˆ°é”™è¯¯ï¼š 1234567remote: Permission to system-thoughts/system-thoughts.github.io.git denied to **buweilv**.fatal: unable to access &#x27;https://github.com/system-thoughts/system-thoughts.github.io.git/&#x27;: The requested URL returned error: 403FATAL &#123; err: &#123; Error: Spawn failed at ChildProcess.task.on.code (/root/blog/node_modules/hexo-deployer-git/node_modules/hexo-util/lib/spawn.js:51:21) at ChildProcess.emit (events.js:198:13) at Process.ChildProcess._handle.onexit (internal/child_process.js:248:12) code: 128 &#125; &#125; &#x27;Something\\&#x27;s wrong. Maybe you can find the solution here: %s&#x27; &#x27;\\u001b[4mhttps://hexo.io/docs/troubleshooting.html\\u001b[24m&#x27; è¿™ä¸ªæ˜¯æˆ‘å¦å¤–ä¸€ä¸ªgithubè´¦æˆ·ï¼Œä¸çŸ¥é“ä¸ºä½•ä¼šé»˜è®¤è¯†åˆ«ä½¿ç”¨è¿™ä¸ªè´¦æˆ·ï¼Œæˆ‘çŒœæƒ³è¿™ä¸ªå¯èƒ½æ˜¯å› ä¸ºç¼“å­˜çš„ç¼˜æ•…å§ã€‚å°†repoé…ç½®ä¸ºsshçš„ä»“åº“åœ°å€ï¼Œä¾¿å¯ä»¥æ­£ç¡®éƒ¨ç½²ç«™ç‚¹ã€‚ Travis CIéƒ¨ç½²hexo blogå½“å‰æ¯æ¬¡éƒ¨ç½²hexo blogï¼Œéƒ½éœ€è¦æ‰‹åŠ¨è¾“å…¥hexo g -dç”Ÿæˆé™æ€é¡µé¢ï¼Œå¹¶éƒ¨ç½²åˆ°github pageä¸Šã€‚è¿™éœ€è¦åœ¨å½“å‰ç¯å¢ƒå®‰è£…hexoåŠnpmï¼Œéƒ¨ç½²åˆ°github pageä¸Šä¹‹åï¼Œ&lt;username&gt;.github.ioä»£ç ä»“æ‰˜ç®¡çš„æ˜¯é™æ€é¡µé¢ï¼Œå¦‚æœè¦åœ¨ä¸åŒè®¾å¤‡ä¸Šè¿›è¡Œå†™ä½œï¼Œéœ€è¦æ‹·è´æœ€æ–°æºæ–‡ä»¶ã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æœ¬åœ°ä¸“æ³¨blogå†™ä½œï¼Œä¸ç”¨æ‹…å¿ƒç¯å¢ƒé…ç½®ã€æºæ–‡ä»¶æ‰˜ç®¡ç­‰æ‚é¡¹ï¼Œä½¿ç”¨Travis CIéƒ¨ç½²hexo blogã€‚ æºæ–‡ä»¶gitç®¡ç†hexo generateå’Œhexo deployä¼šæ–°å¢æ–‡ä»¶å’Œç›®å½•ï¼Œè¿™äº›ç›®å½•çš„è§£é‡Šå¦‚ä¸‹ï¼š ç›®å½•/æ–‡ä»¶ ç”¨é€” public(D) ç”±hexo generateç”Ÿæˆçš„é™æ€é¡µé¢ï¼Œhexo cleanæ¸…é™¤ã€‚Hexo å¼•å…¥äº†å·®åˆ†æœºåˆ¶ï¼Œå¦‚æœ public ç›®å½•å­˜åœ¨ï¼Œé‚£ä¹ˆ hexo g åªä¼šé‡æ–°ç”Ÿæˆæ”¹åŠ¨çš„æ–‡ä»¶ã€‚è‹¥è¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼Œä½¿ç”¨hexo g -f .deploy_git(D) hexo-deployer-gité€šè¿‡åœ¨.deploy_gitä¸­ç”Ÿæˆç«™ç‚¹å¹¶å¼ºåˆ¶å°†å…¶æ¨é€åˆ°_config.ymlä¸­é…ç½®çš„ä»“åº“æ¥å·¥ä½œã€‚ å¦‚æœ.deploy_gitä¸å­˜åœ¨ï¼Œåˆ™å°†åˆå§‹åŒ–å­˜å‚¨åº“ï¼ˆgit initï¼‰ã€‚ å¦åˆ™ï¼Œå°†ä½¿ç”¨å½“å‰çš„ä»“åº“ï¼ˆåŠå…¶æäº¤å†å²ï¼‰ã€‚ å¦‚æ­¤çœ‹æ¥,publicç›®å½•ä¸­ä¿å­˜çš„æ˜¯hexo gæœ¬åœ°ç”Ÿæˆçš„é™æ€ç«™ç‚¹é¡µé¢ã€‚.deploy_gitå®é™…ä¸Šå°±æ˜¯ä»£ç ä»“ï¼Œè·Ÿè¸ªçš„å°±æ˜¯&lt;username&gt;.github.ioä»£ç ä»“ã€‚å½“æ‰§è¡Œhexo dæ—¶ï¼Œä¼šå°†publicç›®å½•ä¸­çš„å†…å®¹å½¢æˆä¸€æ¬¡æ–°çš„æäº¤è®°å½•ï¼Œæäº¤åˆ°&lt;username&gt;.github.ioä»£ç ä»“ä¸­ã€‚å¯¹æ¯”ä¸‹.deploy_gitä¸&lt;username&gt;.github.ioä¸‹çš„å†å²è®°å½•ï¼Œä¸¤è€…å®Œå…¨åŒ¹é…ï¼š .deploy_gitæ˜¯&lt;uername&gt;.github.ioçš„æœ¬åœ°ä»“åº“ï¼Œå…¶masteråˆ†æ”¯è¿½è¸ª&lt;uername&gt;.github.ioçš„æœ¬åœ°åˆ†æ”¯ã€‚åœ¨blogæ ¹ç›®å½•ä¸­ï¼Œåœ¨hexo initåˆå§‹åŒ–æ—¶ä¾¿å­˜åœ¨.gitignoreæ–‡ä»¶ï¼š .gitignore1234567.DS_StoreThumbs.dbdb.json*.lognode_modules/public/.deploy*/ å¯è§hexoæœ‰æ„è¦å°†blogä¹Ÿä½œä¸ºgit repoï¼Œåœ¨æ­¤å¤„å·²ç»ä¸ºæˆ‘ä»¬åˆ—å¥½äº†å¿½ç•¥é¡¹ï¼Œå¿½ç•¥ç›¸å…³ç¯å¢ƒé…ç½®æ–‡ä»¶ã€‚è¿™æ ·ï¼Œhexoä¹Ÿæœ‰æ„ä¿å­˜ä¸¤ä»½git repo: åœ¨ä½¿ç”¨hexo d -géƒ¨ç½²çš„æ—¶å€™ï¼Œå°†.deploy_gitä¸­çš„é™æ€æ–‡ä»¶æ¨é€åˆ°.github.ioçš„masteråˆ†æ”¯ å°†æ ¹ç›®å½•ä¸‹çš„æºæ–‡ä»¶æäº¤åˆ°.github.ioå¦ä¸€åˆ†æ”¯ï¼Œæäº¤ä¼šå¿½ç•¥é™æ€æ–‡ä»¶å’Œç¯å¢ƒé…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬å°†æºæ–‡ä»¶æäº¤åˆ°ä»£ç ä»“çš„srcåˆ†æ”¯ä¸­ã€‚ åœ¨åšå®¢æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºgit repoï¼š 1234$ git init .$ git add . -A &amp;&amp; git commit -m &quot;init blog&quot;$ git remote add origin git@github.com:system-thoughts/system-thoughts.github.io.git$ git push origin master:src å½“å‰ï¼Œåšæ–‡æºæ–‡ä»¶å·²ç»å¯ä»¥åŒæ­¥ï¼Œä¸ºäº†è¿›ä¸€æ­¥æ–¹ä¾¿åšå®¢è‡ªåŠ¨åŒ–ç”Ÿæˆã€éƒ¨ç½²ï¼Œå¯ä»¥ä½¿ç”¨travis CIè¿›è¡ŒæŒç»­é›†æˆã€‚ Travis CIæŒç»­é›†æˆhexo blogæœ¬åœ°éƒ¨ç½²å’Œtravis CIéƒ¨ç½²åšå®¢çš„å·¥ä½œæµç¨‹åŒºåˆ†å¦‚å›¾æ‰€ç¤ºï¼šTravis CIä¼šè‡ªåŠ¨éƒ¨ç½²hexoä¾èµ–çš„ç¯å¢ƒï¼Œä¸€æ—¦æ›´æ–°æºæ–‡ä»¶ï¼Œä¾¿ä¼šè§¦å‘Travis CIæ„å»ºã€éƒ¨ç½²blogã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š æ‰“å¼€å®˜æ–¹ç½‘ç«™https://travis-ci.com/ï¼Œä½¿ç”¨githubè´¦å·è¿›è¡Œç™»å½•ï¼Œç„¶å Travis CIä¼šåˆ—å‡ºä½  Githubä¸Šé¢æ‰€æœ‰çš„ä»“åº“ï¼Œä»¥åŠä½ æ‰€å±äºçš„ç»„ç»‡ã€‚ç‚¹å‡»å®‰è£…Travis CI github APPï¼Œéšåé€‰æ‹©Travis CIæœ‰æƒé™è®¿é—®è´¦å·ä¸‹çš„æ‰€æœ‰ä»£ç ä»“ã€‚ è‹¥è¦Travis CIèƒ½å¤Ÿæ„å»ºé¡¹ç›®ï¼Œéœ€è¦åœ¨ä»£ç ä»“æ ¹ç›®å½•ä¸­æ·»åŠ .travis.ymlé…ç½®æ–‡ä»¶ã€‚å½“ä»£ç ä»“ä¸­æœ‰æ–°çš„æäº¤æ—¶ï¼ŒTravis CIä¼šæ ¹æ®yamlæ–‡ä»¶çš„é…ç½®è¿›è¡Œæ„å»ºã€å‘å¸ƒã€‚12345678910111213141516171819language: node_jsnode_js:- &#x27;12&#x27;install:- npm installscript:- npm run clean- npm run builddeploy: provider: pages skip_cleanup: true github_token: &quot;$GITHUB_TOKEN&quot; local_dir: public on: branch: master target_branch: gh-pagesenv: global: secure: KbvbdGLy5/C3mB5dr+yCF5llN9cAS9Sy498mnz9iMf3ONgQ+oOKYVHQLdqX6eYcQv4KUCrdUQHmUCmADr5vFNEblioRqzjZ4Ftcrg+tR2JaaApxYvPN5nm8TngZIHfEw0KbF83jFFUACMIsPM+sxmFxVX06K7D25l9N27K844uWKlxIqH3g/JygXphuBPSgqSjQ0j+m7AZOADpN16SCHfOqm6b6QPjnbqkEIeqyg7FChbmlGEFuYb4C7kL1E80m0hD8j8NOxohnmHWHTDcoP8xYehPHRNQ2VvrwZSAKVUDFTmmaP2vDYetO6p9MnQafRdgVBwtx+IO0nU7eQMB4eislRWajwXidon+yd0sDiLQyQXhjcg7qqckdatJc+LrOufx/gdSnmOg0fNZB0cVM8F7Sn1rafj9Vv5js9L3/OFjnH0Sc3Aa31bvli+BthXBHH0mhnoFhFupMRDk301af904Nyx/UejzDs3zN+aFV7XedkGEnsFA8TImz7Y2NOamxUSp15cOAiKcuK8fYnEBJh93m98dVCvk9haiuD8FiwIbqNJ+yDYiGxOeriLRxVRrmYKbn3GHKW+RT7t18dljR6ffYf/38jlRbtUnruMChbQ3/gZRsuq30J4hOEDYKS82JU0q6VZKsokDWo1RjU4NlrLDiTzzUUvkNLxGbckQM8MCQ= Travis CIå°†æ„å»ºç”Ÿæˆçš„é™æ€é¡µé¢éƒ¨ç½²åˆ°github pageï¼Œéœ€è¦æ¨é€ä»£ç åˆ°&lt;username&gt;.github.ioä»£ç ä»“çš„æƒé™ã€‚Githubæä¾›äº†Personal Access Tokenèµ‹äºˆTravis CIæƒé™ã€‚å‰å¾€ Github å¸å· Settings é¡µé¢ï¼Œåœ¨å·¦ä¾§é€‰æ‹©Developer settings â†’ Personal Access Tokenï¼Œç„¶ååœ¨å³ä¾§é¢æ¿ç‚¹å‡» â€œGenerate new tokenâ€ æ¥æ–°å»ºä¸€ä¸ª Tokenã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ›å»ºå®Œçš„ Token åªæœ‰ç¬¬ä¸€æ¬¡å¯è§ï¼Œä¹‹åå†è®¿é—®å°±æ— æ³•çœ‹è§ï¼ˆåªèƒ½çœ‹è§ä»–çš„åç§°ï¼‰ï¼Œå› æ­¤è¦ä¿å­˜å¥½è¿™ä¸ªå€¼ã€‚ä¹‹å‰ç”Ÿæˆ Personal Access Tokenæ—¶ï¼Œåªé€‰æ‹©äº†ä»¥ä¸‹æƒé™ï¼šåŠ å¯†å¯†é’¥ï¼š1234$ yum -y install ruby ruby-devel rubygems rpm-build$ gem install travis$ travis login --pro --github-token &#x27;&lt;Personal Access Token&gt;&#x27;$ travis encrypt --pro &#x27;GITHUB_TOKEN=&lt;Personal Access Token&gt;&#x27; --add è¿™é‡Œè¦ç™»å½•https://api.travis-ci.com è€Œéä½¿ç”¨travis login --github-token &#39;&lt;Personal Access Token&gt;&#39;ç™»å½•https://api.travis-ci.org/ã€‚å› ä¸ºæˆ‘ä»¬çš„å·¥ç¨‹åœ¨https://api.travis-ci.com ä¸Šæ„å»ºã€‚åç»­ä½¿ç”¨travis encryptåŠ å¯†çš„GITHUB_TOKENç¯å¢ƒå˜é‡åº”è¯¥åœ¨travis-ci.comä¸­ã€‚travis encrptä¸­è‡ªè¡Œè´´å…¥Personal Access Tokençš„æ˜æ–‡ã€‚ä¹‹å.travis.ymlçš„å†…å®¹ä¼šè‡ªåŠ¨æ›´æ–°ã€‚å¯†é’¥æ·»åŠ æˆåŠŸä¹‹åï¼Œæ¯æ¬¡è§¦å‘travis-ciæ„å»ºéƒ½èƒ½è§‚å¯Ÿåˆ°è¯¥ç¯å¢ƒå˜é‡ï¼š å¯¹æºæ–‡ä»¶è¿›è¡Œä¿®æ”¹ä¹‹åï¼Œæäº¤å³å¯è§¦å‘Travis CIæ„å»ºï¼Œè‹¥è¦å¿½ç•¥æŸæ¬¡æäº¤ï¼Œå³è¿™æ¬¡æäº¤ä¸è¦è§¦å‘Travis CIæ„å»ºå‘å¸ƒhexo blogï¼Œtravisè‹¥è¦å¿½ç•¥ä¸€æ¬¡æäº¤ï¼Œå³è¿™æ¬¡æäº¤ä¸ä¼šè§¦å‘Travis-CIæ„å»ºï¼Œå¯ä»¥åœ¨commit msgä¸­åŠ å…¥[ci skip]æˆ–è€…[skip-ci]å…³é”®å­—ï¼š1git commit -m &#x27;documentation update [ci skip]&#x27; Reference[1] https://neveryu.github.io/2019/02/05/travis-ci/[2] https://medium.com/starbugs/travis-ci-ç°¡å–®äº‹æƒ…å°±äº¤çµ¦é›»è…¦å»åšä¹‹ci-cd-åˆé«”é©—-è®“-github-pages-è‡ªå‹•æ›´æ–°-7647be30eb1c[3] https://segmentfault.com/a/1190000019067492[4] http://magicse7en.github.io/2016/03/27/travis-ci-auto-deploy-hexo-github/[5] https://anran758.github.io/blog/2020/06/08/github-travis-build/[6] https://hexo.io/docs/setup.html","categories":[{"name":"blog","slug":"blog","permalink":"https://system-thoughts.github.io/categories/blog/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://system-thoughts.github.io/tags/hexo/"}]}],"categories":[{"name":"RAS","slug":"ras","permalink":"https://system-thoughts.github.io/categories/ras/"},{"name":"blog","slug":"blog","permalink":"https://system-thoughts.github.io/categories/blog/"},{"name":"compilation","slug":"compilation","permalink":"https://system-thoughts.github.io/categories/compilation/"},{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/categories/boot/"},{"name":"Base Service","slug":"base-service","permalink":"https://system-thoughts.github.io/categories/base-service/"},{"name":"shell","slug":"shell","permalink":"https://system-thoughts.github.io/categories/shell/"},{"name":"tools","slug":"tools","permalink":"https://system-thoughts.github.io/categories/tools/"},{"name":"translation","slug":"translation","permalink":"https://system-thoughts.github.io/categories/translation/"},{"name":"lock-free","slug":"translation/lock-free","permalink":"https://system-thoughts.github.io/categories/translation/lock-free/"},{"name":"tools","slug":"translation/tools","permalink":"https://system-thoughts.github.io/categories/translation/tools/"}],"tags":[{"name":"APEI","slug":"apei","permalink":"https://system-thoughts.github.io/tags/apei/"},{"name":"domain","slug":"domain","permalink":"https://system-thoughts.github.io/tags/domain/"},{"name":"github page","slug":"github-page","permalink":"https://system-thoughts.github.io/tags/github-page/"},{"name":"ELF","slug":"elf","permalink":"https://system-thoughts.github.io/tags/elf/"},{"name":"compilation","slug":"compilation","permalink":"https://system-thoughts.github.io/tags/compilation/"},{"name":"link","slug":"link","permalink":"https://system-thoughts.github.io/tags/link/"},{"name":"boot","slug":"boot","permalink":"https://system-thoughts.github.io/tags/boot/"},{"name":"initramfs","slug":"initramfs","permalink":"https://system-thoughts.github.io/tags/initramfs/"},{"name":"gzip","slug":"gzip","permalink":"https://system-thoughts.github.io/tags/gzip/"},{"name":"deflate","slug":"deflate","permalink":"https://system-thoughts.github.io/tags/deflate/"},{"name":"BIOS","slug":"bios","permalink":"https://system-thoughts.github.io/tags/bios/"},{"name":"shell","slug":"shell","permalink":"https://system-thoughts.github.io/tags/shell/"},{"name":"codebase","slug":"codebase","permalink":"https://system-thoughts.github.io/tags/codebase/"},{"name":"mutt","slug":"mutt","permalink":"https://system-thoughts.github.io/tags/mutt/"},{"name":"ç¤¾åŒº","slug":"ç¤¾åŒº","permalink":"https://system-thoughts.github.io/tags/%E7%A4%BE%E5%8C%BA/"},{"name":"lock-free","slug":"lock-free","permalink":"https://system-thoughts.github.io/tags/lock-free/"},{"name":"memory-reordering","slug":"memory-reordering","permalink":"https://system-thoughts.github.io/tags/memory-reordering/"},{"name":"atomic","slug":"atomic","permalink":"https://system-thoughts.github.io/tags/atomic/"},{"name":"RedHat","slug":"redhat","permalink":"https://system-thoughts.github.io/tags/redhat/"},{"name":"NetworkManager","slug":"networkmanager","permalink":"https://system-thoughts.github.io/tags/networkmanager/"},{"name":"Network","slug":"network","permalink":"https://system-thoughts.github.io/tags/network/"},{"name":"hexo","slug":"hexo","permalink":"https://system-thoughts.github.io/tags/hexo/"}]}